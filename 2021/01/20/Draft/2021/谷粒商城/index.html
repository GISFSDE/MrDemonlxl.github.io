<!doctype html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta>
    <title>谷粒商城 - 魑魅先生</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="application-name" content="魑魅先生">
    <meta name="msapplication-TileImage" content="http://rcy276gfy.hd-bkt.clouddn.com/透明头像.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="魑魅先生">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta description="介绍">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="魑魅先生">
    <meta property="og:url" content="https://mrdemonlxl.github.io/">
    <meta property="og:site_name" content="魑魅先生">
    <meta property="og:description" content="介绍">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:image" content="http://rcy276gfy.hd-bkt.clouddn.com/微信图片_20210131173244.jpg">
    <meta property="article:published_time" content="2021-01-20T14:10:43.000Z">
    <meta property="article:modified_time" content="2022-06-04T10:28:00.215Z">
    <meta property="article:author" content="mrdemonlxl">
    <meta property="article:tag" content="谷粒商城">
    <meta property="twitter:card" content="summary">
    <meta property="twitter:image" content="http://rcy276gfy.hd-bkt.clouddn.com/微信图片_20210131173244.jpg">
    <script
        type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://mrdemonlxl.github.io/2021/01/20/Draft/2021/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/"},"headline":"魑魅先生","image":["http://rcy276gfy.hd-bkt.clouddn.com/webp.png"],"datePublished":"2021-01-20T14:10:43.000Z","dateModified":"2022-06-04T10:28:00.215Z","author":{"@type":"Person","name":"魑魅先生"},"description":"介绍"}</script>
    <link rel="canonical"
        href="http://mrdemonlxl.github.io/2021/01/20/Draft/2021/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/">
    <link rel="icon" href="http://rcy276gfy.hd-bkt.clouddn.com/透明头像.png">
    <meta name="referrer" content="no-referrer">
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
    <link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css">
    <link rel="stylesheet"
        href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css">
    <script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="/js/globalUtils.js"></script>
    <style>
        body>.footer,
        body>.navbar,
        body>.section {
            opacity: 0
        }
    </style>
    <!--!-->
    <!--!-->
    <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script>
    <!--!-->
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css">
    <!--!-->
    <!--!-->
    <script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script>
    <link rel="stylesheet" href="/live2d/waifu.css">
    <script type="text/javascript" async src="/live2d/autoload.js"></script>
    <meta name="generator" content="Hexo 5.3.0">
</head>

<body class="is-3-column has-navbar-fixed-top">
    <nav class="navbar navbar-main is-fixed-top">
        <div class="container">
            <div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img
                        src="http://rcy276gfy.hd-bkt.clouddn.com/彩色logo.png" alt="魑魅先生" height="28"></a></div>
            <div class="navbar-menu">
                <div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item"
                        href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item"
                        href="/tags">标签</a><a class="navbar-item" href="/album">相册</a><a class="navbar-item"
                        href="/friend">友链</a><a class="navbar-item" href="/message">留言</a><a class="navbar-item"
                        href="/self-talking">碎碎念</a><a class="navbar-item" href="/music">音乐</a><a class="navbar-item"
                        href="/media">影音</a><a class="navbar-item" href="/about">关于</a></div>
                <div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Join Gitter"
                        href="https://gitter.im/hexo-theme-amazing/community"><i class="fab fa-gitter"></i></a><a
                        class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub"
                        href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a><a
                        class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i
                            class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索"
                        href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav"
                        title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div>
            </div>
        </div>
    </nav>
    <script type="text/javascript" src="/js/theme-setting.js"></script>
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen">
                    <!--!-->
                    <div class="card">
                        <div class="card-image"><span class="image is-7by3"><img class="fill"
                                    src="http://rcy276gfy.hd-bkt.clouddn.com/webp.png" alt="谷粒商城"></span></div>
                        <article class="card-content article" role="article">
                            <div class="article-meta size-small is-uppercase level is-mobile">
                                <div class="level-left"><i class="far fa-calendar-plus"> </i>2021-01-20  <a
                                        class="commentCountImg"
                                        href="/2021/01/20/Draft/2021/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/#comment-container"><span
                                            class="display-none-class">9db3d7e84e1b224bd9da5bc5a819eaf3</span><i
                                            class="far fa-comment-dots"></i> <span class="commentCount"
                                            id="9db3d7e84e1b224bd9da5bc5a819eaf3">99+</span>  </a><span
                                        class="level-item"><i class="far fa-clock"> </i>9 小时  <i
                                            class="fas fa-pencil-alt"> </i>78.3 k</span><span class="level-item"
                                        id="busuanzi_container_page_pv"><span
                                            id="busuanzi_value_page_pv">0</span>次访问</span></div>
                            </div>
                            <h1 class="title is-3 is-size-4-mobile">谷粒商城</h1>
                            <div class="content">
                                <blockquote>
                                    <p>介绍</p>
                                </blockquote>
                                <a id="more"></a>
                                <blockquote>
                                    <h1 id="%E6%96%B0%E5%AD%A6%E5%9B%9B%E9%97%AE">新学四问</h1>
                                    <p><strong>WHY【与前代优化了什么，弥补了什么空白】</strong>：学习实践分布式组件，高并发等业务<br />
                                        <strong>WHAT【框架，思维导图，主题框架】</strong>：通过项目扎实技术，SpringBoot+SpringCloud+Docker+VUE+Element-UI<br />
                                        <strong>HOW【如何记忆，学习资源（官方文档、视频资源、项目地址）】</strong>：<a target="_blank"
                                            rel="noopener" href="https://share.weiyun.com/z0DElpTd">谷粒商城源码和软件</a>、<a
                                            target="_blank" rel="noopener"
                                            href="https://www.bilibili.com/video/BV1np4y1C7Yf?spm_id_from=333.999.0.0">在线教程</a><br />
                                        <strong>LEVEL【不是每个都学精】</strong>：清晰明了
                                    </p>
                                </blockquote>
                                <h1 id="%E8%BF%9B%E5%BA%A6%EF%BC%9A-%E3%80%9085--5.25%E3%80%91">进度： 【85 -5.25】</h1>
                                <h1 id="%3D%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E7%AF%87%3D">
                                    =<mark><mark><strong>分布式基础篇</strong></mark></mark>=</h1>
                                <hr />
                                <h1 id="%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D">一、项目介绍</h1>
                                <h2 id="1.1-%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF" id="1-1-项目背景">1.1 项目背景</h2>
                                <p>项目在线接口文档：<a target="_blank" rel="noopener"
                                        href="https://easydoc.net/s/78237135/ZUqEdvA4/hKJTcbfd">1、分页请求参数 - 谷粒商城
                                        (easydoc.net)</a></p>
                                <h2 id="1.2-%E7%94%B5%E5%95%86%E6%A8%A1%E5%BC%8F" id="1-2-电商模式">1.2 电商模式</h2>
                                <p>市面上有5种常见的电商模式 B2B 、B2C、C2B 、C2C、O2O</p>
                                <h3 id="1.2.1-b2b-%E6%A8%A1%E5%BC%8F" id="1-2-1-B2B-模式">1.2.1 B2B 模式</h3>
                                <p>B2B （ Business to Business） 是指商家和商家建立的商业关系，如阿里巴巴。</p>
                                <h3 id="1.2.2-b2c-%E6%A8%A1%E5%BC%8F" id="1-2-2-B2C-模式">1.2.2 B2C 模式</h3>
                                <p>B2C(Business to Consumer) 就是我们经常看到的供应商直接把商品买个用户，即 “商对客”
                                    模式，也就是我们呢说的商业零售，直接面向消费销售产品和服务，如苏宁易购，京东，天猫，小米商城</p>
                                <h3 id="1.2.3-c2b-%E6%A8%A1%E5%BC%8F" id="1-2-3-C2B-模式">1.2.3 C2B 模式</h3>
                                <p>C2B (Customer to Business),即消费者对企业，先有消费者需求产生而后有企业生产，即先有消费者提出需求，后又生产企业按需求组织生产</p>
                                <h3 id="1.2.4-c2c-%E6%A8%A1%E5%BC%8F" id="1-2-4-C2C-模式">1.2.4 C2C 模式</h3>
                                <p>C2C (Customer to Consumer) 客户之间吧自己的东西放到网上去卖 如 淘宝 咸鱼</p>
                                <h3 id="1.2.5-o2o" id="1-2-5-O2O">1.2.5 O2O</h3>
                                <p>O2O 即 Online To
                                    Offline，也即将线下商务的机会与互联网结合在一起，让互联网成为线下交易前台，线上快速支付，线下优质服务，如：饿了么，美团，淘票票，京东到家</p>
                                <h2 id="1.3-%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E" id="1-3-谷粒商城">1.3 谷粒商城</h2>
                                <p>谷粒商城是一个 B2C 模式的电商平台，销售自营商品给客户</p>
                                <h2 id="1.4-%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E5%9B%BE" id="1-4-项目架构图">1.4 项目架构图</h2>
                                <ol>
                                    <li>
                                        <h3 id="%E9%A1%B9%E7%9B%AE%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%9B%BE"
                                            id="项目微服务架构图">项目微服务架构图</h3>
                                    </li>
                                </ol>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610937357129-af7e3c78-9872-4db0-8d77-1a982788a193.jpeg"
                                        alt="谷粒商城-微服务架构图.jpg" /></p>
                                <ol start="2">
                                    <li>
                                        <h3 id="%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%92%E5%88%86%E5%9B%BE" id="微服务划分图">
                                            微服务划分图</h3>
                                    </li>
                                </ol>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610938057423-20a6e87f-c156-4a6b-96dc-69b8fe3c9686.png"
                                        alt="image-20201015112852613.png" /></p>
                                <h2 id="1.5-%E9%A1%B9%E7%9B%AE%E6%8A%80%E6%9C%AF%E5%92%8C%E7%89%B9%E8%89%B2"
                                    id="1-5-项目技术和特色">1.5 项目技术和特色</h2>
                                <p>● 前后分离技术、并开发基于 vue 的后台管理系统。</p>
                                <p>●SpringCloud 全新的解决方案</p>
                                <p>●应用监控、限流、网关、熔断降级、等分布式方案，全方位涉及</p>
                                <p>●透彻讲解分布式事务，分布式锁等分布式系统的难点</p>
                                <p>●压力测试与性能优化</p>
                                <p>●各种集群技术的区别以及使用</p>
                                <p>●CI/CD的使用</p>
                                <h2 id="1.6-%E9%A1%B9%E7%9B%AE%E5%89%8D%E7%BD%AE%E8%A6%81%E6%B1%82" id="1-6-项目前置要求">1.6
                                    项目前置要求</h2>
                                <p>学习项目的前置知识</p>
                                <p>●熟悉 Springboot 以及常见的整合方案</p>
                                <p>●了解 SpringCloud</p>
                                <p>●熟悉 git maven</p>
                                <p>●熟悉 Linux 、 redis docker 基本操作</p>
                                <p>●了解html、css、js 、vue</p>
                                <p>●熟悉使用 idea 开发项目</p>
                                <h1
                                    id="%E4%BA%8C%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">
                                    二、分布式基础概念</h1>
                                <h2 id="2.1-%E5%BE%AE%E6%9C%8D%E5%8A%A1" id="2-1-微服务">2.1 微服务</h2>
                                <p>微服务架构风格，就像是把一个单独的应用程序开发成一套小服务，每个小服务运行在自己的进程中，并使用轻量级机制通信，通常是HTTP API
                                    这些服务围绕业务能力来构建，并通过完全自动化部署机制来独立部署，这些服务使用不同的编程语言来写，以及不同的数据存储技术，并保持最低限度的集中式管理。</p>
                                <p>简而言之，拒绝大型单体应用，基于业务边界进行服务拆分，每个服务独立部署运行。</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610943441881-f899ea10-7007-46a8-870a-331b680ac9ac.png"
                                        alt="image-20201015101317095.png" /></p>
                                <h2 id="2.2-%E9%9B%86%E7%BE%A4-%26-%E5%88%86%E5%B8%83%E5%BC%8F-%26-%E8%8A%82%E7%82%B9"
                                    id="2-2-集群-分布式-节点">2.2 集群 &amp; 分布式 &amp; 节点</h2>
                                <p>集群是个物理状态，分布式是个工作方式。</p>
                                <p>只要是一对机器，也可以叫做集群，他不是一起协作干活，这谁也不知道。</p>
                                <p>《分布式系统原理与范型》定义：</p>
                                <p>“分布式系统是若干独立计算机的集合，这些计算机对于用户来说像但各相关系统”</p>
                                <p>分布式系统 (distributed system) 是建立网络之上的软件系统<br />
                                    分布式是指讲不通的业务分布在不同的地方<br />
                                    集群实质是将几台服务器集中在一起，实现同一业务<br />
                                    例如：京东是一个分布式系统，众多业务运行在不同的机器上，所有业务构成一个大型的业务集群，每一个小的业务，比如用户系统，访问压力大的时候一台服务器是不够的，我们就应该将用户系统部署到多个服务器，也就是每个一业务系统也可以做集群化
                                </p>
                                <p>分布式中的每一个节点，都可以做集群，而集群并不一定就是分布式的</p>
                                <p>节点：集群中的一个服务器</p>
                                <h2 id="2.3-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8" id="2-3-远程调用">2.3 远程调用</h2>
                                <p>在分布式系统中，各个服务可能处于不同主机，但是服务之间不可避免的需要互相调用，我们称之为远程调用</p>
                                <p>SpringCloud 中使用 HTTP + JSON 的方式来完成远程调用。</p>
                                <p>HTTP+JSON</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610943854828-5998cdc5-0ece-453f-976d-5866876f02fa.png"
                                        alt="image-20201015103427667.png" /></p>
                                <h2 id="2.4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" id="2-4-负载均衡">2.4 负载均衡</h2>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610943916861-7de530e5-43b4-4543-8f87-104f0da5af10.png"
                                        alt="image-20201015103547907.png" /></p>
                                <p>分布式系统中，A 服务需要调用 B 服务，B 服务在多台机器中都存在，A 调用任意一个服务器均可完成功能。</p>
                                <p>为了使每一个服务器都不要太忙后者太闲，我们可以负载均衡调用每一个服务器，提升网站的健壮性。</p>
                                <p>常见的负载均算法：</p>
                                <p>轮询： 为第一个请求选择健康池中的第一个后端服务器，然后按顺序往后依次选择，直到最后一个，然后循环。<br />
                                    最小连接： 优先选择连接数最少，也就是压力最小的后端服务器，在会话较长的情况下可以考虑采取这种方式。</p>
                                <h2 id="2.5-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%2F%E5%8F%91%E7%8E%B0-%26-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"
                                    id="2-5-服务注册-发现-注册中心">2.5 服务注册/发现 &amp; 注册中心</h2>
                                <p>A 服务调用 B 服务， A 服务 不知道 B 服务当前在哪几台服务器上有，那些正常的，那些服务已经下线，解决这个问题可以引入注册中心。</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610946745993-411f3672-87aa-4440-8974-fecb57c54204.png"
                                        alt="image-20201015104330935.png" /></p>
                                <p>如果某些服务下线，我们其他人可以实时的感知到其他服务的状态，从而避免调用不可用的服务。</p>
                                <h2 id="2.6-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83" id="2-6-配置中心">2.6 配置中心</h2>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610946879552-b1d838ea-605c-4ee3-871c-25dd9123faa0.png"
                                        alt="image-20201015104450711.png" /></p>
                                <p>每一个服务最终都有大量配置，并且每个服务都可能部署在多个服务器上，我们经常需要变更配置，我们可以让每个服务在配置中心获取自己的配置，配置中心用来集中管理微服务的配置信息。
                                </p>
                                <h2 id="2.7-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD-%26-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"
                                    id="2-7-服务熔断-服务降级">2.7 服务熔断 &amp; 服务降级</h2>
                                <p>在微服务架构中，微服务之间通过网络来进行通信，存在相互依赖，当其中一个服务不可用时，有可能会造成雪崩效应，要防止这种情况，必须要有容错机制来保证服务。</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610947257467-3299ac4c-69de-4553-aec8-7972fa6da25e.png"
                                        alt="image-20201015105256207.png" /></p>
                                <ol>
                                    <li>
                                        <h3 id="%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD" id="服务熔断">服务熔断</h3>
                                    </li>
                                </ol>
                                <p>●设置服务的超时，当被调用的服务经常失败达到某个阈值，我们可以开启短路保护机制，后来的请求不再去调用这个服务，本地直接返回默认的数据。</p>
                                <ol start="2">
                                    <li>
                                        <h3 id="%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7" id="服务降级">服务降级</h3>
                                    </li>
                                </ol>
                                <p>●在运维期间，当系统处于高峰期，系统资源紧张，我们可以让非核心业务降级运行，降级某些服务不处理，或者简单处理【抛异常，返回NULL，调用MOCk数据，调用FallBack处理逻辑】
                                </p>
                                <h2 id="2.8-api%E7%BD%91%E5%85%B3" id="2-8-Api网关">2.8 Api网关</h2>
                                <p>在微服务架构中， Api Gateway
                                    作为整体架构的重要组件，它抽象服务中需要的公共功能，同时它提供给了客户端负载均衡、服务自动熔断、灰度发布、统一认证、限流监控、日志统计 等 丰富功能，帮助我们解决了很多
                                    API 管理的难题 。</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/1610947741988-1bfd6a06-45bb-48f4-9849-a6fa424c30e9.png"
                                        alt="image-20201015110148578.png" /></p>
                                <h1 id="%E4%B8%89%E3%80%81%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83">三、搭建环境</h1>
                                <h2 id="3.1-%E5%AE%89%E8%A3%85-linux-%E8%99%9A%E6%8B%9F%E6%9C%BA" id="3-1-安装-Linux-虚拟机">
                                    3.1 安装 Linux 虚拟机</h2>
                                <p>下载&amp;安装 VirtualBox <a target="_blank" rel="noopener"
                                        href="https://www.virtualbox.org/">https://www.virtualbox.org/</a> 要开启 CPU 虚拟化
                                </p>
                                <h3 id="%E4%B8%8B%E8%BD%BD%26-%E5%AE%89%E8%A3%85-vagrant" id="下载-安装-Vagrant">下载&amp; 安装
                                    Vagrant</h3>
                                <p><a target="_blank" rel="noopener"
                                        href="https://app.vagrantup.com/boxes/search">https://app.vagrantup.com/boxes/search</a>
                                    Vagrant 官方镜像仓库</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://www.vagrantup.com/downloads.html">https://www.vagrantup.com/downloads.html</a>
                                    Vagrant下载</p>
                                <p>打开window cmd窗口，运行<strong>Vagrant init centos/7</strong>
                                    ,即可<strong>初始化</strong>一个centos系统</p>
                                <p>运行<strong>vagrant
                                        up</strong>即可<strong>启动</strong>虚拟机。<strong>系统root用户的密码是vagrant</strong></p>
                                <p><strong>vagrant其他常用命令</strong></p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">vagrant ssh 自动使用 vagrant 用户连接虚拟机</span><br><span class="line"></span><br><span class="line">vagrant upload <span class="built_in">source</span> [destination] [name|id] 上传文件</span><br><span class="line"></span><br><span class="line">https://www.vagrantup.com/docs/cli/init.html Vagrant 命令行</span><br><span class="line"></span><br><span class="line">vagrant reload 重启并重新加载Vagrantfile</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>默认虚拟机的ip 地址不是固定ip 开发不方便</p>
                                <p>Vagrant 和 VirtualBox 版本有对应问题 都安装最新版本 则安装成功</p>
                                <p><strong>修改 Vagrantfile</strong></p>
                                <p>config.vm.network &quot;private_network&quot;, ip: &quot;192.168.56.10&quot;</p>
                                <p>这里 ip 需要在 物理机下使用 ipconfig 命令找到</p>
                                <p><img src="https://cdn.nlark.com/yuque/0/2021/png/440247/1610948554518-f1099be6-606a-455c-b1bf-402c52057afe.png"
                                        alt="image-20201015141629387.png" /></p>
                                <h2 id="3.2-%E5%AE%89%E8%A3%85-docker" id="3-2-安装-docker">3.2 安装 docker</h2>
                                <p>Docker 参考 <a target="_blank" rel="noopener" href="https://www.docker.com/">Docker</a>
                                </p>
                                <h3 id="3.2.1-%E5%8D%B8%E8%BD%BD%E7%B3%BB%E7%BB%9F%E4%B9%8B%E5%89%8D%E5%AE%89%E8%A3%85%E7%9A%84docker"
                                    id="3-2-1-卸载系统之前安装的docker">3.2.1 卸载系统之前安装的docker</h3>
                                <p>Uninstall old versions.</p>
                                <p>一步一步往下执行就行</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>SET UP THE REPOSITORY</p>
                                <p>Install the yum-utils package (which provides the yum-config-manager utility) and set
                                    up the stable repository.</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>INSTALL DOCKER ENGINE<br />
                                    1.Install the latest version of Docker Engine and containerd, or go to the next step
                                    to install a specific version:</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Start Docker</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo systemctl start docker</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Verify that Docker Engine is installed correctly by running the hello-world image.
                                </p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo docker run hello-world</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>设置 docker 开机自启动</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>查看Docker的镜像</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo docker images</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>设置 Docker 镜像加速</p>
                                <p>登录 <a target="_blank" rel="noopener" href="http://aliyun.com">aliyun.com</a>
                                    在控制台找到容器镜像服务</p>
                                <p><img src="https://cdn.nlark.com/yuque/0/2021/png/440247/1610948939792-421b248d-416d-4c57-b18d-33b5b9a3fbbb.png"
                                        alt="image-20201015144524435.png" /></p>
                                <p>docker 进入 对应容器</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker ps  <span class="comment">#查看主机有哪些容器正在运行</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 容器ID/NAME /bin/bash  <span class="comment">#进入对应容器</span></span><br><span class="line"><span class="built_in">exit</span>; <span class="comment">#退出容器[快捷键 ctrl + p/q]</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="3.3-docker-%E5%AE%89%E8%A3%85-mysql" id="3-3-docker-安装-mysql">3.3 docker 安装
                                    mysql</h2>
                                <h3 id="3.3.1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6" id="3-3-1-下载镜像文件">
                                    3.3.1 下载镜像文件</h3>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">sudo docker pull mysql:5.7</span><br><span class="line">sudo docker images</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>3.3.2 创建实例并启动</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment"># --name指定容器名字 -v目录挂载 -p指定端口映射  -e设置mysql参数 -d后台运行</span></span><br><span class="line">sudo docker run -p 3306:3306 --name mysql \</span><br><span class="line">-v /mydata/mysql/<span class="built_in">log</span>:/var/<span class="built_in">log</span>/mysql \</span><br><span class="line">-v /mydata/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /mydata/mysql/conf:/etc/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-d mysql:5.7</span><br><span class="line"><span class="comment">####</span></span><br><span class="line">-v 将对应文件挂载到主机【类似快捷方式，两者内容同步】，比如-v /mydata/mysql/<span class="built_in">log</span>【主机快捷方式】:/var/<span class="built_in">log</span>/mysql【容器中文件夹】</span><br><span class="line">-e 初始化对应MYSQL参数</span><br><span class="line">-p 容器端口映射到主机的端口</span><br><span class="line">su root</span><br><span class="line">docker ps  <span class="comment">#查看主机有哪些容器正在运行</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>MySQL 配置</p>
                                <p>vi /mydata/mysql/conf/my.cnf 创建&amp;修改该文件</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">[client]</span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line">[mysqld]</span><br><span class="line">init_connect&#x3D;&#39;SET collation_connection &#x3D; utf8_unicode_ci&#39;</span><br><span class="line">init_connect&#x3D;&#39;SET NAMES utf8&#39;</span><br><span class="line">character-set-server&#x3D;utf8</span><br><span class="line">collation-server&#x3D;utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line">skip-name-resolve</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">#重启mysql</span></span><br><span class="line">docker restart mysql</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="3.3.3-%E9%80%9A%E8%BF%87%E5%AE%B9%E5%99%A8%E7%9A%84mysql-%E5%91%BD%E4%BB%A4%E5%B7%A5%E5%85%B7%E8%BF%9E%E6%8E%A5"
                                    id="3-3-3-通过容器的mysql-命令工具连接">3.3.3 通过容器的mysql 命令工具连接</h3>
                                <p><img src="https://cdn.nlark.com/yuque/0/2021/png/440247/1610949284748-a37e0692-eb52-449c-861c-2fb73d627668.png"
                                        alt="image.png" /></p>
                                <h2 id="3.4-docker-%E5%AE%89%E8%A3%85-redis" id="3-4-docker-安装-redis">3.4 docker 安装
                                    redis</h2>
                                <h3 id="3.4.1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6" id="3-4-1-下载镜像文件">
                                    3.4.1 下载镜像文件</h3>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker pull redis</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="3.4.2-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E5%B9%B6%E5%90%AF%E5%8A%A8"
                                    id="3-4-2-创建实例并启动">3.4.2 创建实例并启动</h3>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">#先创建文件夹和文件再挂载，否则会将其文件名创建为文件夹</span></span><br><span class="line">mkdir -p /mydata/redis/conf</span><br><span class="line">touch /mydata/redis/conf/redis.conf</span><br><span class="line"><span class="comment"># 启动 同时 映射到对应文件夹</span></span><br><span class="line"><span class="comment"># 后面 \ 代表换行</span></span><br><span class="line">docker run -p 6379:6379 --name redis \</span><br><span class="line">-v /mydata/redis/data:/data \</span><br><span class="line">-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d redis redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker ps</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="3.4.3-%E4%BD%BF%E7%94%A8-redis-%E9%95%9C%E5%83%8F%E6%89%A7%E8%A1%8C-redis-cli-%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5"
                                    id="3-4-3-使用-redis-镜像执行-redis-cli-命令连接">3.4.3 使用 redis 镜像执行 redis-cli 命令连接</h3>
                                <p>进入docker cli</p>
                                <p>docker exec -it redis redis-cli</p>
                                <p>持久化 默认 appendonly on 没有开启</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">vi /mydata/redis/conf/redis.conf</span><br><span class="line"><span class="comment"># 插入下面内容</span></span><br><span class="line">appendonly yes</span><br><span class="line">docker restart redis</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="3.5-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%BB%9F%E4%B8%80" id="3-5-开发环境统一">3.5
                                    开发环境统一</h2>
                                <h3 id="3.5.1-maven%E7%89%88%E6%9C%AC%E4%B8%8E%E9%85%8D%E7%BD%AE" id="3-5-1-Maven版本与配置">
                                    3.5.1 Maven版本与配置</h3>
                                <h4 id="1.%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F"
                                    id="1-配置阿里云镜像">1.配置阿里云镜像</h4>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <ol start="2">
                                    <li>
                                        <h4 id="%E9%85%8D%E7%BD%AE-jdk-1.8-%E7%BC%96%E8%AF%91%E9%A1%B9%E7%9B%AE"
                                            id="配置-jdk-1-8-编译项目">配置 jdk 1.8 编译项目</h4>
                                    </li>
                                </ol>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span><span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="3.5.2-idea-%26-vscode" id="3-5-2-idea-vscode">3.5.2 idea &amp; vscode</h3>
                                <p><a target="_blank" rel="noopener"
                                        href="https://github.com/varHarrie/varharrie.github.io/issues/10">VSCode插件</a><br />
                                    <img src="C:/Users/lxl/AppData/Roaming/Typora/typora-user-images/image-20220505214346614.png"
                                        alt="image-20220505214346614" />
                                </p>
                                <p>Vetur ——语法高亮，智能感知 包含格式化功能，Alt+Shift+F (格式化全文) ，Ctrl+K Ctrl+F
                                    (格式化选中代码，两个Ctrl需要同时按着)<br />
                                    EsLint 一一 语法纠错<br />
                                    Auto Close Tag 一一 自动闭合HTML/XML标签<br />
                                    Auto Rename Tag 一一 自动完成另-侧标签的同步修改<br />
                                    JavaScript(ES6) code snippets 一一 ES6 语法智能提示以及快速输入，除j外还支持.ts, .jsx， .tsx， .html,
                                    .vue;省去了配置其支持各种包含is代码文件的时间</p>
                                <h3 id="3.5.3-mybatisplus%E6%95%B4%E5%90%88" id="3-5-3-MybatisPlus整合">3.5.3
                                    MybatisPlus整合</h3>
                                <h4 id="4.1-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83" id="4-1-配置环境">4.1 配置环境</h4>
                                <h5 id="4.1.1%E3%80%81%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96" id="4-1-1、导入依赖">4.1.1、导入依赖
                                </h5>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="4.2.2%E3%80%81%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90" id="4-2-2、配置数据源">
                                    4.2.2、配置数据源</h5>
                                <p>配置数据源</p>
                                <ol>
                                    <li>
                                        <h6 id="%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E9%A9%B1%E5%8A%A8"
                                            id="导入数据库驱动">导入数据库驱动</h6>
                                        <p><a target="_blank" rel="noopener"
                                                href="https://mvnrepository.com/artifact/mysql/mysql-connector-java">https://mvnrepository.com/artifact/mysql/mysql-connector-java</a>
                                        </p>
                                        <figure class="highlight xml">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="comment">&lt;!--导入mysql驱动--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                    </li>
                                    <li>
                                        <h6 id="%E5%9C%A8application.yml%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"
                                            id="在application-yml配置数据源相关信息">在application.yml配置数据源相关信息</h6>
                                        <figure class="highlight yml">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.10:3306/gulimall_pms</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">	<span class="comment"># mapper文件扫描</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># 数据库主键自增</span></span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                    </li>
                                </ol>
                                <p>配置MyBatis-Plus包扫描：</p>
                                <ol>
                                    <li>
                                        <p>使用@MapperScanner</p>
                                    </li>
                                    <li>
                                        <p>告诉MyBatis-Plus,Sql映射文件位置</p>
                                        <figure class="highlight java">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="meta">@MapperScan(&quot;com.atguigu.gulimall.product.dao&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallProductApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GulimallProductApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                    </li>
                                </ol>
                                <p>具体过程参考官网： <a target="_blank" rel="noopener"
                                        href="https://baomidou.com/guide/install.html#release">https://baomidou.com/guide/install.html#release</a>
                                </p>
                                <h4 id="4.2-%E5%88%86%E9%A1%B5%E9%85%8D%E7%BD%AE" id="4-2-分页配置">4.2 分页配置</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Configuration</span> <span class="comment">// 声明配置类</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">// 开启注解</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.atguigu.gulimall.product.dao&quot;)</span> <span class="comment">// 指定扫描包</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 引入分页插件 拦截器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PaginationInterceptor <span class="title">paginationInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PaginationInterceptor paginationInterceptor = <span class="keyword">new</span> PaginationInterceptor();</span><br><span class="line">        <span class="comment">// 设置请求的页面大于最大页后操作， true调回到首页，false 继续请求  默认false</span></span><br><span class="line">         paginationInterceptor.setOverflow(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 设置最大单页限制数量，默认 500 条，-1 不受限制</span></span><br><span class="line">         paginationInterceptor.setLimit(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 开启 count 的 join 优化,只针对部分 left join</span></span><br><span class="line">        paginationInterceptor.setCountSqlParser(<span class="keyword">new</span> JsqlParserCountOptimize(<span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">return</span> paginationInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="4.3-%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4" id="4-3-逻辑删除">4.3 逻辑删除</h4>
                                <p>说明:</p>
                                <p>只对自动注入的sql起效:</p>
                                <ul>
                                    <li>插入: 不作限制</li>
                                    <li>查找: 追加where条件过滤掉已删除数据,且使用 wrapper.entity 生成的where条件会忽略该字段</li>
                                    <li>更新: 追加where条件防止更新到已删除数据,且使用 wrapper.entity 生成的where条件会忽略该字段</li>
                                    <li>删除: 转变为 更新</li>
                                </ul>
                                <p>例如:</p>
                                <ul>
                                    <li>删除: <code>update user set deleted=1 where id = 1 and deleted=0</code></li>
                                    <li>查找: <code>select id,name,deleted from user where deleted=0</code></li>
                                </ul>
                                <h5 id="%E6%AD%A5%E9%AA%A41%EF%BC%9A%E9%85%8D%E7%BD%AE-application.yml"
                                    id="步骤1：配置-application-yml">步骤1：配置 application.yml</h5>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># 数据库主键自增</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="%E6%AD%A5%E9%AA%A42%3A-%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AD%97%E6%AE%B5%E4%B8%8A%E5%8A%A0%E4%B8%8A%40tablelogic%E6%B3%A8%E8%A7%A3"
                                    id="步骤2-实体类字段上加上-TableLogic注解">步骤2: 实体类字段上加上<code>@TableLogic</code>注解</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否显示[0-不显示，1显示]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@TableLogic(value = &quot;1&quot;,delval = &quot;0&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Integer showStatus;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="3.5.4-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEgit" id="3-5-4-安装配置git">3.5.4 安装配置git
                                </h3>
                                <ol>
                                    <li>
                                        <h4 id="%E4%B8%8B%E8%BD%BDgit" id="下载git">下载git</h4>
                                    </li>
                                </ol>
                                <p><a target="_blank" rel="noopener"
                                        href="https://git-scm.com/">https://git-scm.com/</a></p>
                                <ol start="2">
                                    <li>
                                        <h4 id="%E9%85%8D%E7%BD%AE-git-%E8%BF%9B%E5%85%A5-git-bash"
                                            id="配置-git-进入-git-bash">配置 git 进入 git bash</h4>
                                    </li>
                                </ol>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"># 配置用户名</span><br><span class="line">git config --global user.name &quot;user.name&quot;</span><br><span class="line"># 配置邮箱</span><br><span class="line">git config --global user.email &quot;username@email.com&quot; # 注册账号使用的邮箱</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <ol start="3">
                                    <li>
                                        <h3 id="%E9%85%8D%E7%BD%AE-ssh-%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"
                                            id="配置-ssh-免密码登录">配置 ssh 免密码登录</h3>
                                    </li>
                                </ol>
                                <p><a target="_blank" rel="noopener"
                                        href="https://github.com/settings/keys">https://github.com/settings/keys</a></p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">git bash 使用 ssh-keygen -t rsa -C &quot;XXX@xxx.com&quot; 命令 连续三次回车</span><br><span class="line">一般用户目录下都会有</span><br><span class="line">id_rsa 文件</span><br><span class="line">id_rsa.pub 文件</span><br><span class="line">或者 cat ~&#x2F;.ssh&#x2F;id_rsa.pub</span><br><span class="line">登录进 github&#x2F;gitee 设置 SSH KEY</span><br><span class="line">使用 ssh -T git@gitee.com 测试是否成功</span><br><span class="line">具体过程参考百度</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>项目结构创建</p>
                                <h3 id="3.5.5-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E7%9A%84%E4%BD%BF%E7%94%A8"
                                    id="3-5-5-逆向工程的使用">3.5.5 逆向工程的使用</h3>
                                <h4 id="1.%E4%B8%8B%E8%BD%BD%E4%BA%BA%E4%BA%BA%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE"
                                    id="1-下载人人开源项目">1.下载人人开源项目</h4>
                                <p><a target="_blank" rel="noopener"
                                        href="https://gitee.com/renrenio">https://gitee.com/renrenio</a></p>
                                <p><img src="https://cdn.nlark.com/yuque/0/2021/png/440247/1610950177379-b008f830-de8f-4367-9c43-1276a0d13fcb.png"
                                        alt="image.png" /></p>
                                <ol start="2">
                                    <li>
                                        <h4 id="%E9%80%89%E6%8B%A9-renren--generator-%E9%A1%B9%E7%9B%AE"
                                            id="选择-renren-generator-项目">选择 renren -generator 项目</h4>
                                    </li>
                                </ol>
                                <p>1.下载之后，导入项目，修改数据库，修改工程shiro依赖为SpringSecurity</p>
                                <p>2.修改对应数据库配置，模块名与数据库表名前缀</p>
                                <p><img src="C:/Users/lxl/AppData/Roaming/Typora/typora-user-images/image-20220509203144131.png"
                                        alt="image-20220509203144131" /></p>
                                <ol start="3">
                                    <li>
                                        <h4 id="%E4%B8%8B%E8%BD%BD-renren-fast-vue%E9%A1%B9%E7%9B%AE"
                                            id="下载-renren-fast-vue项目">下载 renren-fast-vue项目</h4>
                                    </li>
                                </ol>
                                <p>1.vscode 导入前端项目</p>
                                <p>2.前后端联调测试基本功能</p>
                                <h4 id="2.%E5%88%9B%E5%BB%BA%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97" id="2-创建业务模块">2.创建业务模块
                                </h4>
                                <h4 id="3.%E9%85%8D%E7%BD%AE%E5%85%AC%E5%85%B1%E7%8E%AF%E5%A2%83" id="3-配置公共环境">3.配置公共环境
                                </h4>
                                <h4 id="4.%E4%BD%BF%E7%94%A8%E4%BA%BA%E4%BA%BA%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8%E7%94%9F%E6%88%90%E5%9F%BA%E7%A1%80%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"
                                    id="4-使用人人代码生成器生成基础业务代码">4.使用人人代码生成器生成基础业务代码</h4>
                                <p>修改相关配置</p>
                                <h2 id="3.6-%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83" id="3-6-前后端联调">3.6 前后端联调</h2>
                                <h3 id="3.6.1-%E5%90%AF%E5%8A%A8%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE" id="3-6-1-启动前端项目">
                                    3.6.1 启动前端项目</h3>
                                <p>npm install 安装依赖</p>
                                <p>通过 npm run dev 启动</p>
                                <h3 id="3.6.2-%E5%90%AF%E5%8A%A8%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE" id="3-6-2-启动后端项目">
                                    3.6.2 启动后端项目</h3>
                                <p>这时，你使用浏览器直接该接口，发现访问没事，但是用前端项目访问却报错，什么原因？</p>
                                <p>这其实是浏览器的同源策略造成的跨域问题。</p>
                                <h3 id="3.6.3-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98" id="3-6-3-跨域问题">3.6.3 跨域问题</h3>
                                <p>跨域：浏览器对于javascript的同源策略的限制 。</p>
                                <p>以下情况都属于跨域：</p>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>跨域原因说明</th>
                                            <th>示例</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>域名不同</td>
                                            <td><a target="_blank" rel="noopener"
                                                    href="http://www.jd.com">www.jd.com</a> 与 <a target="_blank"
                                                    rel="noopener" href="http://www.taobao.com">www.taobao.com</a></td>
                                        </tr>
                                        <tr>
                                            <td>域名相同，端口不同</td>
                                            <td><a target="_blank" rel="noopener"
                                                    href="http://www.jd.com:8080">www.jd.com:8080</a> 与 <a
                                                    target="_blank" rel="noopener"
                                                    href="http://www.jd.com:8081">www.jd.com:8081</a></td>
                                        </tr>
                                        <tr>
                                            <td>二级域名不同</td>
                                            <td><a target="_blank" rel="noopener"
                                                    href="http://item.jd.com">item.jd.com</a> 与 <a target="_blank"
                                                    rel="noopener" href="http://miaosha.jd.com">miaosha.jd.com</a></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p>如果域名和端口都相同，但是请求路径不同，不属于跨域，如：</p>
                                <p><a target="_blank" rel="noopener" href="http://www.jd.com/item">www.jd.com/item</a>
                                </p>
                                <p><a target="_blank" rel="noopener" href="http://www.jd.com/goods">www.jd.com/goods</a>
                                </p>
                                <p>http和https也属于跨域</p>
                                <p><a target="_blank" rel="noopener"
                                        href="http://xn--manager-754kviu40app1cwua071bji2g.gmall.xn--comapi-r05ju418anfta.gmall.com">而我们刚才是从manager.gmall.com去访问api.gmall.com</a>，这属于端口不同，跨域了。
                                </p>
                                <h4 id="3.6.3.1-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"
                                    id="3-6-3-1-为什么会有跨域问题">3.6.3.1 为什么会有跨域问题</h4>
                                <p>跨域不一定都会有跨域问题。</p>
                                <p>因为跨域问题是浏览器对于ajax请求的一种安全限制：一个页面发起的ajax请求，只能是与当前页域名相同的路径，这能有效的阻止跨站攻击。</p>
                                <p>因此：跨域问题 是针对ajax的一种限制。</p>
                                <p>但是这却给我们的开发带来了不便，而且在实际生产环境中，肯定会有很多台服务器之间交互，地址和端口都可能不同，怎么办？</p>
                                <h4 id="3.6.3.2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"
                                    id="3-6-3-2-为什么会有跨域问题">3.6.3.2 为什么会有跨域问题</h4>
                                <p>目前比较常用的跨域解决方案有3种：</p>
                                <p>●Jsonp最早的解决方案，利用script标签可以跨域的原理实现。限制：</p>
                                <p>○需要服务的支持</p>
                                <p>○只能发起GET请求</p>
                                <p>●nginx反向代理 思路是：利用nginx把跨域反向代理为不跨域，支持各种请求方式 缺点：需要在nginx进行额外配置，语义不清晰</p>
                                <p>●CORS规范化的跨域请求解决方案，安全可靠。优势：</p>
                                <p>○在服务端进行控制是否允许跨域，可自定义规则</p>
                                <p>○支持各种请求方式</p>
                                <p>●缺点：</p>
                                <p>○会产生额外的请求</p>
                                <p>我们这里会采用cors的跨域方案。</p>
                                <h3 id="3.6.4-%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3" id="3-6-4-跨域解决">3.6.4 跨域解决</h3>
                                <p><strong>什么是cors</strong></p>
                                <p>CORS是一个W3C标准，全称是&quot;跨域资源共享&quot;（Cross-origin resource sharing）。</p>
                                <p>它允许浏览器向跨源服务器，发出<a target="_blank" rel="noopener"
                                        href="http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html">XMLHttpRequest</a>请求，从而克服了AJAX只能<a
                                        target="_blank" rel="noopener"
                                        href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html">同源</a>使用的限制。
                                </p>
                                <p>CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE浏览器不能低于IE10。</p>
                                <p>●浏览器端： 目前，所有浏览器都支持该功能（IE10以下不行）。整个CORS通信过程，都是浏览器自动完成，不需要用户参与。</p>
                                <p>●服务端：
                                    CORS通信与AJAX没有任何差别，因此你不需要改变以前的业务逻辑。只不过，浏览器会在请求中携带一些头信息，我们需要以此判断是否允许其跨域，然后在响应头中加入一些信息即可。这一般通过过滤器完成即可。
                                </p>
                                <p><strong>原理</strong></p>
                                <p>预检请求</p>
                                <p>跨域请求会在正式通信之前，增加一次HTTP查询请求，称为&quot;预检&quot;请求（preflight）。</p>
                                <p>浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的XMLHttpRequest请求，否则就报错。
                                </p>
                                <p>一个“预检”请求的样板：</p>
                                <p>OPTIONS /cors HTTP/1.1</p>
                                <p>Origin: <a target="_blank" rel="noopener"
                                        href="http://localhost:1000">http://localhost:1000</a></p>
                                <p>Access-Control-Request-Method: GET</p>
                                <p>Access-Control-Request-Headers: X-Custom-Header</p>
                                <p>User-Agent: Mozilla/5.0...</p>
                                <p>●Origin：会指出当前请求属于哪个域（协议+域名+端口）。服务会根据这个值决定是否允许其跨域。</p>
                                <p>●Access-Control-Request-Method：接下来会用到的请求方式，比如PUT</p>
                                <p>●Access-Control-Request-Headers：会额外用到的头信息</p>
                                <p>预检请求的响应</p>
                                <p>服务的收到预检请求，如果许可跨域，会发出响应：</p>
                                <p>HTTP/1.1 200 OK</p>
                                <p>Date: Mon, 01 Dec 2008 01:15:39 GMT</p>
                                <p>Server: Apache/2.0.61 (Unix)</p>
                                <p>Access-Control-Allow-Origin: <a target="_blank" rel="noopener"
                                        href="http://miaosha.jd.com/">http://miaosha.jd.com</a></p>
                                <p>Access-Control-Allow-Credentials: true</p>
                                <p>Access-Control-Allow-Methods: GET, POST, PUT</p>
                                <p>Access-Control-Allow-Headers: X-Custom-Header</p>
                                <p>Access-Control-Max-Age: 1728000</p>
                                <p>Content-Type: text/html; charset=utf-8</p>
                                <p>Content-Encoding: gzip</p>
                                <p>Content-Length: 0</p>
                                <p>Keep-Alive: timeout=2, max=100</p>
                                <p>Connection: Keep-Alive</p>
                                <p>Content-Type: text/plain</p>
                                <p>如果服务器允许跨域，需要在返回的响应头中携带下面信息：</p>
                                <p>●Access-Control-Allow-Origin：可接受的域，是一个具体域名或者*（代表任意域名）</p>
                                <p>●Access-Control-Allow-Credentials：是否允许携带cookie，默认情况下，cors不会携带cookie，除非这个值是true</p>
                                <p>●Access-Control-Allow-Methods：允许访问的方式</p>
                                <p>●Access-Control-Allow-Headers：允许携带的头</p>
                                <p>●Access-Control-Max-Age：本次许可的有效时长，单位是秒，过期之前的ajax请求就无需再次进行预检了</p>
                                <p>有关cookie：</p>
                                <p>要想操作cookie，需要满足3个条件：</p>
                                <p>●服务的响应头中需要携带Access-Control-Allow-Credentials并且为true。</p>
                                <p>●浏览器发起ajax需要指定withCredentials 为true</p>
                                <p>●响应头中的Access-Control-Allow-Origin一定不能为*，必须是指定的域名</p>
                                <p><strong>实现方式</strong></p>
                                <p>虽然原理比较复杂，但是前面说过：</p>
                                <p>●浏览器端都有浏览器自动完成，我们无需操心</p>
                                <p>●服务端可以通过拦截器统一实现，不必每次都去进行跨域判定的编写。</p>
                                <p>事实上，Spring已经帮我们写好了CORS的跨域过滤器，内部已经实现了刚才所讲的判定逻辑。</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">spring-webmvc：CorsFilter</span><br><span class="line">spring-webflux：CorsWebFilter</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>springcloud-gateway集成的是webflux，所以这里使用的是CorsWebFilter<br />
                                    在gmall-gateway中编写一个配置类，并且注册CorsWebFilter：<br />
                                    Plain Text</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">@Configuration</span><br><span class="line">public class CorsConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public CorsWebFilter corsWebFilter() &#123;</span><br><span class="line">        &#x2F;&#x2F; 初始化CORS配置对象</span><br><span class="line">        CorsConfiguration config &#x3D; new CorsConfiguration();</span><br><span class="line">        &#x2F;&#x2F; 允许的域,不要写*，否则cookie就无法使用了</span><br><span class="line">        config.addAllowedOrigin(&quot;http:&#x2F;&#x2F;manager.gmall.com&quot;);</span><br><span class="line">        config.addAllowedOrigin(&quot;http:&#x2F;&#x2F;www.gmall.com&quot;);</span><br><span class="line">        &#x2F;&#x2F; 允许的头信息</span><br><span class="line">        config.addAllowedHeader(&quot;*&quot;);</span><br><span class="line">        &#x2F;&#x2F; 允许的请求方式</span><br><span class="line">        config.addAllowedMethod(&quot;*&quot;);</span><br><span class="line">        &#x2F;&#x2F; 是否允许携带Cookie信息</span><br><span class="line">        config.setAllowCredentials(true);</span><br><span class="line">        &#x2F;&#x2F; 添加映射路径，我们拦截一切请求</span><br><span class="line">        UrlBasedCorsConfigurationSource corsConfigurationSource &#x3D; new UrlBasedCorsConfigurationSource();</span><br><span class="line">        corsConfigurationSource.registerCorsConfiguration(&quot;&#x2F;**&quot;, config);</span><br><span class="line">        return new CorsWebFilter(corsConfigurationSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h1 id="%E5%9B%9B%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%84%E4%BB%B6">四、分布式组件</h1>
                                <h2 id="springcloud-alibaba" id="SpringCloud-Alibaba"><a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/spring-cloud-alibaba/blob/2.2.x/README-zh.md">SpringCloud
                                        Alibaba</a></h2>
                                <p>请查看cloud笔记或官方文档或<a target="_blank" rel="noopener"
                                        href="https://www.springcloud.cc/">中文文档</a></p>
                                <p><strong>SpringClouid的几大痛点：</strong></p>
                                <p>SpringCloud部分组件停止维护和更新，给开发带来不便;</p>
                                <p>SpringCloud部分环境搭建复杂，没有完善的可视化界面，我们需要大量的二次开发和定制</p>
                                <p>SpringCloud配置复杂，难以上手，部分配置差别难以区分和合理应用</p>
                                <p><strong>SpringCloud Alibaba的优势：</strong></p>
                                <p>阿里使用过的组件经历了考验，性能强悍，设计合理，现在开源出来大家用</p>
                                <p>成套的产品搭配完善的可视化界面给开发运维带来极大的便利</p>
                                <p>搭建简单，学习曲线低。</p>
                                <h2 id="%E6%8A%80%E6%9C%AF%E6%90%AD%E9%85%8D%E6%96%B9%E6%A1%88" id="技术搭配方案">
                                    <strong>技术搭配方案</strong></h2>
                                <h3 id="springcloud-alibaba-1" id="SpringCloud-Alibaba-v2"><strong>SpringCloud
                                        Alibaba</strong></h3>
                                <p>Nacos : 注册中心 (服务发现/注册)</p>
                                <p>Nacos: 配置中心 (动态配置管理)</p>
                                <p>Sentinel: 服务容错(限流、降级、熔断)</p>
                                <p>Seata: 原Fescar, 即分布式事务解决方案</p>
                                <h3 id="springcloud" id="SpringCloud"><strong>SpringCloud</strong></h3>
                                <p>Ribbon: 负载均衡</p>
                                <p>Feign: 声明式HTTP客户端(调用远程服务)</p>
                                <p>Gateway: API 网关 (webflux 编程模式)</p>
                                <p>Sleuth:调用链监控</p>
                                <h2 id="%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84" id="项目架构">项目架构</h2>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220510131550076.png"
                                        alt="image-20220510131550076" /></p>
                                <h3 id="%E7%BB%84%E4%BB%B6%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" id="组件技术方案">组件技术方案</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220510132138533.png"
                                        alt="image-20220510132138533" /></p>
                                <h2 id="nacos%E3%80%90%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E3%80%91" id="Nacos【注册中心】"><a
                                        target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/spring-cloud-alibaba/blob/2.2.x/spring-cloud-alibaba-examples/nacos-example/nacos-discovery-example/readme-zh.md">Nacos【注册中心】</a>
                                </h2>
                                <p>注册中心【服务发现/注册】</p>
                                <h3 id="1.%E5%85%AC%E5%85%B1%E4%BE%9D%E8%B5%96%E5%BC%95%E8%BF%9B" id="1-公共依赖引进">1.公共依赖引进
                                </h3>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="2.%E4%B8%8B%E8%BD%BDnacos-server" id="2-下载Nacos-Server">2.下载Nacos Server</h3>
                                <h3 id="releases-%C2%B7-alibaba%2Fnacos-(github.com)%E5%B9%B6%E7%82%B9%E5%87%BB%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%8B%E7%9A%84startup.bat%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%2C%E5%90%AF%E5%8A%A8%E4%B8%8D%E4%BA%86%E5%8F%AF%E8%83%BD%E6%9C%AA%E9%85%8Djava_home%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"
                                    id="Releases-·-alibaba-nacos-github-com-并点击文件夹下的startup-bat启动服务-启动不了可能未配JAVA-HOME环境变量">
                                    <a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/nacos/releases">Releases · alibaba/nacos
                                        (github.com)</a>并点击文件夹下的startup.bat启动服务,启动不了可能未配JAVA_HOME环境变量</h3>
                                <h3 id="3.%E9%85%8D%E7%BD%AE" id="3-配置">3.配置</h3>
                                <h4 id="1%E3%80%81%E9%A6%96%E5%85%88%EF%BC%8C%E4%BF%AE%E6%94%B9-pom.xml-%E6%96%87%E4%BB%B6%EF%BC%8C%E5%BC%95%E5%85%A5-nacos-discovery-starter"
                                    id="1、首先，修改-pom-xml-文件，引入-Nacos-Discovery-Starter">1、首先，修改 pom.xml 文件，引入 Nacos
                                    Discovery Starter</h4>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2%E3%80%81%E5%9C%A8%E5%BA%94%E7%94%A8%E7%9A%84-%2Fresource-%2Fapplication.properties-%E4%B8%AD%E9%85%8D%E7%BD%AE-nacos-server%E5%9C%B0%E5%9D%80"
                                    id="2、在应用的-resource-application-properties-中配置-Nacos-Server地址">2、在应用的 /resource
                                    /application.properties 中配置 Nacos Server地址</h4>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">spring.cloud.nacos.discovery.server-addr&#x3D;127.0.0.1:8848</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="4.%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3%E5%BC%80%E5%90%AF%E6%9C%8D%E5%8A%A1%E4%B8%8E%E6%B3%A8%E8%A7%A3%E5%8A%9F%E8%83%BD"
                                    id="4-启动类添加注解开启服务与注解功能">4.启动类添加注解开启服务与注解功能</h3>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">@EnableDiscoveryClient</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="5.%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%9D%97%E5%90%8D" id="5-配置模块名">5.配置模块名</h3>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">spring.application.name&#x3D;service-provider</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="6.%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%9D%97%E8%AE%BF%E9%97%AE" id="6-启动模块访问">6.启动模块访问
                                </h3>
                                <p><a target="_blank" rel="noopener"
                                        href="http://localhost:8848/nacos/#/login">Nacos</a></p>
                                <h2 id="nacos%E3%80%90%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E3%80%91" id="Nacos【配置中心】">
                                    Nacos【配置中心】</h2>
                                <h4 id="1%E3%80%81pom.xml-%E5%BC%95%E5%85%A5-nacos-config-starter"
                                    id="1、pom-xml-引入-Nacos-Config-Starter">1、pom.xml 引入 Nacos Config Starter</h4>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">  <span class="comment">&lt;!--配置中心来做配置管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="5.3.2%E3%80%81%E5%9C%A8%E5%BA%94%E7%94%A8%E7%9A%84-resource-%E4%B8%8B-bootstrap.properties"
                                    id="5-3-2、在应用的-resource-下-bootstrap-properties">5.3.2、在应用的 resource 下
                                    bootstrap.properties</h4>
                                <figure class="highlight properties">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">gulimall-coupon</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="5.3.3%E3%80%81%E5%9C%A8-nacos-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"
                                    id="5-3-3、在-nacos-中添加配置">5.3.3、在 nacos 中添加配置</h4>
                                <p>选择右上角添加配置</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512152022866.png"
                                        alt="image-20220512152022866" /></p>
                                <p>Data ID 改成 gulimall-coupon.properties 默认规则 用户名.应用名.properties</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512152043662.png"
                                        alt="image-20220512152043662" /></p>
                                <h4 id="5.3.4%E3%80%81%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%40value-%E5%92%8C-%40refreshscope"
                                    id="5-3-4、在应用中使用-Value-和-RefreshScope">5.3.4、在应用中使用@Value 和 @RefreshScope</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">// 刷新对应controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;coupon/coupon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CouponController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CouponService couponService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;coupon.user.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;coupon.user.age&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;name&quot;</span>,name).put(<span class="string">&quot;age&quot;</span>,age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="5.3.5%E3%80%81%E8%BF%9B%E9%98%B6" id="5-3-5、进阶">5.3.5、进阶</h4>
                                <blockquote>
                                    <p>1、核心概念</p>
                                </blockquote>
                                <p><strong>命名空间:</strong><br />
                                    用于进行租户粒度的配置隔离。不同的命名空间下，可以存在相同的 <strong>Group</strong> 或 <strong>DatalD</strong>
                                    的配置。<strong>Namespace</strong> 的常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源(如配置、服务)隔离等。</p>
                                <p><strong>配置集</strong></p>
                                <p><strong>一组相关或者不相关的配置项的集合称为配置集</strong>。在系统中，一个配置文件通常就是一个配置集，包含了系统各个方面的配置。例如，一个配置集可能包含了数据源、线程池、日志级别等配置项。
                                </p>
                                <p><strong>配置集ID:</strong></p>
                                <p>Nacos 中的某个配置集的 ID，配置集 ID 是组织划分配置的维度之一，<strong>Data ID</strong>
                                    通常用于组织划分系统的配置集，一个系统或者应用可以包含多个配置集，一个系统应用可以包含多个配置集，每个配置集都可以被一个有意义的名称标识，Data ID 通常采用类
                                    Java 包 如 ( com.taobao.tc.refund.log.level ) 的命名规则保证全局唯一性，此命名规则非强制</p>
                                <p><strong>配置分组：</strong></p>
                                <p>Nacos 中的一组配置集，是组织配置的维度之一，通过一个有意义的字符串，(如 Buy 或 Trade ) 对配置集进行分组，从而区分 Data ID
                                    相同的配置集，当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用，DEFAULT_GROUP
                                    配置分组的常见场景，不同的应用或组件采用了相同的配置类型，如 database_url 配置和 MQ_topic 配置</p>
                                <p><strong>bootstrap.properties 配置</strong></p>
                                <figure class="highlight properties">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">gulimall-coupon # 服务的名称</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848  # 服务注册地址</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.namespace</span>=<span class="string">ae34901c-9215-4409-ae61-c6b8d6c8f9b0  # 命名空间地址</span></span><br><span class="line"><span class="comment">#spring.cloud.nacos.config.group=111 # 对应分组</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.ext-config[0].data-id</span>=<span class="string">datasource.yml  # 配置集指定data_id</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.ext-config[0].group</span>=<span class="string">dev               # 配置集指定 group 分组</span></span><br><span class="line"><span class="meta">spring.cloud.nacos.config.ext-config[0].refresh</span>=<span class="string">true            # 是否动态刷新 在配置中心修改后 微服务自动刷新</span></span><br><span class="line"></span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>相关解释</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、如何使用 Nacos作为配置中心统一管理配置</span></span><br><span class="line"><span class="comment"> *  1.1 引入依赖</span></span><br><span class="line"><span class="comment"> *     &lt;dependency&gt;</span></span><br><span class="line"><span class="comment"> *             &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment"> *             &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment"> *      &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment"> *  1.2 创建一个bootstrap.properties</span></span><br><span class="line"><span class="comment"> *      spring.application.name=gulimall-coupon</span></span><br><span class="line"><span class="comment"> *      spring.cloud.nacos.config.server-addr=127.0.0.1:8848</span></span><br><span class="line"><span class="comment"> *  1.3 需要给配置中心默认添加一个叫 数据集 (Data Id) gulimall-coupon.properties 默认规则 用户名.应用名.properties</span></span><br><span class="line"><span class="comment"> *  1.4 给 应用名.properties 添加任何配置</span></span><br><span class="line"><span class="comment"> *  1.5 动态获取配置</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@RefreshScope</span>: 动态获取并刷新配置</span></span><br><span class="line"><span class="comment"> *      <span class="doctag">@Value</span>$(&quot;$&#123;配置项的名字&#125;&quot;)</span></span><br><span class="line"><span class="comment"> * 如果配置中心和当前应用的配置文件中都配置了相同的配置文件，优先使用配置中心的文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2、细节</span></span><br><span class="line"><span class="comment"> *      1、命名空间：配置隔离：</span></span><br><span class="line"><span class="comment"> *          默认：public(保留空间)；默认新增的所有配置都在 public 空间</span></span><br><span class="line"><span class="comment"> *          1、开发 测试 生产 利用命名空间来做环境隔离</span></span><br><span class="line"><span class="comment"> *          注意: 在bootstrap.properties配置上 需要使用哪个命名空间下的配置</span></span><br><span class="line"><span class="comment"> *              spring.cloud.nacos.config.namespace=b1e89ce0-784f-4a80-9de0-e9b080eeaca5</span></span><br><span class="line"><span class="comment"> *          2、每一个微服务之间互相隔离配置，每一个微服务都创建自己的命名空间，只加载自己命名空间下的所有配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      2、配置集：所有配置的集合</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      3、配置集ID：类似文件名</span></span><br><span class="line"><span class="comment"> *          Data ID：类型文件名</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      4、配置分组：</span></span><br><span class="line"><span class="comment"> *      默认所有的配置都属于 DEFAULT_GROUP</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 每个微服务创建自己的命名空间，使用配置分组区分环境，dev、test、prod</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3、同时加载多个配置集</span></span><br><span class="line"><span class="comment"> *      1、微服务任何配置信息，任何配置文件多可以放在配置中心中</span></span><br><span class="line"><span class="comment"> *      2、只要在 bootstrap.properties 说明加载配置中心中哪些配置文件即可</span></span><br><span class="line"><span class="comment"> *      3、<span class="doctag">@Value</span>，<span class="doctag">@ConfigurationProperties</span>...</span></span><br><span class="line"><span class="comment"> *      以前SpringBoot的任何方式从配置文件中获取值，都能使用</span></span><br><span class="line"><span class="comment"> *      配置中心有的优先使用配置中心的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-10-16</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="sentinel" id="Sentinel">Sentinel</h2>
                                <h3 id="1%E3%80%81%E7%AE%80%E4%BB%8B" id="1、简介">1、简介</h3>
                                <h4 id="1%E3%80%81%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E9%99%90%E6%B5%81" id="1、服务降级限流">
                                    1、服务降级限流</h4>
                                <p><strong>什么是熔断：</strong></p>
                                <p>​ A 服务调用 B 服务的某个功能，由于网络不稳定问题，或者 B 服务卡机，导致功能时间超长，如果这样子的次数太多，我们可以直接将 B 断路了，（A 不在请求 B
                                    接口）凡是调用 B 服务的直接返回降级数据，不必等待 B 的 超时执行，这样 B 的故障问题，就不会级联影响到 A。</p>
                                <p><strong>什么是降级：</strong></p>
                                <p>​ 整个网站处于流量高峰期服务器压力剧增，根据当前自身业务情况以及流量，对一些服务和页面进行有策略的降级/停止服务，所有的调用直接返回降级数据以此缓解服务器资源的压力，以保证核心业务的正常运行，同时也保持了客户和大部分客户等到正确的响应
                                </p>
                                <p>异同：</p>
                                <p>​ 相同点</p>
                                <p>​ 1、为了保证集群大部分服务的可用性和可靠性，防止崩溃，牺牲小我</p>
                                <p>​ 2、用户最终都是体验到某个功能不可用</p>
                                <p>​ 不同点：</p>
                                <p>​ 1、熔断是被调用方的故障，触发系统的主动规则</p>
                                <p>​ 2、降级是基于全局的考虑停止一些正常服务，释放资源</p>
                                <p>什么是限流</p>
                                <p>​ 对打入的服务的请求流量进行控制，使服务能够承担不超过自己能力的流量压力</p>
                                <h4 id="2%E3%80%81sentinel-%E7%AE%80%E4%BB%8B" id="2、Sentinel-简介">2、Sentinel 简介</h4>
                                <p>官方文档：<a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">https://github.com/alibaba/Sentinel/wiki/介绍</a>
                                </p>
                                <p>项目文档：<a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a>
                                </p>
                                <p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p>
                                <p><strong>Sentinel 具有以下特征:</strong></p>
                                <ul>
                                    <li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10
                                        年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li>
                                    <li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500
                                        台以下规模的集群的汇总运行情况。</li>
                                    <li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring
                                        Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>
                                    <li><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI
                                        扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li>
                                </ul>
                                <p>Sentinel 的主要特性：</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201125115407751.png"
                                        alt="image-20201125115407751" /></p>
                                <p><strong>Sentinel 分为两个部分:</strong></p>
                                <ul>
                                    <li>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。
                                    </li>
                                    <li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li>
                                </ul>
                                <p><strong>Sentinel 基本概念:</strong></p>
                                <ul>
                                    <li>资源
                                        <ul>
                                            <li>资源是 Sentinel 的关键概念。它可以是 Java
                                                应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，甚至可以是一段代码。在接下来的文档中，我们都会用资源来描述代码块。
                                            </li>
                                            <li><strong>只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel
                                                    保护起来</strong>。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</li>
                                        </ul>
                                    </li>
                                    <li>规则
                                        <ul>
                                            <li>围绕资源的实时状态设定的规则，可以包括<strong>流量控制规则、熔断降级规则以及系统保护规则。所有规则可以动态实时调整。</strong>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                                <h3 id="2%E3%80%81hystrix-%E4%B8%8E-sentinel-%E6%AF%94%E8%BE%83"
                                    id="2、Hystrix-与-Sentinel-比较">2、Hystrix 与 Sentinel 比较</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201125120634969.png"
                                        alt="image-20201125120634969" /></p>
                                <h3 id="3%E3%80%81%E6%95%B4%E5%90%88-feign-%E5%92%8C-sentinel-%E6%B5%8B%E8%AF%95%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"
                                    id="3、整合-Feign-和-Sentinel-测试熔断降级">3、整合 Feign 和 Sentinel 测试熔断降级</h3>
                                <p>熔断降级官网解释：<a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7">https://github.com/alibaba/Sentinel/wiki/熔断降级</a>
                                </p>
                                <p>Spring- Cloud整合Sentinel和Feign：<a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel">https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel</a>
                                </p>
                                <p>pom.xml</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">&lt;!-- 导入sentinel依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--导入openFeign --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>application.properties</p>
                                <figure class="highlight properties">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">## sentinel与项目间的通信端口</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.transport.port</span>=<span class="string">8719</span></span><br><span class="line"><span class="comment">## sentinel端口设置</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.transport.dashboard</span>=<span class="string">localhost:8333</span></span><br><span class="line"><span class="comment">## 暴露信息</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.exclude</span>=<span class="string">*</span></span><br><span class="line"><span class="comment">## 配置文件打开 Sentinel 对 Feign 的支持</span></span><br><span class="line"><span class="meta">feign.sentinel.enabled</span>=<span class="string">true</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>开启后，在微服务中调用远程服务，Sentinel 就会记录微服务之间的调用，从而对远程调用进行设置熔断降级等。</p>
                                <p>请求设置</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201126154714221.png"
                                        alt="image-20201126154714221" /></p>
                                <p>设置流控规则</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201126165501709.png"
                                        alt="image-20201126165501709" /></p>
                                <p>Feign设置</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201126165336761.png"
                                        alt="image-20201126165336761" /></p>
                                <p>结果</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201126164858768.png"
                                        alt="image-20201126164858768" /></p>
                                <h3 id="4%E3%80%81%E6%95%B4%E5%90%88-sentinel-%E6%B5%8B%E8%AF%95%E9%99%90%E6%B5%81"
                                    id="4、整合-Sentinel-测试限流">4、整合 Sentinel 测试限流</h3>
                                <p>官网Spring-Cloud 整合：<a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel">https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel</a>
                                </p>
                                <p>Pom.xml</p>
                                <blockquote>
                                    <p>参考 3、整合 Feign 和 Sentinel 测试熔断降级</p>
                                </blockquote>
                                <p>控制台：</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201126161848389.png"
                                        alt="" /></p>
                                <p>超过单继阈值，返回自定义请求结果</p>
                                <p>实现方式：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  		1、代码</span></span><br><span class="line"><span class="comment"> *      	try (Entry entry = SphU.entry(&quot;resourceName&quot;)) &#123;</span></span><br><span class="line"><span class="comment"> *      	&#125;(BlockedException e)&#123;&#125;</span></span><br><span class="line"><span class="comment"> *      2、基于注解</span></span><br><span class="line"><span class="comment"> *       	<span class="doctag">@SentinelResource</span>(value = &quot;getCurrentSeckillSkusSource&quot;,blockHandler = &quot;BlockHandler&quot;)</span></span><br><span class="line"><span class="comment"> *       	无论1/2方式一定要配置限流以后的默认返回</span></span><br><span class="line"><span class="comment"> *       	url可以设置统一返回</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>具体实现方式参考官网给出文档：<a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8">https://github.com/alibaba/Sentinel/wiki/如何使用</a>
                                </p>
                                <h3 id="5%E3%80%81sentinel%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81" id="5、Sentinel网关限流">
                                    5、Sentinel网关限流</h3>
                                <p>官网文档：<a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/Sentinel/wiki/%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81">https://github.com/alibaba/Sentinel/wiki/网关限流</a>
                                </p>
                                <p>pom.xml</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinel-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>启动Sentinle1.7.1 后比原先的1.6.1多个一个功能</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201127102052864.png"
                                        alt="image-20201127102052864" /></p>
                                <p>您可以在 <code>GatewayCallbackManager</code> 注册回调进行定制：</p>
                                <ul>
                                    <li><code>setBlockHandler</code>：注册函数用于实现自定义的逻辑处理被限流的请求，对应接口为
                                        <code>BlockRequestHandler</code>。默认实现为
                                        <code>DefaultBlockRequestHandler</code>，当被限流时会返回类似于下面的错误信息：<code>Blocked by Sentinel: FlowException</code>。
                                    </li>
                                </ul>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentinelGatewayConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SentinelGatewayConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        GatewayCallbackManager.setBlockHandler(<span class="keyword">new</span> BlockRequestHandler() &#123;</span><br><span class="line">            <span class="comment">// 网关限流了 就会回调</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">handleRequest</span><span class="params">(ServerWebExchange serverWebExchange, Throwable throwable)</span> </span>&#123;</span><br><span class="line">                R error = R.error(BizCodeEnume.TO_MANY_REQUEST.getCode(), BizCodeEnume.TO_MANY_REQUEST.getMsg());</span><br><span class="line">                String errorJson = JSON.toJSONString(error);</span><br><span class="line">                Mono&lt;ServerResponse&gt; body = ServerResponse.ok().body(Mono.just(errorJson), String.class);</span><br><span class="line">                <span class="keyword">return</span> body;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="seata" id="Seata">Seata</h2>
                                <h4 id="1%E3%80%81%E7%AE%80%E4%BB%8B-1" id="1、简介-v2">1、简介</h4>
                                <p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA
                                    事务模式，为用户打造一站式的分布式解决方案。</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://seata.io/zh-cn/index.html">https://seata.io/zh-cn/index.html</a>
                                </p>
                                <h3 id="2%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" id="2、核心概念">2、核心概念</h3>
                                <p><strong>TC (Transaction Coordinator) - 事务协调者</strong></p>
                                <p>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
                                <p><strong>TM (Transaction Manager) - 事务管理器</strong></p>
                                <p>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
                                <p><strong>RM (Resource Manager) - 资源管理器</strong></p>
                                <p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
                                <h2 id="oss" id="OSS">OSS</h2>
                                <h3 id="5.6.1%E3%80%81%E7%AE%80%E4%BB%8B" id="5-6-1、简介">5.6.1、简介</h3>
                                <p>对象存储服务 阿里云对象存储服务（Object Storage Service，简称
                                    OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。您可以在任何应用、任何时间、任何地点存储和访问任意类型的数据。</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512152840054.png"
                                        alt="image-20220512152840054" /></p>
                                <h3 id="5.6.2%E3%80%81%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4" id="5-6-2、使用步骤">5.6.2、使用步骤
                                </h3>
                                <p>使用 Java 上传文件</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://help.aliyun.com/document_detail/32011.html?spm=a2c4g.11186623.6.915.56196d39rr96Ll">https://help.aliyun.com/document_detail/32011.html?spm=a2c4g.11186623.6.915.56196d39rr96Ll</a>
                                </p>
                                <p>来自官网实例 - 上传文件流</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpload</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">      <span class="comment">// Endpoint以杭州为例，其它Region请按实际情况填写。</span></span><br><span class="line">      String endpoint = <span class="string">&quot;http://oss-cn-hangzhou.aliyuncs.com&quot;</span>;</span><br><span class="line">          <span class="comment">// 云账号AccessKey有所有API访问权限，建议遵循阿里云安全最佳实践，创建并使用RAM子账号进行API访问或日常运维，请登录 //https://ram.console.aliyun.com 创建。</span></span><br><span class="line">      String accessKeyId = <span class="string">&quot;&lt;yourAccessKeyId&gt;&quot;</span>;</span><br><span class="line">      String accessKeySecret = <span class="string">&quot;&lt;yourAccessKeySecret&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">      OSS ossClient = <span class="keyword">new</span> OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 上传文件流。</span></span><br><span class="line">      InputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;&lt;yourlocalFile&gt;&quot;</span>);</span><br><span class="line">      ossClient.putObject(<span class="string">&quot;&lt;yourBucketName&gt;&quot;</span>, <span class="string">&quot;&lt;yourObjectName&gt;&quot;</span>, inputStream);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 关闭OSSClient。</span></span><br><span class="line">      ossClient.shutdown();</span><br><span class="line">      System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>需要填写 AccesskeyId 以及 Secret 同时也要指定文件位置 以及文件名字</p>
                                <p>最终上传结果</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512152930694.png"
                                        alt="image-20220512152930694" /></p>
                                <h3 id="5.6.3%E3%80%81-%E6%8A%BD%E5%8F%96%E6%88%90%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%EF%BC%9Foss"
                                    id="5-6-3、-抽取成一个单独的第三方服务？OSS">5.6.3、 抽取成一个单独的第三方服务？OSS</h3>
                                <p>官网文档</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://github.com/alibaba/aliyun-spring-boot/blob/master/aliyun-spring-boot-samples/aliyun-oss-spring-boot-sample/README-zh.md">https://github.com/alibaba/aliyun-spring-boot/blob/master/aliyun-spring-boot-samples/aliyun-oss-spring-boot-sample/README-zh.md</a>
                                </p>
                                <p>新建项目 gulimall-third-party</p>
                                <p>pom 配置</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alicloud-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- springCloudAlibaba --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>application.yml 配置 <strong>accessKey、secretKey、endpoint</strong></p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">alicloud:</span></span><br><span class="line">      <span class="attr">access-key:</span> <span class="string">LTAI4GE22ckocpNBfd36zkxJ</span> </span><br><span class="line">      <span class="attr">secret-key:</span> <span class="string">qDFrQ6cxZqc4DwxoWx5K2aosXXj0Go</span></span><br><span class="line">      <span class="attr">oss:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">oss-cn-shenzhen.aliyuncs.com</span>  <span class="comment">## 地域节点</span></span><br><span class="line">        <span class="attr">bucket:</span> <span class="string">gulimall-oss01</span> <span class="comment"># 桶列表</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gulimall-third-party</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">30000</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="5.6.4%E3%80%81web%E7%AB%AF%E4%B8%8A%E4%BC%A0%E4%BB%8B%E7%BB%8D"
                                    id="5-6-4、Web端上传介绍">5.6.4、Web端上传介绍</h3>
                                <blockquote>
                                    <p>阿里云对象存储-普通上传方式：</p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512152947516.png"
                                        alt="image-20220512152947516" /></p>
                                <p>用户提交文件到服务器，服务器将文件提交到 OSS 对象存储</p>
                                <p>和数据直传到OSS相比，以上方法有三个缺点：</p>
                                <ul>
                                    <li>上传慢：用户数据需先上传到应用服务器，之后再上传到OSS。网络传输时间比直传到OSS多一倍。如果用户数据不通过应用服务器中转，而是直传到OSS，速度将大大提升。而且OSS采用BGP带宽，能保证各地各运营商之间的传输速度。
                                    </li>
                                    <li>扩展性差：如果后续用户多了，应用服务器会成为瓶颈。</li>
                                    <li>费用高：需要准备多台应用服务器。由于OSS上传流量是免费的，如果数据直传到OSS，不通过应用服务器，那么将能省下几台应用服务器。</li>
                                </ul>
                                <blockquote>
                                    <p>阿里云对象存储-服务端签名后直传：</p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201019203744740.png"
                                        alt="image-20201019203744740" /></p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://help.aliyun.com/document_detail/31926.html">流程介绍</a></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/p139016.png" alt="时序图" /></p>
                                <p><strong>背景</strong></p>
                                <p>采用JavaScript客户端直接签名（参见<a target="_blank" rel="noopener"
                                        href="https://help.aliyun.com/document_detail/31925.html?spm=a2c4g.11186623.2.11.26386e28XWAM19#concept-frd-4gy-5db">JavaScript客户端签名直传</a>）时，AccessKey
                                    ID和AcessKey Secret会暴露在前端页面，因此存在严重的安全隐患。因此，OSS提供了服务端签名后直传的方案。</p>
                                <p>Web端向服务端请求签名，然后直接上传，不会对服务端产生压力，而且安全可靠。服务端签后直传</p>
                                <h2 id="openfeign" id="OpenFeign">OpenFeign</h2>
                                <h3 id="%E7%AE%80%E4%BB%8B" id="简介"><a target="_blank" rel="noopener"
                                        href="https://www.springcloud.cc/spring-cloud-greenwich.html#_spring_cloud_openfeign">简介</a>
                                </h3>
                                <p>Feign 是一个声明式的 HTTP 客户端，他的目的就是让远程调用更加简单，Feign提供了
                                    HTTP请求的模板，<strong>通过编写简单的接口和插入注解</strong>，就可以定义好的 HTTP 请求参数、格式、地址等信息</p>
                                <p>Feign 整合了 <strong>Ribbon（负载均衡</strong>）和
                                    <strong>Hystrix（服务熔断</strong>），可以让我们不再需要显示地使用这两个组件</p>
                                <p>SpringCloud - Feign，在 NetflixFeign 的基础上扩展了对 SpringMVC
                                    注解的支持，在其实现下，我们只需创建一个接口并用注解的方式来配置它，即可完成对服务提供方的接口绑定。简化了 SpringCloud - Ribbon
                                    自行封装服务调用客户端的开发量。</p>
                                <h3 id="1.%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96" id="1-引入依赖">1.引入依赖</h3>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="2.%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3" id="2-创建服务接口">2.创建服务接口
                                </h3>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@FeignClient(&quot;gulimall-coupon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CouponFeignService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/coupon/coupon/member/list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">membercoupons</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="3.%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8A%9F%E8%83%BD"
                                    id="3-开启远程调用功能">3.开启远程调用功能</h3>
                                <p>客户端主启动类注解开启远程调用功能，调用接口使用服务</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">@EnableFeignClients(basePackages &#x3D; &quot;com.atguigu.gulimall.member.feign&quot;)</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="gateway" id="Gateway">Gateway</h2>
                                <h3 id="%E7%AE%80%E4%BB%8B-1" id="简介-v2">简介</h3>
                                <p>网关作为流浪入口，常用功能包括路由转发，权限效验，限流控制等，而 SpringCloud GateWay作为 SpringCloud 官方推出的第二代网关框架，取代了
                                    Zull 网关</p>
                                <p>网上测试 三种网关对应请求数</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512153202454.png"
                                        alt="image-20220512153202454" /></p>
                                <p>网关提供 API 全托管服务，丰富的 API 管理功能，辅助企业管理大规模的
                                    API，以降低管理成本和安全风险、包括协议适配、协议转发、安全策略、防刷、流量、监控日志等功能</p>
                                <p>Spring Cloud GateWay 旨在提供一种简单有效的方式来对 API 进行路由，并为他们提供切面，列如、安全性、监控/指标 和弹性等</p>
                                <h2 id="sleuth%2Bzipkin-%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"
                                    id="Sleuth-Zipkin-服务链路追踪">Sleuth+Zipkin 服务链路追踪</h2>
                                <h3 id="%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8" id="为什么用">为什么用</h3>
                                <p>微服务架构是一个分布式架构，它按业务划分服务单元，一个分布式系统往往有很多个服务单元。由于服务单元数量众多，业务的复杂性，如果出现了错误和异常，很难去定位。主要体现在，一个请求可能需要调用很多个服务，而内部服务的调用复杂性，决定了问题难以定位。所以微服务架构中，必须实现分布式链路追踪，去跟进一个请
                                    求到底有哪些服务参与，参与的顺序又是怎样的，从而达到每个请求的步骤清晰可见，出了问题，很快定位。</p>
                                <p>链路追踪组件有Google 的Dapper, Twitter 的Zipkin,以及阿里的Eagleeye(鹰眼)等，它们都是非常优秀的链路追踪开源组件。</p>
                                <h1
                                    id="%E4%BA%94%E3%80%81%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">
                                    五、前端开发基础知识</h1>
                                <p>这个等以后深入学习在进行记录~~~~</p>
                                <h2 id="7.1-vscode-%E4%BD%BF%E7%94%A8" id="7-1-VSCode-使用">7.1 VSCode 使用</h2>
                                <p>Get</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&quot;http-get请求&quot;: &#123;</span><br><span class="line">	&quot;prefix&quot;: &quot;httpget&quot;,</span><br><span class="line">	&quot;body&quot;: [</span><br><span class="line">	&quot;this.\\$http(&#123;&quot;,</span><br><span class="line">	&quot;url: this.\\$http.adornUrl(&#39;&#39;),&quot;,</span><br><span class="line">	&quot;method: &#39;get&#39;,&quot;,</span><br><span class="line">	&quot;params: this.\\$http.adornParams(&#123;&#125;)&quot;,</span><br><span class="line">	&quot;&#125;).then((&#123; data &#125;) &#x3D;&gt; &#123;&quot;,</span><br><span class="line">	&quot;&#125;)&quot;],</span><br><span class="line">	&quot;description&quot;: &quot;httpGET请求&quot;</span><br><span class="line">&#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>POST</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&quot;http-post请求&quot;: &#123;</span><br><span class="line">	&quot;prefix&quot;: &quot;httppost&quot;,</span><br><span class="line">	&quot;body&quot;: [</span><br><span class="line">	&quot;this.\\$http(&#123;&quot;,</span><br><span class="line">	&quot;url: this.\\$http.adornUrl(&#39;&#39;),&quot;,</span><br><span class="line">	&quot;method: &#39;post&#39;,&quot;,</span><br><span class="line">	&quot;data: this.\\$http.adornData(data, false)&quot;,</span><br><span class="line">	&quot;&#125;).then((&#123; data &#125;) &#x3D;&gt; &#123; &#125;);&quot; ],</span><br><span class="line">	&quot;description&quot;: &quot;httpPOST请求&quot;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="7.2-es6" id="7-2-ES6">7.2 <a target="_blank" rel="noopener"
                                        href="https://es6.ruanyifeng.com/">ES6</a></h2>
                                <h2 id="7.3-node.js" id="7-3-Node-js">7.3 Node.js</h2>
                                <h2 id="7.4-vue" id="7-4-Vue">7.4 Vue</h2>
                                <h3 id="7.4.5-%E6%95%B4%E5%90%88-element-ui" id="7-4-5-整合-Element-UI">7.4.5 整合 Element
                                    UI</h3>
                                <blockquote>
                                    <p>1、安装</p>
                                </blockquote>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">npm i element-ui -S</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><img src="C:/Users/Administrator/Desktop/docs/%25E8%25B0%25B7%25E7%25B2%2592%25E5%2595%2586%25E5%259F%258E%25E9%25A1%25B9%25E7%259B%25AE%25E7%25AC%2594%25E8%25AE%25B0/%25E5%2588%2586%25E5%25B8%2583%25E5%25BC%258F%25E5%259F%25BA%25E7%25A1%2580%25EF%25BC%2588%25E5%2585%25A8%25E6%25A0%2588%25E5%25BC%2580%25E5%258F%2591%25E7%25AF%2587%25EF%25BC%2589/image/image-20201017104101531.png"
                                        alt="image-20201017104101531" /></p>
                                <blockquote>
                                    <p>2、引入 Element</p>
                                </blockquote>
                                <p>main.js 中引入以下内容</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">import Vue from &#39;vue&#39;;</span><br><span class="line">import ElementUI from &#39;element-ui&#39;;</span><br><span class="line">import &#39;element-ui&#x2F;lib&#x2F;theme-chalk&#x2F;index.css&#39;; &#x2F;&#x2F; 引入静态资源文件</span><br><span class="line">import App from &#39;.&#x2F;App.vue&#39;;</span><br><span class="line"></span><br><span class="line">Vue.use(ElementUI);</span><br><span class="line"></span><br><span class="line">new Vue(&#123;</span><br><span class="line">  el: &#39;#app&#39;,</span><br><span class="line">  render: h &#x3D;&gt; h(App)</span><br><span class="line">&#125;);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="7.5-babel" id="7-5-Babel">7.5 Babel</h3>
                                <h3 id="7.6-webpack" id="7-6-Webpack">7.6 Webpack</h3>
                                <h1
                                    id="%E5%85%AD%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB">
                                    六、商品服务&amp;三级分类</h1>
                                <h2 id="8.1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" id="8-1-基础概念">8.1 基础概念</h2>
                                <h3 id="8.1.1%E3%80%81%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB" id="8-1-1、三级分类">8.1.1、三级分类
                                </h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154227328.png"
                                        alt="image-20220512154227328" /></p>
                                <p>一级分类查出二级分类数据，二级分类中查询出三级分类数据</p>
                                <p><strong>数据库设计</strong></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154240463.png"
                                        alt="image-20220512154240463" /></p>
                                <h3 id="8.1.2%E3%80%81spu-%E5%92%8C-sku" id="8-1-2、SPU-和-SKU">8.1.2、SPU 和 SKU</h3>
                                <p><strong>SPU：Standard Product Unit （标准化产品单元）</strong></p>
                                <p>是商品信息聚合的最小单位，是一组可复用，易检索的标准化信息的组合，该集合描述了一个产品的特性</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020083615056.png"
                                        alt="image-20201020083615056" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020083857519.png"
                                        alt="image-20201020083857519" /></p>
                                <p>IPhoneX 是 SPU,MI8 是 SPU</p>
                                <p>IPhoneX 64G 黑曜石 是 SKU</p>
                                <p>MIX8 + 64G 是 SKU</p>
                                <p><strong>SKU: Stock KeepingUnit (库存量单位)</strong></p>
                                <h3 id="8.1.3%E3%80%81%E5%9F%BA%E6%9C%AC%E5%B1%9E%E6%80%A7-%E3%80%90%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E3%80%91%E4%B8%8E-%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7"
                                    id="8-1-3、基本属性-【规格参数】与-销售属性">8.1.3、基本属性 【规格参数】与 销售属性</h3>
                                <p>每个分共下的商共享规格参数、与销售属性，只是有些商品不一定更用这个分类下全部的属性：</p>
                                <p>属性是以三级分类组织起来的</p>
                                <p>规格参数中有些是可以提供检索的</p>
                                <p>规格参数也是基本属性，他们具有自己的分组</p>
                                <p>属性的分组也是以三级分类组织起来的</p>
                                <p>属性名确定的，但是值是每一个商品不同来决定的</p>
                                <blockquote>
                                    <p>【属性分组-规格参数-销售属性-三级分类】关联关系</p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020150957557.png"
                                        alt="image-20201020150957557" /></p>
                                <p>SPU-SKU-属性表</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020151022330.png"
                                        alt="image-20201020151022330" /></p>
                                <h3 id="8.1.4%E3%80%81%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E4%BD%8D%E7%BD%AE"
                                    id="8-1-4、接口文档位置">8.1.4、接口文档位置</h3>
                                <p><a target="_blank" rel="noopener"
                                        href="https://easydoc.xyz/s/78237135/ZUqEdvA4/hKJTcbfd">https://easydoc.xyz/s/78237135/ZUqEdvA4/hKJTcbfd</a>
                                </p>
                                <h3 id="8.1.5%E3%80%81-object-%E5%88%92%E5%88%86" id="8-1-5、-Object-划分">8.1.5、 Object 划分
                                </h3>
                                <h4 id="vo-%EF%BC%88view-object%EF%BC%89%E8%A7%86%E5%9B%BE%E5%AF%B9%E8%B1%A1"
                                    id="VO-（View-Object）视图对象"><strong>VO （View Object）视图对象</strong></h4>
                                <p>用于展示层，它的作用是把某个指定页面（或组件）的所有数据封装起来。通常用于业务层之间的数据传递，和 PO
                                    一样也是仅仅包含数据而已，但应是抽象出的业务对象，可以和表对应，也可以不，这根据业务的需要，用 new 关键字创建，由 GC 回收</p>
                                <p>view Object 试图对象</p>
                                <p>接受页面传递来的数据，封装对象，封装页面需要用的数据</p>
                                <h4 id="dto%EF%BC%88data-transfer-object%EF%BC%89%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1"
                                    id="DTO（Data-Transfer-Object）数据传输对象"><strong>DTO（Data Transfer
                                        Object）数据传输对象</strong></h4>
                                <p>主要用于展示层与服务层之间的数据传输对象。这个概念来源于 J2EE 的设计模式，原来的目的是为了
                                    EJB的分布式应用提供粗粒度的数据实体，以减少分布式调用的次数，从而提高分数调用的性能和降低网络负载，但在这里，泛指用于展示层与服务层之间的数据传输对象</p>
                                <h4 id="do%EF%BC%88domain-object%EF%BC%89%E9%A2%86%E5%9F%9F%E5%AF%B9%E8%B1%A1"
                                    id="DO（Domain-Object）领域对象"><strong>DO（Domain Object）领域对象</strong></h4>
                                <p>就是从现实世界中抽象出来的有形或无形的业务实体。</p>
                                <h4 id="po%EF%BC%88persistent-object%EF%BC%89%EF%BC%9A%E6%8C%81%E4%B9%85%E5%8C%96%E5%AF%B9%E8%B1%A1"
                                    id="PO（Persistent-Object）：持久化对象"><strong>PO（Persistent Object）：持久化对象</strong></h4>
                                <p>它跟持久层（通常是关系型数据库）的数据结构形成一一对应的映射关系，如果持久层是关系型数据库，那么，数据表中的每个字段就对应PO的一个属性。po
                                    就是对应数据库中某一个表的一条记录，多个记录可以用 PO 的集合，PO 中应该不包含任何对数据库到操作</p>
                                <h4 id="to-(transfer-object)-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1"
                                    id="TO-Transfer-Object-数据传输对象"><strong>TO (Transfer Object) 数据传输对象</strong></h4>
                                <p>不同的应用程序之间传输的对象</p>
                                <h4 id="bo(business-object)-%E4%B8%9A%E5%8A%A1%E5%AF%B9%E8%B1%A1"
                                    id="BO-business-object-业务对象"><strong>BO(business object) 业务对象</strong></h4>
                                <p>从业务模型的角度看，见 UML 原件领域模型中的领域对象，封装业务逻辑的， java 对象，通过调用 DAO 方法，结合 PO VO,进行业务操作，business
                                    object 业务对象，主要作用是把业务逻辑封装成一个对象，这个对象包括一个或多个对象，比如一个简历，有教育经历，工作经历，社会关系等等，我们可以把教育经历对应一个
                                    PO 、工作经验对应一个 PO、 社会关系对应一个 PO, 建立一个对应简历的的 BO 对象处理简历，每 个 BO 包含这些 PO ,这样处理业务逻辑时，我们就可以针对
                                    BO 去处理</p>
                                <h4 id="pojo-(-plain-ordinary-java-object)-%E7%AE%80%E5%8D%95%E6%97%A0%E8%A7%84%E5%88%99-java-%E5%AF%B9%E8%B1%A1"
                                    id="POJO-plain-ordinary-java-object-简单无规则-java-对象"><strong>POJO ( plain ordinary
                                        java object) 简单无规则 java 对象</strong></h4>
                                <p>传统意义的 java 对象，就是说一些 Object/Relation Mapping 工具中，能够做到维护数据库表记录的 persisent object
                                    完全是一个符合 Java Bean 规范的 纯 java 对象，没有增加别的属性和方法，我们的理解就是最基本的 Java bean 只有属性字段 setter 和
                                    getter 方法</p>
                                <p>POJO 时是 DO/DTO/BO/VO 的统称</p>
                                <h4 id="dao%EF%BC%88data-access-object%EF%BC%89-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1"
                                    id="DAO（data-access-object）-数据访问对象"><strong>DAO（data access object） 数据访问对象</strong>
                                </h4>
                                <p>是一个 sun 的一个标准 j2ee 设计模式，这个模式有个接口就是 DAO ，他负持久层的操作，为业务层提供接口，此对象用于访问数据库，通常和 PO 结合使用，DAO
                                    中包含了各种数据库的操作方法，通过它的方法，结合 PO 对数据库进行相关操作，夹在业务逻辑与数据库资源中间，配合VO 提供数据库的 CRUD 功能</p>
                                <h4 id="vo-%E4%B8%8E-dto-%E7%9A%84%E5%8C%BA%E5%88%AB" id="VO-与-DTO-的区别"><strong>VO 与 DTO
                                        的区别</strong></h4>
                                <p>DTO 和 VO 的属性值基本是一致的，而且他们通常都是 POJO【简单的 Java 对象（Plain Old Java Object）】,但两者存在本质上的区别；DTO
                                    代表服务层需要接收的数据和返回的数据，而VO 代表展示层需要显示的数据。</p>
                                <h4 id="dto-%E4%B8%8E-do-%E7%9A%84%E5%8C%BA%E5%88%AB" id="DTO-与-DO-的区别"><strong>DTO 与 DO
                                        的区别</strong></h4>
                                <p>首先是概念上的区别，DTO 是展示层和服务层之间的数据传输对象（可以认为是两者之间的协议），而 DO是对现实世界各种业务角色的抽象，这就引出了两者在数据上的区别。</p>
                                <h4 id="do-%E4%B8%8E-po-%E7%9A%84%E5%8C%BA%E5%88%AB" id="DO-与-PO-的区别"><strong>DO 与 PO
                                        的区别</strong></h4>
                                <p>DO 和 PO 在绝大部分情况下是一一对应的，PO是只含有 get/set 方法的POJO，但某些场景还是能反映出两者在概念上存在本质区别：<br />
                                    DO在某些场景下不需要进行显式的持久化，例如利用策略模式设计的商品折扣策略，会衍生出折扣策略的接口和不同折扣策略实现类，这些折扣策略实现类可以算是DO，但它们只会驻留在静态内存池，不需要持久化到持久层，因此，这类
                                    DO 是不存在对应的 PO的。<br />
                                    同样的道理，某些场景下，PO也没有对应的DO，例如老师Teacher和学生Student存在多对多的关系，在关系数据库中，这种关系需要表现为一个中间表，也就对应有一个TeacherAndStudentPO的PO，但这个PO在业务领域没有任何现实的意义，它完全不能与任何DO对应上。
                                </p>
                                <h2 id="8.2-%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99"
                                    id="8-2-三级分类接口编写">8.2 三级分类接口编写</h2>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 返回查询所有分类以及子子分类，以树形结构组装起来    </span></span><br><span class="line"><span class="function">List&lt;CategoryEntity&gt; <span class="title">listWithTree</span><span class="params">()</span></span>;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>实现类：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title">listWithTree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 1、查出所有分类 设置为null查询全部</span></span><br><span class="line">      List&lt;CategoryEntity&gt; entities = baseMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 2、组装成父子的树形结构</span></span><br><span class="line">      List&lt;CategoryEntity&gt; levelList = entities.stream().filter(categoryEntity -&gt; &#123;</span><br><span class="line">          <span class="comment">// parentCid ==0 为父目录默认0</span></span><br><span class="line">          <span class="keyword">return</span> categoryEntity.getParentCid() == <span class="number">0</span>;</span><br><span class="line">      &#125;).map(menu -&gt; &#123;</span><br><span class="line">          <span class="comment">// 设置二三级分类 递归</span></span><br><span class="line">          menu.setChildren(getChildrens(menu,entities));</span><br><span class="line">          <span class="keyword">return</span> menu;</span><br><span class="line">      &#125;).sorted((menu1, menu2) -&gt; &#123;</span><br><span class="line">          <span class="comment">//  排序 Sort字段排序</span></span><br><span class="line">          <span class="keyword">return</span> (menu1.getSort() == <span class="keyword">null</span> ? <span class="number">0</span> : menu1.getSort()) - (menu2.getSort() == <span class="keyword">null</span> ? <span class="number">0</span> : menu2.getSort());</span><br><span class="line">      &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> levelList;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   *  递归查询子分类</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> root 当前category对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> all  全部分类数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> List&lt;CategoryEntity&gt; <span class="title">getChildrens</span><span class="params">(CategoryEntity root, List&lt;CategoryEntity&gt; all)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      List&lt;CategoryEntity&gt; collect = all.stream().filter(categoryEntity -&gt; &#123;</span><br><span class="line">          <span class="comment">// 遍历所有的category对象的父类id = 等于root的分类id 说明是他的子类</span></span><br><span class="line">          <span class="keyword">return</span> categoryEntity.getParentCid() == root.getCatId();</span><br><span class="line">      &#125;).map(menu -&gt; &#123;</span><br><span class="line">          <span class="comment">// 1、递归遍历菜单</span></span><br><span class="line">          menu.setChildren(getChildrens(menu, all));</span><br><span class="line">          <span class="keyword">return</span> menu;</span><br><span class="line">      &#125;).sorted((menu1, menu2) -&gt; &#123;</span><br><span class="line">          <span class="comment">// 2、菜单排序</span></span><br><span class="line">          <span class="keyword">return</span> (menu1.getSort() == <span class="keyword">null</span> ? <span class="number">0</span> : menu1.getSort()) - (menu2.getSort() == <span class="keyword">null</span> ? <span class="number">0</span> : menu2.getSort());</span><br><span class="line">      &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> collect;</span><br><span class="line">  &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>跨域</p>
                                </blockquote>
                                <p>跨域：指的是浏览器不能执行其他网站的脚本。它是由浏览器的同源策略造成的，是浏览器对javascript施加的安全限制。</p>
                                <p>同源策略：是指协议，域名，端口都要相同，其中有一个不同都会产生跨域；</p>
                                <p>下图详细说明了 URL 的改变导致是否允许通信</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154306048.png"
                                        alt="image-20220512154306048" /></p>
                                <blockquote>
                                    <p>跨域流程</p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154318670.png"
                                        alt="image-20220512154318670" /></p>
                                <p>浏览器发请求都要实现发送一个请求询问是否可以进行通信 ，我直接给你返回可以通信不就可以了吗？<img
                                        src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201017090546193.png"
                                        alt="image-20201017090546193" /></p>
                                <p>相关资料参考：<a target="_blank" rel="noopener"
                                        href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</a>
                                </p>
                                <blockquote>
                                    <p>解决跨越（ 一 ） 使用nginx部署为同一域</p>
                                </blockquote>
                                <p>开发过于麻烦，上线在使用</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154332704.png"
                                        alt="image-20220512154332704" /></p>
                                <blockquote>
                                    <p>解决跨域 （ 二 ）配置当次请求允许跨域</p>
                                </blockquote>
                                <p>1、添加响应头</p>
                                <ul>
                                    <li>
                                        <p>Access-Control-Allow-Origin: 支持哪些来源的请求跨域</p>
                                    </li>
                                    <li>
                                        <p>Access-Control-Allow-Methods: 支持哪些方法跨域</p>
                                    </li>
                                    <li>
                                        <p>Access-Control-Allow-Credentials: 跨域请求默认不包含cookie,设置为true可以包含cookie</p>
                                    </li>
                                    <li>
                                        <p>Access-Control-Expose-Headers: 跨域请求暴露的字段</p>
                                        <p>​ CORS请求时, XML .HttpRequest对象的getResponseHeader()方法只能拿到6个基本字段:
                                            CacheControl、Content-L anguage、Content Type、Expires、</p>
                                        <p>Last-Modified、 Pragma。 如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。</p>
                                    </li>
                                    <li>
                                        <p>Access-Control-Max- Age:
                                            表明该响应的有效时间为多少秒。在有效时间内，浏览器无须为同一-请求再次发起预检请求。请注意，浏览器自身维护了一个最大有效时间，如果该首部字段的值超过了最大有效时间，将不会生效。
                                        </p>
                                    </li>
                                </ul>
                                <p>网关配置文件</p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">product_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://gulimall-product</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;/?.*),/$\&#123;segment&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">admin_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://renren-fast</span>  <span class="comment"># lb负载均衡</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/**</span>  <span class="comment"># path指定对应路径</span></span><br><span class="line">  <span class="attr">filters:</span> <span class="comment"># 重写路径</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;/?.*),</span> <span class="string">/renren-fast/$\&#123;segment&#125;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>跨越设置</p>
                                <p>请求先发送到网关，网关在转发给其他服务 事先都要注册到<strong>注册中心</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallCorsConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsWebFilter <span class="title">corsWebFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line"></span><br><span class="line">        CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置跨越</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>); <span class="comment">// 允许那些头</span></span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>); <span class="comment">// 允许那些请求方式</span></span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>); <span class="comment">//  允许请求来源</span></span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="keyword">true</span>); <span class="comment">// 是否允许携带cookie跨越</span></span><br><span class="line">        <span class="comment">// 注册跨越配置</span></span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>,corsConfiguration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>去掉renren-fast默认跨域设置</p>
                                <h3 id="8.2.1-%E6%A0%91%E5%BD%A2%E5%B1%95%E7%A4%BA%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE"
                                    id="8-2-1-树形展示三级分类数据">8.2.1 树形展示三级分类数据</h3>
                                <blockquote>
                                    <p>1、用到的前端组件 Tree 树形控件</p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154347353.png"
                                        alt="image-20220512154347353" /></p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;el-tree :data&#x3D;&quot;data&quot; :props&#x3D;&quot;defaultProps&quot; @node-click&#x3D;&quot;handleNodeClick&quot;&gt;&lt;&#x2F;el-tree&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">data	</span><br><span class="line">展示数据</span><br><span class="line">props 配置选项</span><br><span class="line">children 指定子树为节点对象的某个属性值</span><br><span class="line">label 指定节点标签为节点对象的某个属性值</span><br><span class="line">disabled 节点选择框是否禁用为节点对象的某个属性值</span><br><span class="line">@node-click 节点被点击时的回调</span><br><span class="line">--&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>配置静态数据就能显示出对应的效果</p>
                                <blockquote>
                                    <p>2、编写方法获取全部菜单数据</p>
                                </blockquote>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="title">getMenus</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">          <span class="comment">// 请求接口见上面</span></span><br><span class="line">        url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">&quot;/product/category/list/tree&quot;</span>),</span><br><span class="line">        method: <span class="string">&quot;get&quot;</span></span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;返回的菜单数据&quot;</span> + data.data);</span><br><span class="line">        <span class="built_in">this</span>.menus = data.data;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>3、最终展示结果 ( append ,edit 会在后面介绍)</p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154358877.png"
                                        alt="image-20220512154358877" /></p>
                                <h3 id="8.2.2-%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4%26%E5%88%A0%E9%99%A4%E6%95%88%E6%9E%9C%E7%BB%86%E5%8C%96"
                                    id="8-2-2-逻辑删除-删除效果细化">8.2.2 逻辑删除&amp;删除效果细化</h3>
                                <p>效果图</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154414329.png"
                                        alt="image-20220512154414329" /></p>
                                <blockquote>
                                    <p>1、节点的内容支持自定义，可以在节点区添加按钮或图标等内容</p>
                                </blockquote>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> &lt;el-button</span><br><span class="line">            v-if&#x3D;&quot;node.childNodes.length &#x3D;&#x3D; 0&quot;</span><br><span class="line">            type&#x3D;&quot;text&quot;</span><br><span class="line">            size&#x3D;&quot;mini&quot;</span><br><span class="line">            @click&#x3D;&quot;() &#x3D;&gt; remove(node, data)&quot;</span><br><span class="line">          &gt; Delete&lt;&#x2F;el-button&gt;</span><br><span class="line"> &lt;!-- </span><br><span class="line">	v-if&#x3D;&quot;node.childNodes.length &#x3D;&#x3D; 0&quot;  没有子节点可以删除</span><br><span class="line">	type 对应类型</span><br><span class="line">	size 大小</span><br><span class="line">	@click 点击后出发的方法 此处使用了 箭头函数</span><br><span class="line">--&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>2、前端remove方法进行删除</p>
                                </blockquote>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="title">remove</span>(<span class="params">node, data</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.$confirm(<span class="string">`是否删除【<span class="subst">$&#123;data.name&#125;</span>】菜单 ? `</span>, <span class="string">&quot;提示&quot;</span>, &#123;</span><br><span class="line">        confirmButtonText: <span class="string">&quot;确定&quot;</span>,</span><br><span class="line">        cancelButtonText: <span class="string">&quot;取消&quot;</span>,</span><br><span class="line">        type: <span class="string">&quot;warning&quot;</span></span><br><span class="line">      &#125;)</span><br><span class="line">        .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 拿到当前节点的catId</span></span><br><span class="line">          <span class="keyword">var</span> ids = [data.catId];</span><br><span class="line">          <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">            url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">&quot;/product/category/delete&quot;</span>),</span><br><span class="line">            method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">            data: <span class="built_in">this</span>.$http.adornData(ids, <span class="literal">false</span>)</span><br><span class="line">          &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.$message(&#123;</span><br><span class="line">              message: <span class="string">&quot;菜单删除成功&quot;</span>,</span><br><span class="line">              type: <span class="string">&quot;success&quot;</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 刷新菜单</span></span><br><span class="line">            <span class="built_in">this</span>.getMenus();</span><br><span class="line">            <span class="comment">// 设置默认需要展开的菜单</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            default-expanded-keys  默认展开节点的 key 数组 </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="built_in">this</span>.expandedKey = [node.parent.data.catId];</span><br><span class="line">            <span class="built_in">console</span>.log(node.parent.data.catId);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;remove&quot;</span>, node, data);</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>3、后端接口 -- 逻辑删除配置</p>
                                </blockquote>
                                <p>3.1 第一种方式 mybatisplus 逻辑删除参考官网：<a target="_blank" rel="noopener"
                                        href="https://baomidou.com/guide/logic-delete.html">https://baomidou.com/guide/logic-delete.html</a>
                                </p>
                                <p>在appliction.yml 中配置 myabtisplus 逻辑删除</p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span> <span class="comment"># 数据库主键自增</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span> <span class="comment"># 逻辑已删除值(默认为 1)</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span> <span class="comment"># 逻辑未删除值(默认为 0)</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>3.2 第二种方式 在 Entity中 使用注解</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	是否为数据库表字段</span></span><br><span class="line"><span class="comment">	默认 true 存在，false 不存在</span></span><br><span class="line"><span class="comment">	标记为false 说明 该字段不在数据库 </span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="keyword">private</span> List&lt;CategoryEntity&gt; children;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>4、Controller 实现 使用了代码生成器</p>
                                </blockquote>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@RequestBody</span>:获取请求体，必须发送post请求才有 get请求没有</span></span><br><span class="line"><span class="comment">     * SpringMvc 自动将请求体的数据 ( json ) 转为对应的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delete&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">delete</span><span class="params">(<span class="meta">@RequestBody</span> Long[] catIds)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 1、检查当前删除的菜单，是否被别的地方应用</span></span><br><span class="line">        categoryService.removeMenuByIds(Arrays.asList(catIds));</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//Service 实现</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeMenuByIds</span><span class="params">(List&lt;Long&gt; asList)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1、逻辑删除</span></span><br><span class="line">        baseMapper.deleteBatchIds(asList);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="8.2.3-%E6%96%B0%E5%A2%9E%E6%95%88%E6%9E%9C%26%E5%9F%BA%E6%9C%AC%E4%BF%AE%E6%94%B9"
                                    id="8-2-3-新增效果-基本修改">8.2.3 新增效果&amp;基本修改</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154444827.png"
                                        alt="image-20220512154444827" /></p>
                                <blockquote>
                                    <p>1、前端组件 button 组件 Dialog 对话框</p>
                                </blockquote>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">  &lt;!-- 层级小于2 才能新增 --&gt;</span><br><span class="line">          &lt;el-button</span><br><span class="line">            v-if&#x3D;&quot;node.level &lt;&#x3D; 2&quot;</span><br><span class="line">            type&#x3D;&quot;text&quot;</span><br><span class="line">            size&#x3D;&quot;mini&quot;</span><br><span class="line">            @click&#x3D;&quot;() &#x3D;&gt; append(data)&quot;</span><br><span class="line">            &gt;Append</span><br><span class="line">          &lt;&#x2F;el-button&gt;</span><br><span class="line"> &lt;el-button type&#x3D;&quot;text&quot; size&#x3D;&quot;mini&quot; @click&#x3D;&quot;() &#x3D;&gt; edit(data)&quot;</span><br><span class="line">            &gt;edit</span><br><span class="line">          &lt;&#x2F;el-button&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 上面组件在tree中--&gt;</span><br><span class="line">&lt;el-dialog</span><br><span class="line">      :title&#x3D;&quot;title&quot;</span><br><span class="line">      :visible.sync&#x3D;&quot;dialogVisible&quot;</span><br><span class="line">      width&#x3D;&quot;30%&quot;</span><br><span class="line">      :before-close&#x3D;&quot;handleClose&quot;</span><br><span class="line">      :close-on-click-modal&#x3D;&quot;false&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;el-form :model&#x3D;&quot;category&quot;&gt;</span><br><span class="line">        &lt;el-form-item label&#x3D;&quot;分类名称&quot;&gt;</span><br><span class="line">          &lt;el-input v-model&#x3D;&quot;category.name&quot; autocomplete&#x3D;&quot;off&quot;&gt;&lt;&#x2F;el-input&gt;</span><br><span class="line">        &lt;&#x2F;el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label&#x3D;&quot;图标&quot;&gt;</span><br><span class="line">          &lt;el-input v-model&#x3D;&quot;category.icon&quot; autocomplete&#x3D;&quot;off&quot;&gt;&lt;&#x2F;el-input&gt;</span><br><span class="line">        &lt;&#x2F;el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label&#x3D;&quot;计量单位&quot;&gt;</span><br><span class="line">          &lt;el-input</span><br><span class="line">            v-model&#x3D;&quot;category.productUnit&quot;</span><br><span class="line">            autocomplete&#x3D;&quot;off&quot;</span><br><span class="line">          &gt;&lt;&#x2F;el-input&gt;</span><br><span class="line">        &lt;&#x2F;el-form-item&gt;</span><br><span class="line">      &lt;&#x2F;el-form&gt;</span><br><span class="line">      &lt;span slot&#x3D;&quot;footer&quot; class&#x3D;&quot;dialog-footer&quot;&gt;</span><br><span class="line">        &lt;el-button @click&#x3D;&quot;dialogVisible &#x3D; false&quot;&gt;取 消&lt;&#x2F;el-button&gt;</span><br><span class="line">        &lt;el-button type&#x3D;&quot;primary&quot; @click&#x3D;&quot;submitData&quot;&gt;确 定&lt;&#x2F;el-button&gt;</span><br><span class="line">      &lt;&#x2F;span&gt;</span><br><span class="line">    &lt;&#x2F;el-dialog&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>2、新增&amp;修改</p>
                                </blockquote>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">  <span class="function"><span class="title">append</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.dialogVisible = <span class="literal">true</span>;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;append&quot;</span>, data);</span><br><span class="line">      <span class="built_in">this</span>.category.name = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="built_in">this</span>.dialogType = <span class="string">&quot;add&quot;</span>;</span><br><span class="line">      <span class="built_in">this</span>.title = <span class="string">&quot;添加分类&quot;</span>;</span><br><span class="line">      <span class="built_in">this</span>.category.parentCid = data.catId;</span><br><span class="line">      <span class="built_in">this</span>.category.catLevel = data.catLevel * <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">this</span>.category.name = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="built_in">this</span>.category.catId = <span class="literal">null</span>;</span><br><span class="line">      <span class="built_in">this</span>.category.icon = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="built_in">this</span>.category.productUnit = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;, <span class="comment">// 要修改的数据</span></span><br><span class="line">    <span class="function"><span class="title">edit</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;要修改的数据&quot;</span>, data);</span><br><span class="line">      <span class="built_in">this</span>.dialogType = <span class="string">&quot;edit&quot;</span>;</span><br><span class="line">      <span class="built_in">this</span>.title = <span class="string">&quot;修改分类&quot;</span>;</span><br><span class="line">      <span class="built_in">this</span>.dialogVisible = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 发送请求获取最新的数据</span></span><br><span class="line">      <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">        url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">`/product/category/info/<span class="subst">$&#123;data.catId&#125;</span>`</span>),</span><br><span class="line">        method: <span class="string">&quot;get&quot;</span></span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 请求成功</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;要回显的数据&quot;</span>, data);</span><br><span class="line">        <span class="built_in">this</span>.category.name = data.data.name;</span><br><span class="line">        <span class="built_in">this</span>.category.catId = data.data.catId;</span><br><span class="line">        <span class="built_in">this</span>.category.icon = data.data.icon;</span><br><span class="line">        <span class="built_in">this</span>.category.productUnit = data.data.productUnit;</span><br><span class="line">        <span class="built_in">this</span>.category.parentCid = data.data.parentCid;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">submitData</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.dialogType == <span class="string">&quot;add&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 进行新增</span></span><br><span class="line">        <span class="built_in">this</span>.addCategory();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.dialogType == <span class="string">&quot;edit&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 进行修改</span></span><br><span class="line">        <span class="built_in">this</span>.editCategory();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">        <span class="comment">// 添加三级分类</span></span><br><span class="line">    <span class="function"><span class="title">addCategory</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;添加三级分类的数据&quot;</span>, <span class="built_in">this</span>.category);</span><br><span class="line">      <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">        url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">&quot;/product/category/save&quot;</span>),</span><br><span class="line">        method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        data: <span class="built_in">this</span>.$http.adornData(<span class="built_in">this</span>.category, <span class="literal">false</span>)</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$message(&#123;</span><br><span class="line">          message: <span class="string">&quot;菜单保存成功&quot;</span>,</span><br><span class="line">          type: <span class="string">&quot;success&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 关闭对话框</span></span><br><span class="line">        <span class="built_in">this</span>.dialogVisible = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 重新刷新数据</span></span><br><span class="line">        <span class="built_in">this</span>.getMenus();</span><br><span class="line">        <span class="comment">// 默认展开的菜单</span></span><br><span class="line">        <span class="built_in">this</span>.expandedKey = [<span class="built_in">this</span>.category.parentCid];</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, <span class="comment">// 修改三级分类数据</span></span><br><span class="line">    <span class="function"><span class="title">editCategory</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 解构出单独的几个对象 用来提交</span></span><br><span class="line">      <span class="keyword">var</span> &#123; catId, name, icon, productUnit &#125; = <span class="built_in">this</span>.category;</span><br><span class="line">      <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">        url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">&quot;/product/category/update&quot;</span>),</span><br><span class="line">        method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        data: <span class="built_in">this</span>.$http.adornData(&#123; catId, name, icon, productUnit &#125;, <span class="literal">false</span>)</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$message(&#123;</span><br><span class="line">          message: <span class="string">&quot;菜单修改成功&quot;</span>,</span><br><span class="line">          type: <span class="string">&quot;success&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 关闭对话框</span></span><br><span class="line">        <span class="built_in">this</span>.dialogVisible = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 重新刷新数据</span></span><br><span class="line">        <span class="built_in">this</span>.getMenus();</span><br><span class="line">        <span class="comment">// 默认展开的菜单</span></span><br><span class="line">        <span class="built_in">this</span>.expandedKey = [<span class="built_in">this</span>.category.parentCid];</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>3、要考虑到的点 以及细节</p>
                                </blockquote>
                                <ul>
                                    <li>添加完成后要把表单的数据进行清除，否则第二次打开任然会有上次表单提交剩下的数据 <a target="_blank" rel="noopener"
                                            href="http://this.category.name">this.category.name</a> = &quot;&quot;;</li>
                                    <li>修改和新增用的是同一个表单，因此在方法对话框中 动态的绑定了 :title=&quot;title&quot; 标题 用于显示是新增还是修改</li>
                                    <li>一个表单都是一个提交方法 因此在提交方法的时候进行了判断，根据变量赋值决定调用那个方法 this.dialogType = &quot;add&quot;;
                                        this.dialogType = &quot;edit&quot;;</li>
                                </ul>
                                <h3 id="8.2.4-%E6%8B%96%E6%8B%BD%E5%8A%9F%E8%83%BD%26%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%26%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"
                                    id="8-2-4-拖拽功能-数据收集-批量删除">8.2.4 拖拽功能&amp;数据收集&amp;批量删除</h3>
                                <p>效果演示</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154501803.png"
                                        alt="image-20220512154501803" /></p>
                                <blockquote>
                                    <p>1、前端用的组件 Tree 树形控件 可拖拽节点</p>
                                </blockquote>
                                <p>通过 draggable 属性可让节点变为可拖拽。</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> &lt;el-tree</span><br><span class="line">      :expand-on-click-node&#x3D;&quot;false&quot; </span><br><span class="line">      :data&#x3D;&quot;menus&quot;</span><br><span class="line">      :props&#x3D;&quot;defaultProps&quot;</span><br><span class="line">      show-checkbox</span><br><span class="line">      node-key&#x3D;&quot;catId&quot;</span><br><span class="line">      :default-expanded-keys&#x3D;&quot;expandedKey&quot;</span><br><span class="line">      :draggable&#x3D;&quot;draggable&quot;</span><br><span class="line">      :allow-drop&#x3D;&quot;allowDrop&quot;</span><br><span class="line">      @node-drop&#x3D;&quot;handleDrop&quot;</span><br><span class="line">      ref&#x3D;&quot;menuTree&quot;</span><br><span class="line">    &gt;</span><br><span class="line">&lt;!-- </span><br><span class="line">:expand-on-click-node 是否在点击节点的时候展开或者收缩节点 默认 true 则只有点箭头图标的时候才会展开或者收缩节点。</span><br><span class="line">show-checkbox	节点是否可被选择</span><br><span class="line">node-key 每个树节点用来做唯一标识的属性 </span><br><span class="line">default-expanded-keys  默认展开节点的节点</span><br><span class="line">draggable 表示是否可以被拖拽 true&amp;false</span><br><span class="line">allow-drop 拖拽时判定目标节点能否被放置</span><br><span class="line">node-drop 拖拽成功完成出发的事件</span><br><span class="line">ref 该组件tree的引用</span><br><span class="line">详细解释参考官网 https:&#x2F;&#x2F;element.eleme.cn&#x2F;#&#x2F;zh-CN&#x2F;component&#x2F;tree</span><br><span class="line">--&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>2、主要业务逻辑 TODO：暂时不懂 回头再来看</p>
                                </blockquote>
                                <p><strong>allowDrop</strong>：</p>
                                <p>拖拽时判定目标节点能否被放置。<code>type</code> 参数有三种情况：'prev'、'inner' 和
                                    'next'，分别表示放置在目标节点前、插入至目标节点和放置在目标节点后</p>
                                <p><strong>@node-drop</strong></p>
                                <p>拽成功完成时触发的事件</p>
                                <p>共四个参数，依次为：被拖拽节点对应的 Node、结束拖拽时最后进入的节点、被拖拽节点的放置位置（before、after、inner）、event</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="title">allowDrop</span>(<span class="params">draggingNode, dropNode, type</span>)</span> &#123;</span><br><span class="line">     <span class="comment">// 1、被拖动的当前节点以及所在的父节点总层次不能大于3</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 1) 被拖动节点的总层数</span></span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;allowDrop&quot;</span>, draggingNode, dropNode, type);</span><br><span class="line"></span><br><span class="line">     <span class="built_in">this</span>.countNodeLevel(draggingNode.data);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 当前正在拖动的节点 + 父节点所在的深度不大于3即可</span></span><br><span class="line">     <span class="keyword">let</span> deep = <span class="built_in">Math</span>.abs(<span class="built_in">this</span>.maxLevel - draggingNode.level) + <span class="number">1</span>;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;深度&quot;</span>, deep);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (type == <span class="string">&quot;inner&quot;</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> deep + dropNode.level &lt;= <span class="number">3</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> deep + dropNode.parent.level &lt;= <span class="number">3</span>;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;,</span><br><span class="line">   <span class="function"><span class="title">countNodeLevel</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">     <span class="comment">// 找到所有子节点，求出最大深度</span></span><br><span class="line">     <span class="keyword">if</span> (node.children != <span class="literal">null</span> &amp;&amp; node.children.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; node.children.length; i++) &#123;</span><br><span class="line">         <span class="keyword">if</span> (node.children[i].catLevel &gt; <span class="built_in">this</span>.maxLevel) &#123;</span><br><span class="line">           <span class="built_in">this</span>.maxLevel = node.children[i].catLevel;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 递归查找</span></span><br><span class="line">         <span class="built_in">this</span>.countNodeLevel(node.children[i]);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,  <span class="function"><span class="title">handleDrop</span>(<span class="params">draggingNode, dropNode, dropType, ev</span>)</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;handleDrop: &quot;</span>, draggingNode, dropNode, dropType);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 1、当前节点最新的父节点</span></span><br><span class="line">     <span class="keyword">let</span> pCid = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">let</span> siblings = <span class="literal">null</span>;</span><br><span class="line">     <span class="keyword">if</span> (dropType == <span class="string">&quot;before&quot;</span> || dropType == <span class="string">&quot;after&quot;</span>) &#123;</span><br><span class="line">       pCid =</span><br><span class="line">         dropNode.parent.data.catId == <span class="literal">undefined</span></span><br><span class="line">           ? <span class="number">0</span></span><br><span class="line">           : dropNode.parent.data.catId;</span><br><span class="line">       siblings = dropNode.parent.childNodes;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       pCid = dropNode.data.catId;</span><br><span class="line">       siblings = dropNode.childNodes;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// this.PCid = pCid</span></span><br><span class="line">     <span class="built_in">this</span>.pCid.push(pCid);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 2、当前拖拽节点的最新顺序</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; siblings.length; i++) &#123;</span><br><span class="line">       <span class="keyword">if</span> (siblings[i].data.catId == draggingNode.data.catId) &#123;</span><br><span class="line">         <span class="comment">// 如果遍历的是当前正在拖拽的节点</span></span><br><span class="line">         <span class="keyword">let</span> catLevel = draggingNode.level;</span><br><span class="line">         <span class="keyword">if</span> (siblings[i].level != draggingNode.level) &#123;</span><br><span class="line">           <span class="comment">// 当前结点的层级发生变化</span></span><br><span class="line">           catLevel = siblings[i].level;</span><br><span class="line">           <span class="comment">// 修改它子节点的层级</span></span><br><span class="line">           <span class="built_in">this</span>.updateChildNodeLevel(siblings[i]);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 如果遍历当前正在拖拽的节点</span></span><br><span class="line">         <span class="built_in">this</span>.updateNodes.push(&#123;</span><br><span class="line">           catId: siblings[i].data.catId,</span><br><span class="line">           sort: i,</span><br><span class="line">           parentCid: pCid</span><br><span class="line">         &#125;);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="built_in">this</span>.updateNodes.push(&#123; <span class="attr">catId</span>: siblings[i].data.catId, <span class="attr">sort</span>: i &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 3、当前拖拽节点的最新层级</span></span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;updateNodes&quot;</span>, <span class="built_in">this</span>.updateNodes);</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="function"><span class="title">updateChildNodeLevel</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (node.childNodes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; node.childNodes.length; i++) &#123;</span><br><span class="line">         <span class="keyword">var</span> cNode = node.childNodes[i].data;</span><br><span class="line">         <span class="built_in">this</span>.updateNodes.push(&#123;</span><br><span class="line">           catId: cNode.catId,</span><br><span class="line">           catLevel: node.childNodes[i].level</span><br><span class="line">         &#125;);</span><br><span class="line">         <span class="built_in">this</span>.updateChildNodeLevel(node.childNodes[i]);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>3、批量删除</p>
                                </blockquote>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;el-button type&#x3D;&quot;danger&quot; @click&#x3D;&quot;batchDelete&quot;&gt;批量删除&lt;&#x2F;el-button&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>batchDelete方法</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="title">batchDelete</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> catIds = [];</span><br><span class="line">    <span class="keyword">let</span> names = [];</span><br><span class="line">    <span class="comment">// 返回目前被选中的节点所组成的数组</span></span><br><span class="line">    <span class="keyword">let</span> checkedNodes = <span class="built_in">this</span>.$refs.menuTree.getCheckedNodes();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;被选中的元素&quot;</span>, checkedNodes);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; checkedNodes.length; i++) &#123;</span><br><span class="line">        <span class="comment">// 遍历节点数组 拿到需要的值</span></span><br><span class="line">      catIds.push(checkedNodes[i].catId);</span><br><span class="line">      names.push(checkedNodes[i].name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.$confirm(<span class="string">`是否批量删除【<span class="subst">$&#123;names&#125;</span>】菜单 ? `</span>, <span class="string">&quot;提示&quot;</span>, &#123;</span><br><span class="line">      confirmButtonText: <span class="string">&quot;确定&quot;</span>,</span><br><span class="line">      cancelButtonText: <span class="string">&quot;取消&quot;</span>,</span><br><span class="line">      type: <span class="string">&quot;warning&quot;</span></span><br><span class="line">    &#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">        url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">&quot;/product/category/delete&quot;</span>),</span><br><span class="line">        method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        data: <span class="built_in">this</span>.$http.adornData(catIds, <span class="literal">false</span>)</span><br><span class="line">      &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.$message(&#123;</span><br><span class="line">          message: <span class="string">&quot;删除成功&quot;</span>,</span><br><span class="line">          type: <span class="string">&quot;success&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">      <span class="comment">// 刷新菜单</span></span><br><span class="line">      <span class="built_in">this</span>.getMenus();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>后端接口也是逻辑批量删除</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeMenuByIds</span><span class="params">(List&lt;Long&gt; asList)</span></span>; <span class="comment">//接收的是一个id数组</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结：</strong></p>
                                <p>前端用到的组件</p>
                                <p>Dialog 对话框、可拖拽节点、Switch 开关、Button 按钮、Tree组件（属性较多）</p>
                                <p>细节点：</p>
                                <p>没开启拖拽</p>
                                <p>开启拖拽：</p>
                                <p>通过 draggable 属性可让节点变为可拖拽。</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20220512154539368.png"
                                        alt="image-20220512154539368" /></p>
                                <h1
                                    id="%E4%B8%83%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86">
                                    七、商品服务&amp;品牌管理</h1>
                                <h2 id="9.1%E3%80%81%E6%95%88%E6%9E%9C%E6%98%BE%E7%A4%BA%E4%BC%98%E5%8C%96%E4%B8%8E%E5%BF%AB%E9%80%9F%E6%98%BE%E7%A4%BA%E5%BC%80%E5%85%B3"
                                    id="9-1、效果显示优化与快速显示开关">9.1、效果显示优化与快速显示开关</h2>
                                <p>vue代码</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> &lt;el-switch</span><br><span class="line">            v-model&#x3D;&quot;scope.row.showStatus&quot;</span><br><span class="line">            active-color&#x3D;&quot;#13ce66&quot;</span><br><span class="line">            inactive-color&#x3D;&quot;#ff4949&quot;</span><br><span class="line">            :active-value&#x3D;&quot;1&quot;</span><br><span class="line">            :inactive-value&#x3D;&quot;0&quot;</span><br><span class="line">            @change&#x3D;&quot;updateBrandStatus(scope.row)&quot;</span><br><span class="line">          &gt;</span><br><span class="line">     &lt;!-- </span><br><span class="line">scope.row 拿到整行的数据</span><br><span class="line">active-color	switch 打开时的背景色</span><br><span class="line">inactive-color	switch 关闭时的背景色</span><br><span class="line">active-value	switch 打开时的值</span><br><span class="line">inactive-value	switch 关闭时的值</span><br><span class="line">--&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>组件地址：<a target="_blank" rel="noopener"
                                        href="https://element.eleme.cn/#/zh-CN/component/switch">https://element.eleme.cn/#/zh-CN/component/switch</a>
                                </p>
                                <p>用户点击 switch 开关就会调用后台的接口更改对应数据库的字段 ( 决定是否显示)，定义了 @change 事件 只要修后就会触发对应方法</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="title">updateBrandStatus</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;整行数据&quot;</span>,data);</span><br><span class="line">    <span class="comment">// 单独就封装两个字段</span></span><br><span class="line">     <span class="keyword">let</span> &#123;brandId,showStatus&#125; = data</span><br><span class="line">     <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">       url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">&#x27;/product/brand/update&#x27;</span>),</span><br><span class="line">       method: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">       data: <span class="built_in">this</span>.$http.adornData(&#123;brandId,showStatus&#125;, <span class="literal">false</span>)</span><br><span class="line">     &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="built_in">this</span>.$message(&#123;</span><br><span class="line">         type:<span class="string">&quot;success&quot;</span>,</span><br><span class="line">         message:<span class="string">&quot;状态更新成功&quot;</span></span><br><span class="line">       &#125;)</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="9.2%E3%80%81%E8%A1%A8%E5%8D%95%E6%95%88%E9%AA%8C%26%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%88%E9%AA%8C%E8%A7%84%E5%88%99"
                                    id="9-2、表单效验-自定义效验规则">9.2、表单效验&amp;自定义效验规则</h2>
                                <p>Form 组件提供了表单验证的功能，只需要通过 <code>rules</code> 属性传入约定的验证规则，并将 Form-Item 的
                                    <code>prop</code> 属性设置为需校验的字段名即可</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;el-form</span><br><span class="line">      :model&#x3D;&quot;dataForm&quot;</span><br><span class="line">      :rules&#x3D;&quot;dataRule&quot;</span><br><span class="line">      ref&#x3D;&quot;dataForm&quot;</span><br><span class="line">      @keyup.enter.native&#x3D;&quot;dataFormSubmit()&quot;</span><br><span class="line">      label-width&#x3D;&quot;140px&quot;</span><br><span class="line">    &gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>data中</p>
                                <p>自定义的规则 ，用来对数据进行判断</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">dataRule: &#123;</span><br><span class="line">        name: [&#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;品牌名不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;],</span><br><span class="line">        <span class="comment">// 自定义的规则  </span></span><br><span class="line">        firstLetter: [</span><br><span class="line">          &#123; <span class="attr">validator</span>: <span class="function">(<span class="params">rule, value, callback</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(value == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">              callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;首字母必须填写&quot;</span>))</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(! <span class="regexp">/^[a-zA-Z]$/</span>.test(value)) &#123;</span><br><span class="line">              callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;首字母必须a-z或者A-Z之间&quot;</span>))</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              callback()</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,<span class="attr">trigger</span>:<span class="string">&#x27;blur&#x27;</span>&#125;</span><br><span class="line">        ],</span><br><span class="line">        sort: [&#123; <span class="attr">validator</span>: <span class="function">(<span class="params">rule, value, callback</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(value == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">              callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;排序字段必须填写&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">Number</span>.isInteger(value) || value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">              callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;排序必须是一个大于等于0的整数&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              callback();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;]</span><br><span class="line">      &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="9.3%E3%80%81jsr303-%E6%95%B0%E6%8D%AE%E6%95%88%E9%AA%8C-%26-%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"
                                    id="9-3、JSR303-数据效验-统一异常处理">9.3、JSR303 数据效验 &amp; 统一异常处理</h2>
                                <p>前端数据效验成功了，就会把json数据传递到后端，但是有人利用接口 比如 postman 乱发送请求 那会怎么办，于是后端也会利用 JSR303进行数据效验</p>
                                <h3 id="9.3.1%E3%80%81%E7%BB%99bean%E6%B7%BB%E5%8A%A0%E6%95%88%E9%AA%8C%E6%B3%A8%E8%A7%A3-javax.validation.constraints%E5%8C%85%E4%B8%8B-%E5%B9%B6%E5%AE%9A%E4%B9%89%E8%87%AA%E5%B7%B1%E7%9A%84%E7%9A%84message%E6%8F%90%E7%A4%BA"
                                    id="9-3-1、给Bean添加效验注解-javax-validation-constraints包下-并定义自己的的message提示">
                                    9.3.1、给Bean添加效验注解 javax.validation.constraints包下 并定义自己的的message提示</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201019205020068.png"
                                        alt="" /></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@NotEmpty(messsage = &quot;logo不能为空&quot;)</span></span><br><span class="line"><span class="meta">@URL(message = &quot;logo必须是一个合法的url地址&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String logo;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="9.3.2%E3%80%81%E5%BC%80%E5%90%AF%E6%95%88%E9%AA%8C%E5%8A%9F%E8%83%BD-%40valid"
                                    id="9-3-2、开启效验功能-Valid">9.3.2、开启效验功能 @Valid</h3>
                                <ul>
                                    <li>
                                        <p>效果：效验错误以后有默认的响应</p>
                                        <p>Controller代码：</p>
                                        <figure class="highlight java">
                                            <table>
                                                <tr>
                                                    <td class="gutter">
                                                        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                                    </td>
                                                    <td class="code">
                                                        <pre><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">save</span><span class="params">(<span class="meta">@Valid</span><span class="meta">@RequestBody</span> BrandEntity brand)</span></span>&#123;</span><br><span class="line">    brandService.save(brand);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                                    </td>
                                                </tr>
                                            </table>
                                        </figure>
                                        <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020083020271.png"
                                                alt="image-20201020083020271" /></p>
                                    </li>
                                </ul>
                                <h3 id="9.3.3%E3%80%81%E7%BB%99%E6%95%88%E9%AA%8C%E7%9A%84bean%E5%90%8E%E7%B4%A7%E8%B7%9F%E4%B8%80%E4%B8%AAbindingresult-%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E5%88%B0%E6%95%88%E9%AA%8C%E7%9A%84%E7%BB%93%E6%9E%9C"
                                    id="9-3-3、给效验的bean后紧跟一个BindingResult-就可以获取到效验的结果">9.3.3、给效验的bean后紧跟一个BindingResult
                                    就可以获取到效验的结果</h3>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">save</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BrandEntity brand,BindingResult result)</span></span>&#123;</span><br><span class="line"> <span class="keyword">if</span>(result.hasErrors())&#123;</span><br><span class="line">           Map&lt;String,String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">           <span class="comment">//1、获取校验的错误结果</span></span><br><span class="line">           result.getFieldErrors().forEach((item)-&gt;&#123;</span><br><span class="line">               <span class="comment">//FieldError 获取到错误提示</span></span><br><span class="line">               String message = item.getDefaultMessage();</span><br><span class="line">               <span class="comment">//获取错误的属性的名字</span></span><br><span class="line">               String field = item.getField();</span><br><span class="line">               map.put(field,message);</span><br><span class="line">           &#125;);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> R.error(<span class="number">400</span>,<span class="string">&quot;提交的数据不合法&quot;</span>).put(<span class="string">&quot;data&quot;</span>,map);</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="9.3.4%E3%80%81%E5%88%86%E7%BB%84%E6%95%88%E9%AA%8C-(%E5%A4%9A%E5%9C%BA%E6%99%AF%E5%A4%8D%E6%9D%82%E6%95%88%E9%AA%8C)"
                                    id="9-3-4、分组效验-多场景复杂效验">9.3.4、分组效验 (多场景复杂效验)</h3>
                                <p>添加一个组 &amp; 修改一个组</p>
                                <p>1、@NotBlank(message = &quot;品牌名必须提交&quot;,groups =
                                    {AddGroup.class,UpdateGroup.class})</p>
                                <ul>
                                    <li><strong>给效验注解标注什么情况需要进行效验</strong></li>
                                    <li>@Validated({AddGroup.class}) 在对应方法上进行标注</li>
                                    <li><strong>默认没有指定分组的效验注解 @NotBlank
                                            在分组效验情况@Validated({AddGroup.class})不生效</strong>，只会在@Validated生效</li>
                                </ul>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 标记使用修改分组</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">update</span><span class="params">(<span class="meta">@Validated(UpdateGroup.class)</span> <span class="meta">@RequestBody</span> BrandEntity brand)</span></span>&#123;</span><br><span class="line">	brandService.updateById(brand);</span><br><span class="line">      <span class="keyword">return</span> R.ok();</span><br><span class="line">  &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Entity</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 品牌id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Null(message = &quot;新增不能指定Id&quot;,groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@NotNull(message = &quot;修改必须指定品牌id&quot;,groups = &#123;UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@TableId</span></span><br><span class="line"><span class="keyword">private</span> Long brandId;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 品牌名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotBlank(message = &quot;品牌名不能为空&quot;,groups = &#123;AddGroup.class,UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 品牌logo地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotEmpty(groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@URL(message = &quot;logo必须是一个合法的url地址&quot;,groups = &#123;AddGroup.class,UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> String logo;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 介绍</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String descript;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 显示状态[0-不显示；1-显示]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotNull(groups = &#123;AddGroup.class, UpdateStatusGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@ListValue(vals=&#123;0,1&#125;,groups = &#123;AddGroup.class,UpdateStatusGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> Integer showStatus;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检索首字母</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotEmpty(groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@Pattern(regexp = &quot;^[a-zA-Z]$&quot;,message = &quot;检索首字母必须是一个字母&quot;,groups = &#123;AddGroup.class,UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> String firstLetter;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NotNull(groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@Min(value=0,message = &quot;排序必须大于等于0&quot;,groups = &#123;AddGroup.class,UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> Integer sort;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="9.3.5%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%88%E9%AA%8C" id="9-3-5、自定义效验">
                                    9.3.5、自定义效验</h3>
                                <ul>
                                    <li>
                                        <pre><code> 编写一个自定义的效验注解
</code></pre>
                                    </li>
                                    <li>
                                        <pre><code> 编写一个自定义的效验器何自定义的效验注解
</code></pre>
                                    </li>
                                </ul>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = &#123;ListValueConstraintValidator.class&#125;)</span><span class="comment">//【可以指定多个不同的效验器，适配不同类型的效验】</span></span><br><span class="line"><span class="meta">@Target(&#123; METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ListValue &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 三要素不能丢</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;</span>&#123;com.atguigu.gulimall.product.valid.ListValue.message&#125;<span class="string">&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;?&gt;[] groups() default &#123; &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Class&lt;? extends Payload&gt;[] payload() default &#123; &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    int[] vals() default &#123; &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>实现约束</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListValueConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">ListValue</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">// 初始化方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ListValue constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] vals = constraintAnnotation.vals();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> val : vals) &#123;</span><br><span class="line">            <span class="comment">// 将结果添加到set集合</span></span><br><span class="line">            set.add(val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *	判断效验是否成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 需要效验的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Integer value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是包含该值</span></span><br><span class="line">        <span class="keyword">return</span> set.contains(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="9.3.6%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86" id="9-3-6、异常处理">9.3.6、异常处理
                                </h3>
                                <p>这里使用到了 SpringMVC 的注解 @ControllerAdvice</p>
                                <p>1、编写异常处理类使用SpringMvc的@ControllerAdvice</p>
                                <p>2、使用@ExceptionHandler标记方法可以处理异常</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice(basePackages =  &quot;com.atguigu.gulimall.product.controller&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallExceptionControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 捕获定义的异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">handleVaildException</span><span class="params">(MethodArgumentNotValidException e)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">&quot;数据效验出现问题&#123;&#125;,异常类型:&#123;&#125;&quot;</span>,e.getMessage(),e.getClass());</span><br><span class="line">        Map&lt;String,String&gt; errorMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        BindingResult bindingResult = e.getBindingResult();</span><br><span class="line">        bindingResult.getFieldErrors().forEach(fieldError -&gt; &#123;</span><br><span class="line">            errorMap.put(fieldError.getField(),fieldError.getDefaultMessage());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCodeEnume.VAILD_EXCEPTION.getCode(),BizCodeEnume.VAILD_EXCEPTION.getMsg()).put(<span class="string">&quot;data&quot;</span>,errorMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 兜底异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Throwable.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">handleException</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.error();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>异常错误码定义 （重点）</strong></p>
                                <p>后端将定义的错误码写入到开发手册，前端出现对于的错误，就可以通过手册查询到对应的异常</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 错误码和错误信息定义类</span></span><br><span class="line"><span class="comment"> * 1. 错误码定义规则为5为数字</span></span><br><span class="line"><span class="comment"> * 2. 前两位表示业务场景，最后三位表示错误码。例如：100001。10:通用 001:系统未知异常</span></span><br><span class="line"><span class="comment"> * 3. 维护错误码后需要维护错误描述，将他们定义为枚举形式</span></span><br><span class="line"><span class="comment"> * 错误码列表：</span></span><br><span class="line"><span class="comment"> *  10: 通用</span></span><br><span class="line"><span class="comment"> *      001：参数格式校验</span></span><br><span class="line"><span class="comment"> *  11: 商品</span></span><br><span class="line"><span class="comment"> *  12: 订单</span></span><br><span class="line"><span class="comment"> *  13: 购物车</span></span><br><span class="line"><span class="comment"> *  14: 物流</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">BizCodeEnume</span> </span>&#123;</span><br><span class="line">    UNKNOW_EXCEPTION(<span class="number">10000</span>,<span class="string">&quot;系统未知异常&quot;</span>),</span><br><span class="line">    VAILD_EXCEPTION(<span class="number">10001</span>,<span class="string">&quot;参数格式校验失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    BizCodeEnume(<span class="keyword">int</span> code,String msg)&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h1
                                    id="%E5%85%AB%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84">
                                    八、商品服务&amp;属性分组</h1>
                                <h2 id="10.1-%E3%80%81%E5%89%8D%E7%AB%AF%E7%BB%84%E4%BB%B6%E6%8A%BD%E5%8F%96-%26-%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E4%BA%A4%E4%BA%92"
                                    id="10-1-、前端组件抽取-父子组件交互">10.1 、前端组件抽取 &amp; 父子组件交互</h2>
                                <h3 id="10.1.1-%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84---%E6%95%88%E6%9E%9C"
                                    id="10-1-1-属性分组-效果">10.1.1 属性分组 - 效果</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020151047887.png"
                                        alt="image-20201020151047887" /></p>
                                <p>左边这个树形空间我们已经写过了，在三级分类的时候编写过，相对应的功能，拖拽，添加，删除等等都已经实现，那我们为什么不把他抽取出一个公共的组件便于其他组件利用？</p>
                                <p>说干就干！</p>
                                <p>在 modules 中新建 common 文件夹，在common中 新建 category.vue</p>
                                <p>category.vue 核心代码</p>
                                <p>抽取需要的结果，多余的结果进行删除</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-tree :data&#x3D;&quot;menus&quot; :props&#x3D;&quot;defaultProps&quot; node-key&#x3D;&quot;catId&quot; ref&#x3D;&quot;menuTree&quot; @node-click&#x3D;&quot;nodeClick&quot;&gt;</span><br><span class="line">  &lt;&#x2F;el-tree&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="10.1.2-layout-%E5%B8%83%E5%B1%80" id="10-1-2-Layout-布局">10.1.2 Layout 布局</h3>
                                <p>通过基础的 24 分栏，迅速简便地创建布局、类似之前学过的bootstrap</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;el-row :gutter&#x3D;&quot;20&quot;&gt;</span><br><span class="line">  &lt;el-col :span&#x3D;&quot;6&quot;&gt;表格&lt;&#x2F;el-col&gt;</span><br><span class="line">  &lt;el-col :span&#x3D;&quot;18&quot;&gt;菜单&lt;&#x2F;el-col&gt;</span><br><span class="line">&lt;&#x2F;el-row&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>左边放表格，右边放菜单</p>
                                <p>引入 category 组件</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">import</span> category <span class="keyword">from</span> <span class="string">&quot;../common/category&quot;</span>;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>并且声明</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">//import引入的组件需要注入到对象中才能使用</span></span><br><span class="line">  components: &#123;</span><br><span class="line">    category</span><br><span class="line">  &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>最后在组件中使用</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;el-col :span&#x3D;&quot;6&quot;&gt;</span><br><span class="line">    &lt;!-- 直接使用--&gt;</span><br><span class="line">   &lt;category @tree-node-click&#x3D;&quot;treenodeclick&quot;&gt;&lt;&#x2F;category&gt;</span><br><span class="line"> &lt;&#x2F;el-col&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>右边菜单使用代码生成器的代码直接引入即可</p>
                                <h3 id="10.1.3-%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92"
                                    id="10-1-3-父子组件如何进行交互">10.1.3 父子组件如何进行交互</h3>
                                <p>子组件中的 Tree 组件的一个事件 node-click 节点被点击时的回调</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">  <span class="comment">// 向父组件发送事件，后面是需要传递的对象，参数等</span></span><br><span class="line"><span class="built_in">this</span>.$emit(<span class="string">&quot;tree-node-click&quot;</span>,data,node,component)</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>父组件需要定义相同方法接收</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;category @tree-node-click&#x3D;&quot;treenodeclick&quot;&gt;&lt;&#x2F;category&gt;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 感知到节点被点击</span></span><br><span class="line">   <span class="function"><span class="title">treenodeclick</span>(<span class="params">node, data, component</span>)</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;attrgroup感知到category节点被点击&quot;</span>);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&quot;刚才被点击的菜单id:&quot;</span> + data.catId);</span><br><span class="line">     <span class="keyword">if</span> (node.level == <span class="number">3</span>) &#123;</span><br><span class="line">       <span class="built_in">this</span>.catId = data.catId;</span><br><span class="line">       <span class="built_in">this</span>.getDataList();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="10.2-%E3%80%81%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7%E5%88%86%E7%B1%BB%E5%88%86%E7%BB%84"
                                    id="10-2-、获取属性分类分组">10.2 、获取属性分类分组</h2>
                                <p>查看提供的接口文档</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020153526835.png"
                                        alt="image-20201020153526835" /></p>
                                <p>请求参数需要我们带对应的分页参数，所以我们在请求的时候得把参数带上</p>
                                <p>那就定义接口 go</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页请求相关参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catelogId 三级分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">PageUtils <span class="title">queryPage</span><span class="params">(Map&lt;String, Object&gt; params, Long catelogId)</span></span>;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>实现类</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPage</span><span class="params">(Map&lt;String, Object&gt; params, Long catelogId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 分类id 等于01 查询全部</span></span><br><span class="line">    <span class="keyword">if</span> (catelogId == <span class="number">0</span>) &#123;</span><br><span class="line">        IPage&lt;AttrGroupEntity&gt; page = <span class="keyword">this</span>.page(<span class="keyword">new</span> Query&lt;AttrGroupEntity&gt;().getPage(params),</span><br><span class="line">                <span class="keyword">new</span> QueryWrapper&lt;AttrGroupEntity&gt;());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 拿到参数中的 key</span></span><br><span class="line">        String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        <span class="comment">// 先根据分类id进行查询</span></span><br><span class="line">        QueryWrapper&lt;AttrGroupEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;AttrGroupEntity&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;catelog_id&quot;</span>,catelogId);</span><br><span class="line">        <span class="comment">// selecet * from attrgroup where catelog_id = ? and (attr_group_id = key or like attr_group_name = key)</span></span><br><span class="line">        <span class="comment">// 有时候查询也不会带上key 所以得判断</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">            <span class="comment">// where条件后加上 and </span></span><br><span class="line">            wrapper.and((obj) -&gt; &#123;</span><br><span class="line">                obj.eq(<span class="string">&quot;attr_group_id&quot;</span>,key).or().like(<span class="string">&quot;attr_group_name&quot;</span>,key);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 组装条件进行查询 </span></span><br><span class="line">        IPage&lt;AttrGroupEntity&gt; page = <span class="keyword">this</span>.page(<span class="keyword">new</span> Query&lt;AttrGroupEntity&gt;().getPage(params),</span><br><span class="line">                wrapper);</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="10.3-%E3%80%81%E5%88%86%E7%B1%BB%E6%96%B0%E5%A2%9E-%26-%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A8"
                                    id="10-3-、分类新增-级联选择器">10.3 、分类新增 &amp; 级联选择器</h2>
                                <p>级联选择器是啥？？ 没接触过</p>
                                <p>官方解释</p>
                                <p><strong>Cascader 级联选择器</strong></p>
                                <p>当一个数据集合有清晰的层级结构时，可通过级联选择器逐级查看并选择。</p>
                                <p>对应效果</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020154619941.png"
                                        alt="image-20201020154619941" /></p>
                                <p>attrgroup-add-or-update.vue 中 加入该组件</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">  &lt;el-cascader</span><br><span class="line">          v-model&#x3D;&quot;dataForm.catelogPath&quot;</span><br><span class="line">           placeholder&#x3D;&quot;试试搜索：手机&quot;</span><br><span class="line">          :options&#x3D;&quot;categorys&quot;</span><br><span class="line">          :props&#x3D;&quot;props&quot;</span><br><span class="line">          filterable</span><br><span class="line">        &gt;&lt;&#x2F;el-cascader&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">placeholder&#x3D;&quot;试试搜索：手机&quot;默认的搜索提示</span><br><span class="line">:options&#x3D;&quot;categorys&quot; 可选项数据源，键名可通过 Props 属性配置</span><br><span class="line">:props&#x3D;&quot;props&quot; 配置选项	</span><br><span class="line"> filterable 是否可搜索选项</span><br><span class="line">--&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>那么问题来了？ 我怎样把数据加载到这个组件里面？</p>
                                <p>在你组件加载完成后，我在调用方法 ( getCategorys() ) 获取菜单数据，在设置到options不就行了吗？</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="title">getCategorys</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.$http(&#123;</span><br><span class="line">      url: <span class="built_in">this</span>.$http.adornUrl(<span class="string">&quot;/product/category/list/tree&quot;</span>),</span><br><span class="line">      method: <span class="string">&quot;get&quot;</span></span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.categorys = data.data;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="10.4-%E3%80%81%E5%88%86%E7%B1%BB%E4%BF%AE%E6%94%B9-%26-%E5%9B%9E%E6%98%BE%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A8"
                                    id="10-4-、分类修改-回显级联选择器">10.4 、分类修改 &amp; 回显级联选择器</h2>
                                <p>修改和新增用的是一个添加组件 那么我们再点击修改后，你如何把 级联显示的数据再次显示出来？</p>
                                <p>在 AttrGroup点击修改后，会触发addOrUpdateHandle方法，他会通过引用 vue 文件里的 addOrUpdate 并调用他的 init初始化方法
                                </p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 新增 / 修改</span></span><br><span class="line">   <span class="function"><span class="title">addOrUpdateHandle</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">     <span class="comment">// 对话框显示</span></span><br><span class="line">     <span class="built_in">this</span>.addOrUpdateVisible = <span class="literal">true</span>;</span><br><span class="line">     <span class="comment">// 要渲染的组件完成选然后 调用该方法</span></span><br><span class="line">     <span class="built_in">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">       <span class="comment">// this 当前 refs 当前所有组件</span></span><br><span class="line">       <span class="built_in">this</span>.$refs.addOrUpdate.init(id);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;,</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>init执行完成会回调</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">.then((&#123; data &#125;) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (data &amp;&amp; data.code === <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.dataForm.attrGroupName = data.attrGroup.attrGroupName;</span><br><span class="line">              <span class="keyword">this</span>.dataForm.sort = data.attrGroup.sort;</span><br><span class="line">              <span class="keyword">this</span>.dataForm.descript = data.attrGroup.descript;</span><br><span class="line">              <span class="keyword">this</span>.dataForm.icon = data.attrGroup.icon;</span><br><span class="line">              <span class="keyword">this</span>.dataForm.catelogId = data.attrGroup.catelogId;</span><br><span class="line">                <span class="comment">// 设置 级联的路径 从数据中取</span></span><br><span class="line">              <span class="keyword">this</span>.dataForm.catelogPath = data.attrGroup.catelogPath;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>后端如何根据分组id 查询出 对应的分类？定义接口</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 找到catelogId的完整路径</span></span><br><span class="line"><span class="comment"> * 【父/子/孙】</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catelogId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Long[] findCatelogPath(Long catelogId);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long[] findCatelogPath(Long catelogId) &#123;</span><br><span class="line">    List&lt;Long&gt; paths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Long&gt; parentPath = findParentPath(catelogId, paths);</span><br><span class="line">    <span class="comment">// 反转</span></span><br><span class="line">    Collections.reverse(parentPath);</span><br><span class="line">    <span class="comment">//转成Long[] 数组返回</span></span><br><span class="line">    <span class="keyword">return</span> parentPath.toArray(<span class="keyword">new</span> Long[parentPath.size()]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归查找</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catelogId 三级分类的id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paths 路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Long&gt; <span class="title">findParentPath</span><span class="params">(Long catelogId,List&lt;Long&gt; paths)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、收集当前节点id</span></span><br><span class="line">    paths.add(catelogId);</span><br><span class="line">    <span class="comment">// 2、通过分类id拿到 Category 对象</span></span><br><span class="line">    CategoryEntity byId = <span class="keyword">this</span>.getById(catelogId);</span><br><span class="line">    <span class="comment">// 3、如果不是根节点 就一直递归下去查找</span></span><br><span class="line">    <span class="keyword">if</span> (byId.getParentCid() != <span class="number">0</span>) &#123;</span><br><span class="line">        findParentPath(byId.getParentCid(),paths);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> paths;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>在 AttrGroupEntity 中 添加了一个新属性</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于存放 级联显示的 父子孙的地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@TableField(exist = false)</span> <span class="comment">// 标注为false 表是不是数据库字段</span></span><br><span class="line"><span class="keyword">private</span> Long[] catelogPath;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Controller 具体设置返回数据</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 信息</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/info/&#123;attrGroupId&#125;&quot;)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> R <span class="title">info</span><span class="params">(<span class="meta">@PathVariable(&quot;attrGroupId&quot;)</span> Long attrGroupId)</span></span>&#123;</span><br><span class="line">     <span class="comment">// 根据id查询出 分组group对象</span></span><br><span class="line">AttrGroupEntity attrGroup = attrGroupService.getById(attrGroupId);</span><br><span class="line"><span class="comment">// 拿到分类id</span></span><br><span class="line">     Long catelogId = attrGroup.getCatelogId();</span><br><span class="line">     <span class="comment">// 根据分类id查询出 他的 父 子 孙 对应的数据,并且设置到 attrGroup对象</span></span><br><span class="line">     Long[] catelogPath = categoryService.findCatelogPath(catelogId);</span><br><span class="line">     attrGroup.setCatelogPath(catelogPath);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> R.ok().put(<span class="string">&quot;attrGroup&quot;</span>, attrGroup);</span><br><span class="line"> &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="10.5%E3%80%81%E5%93%81%E7%89%8C%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94%E4%B8%8E%E7%BA%A7%E8%81%94%E6%9B%B4%E6%96%B0"
                                    id="10-5、品牌分类关联与级联更新">10.5、品牌分类关联与级联更新</h2>
                                <h3 id="10.5.1%E3%80%81%E5%AE%9E%E7%8E%B0%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86%E6%90%9C%E7%B4%A2"
                                    id="10-5-1、实现品牌管理搜索">10.5.1、实现品牌管理搜索</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201020120929362.png"
                                        alt="image-20201020120929362" /></p>
                                <p>在原本查询中加入新功能</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 1、获取key</span></span><br><span class="line">       String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">       QueryWrapper&lt;BrandEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">       <span class="comment">// key不为空 brand_id 和 name 进行值匹配 </span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">           wrapper.eq(<span class="string">&quot;brand_id&quot;</span>,key).or().like(<span class="string">&quot;name&quot;</span>,key);</span><br><span class="line">       &#125;</span><br><span class="line">       IPage&lt;BrandEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">               <span class="keyword">new</span> Query&lt;BrandEntity&gt;().getPage(params),</span><br><span class="line">               wrapper</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>我们是直接把数据表存进了中间表,如果在真正的品牌名和分类名进行了修改，那么此时中间表的数据就是不对的，这时候数据就不是一致性</p>
                                <p>解决</p>
                                <p>在进行修改的时候，也要把中间表的数据进行更改</p>
                                <p>Brand</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// BrandController</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">      /**</span></span><br><span class="line"><span class="comment">     * 修改</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">update</span><span class="params">(<span class="meta">@Validated(UpdateGroup.class)</span> <span class="meta">@RequestBody</span> BrandEntity brand)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">		brandService.updateDetail(brand);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateDetail</span><span class="params">(BrandEntity brand)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保证字段一致</span></span><br><span class="line">    <span class="comment">// 根据id更改</span></span><br><span class="line">    <span class="keyword">this</span>.updateById(brand);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(brand.getName())) &#123;</span><br><span class="line">        <span class="comment">// 同步更新其他关联表中的数据</span></span><br><span class="line">        categoryBrandRelationService.updateBrand(brand.getBrandId(),brand.getName());</span><br><span class="line">        <span class="comment">// TODO 更新其他关联</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Service实现类</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateBrand</span><span class="params">(Long brandId, String name)</span> </span>&#123;</span><br><span class="line">        CategoryBrandRelationEntity relationEntity = <span class="keyword">new</span> CategoryBrandRelationEntity();</span><br><span class="line">        relationEntity.setBrandName(name);</span><br><span class="line">        relationEntity.setBrandId(brandId);</span><br><span class="line">        <span class="keyword">this</span>.update(relationEntity,<span class="keyword">new</span> UpdateWrapper&lt;CategoryBrandRelationEntity&gt;().eq(<span class="string">&quot;brand_id&quot;</span>,brandId));</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Category</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCascate</span><span class="params">(CategoryEntity category)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.updateById(category);</span><br><span class="line">    categoryBrandRelationService.updateCategory(category.getCatId(),category.getName());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Service </span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCascate</span><span class="params">(CategoryEntity category)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新自己表对象</span></span><br><span class="line">        <span class="keyword">this</span>.updateById(category);</span><br><span class="line">        <span class="comment">// 更新关联表对象</span></span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(),category.getName());</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h1
                                    id="%E4%B9%9D%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%B9%B3%E5%8F%B0%E5%B1%9E%E6%80%A7">
                                    九、商品服务&amp;平台属性</h1>
                                <h2 id="object%E5%88%92%E5%88%86" id="Object划分">Object划分</h2>
                                <h5 id="1%E3%80%81po-(persistant-object)-%E6%8C%81%E4%B9%85%E5%8C%96%E5%AF%B9%E8%B1%A1"
                                    id="1、PO-persistant-object-持久化对象">1、PO (persistant object) 持久化对象</h5>
                                <p>po 就是对应数据库中某一个表的一条记录，多个记录可以用 PO 的集合，PO 中应该不包含任何对数据库到操作</p>
                                <h5 id="2%E3%80%81do-(-domain-object)-%E9%A2%86%E5%9F%9F%E5%AF%B9%E8%B1%A1"
                                    id="2、DO-Domain-Object-领域对象">2、DO ( Domain Object) 领域对象</h5>
                                <p>就是从现实世界抽象出来的有形或无形的业务实体</p>
                                <h5 id="3%E3%80%81to-(transfer-object)-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1"
                                    id="3、TO-Transfer-Object-数据传输对象">3、TO (Transfer Object) 数据传输对象</h5>
                                <p>不同的应用程序之间传输的对象</p>
                                <h5 id="4%E3%80%81dto-(data-transfer-object)-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1"
                                    id="4、DTO-Data-Transfer-Object-数据传输对象">4、DTO (Data Transfer Object) 数据传输对象</h5>
                                <p>这个概念来源于 J2EE 的设计模式，原来的目的是为了
                                    EJB的分布式应用提供粗粒度的数据实体，以减少分布式调用的次数，从而提高分数调用的性能和降低网络负载，但在这里，泛指用于展示层与服务层之间的数据传输对象</p>
                                <h5 id="5%E3%80%81vo(value-object)-%E5%80%BC%E5%AF%B9%E8%B1%A1"
                                    id="5、VO-value-object-值对象">5、VO(value object) 值对象</h5>
                                <p>通常用于业务层之间的数据传递，和 PO 一样也是仅仅包含数据而已，但应是抽象出的业务对象，可以和表对应，也可以不，这根据业务的需要，用 new 关键字创建，由 GC 回收
                                </p>
                                <p>view Object 试图对象</p>
                                <p>接受页面传递来的数据，封装对象，封装页面需要用的数据</p>
                                <h5 id="6%E3%80%81bo(business-object)-%E4%B8%9A%E5%8A%A1%E5%AF%B9%E8%B1%A1"
                                    id="6、BO-business-object-业务对象">6、BO(business object) 业务对象</h5>
                                <p>从业务模型的角度看，见 UML 原件领域模型中的领域对象，封装业务逻辑的， java 对象，通过调用 DAO 方法，结合 PO VO,进行业务操作，business
                                    object 业务对象，主要作用是把业务逻辑封装成一个对象，这个对象包括一个或多个对象，比如一个简历，有教育经历，工作经历，社会关系等等，我们可以把教育经历对应一个
                                    PO 、工作经验对应一个 PO、 社会关系对应一个 PO, 建立一个对应简历的的 BO 对象处理简历，每 个 BO 包含这些 PO ,这样处理业务逻辑时，我们就可以针对
                                    BO 去处理</p>
                                <h5 id="7%E3%80%81pojo-(-plain-ordinary-java-object)-%E7%AE%80%E5%8D%95%E6%97%A0%E8%A7%84%E5%88%99-java-%E5%AF%B9%E8%B1%A1"
                                    id="7、POJO-plain-ordinary-java-object-简单无规则-java-对象">7、POJO ( plain ordinary java
                                    object) 简单无规则 java 对象</h5>
                                <p>传统意义的 java 对象，就是说一些 Object/Relation Mapping 工具中，能够做到维护数据库表记录的 persisent object
                                    完全是一个符合 Java Bean 规范的 纯 java 对象，没有增加别的属性和方法，我们的理解就是最基本的 Java bean 只有属性字段 setter 和
                                    getter 方法</p>
                                <p>POJO 时是 DO/DTO/BO/VO 的统称</p>
                                <h5 id="8%E3%80%81dao%EF%BC%88data-access-object%EF%BC%89-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1"
                                    id="8、DAO（data-access-object）-数据访问对象">8、DAO（data access object） 数据访问对象</h5>
                                <p>是一个 sun 的一个标准 j2ee 设计模式，这个模式有个接口就是 DAO ，他负持久层的操作，为业务层提供接口，此对象用于访问数据库，通常和 PO 结合使用，DAO
                                    中包含了各种数据库的操作方法，通过它的方法，结合 PO 对数据库进行相关操作，夹在业务逻辑与数据库资源中间，配合VO 提供数据库的 CRUD 功能</p>
                                <h2 id="11.1-%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E6%96%B0%E5%A2%9E%E4%B8%8Evo"
                                    id="11-1-规格参数新增与VO">11.1 规格参数新增与VO</h2>
                                <h3 id="11.1.1-%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0"
                                    id="11-1-1-获取分类规格参数">11.1.1 获取分类规格参数</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>查询的数据没有分类和分组</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201021051239049.png"
                                        alt="image-20201021051239049" /></p>
                                <p>属性分类 和 所属分组居然没有数据？</p>
                                <p>先查看返回的数据</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201021051433485.png"
                                        alt="image-20201021051433485" /></p>
                                <p>发现没有 catelogName 和 AttrGroupName 的数据！！ 原因是 AttrEntity没有这两个属性</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201021051653178.png"
                                        alt="image-20201021051653178" /></p>
                                <p>但是他关联了 pms_attr_attrgroup_relation 表 这个表里面有 attr_Group_id 那么思路来了？</p>
                                <p>1、我先用 attr_id 去 pms_attr_attrgroup_relation中查询出 attr_Group_id 然后通过
                                    attr_Group_id去pms_attr_group 表中查询出 分组的名称</p>
                                <p>2、自身 attr表中有 catelog_id 那我根据这个id去 category表中查询到 分类的姓名 不就行了吗？</p>
                                <p>上代码</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryBaseAttrPage</span><span class="params">(Map&lt;String, Object&gt; params, Long catelogId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;AttrEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (catelogId != <span class="number">0</span>) &#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;catelog_id&quot;</span>,catelogId);</span><br><span class="line">    &#125;</span><br><span class="line">    String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">        wrapper.and((wrapper1) -&gt; &#123;</span><br><span class="line">            wrapper1.eq(<span class="string">&quot;attr_id&quot;</span>,key).or().like(<span class="string">&quot;attr_name&quot;</span>,key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    IPage&lt;AttrEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">            <span class="keyword">new</span> Query&lt;AttrEntity&gt;().getPage(params),</span><br><span class="line">            wrapper</span><br><span class="line">    );</span><br><span class="line">    PageUtils pageUtils = <span class="keyword">new</span> PageUtils(page);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到分页记录</span></span><br><span class="line">    List&lt;AttrEntity&gt; records = page.getRecords();</span><br><span class="line"></span><br><span class="line">    List&lt;AttrRespVo&gt; respVo = records.stream().map((attrEntity) -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        AttrRespVo attrRespVo = <span class="keyword">new</span> AttrRespVo();</span><br><span class="line">        BeanUtils.copyProperties(attrEntity, attrRespVo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1、设置分类和分组的名字</span></span><br><span class="line">        AttrAttrgroupRelationEntity attr_idEntity = relationDao.selectOne(<span class="keyword">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;attr_id&quot;</span>, attrEntity.getAttrId()));</span><br><span class="line">        <span class="keyword">if</span> (attr_idEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            AttrGroupEntity attrGroupEntity = attrGroupDao.selectById(attr_idEntity.getAttrGroupId());</span><br><span class="line">            attrRespVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">        &#125;</span><br><span class="line">        CategoryEntity categoryEntity = categoryDao.selectById(attrEntity.getCatelogId());</span><br><span class="line">        <span class="keyword">if</span> (categoryEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            attrRespVo.setCatelogName(categoryEntity.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> attrRespVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    pageUtils.setList(respVo);</span><br><span class="line">    <span class="keyword">return</span> pageUtils;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>但是原先的 AttrEntity 对象里面任然没有这两个属性 ! 怎么解决</p>
                                <p>1、我直接在 AttrEntity中新建对应的字段不就行了吗？ 然后设置成不是数据库的字段</p>
                                <p>缺点：<strong>这样子是不是太乱了？</strong></p>
                                <p>2、新建一个 VO 抽取出这两个属性 不就行了吗？</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttrRespVo</span> <span class="keyword">extends</span> <span class="title">AttrVo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * catelogName 手机数码，所属分类名字</span></span><br><span class="line"><span class="comment">     * groupName 主体 所属分组名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String catelogName;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="11.2-%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8%26%E8%A7%84%E6%A0%BC%E4%BF%AE%E6%94%B9"
                                    id="11-2-规格参数列表-规格修改">11.2 规格参数列表&amp;规格修改</h2>
                                <h4 id="11.2.1%E3%80%81%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0"
                                    id="11-2-1、获取分类规格参数">11.2.1、获取分类规格参数</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取分类规格参数</span></span><br><span class="line"><span class="comment"> 	attrType 和 catelogId 通用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catelogId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type  sale 销售属性 base 规格参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;attrType&#125;/list/&#123;catelogId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">baseAttrList</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String,Object&gt; params</span></span></span><br><span class="line"><span class="function"><span class="params">        ,<span class="meta">@PathVariable(&quot;catelogId&quot;)</span> Long catelogId,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="meta">@PathVariable(&quot;attrType&quot;)</span> String  type)</span> </span>&#123;</span><br><span class="line">    PageUtils page = attrService.queryBaseAttrPage(params,catelogId,type);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>,page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>实现类</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryBaseAttrPage</span><span class="params">(Map&lt;String, Object&gt; params, Long catelogId, String type)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 先根据 attr_type字段进行查询 该字段表示 1是基本属性 0是销售属性，基本属性和销售属性我们放在一张表内</span></span><br><span class="line">       QueryWrapper&lt;AttrEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;AttrEntity&gt;()</span><br><span class="line">               .eq(<span class="string">&quot;attr_type&quot;</span>,<span class="string">&quot;base&quot;</span>.equalsIgnoreCase(type)?</span><br><span class="line">                       ProductConstant.AttrEnum.ATTR_TYPE_BASE.getCode():</span><br><span class="line">                       ProductConstant.AttrEnum.ATTR_TYPE_SALE.getCode());</span><br><span class="line">       <span class="comment">// 分类id不等于0 按照分类id进行查询</span></span><br><span class="line">       <span class="keyword">if</span> (catelogId != <span class="number">0</span>) &#123;</span><br><span class="line">           wrapper.eq(<span class="string">&quot;catelog_id&quot;</span>,catelogId);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 取出参数 key,进行条件查询</span></span><br><span class="line">       String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">           wrapper.and((wrapper1) -&gt; &#123;</span><br><span class="line">               wrapper1.eq(<span class="string">&quot;attr_id&quot;</span>,key).or().like(<span class="string">&quot;attr_name&quot;</span>,key);</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 封装分页数据</span></span><br><span class="line">       IPage&lt;AttrEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">               <span class="keyword">new</span> Query&lt;AttrEntity&gt;().getPage(params),</span><br><span class="line">               wrapper</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       PageUtils pageUtils = <span class="keyword">new</span> PageUtils(page);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 拿到全部的分页记录</span></span><br><span class="line">       List&lt;AttrEntity&gt; records = page.getRecords();</span><br><span class="line">       <span class="comment">// 查询所属分类以及所属分组</span></span><br><span class="line">       List&lt;AttrRespVo&gt; respVo = records.stream().map((attrEntity) -&gt; &#123;</span><br><span class="line">           <span class="comment">// 实例化数据传输对象 将 attrEntity的分类名字以及分组名字 复制到该对象</span></span><br><span class="line">           AttrRespVo attrRespVo = <span class="keyword">new</span> AttrRespVo();</span><br><span class="line">           BeanUtils.copyProperties(attrEntity, attrRespVo);</span><br><span class="line">           <span class="comment">// Controller地址如果是 基础 才进行查询分裂</span></span><br><span class="line">           <span class="keyword">if</span>(<span class="string">&quot;base&quot;</span>.equalsIgnoreCase(type))&#123;</span><br><span class="line">               <span class="comment">// 1、根据attr_id 查询到 attr和 attrGroup的关系表</span></span><br><span class="line">               AttrAttrgroupRelationEntity attr_idEntity = relationDao.selectOne(<span class="keyword">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;()</span><br><span class="line">                       .eq(<span class="string">&quot;attr_id&quot;</span>, attrEntity.getAttrId()));</span><br><span class="line">               <span class="comment">//查询到的关系对象以及分组id不为空</span></span><br><span class="line">               <span class="keyword">if</span> (attr_idEntity != <span class="keyword">null</span> &amp;&amp; attr_idEntity.getAttrGroupId()!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// 根据分组id查询到分组信息</span></span><br><span class="line">                   AttrGroupEntity attrGroupEntity = attrGroupDao.selectById(attr_idEntity.getAttrGroupId());</span><br><span class="line">                   attrRespVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 根据attrEntity的分类id 查询到分类对象并设置分类姓名</span></span><br><span class="line">           CategoryEntity categoryEntity = categoryDao.selectById(attrEntity.getCatelogId());</span><br><span class="line">           <span class="keyword">if</span> (categoryEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">               attrRespVo.setCatelogName(categoryEntity.getName());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> attrRespVo;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line">       <span class="comment">//封装到分页工具类</span></span><br><span class="line">       pageUtils.setList(respVo);</span><br><span class="line">       <span class="keyword">return</span> pageUtils;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>先是根据 <code>catelog_id</code>查询到<code>AttrEntity</code> 对象 该对象里拥有 <code>attr_id</code>
                                    然后根据attr_id 去 <code>pms_attr_attrgroup_relation</code>表进行查询</p>
                                <h4 id="11.2.2%E3%80%81%E6%9F%A5%E8%AF%A2%E5%B1%9E%E6%80%A7%E8%AF%A6%E6%83%85"
                                    id="11-2-2、查询属性详情">11.2.2、查询属性详情</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201022154745658.png"
                                        alt="image-20201022154745658" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 信息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping(&quot;/info/&#123;attrId&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> R <span class="title">info</span><span class="params">(<span class="meta">@PathVariable(&quot;attrId&quot;)</span> Long attrId)</span></span>&#123;</span><br><span class="line">AttrRespVo attr = attrService.getAttrInfo(attrId);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> R.ok().put(<span class="string">&quot;attr&quot;</span>, attr);</span><br><span class="line">  &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service 实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AttrRespVo <span class="title">getAttrInfo</span><span class="params">(Long attrId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 实例化封装VO数据对象</span></span><br><span class="line">    AttrRespVo attrRespVo = <span class="keyword">new</span> AttrRespVo();</span><br><span class="line">    <span class="comment">// 根据attrid查询出商品属性</span></span><br><span class="line">    AttrEntity attrEntity = <span class="keyword">this</span>.getById(attrId);</span><br><span class="line">    <span class="comment">// 将商品属性对象的属性复制到 VO数据对象</span></span><br><span class="line">    BeanUtils.copyProperties(attrEntity, attrRespVo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  attrType == 1为基本类型才进行查询分组信息</span></span><br><span class="line">    <span class="keyword">if</span> (attrEntity.getAttrType() == ProductConstant.AttrEnum.ATTR_TYPE_BASE.getCode()) &#123;</span><br><span class="line">        <span class="comment">// 根据 attr_id 查询到 商品属性以及商品分组关系表</span></span><br><span class="line">        AttrAttrgroupRelationEntity relationEntity = relationDao.selectOne(<span class="keyword">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;attr_id&quot;</span>, attrId));</span><br><span class="line">        <span class="keyword">if</span> (relationEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置分组id</span></span><br><span class="line">            attrRespVo.setAttrGroupId(relationEntity.getAttrGroupId());</span><br><span class="line">            <span class="comment">// 分组&amp;商品信息关系表拿到分组id 查询到分组对象</span></span><br><span class="line">            AttrGroupEntity attrGroupEntity = attrGroupDao.selectById(relationEntity.getAttrGroupId());</span><br><span class="line">            <span class="keyword">if</span> (attrGroupEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//不为空设置分组姓名</span></span><br><span class="line">                attrRespVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从当前商品属性对象中拿到分类id进行设置分类信息</span></span><br><span class="line">    Long catelogId = attrEntity.getCatelogId();</span><br><span class="line">    <span class="comment">// 根据 catelogId 查询到分类 父 子 孙 路径</span></span><br><span class="line">    Long[] catelogPath = categoryService.findCatelogPath(catelogId);</span><br><span class="line">    attrRespVo.setCatelogPath(catelogPath);</span><br><span class="line">    <span class="comment">//最后根据分类id 查询到分类对象 并进行设置分类姓名</span></span><br><span class="line">    CategoryEntity categoryEntity = categoryService.getById(catelogId);</span><br><span class="line">    <span class="keyword">if</span> (categoryEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        attrRespVo.setCatelogName(categoryEntity.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attrRespVo;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>主要理解： 先是根据 <code>attrId</code> 查询到<strong>商品属性</strong> 然后根据 attrId
                                    查询到<strong>分类关系表</strong> 该表中有分组id attrGroup_id 通过这个查询到 <strong>分组对象信息</strong>，</p>
                                <p>，同时在 商品属性表中拿到 分类id 通过<strong>分类id 查询到 查询到分类对象</strong> 同时根据
                                    分类id查询对应层级关系，并设置<strong>分类姓名</strong></p>
                                <h4 id="11.3.3%E3%80%81%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7" id="11-3-3、销售属性">
                                    11.3.3、销售属性</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201022155557579.png"
                                        alt="image-20201022155557579" /></p>
                                <p>销售属性 和 基本属性 通过一个字段来区分，对应的修改，查询 都用的同一个方法，所以在方法的中 也进行了对应的判断</p>
                                <p>保存</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAttr</span><span class="params">(AttrVo attr)</span> </span>&#123;</span><br><span class="line">    AttrEntity attrEntity = <span class="keyword">new</span> AttrEntity();</span><br><span class="line">    BeanUtils.copyProperties(attr, attrEntity);</span><br><span class="line">    <span class="comment">// 保存基本数据</span></span><br><span class="line">    <span class="keyword">this</span>.save(attrEntity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、保存关联关系</span></span><br><span class="line">    <span class="comment">// 等于1 说明基本属性 才进行保存分组关系</span></span><br><span class="line">    <span class="keyword">if</span> (attr.getAttrType() == ProductConstant.AttrEnum.ATTR_TYPE_BASE.getCode() &amp;&amp; attr.getAttrGroupId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        AttrAttrgroupRelationEntity relationEntity = <span class="keyword">new</span> AttrAttrgroupRelationEntity();</span><br><span class="line">        relationEntity.setAttrGroupId(attr.getAttrGroupId());</span><br><span class="line">        relationEntity.setAttrId(attrEntity.getAttrId());</span><br><span class="line">        relationDao.insert(relationEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>修改</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAttr</span><span class="params">(AttrVo attr)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Vo数据传输对象属性拷贝到 attrEntity对象</span></span><br><span class="line">       AttrEntity attrEntity = <span class="keyword">new</span> AttrEntity();</span><br><span class="line">       BeanUtils.copyProperties(attr, attrEntity);</span><br><span class="line">       <span class="keyword">this</span>.updateById(attrEntity);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// attrType 等于 1 也就是基本属性</span></span><br><span class="line">       <span class="keyword">if</span> (attrEntity.getAttrType() == ProductConstant.AttrEnum.ATTR_TYPE_BASE.getCode()) &#123;</span><br><span class="line">           <span class="comment">//1、修改分组关联</span></span><br><span class="line">           AttrAttrgroupRelationEntity relationEntity = <span class="keyword">new</span> AttrAttrgroupRelationEntity();</span><br><span class="line">           <span class="comment">// 设置attrid 以及 分组id</span></span><br><span class="line">           relationEntity.setAttrId(attr.getAttrId());</span><br><span class="line">           relationEntity.setAttrGroupId(attr.getAttrGroupId());</span><br><span class="line">           <span class="comment">// 关系表中根据attr_id 进行更新</span></span><br><span class="line">           relationDao.update(relationEntity, <span class="keyword">new</span> UpdateWrapper&lt;AttrAttrgroupRelationEntity&gt;().</span><br><span class="line">                   eq(<span class="string">&quot;attr_id&quot;</span>, attr.getAttrId()));</span><br><span class="line">           <span class="comment">// 根据 attr_id 是否可以查询到结果</span></span><br><span class="line">           Integer count = relationDao.selectCount(<span class="keyword">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;().</span><br><span class="line">                   eq(<span class="string">&quot;attr_id&quot;</span>, attr.getAttrId()));</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// 查得到</span></span><br><span class="line">           <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="comment">// 进行更新</span></span><br><span class="line">               relationDao.update(relationEntity, <span class="keyword">new</span> UpdateWrapper&lt;AttrAttrgroupRelationEntity&gt;().</span><br><span class="line">                       eq(<span class="string">&quot;attr_id&quot;</span>, attr.getAttrId()));</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 查不到意味着 没有该记录 则进行插入</span></span><br><span class="line">               relationDao.insert(relationEntity);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="11.3-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94%E5%B1%9E%E6%80%A7%26%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94%26%E6%9F%A5%E8%AF%A2%E5%88%86%E7%BB%84%E6%9C%AA%E5%85%B3%E8%81%94%E5%B1%9E%E6%80%A7"
                                    id="11-3-查询分类关联属性-删除关联-查询分组未关联属性">11.3 查询分类关联属性&amp;删除关联&amp;查询分组未关联属性</h2>
                                <h4 id="11.3.1%E3%80%81%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84%E7%9A%84%E5%85%B3%E8%81%94%E7%9A%84%E6%89%80%E6%9C%89%E5%B1%9E%E6%80%A7"
                                    id="11-3-1、获取属性分组的关联的所有属性">11.3.1、获取属性分组的关联的所有属性</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取属性分组的关联的所有属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrgroupId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;attrgroupId&#125;/attr/relation&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">attrRelation</span><span class="params">(<span class="meta">@PathVariable(&quot;attrgroupId&quot;)</span> Long attrgroupId)</span> </span>&#123;</span><br><span class="line">    List&lt;AttrEntity&gt; entityList = attrService.getRelationAttr(attrgroupId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, entityList);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service 实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据分组id查找关联的所有基本属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrgroupId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;AttrEntity&gt; <span class="title">getRelationAttr</span><span class="params">(Long attrgroupId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据attr_group_id 查询到 关系表</span></span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; entities = relationDao.selectList(<span class="keyword">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;()</span><br><span class="line">            .eq(<span class="string">&quot;attr_group_id&quot;</span>, attrgroupId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从关系表中 取到 属性id</span></span><br><span class="line">    List&lt;Long&gt; attrIds = entities.stream().map((attr) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">if</span> (attrIds == <span class="keyword">null</span> || attrIds.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按照属性id进行查询</span></span><br><span class="line">    Collection&lt;AttrEntity&gt; attrEntities = <span class="keyword">this</span>.listByIds(attrIds);</span><br><span class="line">    <span class="keyword">return</span> (List&lt;AttrEntity&gt;) attrEntities;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201022161654834.png"
                                        alt="image-20201022161654834" /></p>
                                <p>已知有参数 attr_group_id 进行查询 能查到 attr_id,在利用 attr_id 查询到 attr相关信息</p>
                                <h4 id="11.3.2%E3%80%81%E5%88%A0%E9%99%A4%E5%B1%9E%E6%80%A7%E4%B8%8E%E5%88%86%E7%BB%84%E7%9A%84%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB"
                                    id="11-3-2、删除属性与分组的关联关系">11.3.2、删除属性与分组的关联关系</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201022162103501.png"
                                        alt="image-20201022162103501" /></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除属性与分组的关联关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> relationVo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/attr/relation/delete&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">deleteRelation</span><span class="params">(<span class="meta">@RequestBody</span> AttrGroupRelationVo[] relationVo)</span> </span>&#123;</span><br><span class="line">    attrService.deleteRelation(relationVo);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service 实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteRelation</span><span class="params">(AttrGroupRelationVo[] relationVo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 转成 list 进行stream流处理</span></span><br><span class="line">       List&lt;AttrAttrgroupRelationEntity&gt; entities = Arrays.asList(relationVo).stream().map((item) -&gt; &#123;</span><br><span class="line">           <span class="comment">// 将 item对应属性拷贝到 relationEntity对象中</span></span><br><span class="line">           AttrAttrgroupRelationEntity relationEntity = <span class="keyword">new</span> AttrAttrgroupRelationEntity();</span><br><span class="line">           BeanUtils.copyProperties(item, relationEntity);</span><br><span class="line">           <span class="keyword">return</span> relationEntity;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line">       <span class="comment">// id批量删除</span></span><br><span class="line">       relationDao.deleteBatchRelation(entities);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>deleteBatchRelation 方法</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteBatchRelation&quot;</span>&gt;</span></span><br><span class="line">    DELETE FROM `pms_attr_attrgroup_relation` WHERE </span><br><span class="line">    &lt;!- 循环遍历进行删除 使用的是 or--&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;entities&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">separator</span>=<span class="string">&quot; OR &quot;</span>&gt;</span></span><br><span class="line">        ( attr_id=#&#123;item.attrId&#125; AND attr_group_id=#&#123;item.attrGroupId&#125; )</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="11.3.3%E3%80%81%E6%9F%A5%E8%AF%A2%E5%88%86%E7%BB%84%E6%9C%AA%E5%85%B3%E8%81%94%E5%B1%9E%E6%80%A7"
                                    id="11-3-3、查询分组未关联属性">11.3.3、查询分组未关联属性</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;attrgroupId&#125;/noattr/relation&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">attrNoRelation</span><span class="params">(<span class="meta">@PathVariable(&quot;attrgroupId&quot;)</span> Long attrgroupId,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">    PageUtils page = attrService.getNoRelationAttr(params,attrgroupId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>,page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">getNoRelationAttr</span><span class="params">(Map&lt;String, Object&gt; params, Long attrgroupId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、当前分组只能关联自己所属分类里面的所有属性</span></span><br><span class="line">    AttrGroupEntity attrGroupEntity = attrGroupDao.selectById(attrgroupId);</span><br><span class="line">    Long catelogId = attrGroupEntity.getCatelogId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、当前分组只能关联别的分组没有引用的属性</span></span><br><span class="line">    <span class="comment">//2.1 当前分类下的 **其他分组** 根据分类id进行查询</span></span><br><span class="line">    List&lt;AttrGroupEntity&gt; group = attrGroupDao.selectList(<span class="keyword">new</span> QueryWrapper&lt;AttrGroupEntity&gt;()</span><br><span class="line">            .eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId));</span><br><span class="line">    <span class="comment">// 拿到分组id</span></span><br><span class="line">    List&lt;Long&gt; collect = group.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getAttrGroupId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.2 这些分组关联的属性  根据分组id查询出关联表</span></span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; groupId = relationDao.selectList(<span class="keyword">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;()</span><br><span class="line">            .in(<span class="string">&quot;attr_group_id&quot;</span>, collect));</span><br><span class="line">    <span class="comment">// 拿到所有的属性id</span></span><br><span class="line">    List&lt;Long&gt; attrIds = groupId.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.3 从当前分类的所有属性中移除这些属性</span></span><br><span class="line">    QueryWrapper&lt;AttrEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;AttrEntity&gt;()</span><br><span class="line">            .eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId)</span><br><span class="line">            .eq(<span class="string">&quot;attr_type&quot;</span>, ProductConstant.AttrEnum.ATTR_TYPE_BASE.getCode());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// attrIds 属性id数组不为空</span></span><br><span class="line">    <span class="keyword">if</span> (attrIds != <span class="keyword">null</span> &amp;&amp; attrIds.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 在attrids 数组中得id不用进行查询</span></span><br><span class="line">        wrapper.notIn(<span class="string">&quot;attr_id&quot;</span>, attrIds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取出参数进行 对应条件查询</span></span><br><span class="line">    String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">        wrapper.and((w) -&gt; &#123;</span><br><span class="line">            w.eq(<span class="string">&quot;attr_id&quot;</span>, key).or().like(<span class="string">&quot;attr_name&quot;</span>, key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据分页数据 以及 wrapper进行查询</span></span><br><span class="line">    IPage&lt;AttrEntity&gt; page = <span class="keyword">this</span>.page(<span class="keyword">new</span> Query&lt;AttrEntity&gt;().getPage(params), wrapper);</span><br><span class="line">    PageUtils pageUtils = <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">    <span class="keyword">return</span> pageUtils;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="11.4.4%E3%80%81%E6%96%B0%E5%A2%9E%E5%88%86%E7%BB%84%E4%B8%8E%E5%B1%9E%E6%80%A7%E5%85%B3%E8%81%94"
                                    id="11-4-4、新增分组与属性关联">11.4.4、新增分组与属性关联</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@PostMapping(&quot;/attr/relation&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span>  R <span class="title">addRelation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;AttrGroupRelationVo&gt; attrGroupRelationVo)</span> </span>&#123;</span><br><span class="line">    attrAttrgroupRelationService.saveBatch(attrGroupRelationVo);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBatch</span><span class="params">(List&lt;AttrGroupRelationVo&gt; attrGroupRelationVo)</span> </span>&#123;</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; collect = attrGroupRelationVo.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="comment">// 复制属性 返回</span></span><br><span class="line">        AttrAttrgroupRelationEntity relationEntity = <span class="keyword">new</span> AttrAttrgroupRelationEntity();</span><br><span class="line">        BeanUtils.copyProperties(item, relationEntity);</span><br><span class="line">        <span class="keyword">return</span> relationEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">this</span>.saveBatch(collect);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>业务之间需要多种测试 各种判断</p>
                                <h1
                                    id="%E5%8D%81%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E6%96%B0%E5%A2%9E%E5%95%86%E5%93%81">
                                    十、商品服务&amp;新增商品</h1>
                                <h2 id="12.1-%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94%E7%9A%84%E5%93%81%E7%89%8C"
                                    id="12-1-获取分类关联的品牌">12.1 获取分类关联的品牌</h2>
                                <p>前端发送请求</p>
                                <p>后端编写：</p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  获取分类关联的品牌</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/brands/list&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">relationBrandList</span><span class="params">(<span class="meta">@RequestParam(value = &quot;catId&quot;,required = true)</span> Long catId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;BrandEntity&gt; vos = categoryBrandRelationService.getBrandCatId(catId);</span><br><span class="line">    <span class="comment">//拿到 品牌对象数据后 从中抽取除 品牌姓名和id</span></span><br><span class="line">    List&lt;BrandVo&gt; collect = vos.stream().map(item -&gt; &#123;</span><br><span class="line">        BrandVo brandVo = <span class="keyword">new</span> BrandVo();</span><br><span class="line">        brandVo.setBrandId(item.getBrandId());</span><br><span class="line">        brandVo.setBrandName(item.getName());</span><br><span class="line">        <span class="keyword">return</span> brandVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>,collect);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BrandEntity&gt; <span class="title">getBrandCatId</span><span class="params">(Long catId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据分类id查询出 分类和品牌的关系表</span></span><br><span class="line">    List&lt;CategoryBrandRelationEntity&gt; catelogId = categoryBrandRelationDao.selectList(<span class="keyword">new</span> QueryWrapper&lt;CategoryBrandRelationEntity&gt;().eq(<span class="string">&quot;catelog_id&quot;</span>, catId));</span><br><span class="line"></span><br><span class="line">    List&lt;BrandEntity&gt; collect = catelogId.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="comment">//根据品牌id查询出品牌对象</span></span><br><span class="line">        BrandEntity brandEntity = brandDao.selectById(item.getBrandId());</span><br><span class="line">        <span class="keyword">return</span> brandEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>总结：</p>
                                </blockquote>
                                <p>业务操作设计两个表</p>
                                <ul>
                                    <li>pms_brand</li>
                                    <li>pms_category_brand_relation</li>
                                </ul>
                                <p>请求参数是 CatId Long类型</p>
                                <ul>
                                    <li>先根据 CatId 在 pms_category_brand_relation表中查询到品牌 Id</li>
                                    <li>拿到 brand_id 查询出 brand 的相关信息</li>
                                    <li>组装成 BrandVo 后 返回</li>
                                </ul>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201023052748618.png"
                                        alt="image-20201023052748618" /></p>
                                <h2 id="12.2-%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E4%B8%8B%E6%89%80%E6%9C%89%E5%88%86%E7%BB%84%E4%BB%A5%E5%8F%8A%E5%B1%9E%E6%80%A7"
                                    id="12-2-获取分类下所有分组以及属性">12.2 获取分类下所有分组以及属性</h2>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201023072959266.png"
                                        alt="image-20201023072959266" /></p>
                                <p>基本信息输入成功后，就会跳转到规格参数，</p>
                                <p>并根据分类id查询出对应数据</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201023073041272.png"
                                        alt="image-20201023073041272" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  获取分类下所有分组&amp;关联属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catelogId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&#123;catelogId&#125;/withattr&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">getAttrGroupWithAttrs</span><span class="params">(<span class="meta">@PathVariable(&quot;catelogId&quot;)</span> Long catelogId)</span>   </span>&#123;</span><br><span class="line">    List&lt;AttrGroupWithAttrsVo&gt; vos = attrGroupService.getAttrGroupWithAttrsByCatelogId(catelogId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>,vos);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service 实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;AttrGroupWithAttrsVo&gt; <span class="title">getAttrGroupWithAttrsByCatelogId</span><span class="params">(Long catelogId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、根据分类id查询出 查询分组关系</span></span><br><span class="line">    List&lt;AttrGroupEntity&gt; attrgroupEntites = <span class="keyword">this</span>.list(<span class="keyword">new</span> QueryWrapper&lt;AttrGroupEntity&gt;().eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId));</span><br><span class="line"></span><br><span class="line">    List&lt;AttrGroupWithAttrsVo&gt; collect = attrgroupEntites.stream().map(group -&gt; &#123;</span><br><span class="line">        AttrGroupWithAttrsVo attrsVo = <span class="keyword">new</span> AttrGroupWithAttrsVo();</span><br><span class="line">        <span class="comment">// 2、将分组属性拷贝到 VO中</span></span><br><span class="line">        BeanUtils.copyProperties(group, attrsVo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、通过分组id查询出 商品属性信息</span></span><br><span class="line">        <span class="comment">// 调用 getRelationAttr方法先根据 分组id去 中间关系表查询到商品属性id 然后根据商品属性id查询到商品信息</span></span><br><span class="line">        List&lt;AttrEntity&gt; relationAttr = attrService.getRelationAttr(attrsVo.getAttrGroupId());</span><br><span class="line">        attrsVo.setAttrs(relationAttr);</span><br><span class="line">        <span class="keyword">return</span> attrsVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h2 id="12.3-%E5%95%86%E5%93%81-vo-%E6%8A%BD%E5%8F%96%26%E5%95%86%E5%93%81%E6%96%B0%E5%A2%9E%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"
                                    id="12-3-商品-VO-抽取-商品新增业务流程">12.3 商品 VO 抽取&amp;商品新增业务流程</h2>
                                <p>商品属性、销售属性、规格参数、基本信息都填好了后就会生成一串 JSON</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201023080411308.png"
                                        alt="image-20201023080411308" /></p>
                                <p>我们将 json 放到 json解析网站上 并生成对应得实体类</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201023080500520.png"
                                        alt="image-20201023080500520" /></p>
                                <h3 id="12.3.4-%E5%B0%81%E8%A3%85-vo-%E4%B8%AD%EF%BC%8C%E6%9B%B4%E6%94%B9%E5%AF%B9%E5%BA%94%E5%BE%97%E5%B1%9E%E6%80%A7"
                                    id="12-3-4-封装-Vo-中，更改对应得属性">12.3.4 封装 Vo 中，更改对应得属性</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201023081250886.png"
                                        alt="image-20201023081250886" /></p>
                                <p>有些参与计算的属性 如 int price 将类型更改为 BigDecimal</p>
                                <h3 id="12.3.5-%E5%88%86%E6%9E%90%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"
                                    id="12-3-5-分析业务流程">12.3.5 分析业务流程</h3>
                                <blockquote>
                                    <p>业务流程:</p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024112115137.png"
                                        alt="image-20201024112115137" /></p>
                                <h3 id="12.3.6-%E4%B8%BB%E8%A6%81%E7%BC%96%E7%A0%81%EF%BC%81" id="12-3-6-主要编码！">12.3.6
                                    主要编码！</h3>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveSpuInfo</span><span class="params">(SpuSaveVo vo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、保存Spu基本信息  pms_spu_info</span></span><br><span class="line">    SpuInfoEntity spuInfoEntity = <span class="keyword">new</span> SpuInfoEntity();</span><br><span class="line">    BeanUtils.copyProperties(vo,spuInfoEntity);</span><br><span class="line">    spuInfoEntity.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">    spuInfoEntity.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.saveBaseSpuInfo(spuInfoEntity);</span><br><span class="line">    <span class="comment">// 2、保存Spu的描述信息  pms_spu_info_desc</span></span><br><span class="line">    List&lt;String&gt; decript = vo.getDecript();</span><br><span class="line">    SpuInfoDescEntity spuInfoDescEntity = <span class="keyword">new</span> SpuInfoDescEntity();</span><br><span class="line">    <span class="comment">// SpuInfoEntity保存到取得 spuId 设置到 Desc中</span></span><br><span class="line">    spuInfoDescEntity.setSpuId(spuInfoEntity.getId());</span><br><span class="line">    <span class="comment">// 以逗号来拆分</span></span><br><span class="line">    spuInfoDescEntity.setDecript(String.join(<span class="string">&quot;,&quot;</span>,decript));</span><br><span class="line">    spuInfoDescService.saveSpuInfoDesc(spuInfoDescEntity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、保存Spu的图片集 pms_spu_images</span></span><br><span class="line">    List&lt;String&gt; imageList = vo.getImages();</span><br><span class="line">    spuImagesService.saveImages(spuInfoEntity.getId(),imageList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、保存spu的规格参数 pms_product_attr_value</span></span><br><span class="line">    List&lt;BaseAttrs&gt; baseAttrs = vo.getBaseAttrs();</span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; collect = baseAttrs.stream().map(attr -&gt; &#123;</span><br><span class="line">        <span class="comment">// 设置 spu 属性值</span></span><br><span class="line">        ProductAttrValueEntity valueEntity = <span class="keyword">new</span> ProductAttrValueEntity();</span><br><span class="line">        valueEntity.setAttrId(attr.getAttrId());</span><br><span class="line">        AttrEntity attrEntity = attrService.getById(attr.getAttrId());</span><br><span class="line">        valueEntity.setAttrName(attrEntity.getAttrName());</span><br><span class="line">        valueEntity.setSpuId(spuInfoEntity.getId());</span><br><span class="line">        valueEntity.setQuickShow(attr.getShowDesc());</span><br><span class="line">        valueEntity.setAttrValue(attr.getAttrValues());</span><br><span class="line">        <span class="keyword">return</span> valueEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    attrValueService.saveProductAttr(collect);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、保存SPU的积分信息 gulimall_sms sms =&gt; sms_spu_bounds</span></span><br><span class="line">    Bounds bounds = vo.getBounds();</span><br><span class="line">    SpuBoundTo spuBoundTo = <span class="keyword">new</span> SpuBoundTo();</span><br><span class="line">    BeanUtils.copyProperties(bounds,spuBoundTo);</span><br><span class="line">    spuBoundTo.setSpuId(spuInfoEntity.getId());</span><br><span class="line">    <span class="comment">// 远程服务调用</span></span><br><span class="line">    R r = couponFeignService.saveSpuBounds(spuBoundTo);</span><br><span class="line">    <span class="keyword">if</span> (r.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;远程保存优惠信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、保存当前Spu对应的所有SKU信息</span></span><br><span class="line">    List&lt;Skus&gt; skus = vo.getSkus();</span><br><span class="line">    <span class="keyword">if</span> (skus != <span class="keyword">null</span> &amp;&amp; skus.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 遍历 skus 集合</span></span><br><span class="line">        skus.forEach(item -&gt;&#123;</span><br><span class="line">            String defaultImage = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="comment">// 遍历 skus 集合中的图片 </span></span><br><span class="line">            <span class="keyword">for</span> (Images image : item.getImages()) &#123;</span><br><span class="line">                <span class="comment">// 默认图片等于 1 该记录则是默认图片</span></span><br><span class="line">                <span class="keyword">if</span> (image.getDefaultImg() == <span class="number">1</span>) &#123;</span><br><span class="line">                    defaultImage = image.getImgUrl();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// private String skuName;</span></span><br><span class="line">            <span class="comment">//    private String price;</span></span><br><span class="line">            <span class="comment">//    private String skuTitle;</span></span><br><span class="line">            <span class="comment">//    private String skuSubtitle;</span></span><br><span class="line">            <span class="comment">// 只有上面4个属性相同</span></span><br><span class="line">            SkuInfoEntity skuInfoEntity = <span class="keyword">new</span> SkuInfoEntity();</span><br><span class="line">            BeanUtils.copyProperties(item,skuInfoEntity);</span><br><span class="line">            <span class="comment">// 其他属性需要自己赋值</span></span><br><span class="line">            skuInfoEntity.setBrandId(spuInfoEntity.getBrandId());</span><br><span class="line">            skuInfoEntity.setCatalogId(spuInfoEntity.getCatalogId());</span><br><span class="line">            skuInfoEntity.setSaleCount(<span class="number">0L</span>);</span><br><span class="line">            skuInfoEntity.setSpuId(spuInfoDescEntity.getSpuId());</span><br><span class="line">            skuInfoEntity.setSkuDefaultImg(defaultImage);</span><br><span class="line">            <span class="comment">//5.1、SKU的基本信息 pms_sku_info</span></span><br><span class="line">            skuInfoService.saveSkuInfo(skuInfoEntity);</span><br><span class="line"></span><br><span class="line">            Long skuId = skuInfoEntity.getSkuId();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存 sku 图片信息</span></span><br><span class="line">            List&lt;SkuImagesEntity&gt; imagesEntities = item.getImages().stream().map(img -&gt; &#123;</span><br><span class="line">                SkuImagesEntity skuImagesEntity = <span class="keyword">new</span> SkuImagesEntity();</span><br><span class="line">                skuImagesEntity.setSkuId(skuId);</span><br><span class="line">                skuImagesEntity.setImgUrl(img.getImgUrl());</span><br><span class="line">                skuImagesEntity.setDefaultImg(img.getDefaultImg());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> skuImagesEntity;</span><br><span class="line">            &#125;).filter(entity -&gt;&#123;</span><br><span class="line">                <span class="comment">//返回 true 需要 false 过滤</span></span><br><span class="line">                <span class="keyword">return</span> !StringUtils.isEmpty(entity.getImgUrl());</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// TODO 没有图片路径的无需保存</span></span><br><span class="line">            <span class="comment">//5.2、SKU的图片信息 pms_sku_images</span></span><br><span class="line">            skuImagesService.saveBatch(imagesEntities);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            List&lt;Attr&gt; attr = item.getAttr();</span><br><span class="line">            <span class="comment">// 保存 sku 销售属性</span></span><br><span class="line">            List&lt;SkuSaleAttrValueEntity&gt; skuSaleAttrValueEntities = attr.stream().map(a -&gt; &#123;</span><br><span class="line">                SkuSaleAttrValueEntity skuSaleAttrValueEntity = <span class="keyword">new</span> SkuSaleAttrValueEntity();</span><br><span class="line">                BeanUtils.copyProperties(a, skuSaleAttrValueEntity);</span><br><span class="line">                skuSaleAttrValueEntity.setSkuId(skuId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> skuSaleAttrValueEntity;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            <span class="comment">//5.3、SKU的销售属性信息 pms_sku_sale_attr_value</span></span><br><span class="line">            saleAttrValueService.saveBatch(skuSaleAttrValueEntities);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//5.4、SKU的优惠、满减等信息 gulimall_sms -&gt;sms_sku_ladder \sms_sku_full_reduction\sms_member_price</span></span><br><span class="line"></span><br><span class="line">            SkuReductionTo skuReductionTo = <span class="keyword">new</span> SkuReductionTo();</span><br><span class="line">            BeanUtils.copyProperties(item,skuReductionTo);</span><br><span class="line">            skuReductionTo.setSkuId(skuId);</span><br><span class="line">            <span class="keyword">if</span> (skuReductionTo.getFullCount() &gt; <span class="number">0</span> || skuReductionTo.getFullPrice().compareTo(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line">                R r1 = couponFeignService.saveSkuReduction(skuReductionTo);</span><br><span class="line">                <span class="keyword">if</span> (r1.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;远程保存sku优惠信息失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>saveImages</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveImages</span><span class="params">(Long id, List&lt;String&gt; imageList)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (imageList == <span class="keyword">null</span> || imageList.size() &lt;=<span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;图片为空！！！！！！&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;SpuImagesEntity&gt; collect = imageList.stream().map(img -&gt; &#123;</span><br><span class="line">            SpuImagesEntity entity = <span class="keyword">new</span> SpuImagesEntity();</span><br><span class="line">            <span class="comment">// 设置主要属性 </span></span><br><span class="line">            entity.setSpuId(id);</span><br><span class="line">            entity.setImgUrl(img);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> entity;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">this</span>.saveBatch(collect );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>远程服务调用 对应方法</p>
                                <p>保存了 <strong>商品阶梯价格</strong>、<strong>商品满减信息</strong>、<strong>商品会员价格</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveSkuReduction</span><span class="params">(SkuReductionTo skuReductionTo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.4、SKU的优惠、满减等信息 gulimall_sms -&gt;sms_sku_ladder \sms_sku_full_reduction\sms_member_price</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//sms_sku_ladder</span></span><br><span class="line">    SkuLadderEntity skuLadderEntity = <span class="keyword">new</span> SkuLadderEntity();</span><br><span class="line">    skuLadderEntity.setSkuId(skuReductionTo.getSkuId());</span><br><span class="line">    skuLadderEntity.setFullCount(skuReductionTo.getFullCount());</span><br><span class="line">    skuLadderEntity.setAddOther(skuReductionTo.getCountStatus());</span><br><span class="line">    skuLadderEntity.setDiscount(skuReductionTo.getDiscount());</span><br><span class="line">    <span class="keyword">if</span> (skuLadderEntity.getFullCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        skuLadderService.save(skuLadderEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//sms_sku_full_reduction</span></span><br><span class="line">    SkuFullReductionEntity skuFullReductionEntity = <span class="keyword">new</span> SkuFullReductionEntity();</span><br><span class="line">    BeanUtils.copyProperties(skuReductionTo,skuFullReductionEntity);</span><br><span class="line">    <span class="comment">// BigDecimal 用 compareTo来比较</span></span><br><span class="line">    <span class="keyword">if</span> (skuFullReductionEntity.getFullPrice().compareTo(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.save(skuFullReductionEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//sms_member_price</span></span><br><span class="line"></span><br><span class="line">    List&lt;MemberPrice&gt; memberPrice = skuReductionTo.getMemberPrice();</span><br><span class="line"></span><br><span class="line">    List&lt;MemberPriceEntity&gt; collect = memberPrice.stream().map(item -&gt; &#123;</span><br><span class="line">        MemberPriceEntity priceEntity = <span class="keyword">new</span> MemberPriceEntity();</span><br><span class="line">        priceEntity.setSkuId(skuReductionTo.getSkuId());</span><br><span class="line">        priceEntity.setMemberPrice(item.getPrice());</span><br><span class="line">        priceEntity.setMemberLevelName(item.getName());</span><br><span class="line">        priceEntity.setMemberLevelId(item.getId());</span><br><span class="line">        priceEntity.setAddOther(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> priceEntity;</span><br><span class="line">    &#125;).filter(item -&gt; &#123;</span><br><span class="line">        <span class="comment">// 会员对应价格等于0 过滤掉</span></span><br><span class="line">        <span class="keyword">return</span> item.getMemberPrice().compareTo(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    memberPriceService.saveBatch(collect);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="12.3.7-%E6%80%BB%E7%BB%93" id="12-3-7-总结"><strong>12.3.7 总结</strong></h3>
                                <ul>
                                    <li>电商系统中大表数据不做关联 宁可一点一点查询</li>
                                    <li>商品新增业务，眨眼一看很多代码，但是如果把他们划分成几个功能点一一完成，业务也就不会变得很庞大</li>
                                </ul>
                                <p>相关操作的表</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024113618961.png"
                                        alt="image-20201024113618961" /></p>
                                <h3 id="12.3.8-%E5%95%86%E5%93%81%E4%BF%9D%E5%AD%98%E5%90%8E-debug-%E8%B0%83%E8%AF%95"
                                    id="12-3-8-商品保存后-Debug-调试">12.3.8 商品保存后 Debug 调试</h3>
                                <p>很少有一次写的代码能一次通过，所以我们要 一个功能点一个断点来调试程序是否正确</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"># 将当前会话等级设置成读为提交，当前窗口就能查看到没有提交的数据</span><br><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>具体 Debug 过程不在此叙述</p>
                                <h3 id="12.3.9-%E5%95%86%E5%93%81%E4%BF%9D%E5%AD%98%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"
                                    id="12-3-9-商品保存其他问题处理">12.3.9 商品保存其他问题处理</h3>
                                <h4 id="1%E3%80%81-sku_images-%E8%A1%A8%E4%B8%AD-img_url-%E5%AD%97%E6%AE%B5%E4%B8%BA%E7%A9%BA"
                                    id="1、-sku-images-表中-img-url-字段为空">1、 <code>sku_images</code> 表中 img_url 字段为空</h4>
                                <p><code>sku_images</code> 中有很多图片都是为空，因此我们需要在程序中处理这个数据，空数据不写入到数据库中</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024114238060.png"
                                        alt="image-20201024114238060" /></p>
                                <p><strong>解决思路：</strong></p>
                                <p><code>skuImages</code> 保存部分代码、如果 <code>ImgUrl</code> 为空则进行过滤</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#125;).filter(entity -&gt;&#123;</span><br><span class="line">    <span class="comment">//返回 true 需要 false 过滤</span></span><br><span class="line">    <span class="keyword">return</span> !StringUtils.isEmpty(entity.getImgUrl());</span><br><span class="line">&#125;).collect(Collectors.toList());</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2%E3%80%81sku-%E6%BB%A1%E5%87%8F%E4%BB%A5%E5%8F%8A%E6%89%93%E6%8A%98%E4%BF%A1%E6%81%AF-%E6%95%B0%E6%8D%AE%E5%87%BA%E7%8E%B0%E9%94%99%E8%AF%AF"
                                    id="2、sku-满减以及打折信息-数据出现错误">2、sku 满减以及打折信息 数据出现错误</h4>
                                <p>有部分数据 为0</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024114652266.png"
                                        alt="image-20201024114652266" /></p>
                                <p>解决思路：</p>
                                <p>在代码中过滤对应为0的数据</p>
                                <p>部分修改代码</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 满几件 大于0 可以添加  满多少钱 至少要大于0</span></span><br><span class="line"><span class="keyword">if</span> (skuReductionTo.getFullCount() &gt; <span class="number">0</span> || skuReductionTo.getFullPrice().compareTo(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line">    R r1 = couponFeignService.saveSkuReduction(skuReductionTo);</span><br><span class="line">    <span class="keyword">if</span> (r1.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;远程保存sku优惠信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>远程服务中也进行对应修改</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">保存 商品阶梯价格</span></span><br><span class="line"><span class="comment">件数 大于0才能进行修改</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">if</span> (skuLadderEntity.getFullCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    skuLadderService.save(skuLadderEntity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">保存商品满减信息</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  <span class="comment">// BigDecimal 用 compareTo来比较</span></span><br><span class="line"><span class="keyword">if</span> (skuFullReductionEntity.getFullPrice().compareTo(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.save(skuFullReductionEntity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">保存商品会员价格</span></span><br><span class="line"><span class="comment">也进行了过滤数据</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"> &#125;).filter(item -&gt; &#123;</span><br><span class="line">            <span class="comment">// 会员对应价格等于0 过滤掉</span></span><br><span class="line">            <span class="keyword">return</span> item.getMemberPrice().compareTo(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="3%E3%80%81%E7%A8%8B%E5%BA%8F%E4%B8%AD%E5%85%B6%E4%BB%96%E7%9A%84%E5%BC%82%E5%B8%B8"
                                    id="3、程序中其他的异常">3、程序中其他的异常</h4>
                                <p>程序中总会出现一些其他的异常的，这个留到高级篇进行讲解</p>
                                <h1
                                    id="%E5%8D%81%E4%B8%80%E3%80%81-%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86">
                                    十一、 商品服务&amp;商品管理</h1>
                                <h2 id="spu-sku" id="SPU-SKU">SPU SKU</h2>
                                <h2 id="11.1-%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86-spu-%E6%A3%80%E7%B4%A2"
                                    id="11-1-商品管理-SPU-检索">11.1 商品管理 SPU 检索</h2>
                                <p><strong>功能概述：</strong></p>
                                <ul>
                                    <li>查询刚刚发布的商品，并能进行对应的条件查询</li>
                                </ul>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024061157844.png"
                                        alt="image-20201024061157844" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="comment">//@RequiresPermissions(&quot;product:spuinfo:list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span></span>&#123;</span><br><span class="line">        PageUtils page = spuInfoService.queryPageByCondition(params);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service 实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据条件进行查询 spu相关信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页参数  status上架状态，catelogId 分类id brandId 品牌id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPageByCondition</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;SpuInfoEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出参数 key 进行查询</span></span><br><span class="line">    String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">        wrapper.and((w) -&gt;&#123;</span><br><span class="line">            w.eq(<span class="string">&quot;id&quot;</span>,<span class="string">&quot;key&quot;</span>).or().like(<span class="string">&quot;spu_name&quot;</span>,key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证不为空 取出参数进行 查询</span></span><br><span class="line">    String status = (String) params.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(status)) &#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;publish_status&quot;</span>,status);</span><br><span class="line">    &#125;</span><br><span class="line">    String brandId = (String) params.get(<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(brandId)  &amp;&amp; ! <span class="string">&quot;0&quot;</span>.equalsIgnoreCase(brandId)) &#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;brand_id&quot;</span>,brandId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String catelogId = (String) params.get(<span class="string">&quot;catelogId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(catelogId) &amp;&amp; ! <span class="string">&quot;0&quot;</span>.equalsIgnoreCase(catelogId)) &#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;catalog_id&quot;</span>,catelogId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPage&lt;SpuInfoEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">            <span class="keyword">new</span> Query&lt;SpuInfoEntity&gt;().getPage(params),</span><br><span class="line">            wrapper);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程</strong></p>
                                <ul>
                                    <li>主要查询的是 <code>pms_spu_info</code> 这张表 前端传递过来的参数 主要有分页，以及 品牌id 分类id
                                        我们需要判断这些值是否正确，然后进行查询数据</li>
                                </ul>
                                <h2 id="11.2-%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86-sku-%E6%A3%80%E7%B4%A2"
                                    id="11-2-商品管理-SkU-检索">11.2 商品管理 SkU 检索</h2>
                                <p><strong>功能概述：</strong></p>
                                <p>查询具体的商品管理 库存</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024061836312.png"
                                        alt="image-20201024061836312" /></p>
                                <p>Controller</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#x2F;**</span><br><span class="line"> * 列表</span><br><span class="line"> *&#x2F;</span><br><span class="line">@RequestMapping(&quot;&#x2F;list&quot;)</span><br><span class="line">&#x2F;&#x2F;@RequiresPermissions(&quot;product:skuinfo:list&quot;)</span><br><span class="line">public R list(@RequestParam Map&lt;String, Object&gt; params)&#123;</span><br><span class="line">    PageUtils page &#x3D; skuInfoService.queryPageByCondition(params);</span><br><span class="line"></span><br><span class="line">    return R.ok().put(&quot;page&quot;, page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPageByCondition</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;SkuInfoEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出参数 进行查询</span></span><br><span class="line">    String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">        wrapper.and((w) -&gt;&#123;</span><br><span class="line">            w.eq(<span class="string">&quot;sku_id&quot;</span>,key).or().like(<span class="string">&quot;sku_name&quot;</span>,key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证 id 是否为0 否则进行匹配</span></span><br><span class="line">    String catelogId = (String) params.get(<span class="string">&quot;catelogId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(catelogId) &amp;&amp; !<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(catelogId)) &#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;catalog_id&quot;</span>,catelogId);</span><br><span class="line">    &#125;</span><br><span class="line">    String brandId = (String) params.get(<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(brandId) &amp;&amp; !<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(brandId)) &#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;brand_id&quot;</span>,brandId);</span><br><span class="line">    &#125;</span><br><span class="line">    String min = (String) params.get(<span class="string">&quot;min&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(min)) &#123;</span><br><span class="line">        wrapper.ge(<span class="string">&quot;price&quot;</span>,min);</span><br><span class="line">    &#125;</span><br><span class="line">    String max = (String) params.get(<span class="string">&quot;max&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(max) ) &#123;</span><br><span class="line">        <span class="comment">// 怕前端传递的数据是 abc 等等 所以要抛出异常</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BigDecimal bigDecimal = <span class="keyword">new</span> BigDecimal(max);</span><br><span class="line">            <span class="keyword">if</span> ( bigDecimal.compareTo(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line">                wrapper.le(<span class="string">&quot;price&quot;</span>,max);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPage&lt;SkuInfoEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">            <span class="keyword">new</span> Query&lt;SkuInfoEntity&gt;().getPage(params),</span><br><span class="line">            wrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程：</strong></p>
                                <p>主要查询是 <code>pms_sku_info</code> 这张表，我出现的问题是发布商品时候，实体类的 价格 与
                                    VO属性不一致，出现了数据没有拷贝，修改后，数据查询正常</p>
                                <h1
                                    id="%E5%8D%81%E4%BA%8C%E3%80%81%E4%BB%93%E5%82%A8%E6%9C%8D%E5%8A%A1%26%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86">
                                    十二、仓储服务&amp;仓库管理</h1>
                                <h2 id="14.1-%E6%95%B4%E5%90%88ware%E6%9C%8D%E5%8A%A1%26%E8%8E%B7%E5%8F%96%E4%BB%93%E5%BA%93%E5%88%97%E8%A1%A8"
                                    id="14-1-整合ware服务-获取仓库列表">14.1 整合ware服务&amp;获取仓库列表</h2>
                                <h3 id="14.1.1%E6%95%B4%E5%90%88-ware-%E6%9C%8D%E5%8A%A1" id="14-1-1整合-ware-服务">14.1.1整合
                                    ware 服务</h3>
                                <p>1、首先服务需要先注册到 Nacos 中，需要自己配置文件 配置对应的 nacos注册地址，</p>
                                <p>2、启动类需要开启 服务注册发现，开启远程服务调用</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">// 开启openfeign 远程服务调用</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">//开启事务</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.atguigu.gulimall.ware.dao&quot;)</span> <span class="comment">//mapper包扫描</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">//服务注册发现</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="14.1.2-%E8%8E%B7%E5%8F%96%E4%BB%93%E5%BA%93%E5%88%97%E8%A1%A8"
                                    id="14-1-2-获取仓库列表">14.1.2 获取仓库列表</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>根据参数名查询出 仓库相关的记录 ，具体对于操作的是<code>wms_ware_info</code> 表</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024121842147.png"
                                        alt="" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;ware:wareinfo:list&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span></span>&#123;</span><br><span class="line">    PageUtils page = wareInfoService.queryPage(params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;WareInfoEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出参数</span></span><br><span class="line">    String key = (String)params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="comment">// 拼接条件</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;id&quot;</span>,key).or()</span><br><span class="line">                .like(<span class="string">&quot;name&quot;</span>,key)</span><br><span class="line">                .eq(<span class="string">&quot;address&quot;</span>,key)</span><br><span class="line">                .eq(<span class="string">&quot;areacode&quot;</span>,key);</span><br><span class="line">    &#125;</span><br><span class="line">    IPage&lt;WareInfoEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">            <span class="keyword">new</span> Query&lt;WareInfoEntity&gt;().getPage(params),</span><br><span class="line">            wrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程</strong></p>
                                <p>仓库维护对应的是 <code>wms_ware_info</code> 根据前端传递过来的参数进行拼接然后进行查询</p>
                                <h2 id="14.2-%E6%9F%A5%E8%AF%A2%E5%BA%93%E5%AD%98%26%E5%88%9B%E5%BB%BA%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"
                                    id="14-2-查询库存-创建采购需求">14.2 查询库存&amp;创建采购需求</h2>
                                <h3 id="14.2.1-%E6%9F%A5%E8%AF%A2%E5%BA%93%E5%AD%98" id="14-2-1-查询库存">14.2.1 查询库存</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>根据 <strong>仓库、skuId</strong> 进行查询对应的表是 wms_ware_sku</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024122540156.png"
                                        alt="image-20201024122540156" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;ware:waresku:list&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span></span>&#123;</span><br><span class="line">    PageUtils page = wareSkuService.queryPage(params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;WareSkuEntity&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出请求的参数 组装条件进行查询</span></span><br><span class="line">    String skuId = (String) params.get(<span class="string">&quot;skuId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(skuId)) &#123;</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;sku_id&quot;</span>,skuId);</span><br><span class="line">    &#125;</span><br><span class="line">    String wareId = (String) params.get(<span class="string">&quot;wareId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(wareId)) &#123;</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;ware_id&quot;</span>,wareId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPage&lt;WareSkuEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">            <span class="keyword">new</span> Query&lt;WareSkuEntity&gt;().getPage(params),</span><br><span class="line">            queryWrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程：</strong></p>
                                <p><code>wms_ware_sku</code> 主要的操作的就是该表 一样的封装条件，然后进行查询</p>
                                <h3 id="14.2.2-%E5%88%9B%E5%BB%BA%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"
                                    id="14-2-2-创建采购需求">14.2.2 创建采购需求</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>选择 仓库、状态、 以及其他关键字 查询出对应的数据 那么查询的是哪张表？ <code>wms_purchase_detail</code></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024125311832.png"
                                        alt="image-20201024125311832" /></p>
                                <p>Controller</p>
                                <p>如往常一样 调用 <code>Service</code> 返回结果 组装 返回~~~</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;ware:purchasedetail:list&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span></span>&#123;</span><br><span class="line">    PageUtils page = purchaseDetailService.queryPage(params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  //   status: 0,//状态</span></span><br><span class="line"><span class="comment"> *         //   wareId: 1,//仓库id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;PurchaseDetailEntity&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出key</span></span><br><span class="line">    String key = (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="comment">// key 主要查询条件 </span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(key)) &#123;</span><br><span class="line">        wrapper.and((w) -&gt;&#123;</span><br><span class="line">            w.eq(<span class="string">&quot;purchase_id&quot;</span>,key).or().eq(<span class="string">&quot;sku_id&quot;</span>,key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String status = (String) params.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(status)) &#123;</span><br><span class="line">        wrapper.and((w) -&gt;&#123;</span><br><span class="line">            w.eq(<span class="string">&quot;status&quot;</span>,status);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    String wareId = (String) params.get(<span class="string">&quot;wareId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(wareId)) &#123;</span><br><span class="line">        wrapper.and((w) -&gt;&#123;</span><br><span class="line">            w.eq(<span class="string">&quot;ware_id&quot;</span>,wareId);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IPage&lt;PurchaseDetailEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">            <span class="keyword">new</span> Query&lt;PurchaseDetailEntity&gt;().getPage(params),</span><br><span class="line">            wrapper</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程：</strong></p>
                                <p>对 <code>wms_purchase_detail</code> 表进行操作 拼装条件 查询 嗯 就这样~~~</p>
                                <h2 id="14.3-%E5%90%88%E5%B9%B6%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82%26%E9%A2%86%E5%8F%96%E9%87%87%E8%B4%AD%E5%8D%95%26%E5%AE%8C%E6%88%90%E9%87%87%E8%B4%AD%26spu%E8%A7%84%E6%A0%BC%E7%BB%B4%E6%8A%A4"
                                    id="14-3-合并采购需求-领取采购单-完成采购-Spu规格维护">14.3 合并采购需求&amp;领取采购单&amp;完成采购&amp;Spu规格维护</h2>
                                <h3 id="14.3.1-%E5%90%88%E5%B9%B6%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"
                                    id="14-3-1-合并采购需求">14.3.1 合并采购需求</h3>
                                <p><strong>具体需求：</strong></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024131822802.png"
                                        alt="" /></p>
                                <p>选中 点击批量操作</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024132207468.png"
                                        alt="image-20201024132207468" /></p>
                                <p>请求参数分享</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#123;</span><br><span class="line">  purchaseId: <span class="number">1</span>, <span class="comment">//整单id</span></span><br><span class="line">  items:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>] <span class="comment">//合并项集合</span></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>那就建立对应的 Vo 用来接收请求参数</p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 合并采购</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mergeVo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">///ware/purchase/merge</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/merge&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">merge</span><span class="params">(<span class="meta">@RequestBody</span> MergeVo mergeVo)</span> </span>&#123;</span><br><span class="line">    purchaseService.mrgePurchase(mergeVo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 合并采购需求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mergeVo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mrgePurchase</span><span class="params">(MergeVo mergeVo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 拿到采购单id</span></span><br><span class="line">    Long purchaseId = mergeVo.getPurchaseId();</span><br><span class="line">    <span class="comment">// 采购单 id为空 新建</span></span><br><span class="line">    <span class="keyword">if</span> (purchaseId == <span class="keyword">null</span> ) &#123;</span><br><span class="line">        PurchaseEntity purchaseEntity = <span class="keyword">new</span> PurchaseEntity();</span><br><span class="line">        <span class="comment">// 状态设置为新建</span></span><br><span class="line">        purchaseEntity.setStatus(WareConstant.PurchaseStatusEnum.CREATED.getCode());</span><br><span class="line">        purchaseEntity.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        purchaseEntity.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">this</span>.save(purchaseEntity);</span><br><span class="line">        <span class="comment">// 拿到最新的采购单id</span></span><br><span class="line">        purchaseId = purchaseEntity.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO 确认采购是 0 或 1 才可以合并</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到合并项 **采购需求的id**</span></span><br><span class="line">    List&lt;Long&gt; items = mergeVo.getItems();</span><br><span class="line">    Long finalPurchaseId = purchaseId;</span><br><span class="line">    List&lt;PurchaseDetailEntity&gt; collect = items.stream().map(i -&gt; &#123;</span><br><span class="line">        <span class="comment">// 采购需求</span></span><br><span class="line">        PurchaseDetailEntity detailEntity = <span class="keyword">new</span> PurchaseDetailEntity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过采购单id 查询到 采购信息对象</span></span><br><span class="line">        PurchaseEntity byId = <span class="keyword">this</span>.getById(finalPurchaseId);</span><br><span class="line">        <span class="comment">// 状态如果是正在采购</span></span><br><span class="line">        <span class="keyword">if</span> (! (byId.getStatus() == WareConstant.PurchaseDetailStatusEnum.BUYING.getCode())) &#123;</span><br><span class="line">            <span class="comment">// 设置为已分配</span></span><br><span class="line">            detailEntity.setStatus(WareConstant.PurchaseDetailStatusEnum.HASERROR.getCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        detailEntity.setId(i);</span><br><span class="line">        <span class="comment">// 设置采购单id</span></span><br><span class="line">        detailEntity.setPurchaseId(finalPurchaseId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> detailEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// id批量更新</span></span><br><span class="line">    purchaseDetailService.updateBatchById(collect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再次合并的话 更新修改时间</span></span><br><span class="line">    PurchaseEntity purchaseEntity = <span class="keyword">new</span> PurchaseEntity();</span><br><span class="line">    purchaseEntity.setId(purchaseId);</span><br><span class="line">    purchaseEntity.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line">    <span class="keyword">this</span>.updateById(purchaseEntity);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程:</strong></p>
                                <ul>
                                    <li>从 参数 mergeVo中取出 purchaseId 和 items 进行相关操作</li>
                                    <li>主要是用来操作两张表 <code>wms_purchase</code> 和 <code>wms_purchase_detail</code></li>
                                    <li><code>wms_purchase</code> 表是 采购信息</li>
                                    <li><code>wms_purchase_detail</code> 表是 采购需求</li>
                                    <li>我的理解是将 <code>wms_purchase</code> 的id插入到 <code>wms_purchase_detail</code> 表中 也就是
                                        purchase_id 字段，中间通过这个字段关联起来，同时 <code>wms_purchase</code> 表对 status
                                        状态有比较多的选择，视频里面也是定义了两个常量</li>
                                </ul>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WareConstant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span>  <span class="title">PurchaseStatusEnum</span></span>&#123;</span><br><span class="line">        CREATED(<span class="number">0</span>,<span class="string">&quot;新建&quot;</span>),ASSIGNED(<span class="number">1</span>,<span class="string">&quot;已分配&quot;</span>),</span><br><span class="line">        RECEIVE(<span class="number">2</span>,<span class="string">&quot;已领取&quot;</span>),FINISH(<span class="number">3</span>,<span class="string">&quot;已完成&quot;</span>),</span><br><span class="line">        HASERROR(<span class="number">4</span>,<span class="string">&quot;有异常&quot;</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">        <span class="keyword">private</span> String msg;</span><br><span class="line">        PurchaseStatusEnum(<span class="keyword">int</span> code,String msg) &#123;</span><br><span class="line">            <span class="keyword">this</span>.code = code;</span><br><span class="line">            <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.code = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span>  <span class="title">PurchaseDetailStatusEnum</span></span>&#123;</span><br><span class="line">        CREATED(<span class="number">0</span>,<span class="string">&quot;新建&quot;</span>),ASSIGNED(<span class="number">1</span>,<span class="string">&quot;已分配&quot;</span>),</span><br><span class="line">        BUYING(<span class="number">2</span>,<span class="string">&quot;正在采购&quot;</span>),FINISH(<span class="number">3</span>,<span class="string">&quot;已完成&quot;</span>),</span><br><span class="line">        HASERROR(<span class="number">4</span>,<span class="string">&quot;采购失败&quot;</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">        <span class="keyword">private</span> String msg;</span><br><span class="line">        PurchaseDetailStatusEnum(<span class="keyword">int</span> code,String msg) &#123;</span><br><span class="line">            <span class="keyword">this</span>.code = code;</span><br><span class="line">            <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.code = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>将常量抽取出来，修改更加方便</p>
                                <h3 id="14.3.2-%E9%A2%86%E5%8F%96%E9%87%87%E8%B4%AD%E5%8D%95" id="14-3-2-领取采购单">14.3.2
                                    领取采购单</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>合并采购需求成功后，具体这个功能有啥用啊？ 你总得需要有人去采购吧？ 所以就会有一个<strong>采购APP
                                        工作人员点击采购</strong>，然后就去采购，这里就没有实现采购 APP 就用接口来实现，通过 JSON 的参数 来请求</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024140120849.png"
                                        alt="image-20201024140120849" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/received&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">received</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; ids)</span> </span>&#123;</span><br><span class="line">    purchaseService.received(ids);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(List&lt;Long&gt; ids)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、确认当前采购单是 新建或者 已分配状态 才能进行采购</span></span><br><span class="line">    List&lt;PurchaseEntity&gt; collect = ids.stream().map(id -&gt; &#123;</span><br><span class="line">        <span class="comment">// 根据采购id查询出采购信息</span></span><br><span class="line">        PurchaseEntity byId = <span class="keyword">this</span>.getById(id);</span><br><span class="line">        <span class="keyword">return</span> byId;</span><br><span class="line">    &#125;).filter(item -&gt; &#123;</span><br><span class="line">        <span class="comment">// 新建或者已分配留下</span></span><br><span class="line">        <span class="keyword">if</span> (item.getStatus() == WareConstant.PurchaseStatusEnum.CREATED.getCode() ||</span><br><span class="line">                item.getStatus() == WareConstant.PurchaseStatusEnum.ASSIGNED.getCode()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;).map(item -&gt; &#123;</span><br><span class="line">        <span class="comment">// 设置为已领取</span></span><br><span class="line">        item.setStatus(WareConstant.PurchaseStatusEnum.RECEIVE.getCode());</span><br><span class="line">        item.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、改变采购单状态</span></span><br><span class="line">    <span class="keyword">this</span>.updateBatchById(collect);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、改变采购项的状态</span></span><br><span class="line">    collect.forEach((item) -&gt; &#123;</span><br><span class="line">        <span class="comment">// 根据 purchase_id 查询出采购需求</span></span><br><span class="line">        List&lt;PurchaseDetailEntity&gt; entities = purchaseDetailService.listDetailByPurchaseId(item.getId());</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        List&lt;PurchaseDetailEntity&gt; detailEntites = entities.stream().map(entity -&gt; &#123;</span><br><span class="line">            PurchaseDetailEntity detailEntity = <span class="keyword">new</span> PurchaseDetailEntity();</span><br><span class="line"></span><br><span class="line">            detailEntity.setId(entity.getId());</span><br><span class="line">            <span class="comment">// 设置状态正在采购</span></span><br><span class="line">            detailEntity.setStatus(WareConstant.PurchaseDetailStatusEnum.BUYING.getCode());</span><br><span class="line">            <span class="keyword">return</span> detailEntity;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// id批量更新</span></span><br><span class="line">        purchaseDetailService.updateBatchById(detailEntites);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程：</strong></p>
                                <p>业务分析</p>
                                <ul>
                                    <li>采购人员通过 APP 点击采购 完成对应的采购需求，这里使用的是 PostMan 来发送请求，发送请求 带的参数是什么？ 参数就是 采购Id</li>
                                    <li>通过采购 Id 查询出采购相关信息，然后设置采购表的状态，设置成采购成功，同时通过这个 id 在
                                        <code>wms_purchase_detail</code> 表中 <strong>对应的是 purchase_id</strong>
                                        查询采购需求表的数据， 查询到后将他的状态设置成 <strong>“正在采购“</strong></li>
                                </ul>
                                <h3 id="14.3.3-%E5%AE%8C%E6%88%90%E9%87%87%E8%B4%AD" id="14-3-3-完成采购">14.3.3 完成采购</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>采购人员参与采购后，采购就会有他的结果，采购成功、采购失败，</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201024142800046.png"
                                        alt="image-20201024142800046" /></p>
                                <p>有了请求参数，如果比较多，那么底考虑设计一个 VO 哦</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@PostMapping(&quot;/done&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">finish</span><span class="params">(<span class="meta">@RequestBody</span> PurchaseDoneVo doneVo)</span> </span>&#123;</span><br><span class="line">    purchaseService.done(doneVo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Vo</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PurchaseDoneVo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 采购单id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">public</span> List&lt;PurchaseItemDoneVo&gt; items;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">@Data</span><br><span class="line">public class PurchaseItemDoneVo &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 完成&#x2F;失败的需求详情</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private Long itemId;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 状态</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private Integer status;</span><br><span class="line">    </span><br><span class="line">    private String reason;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">(PurchaseDoneVo doneVo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 采购单id</span></span><br><span class="line">    Long id = doneVo.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、改变采购项目的状态</span></span><br><span class="line">    Boolean flag = <span class="keyword">true</span>;</span><br><span class="line">    List&lt;PurchaseItemDoneVo&gt; items = doneVo.getItems();</span><br><span class="line">    List&lt;PurchaseDetailEntity&gt; updates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (PurchaseItemDoneVo item : items) &#123;</span><br><span class="line">        PurchaseDetailEntity detailEntity = <span class="keyword">new</span> PurchaseDetailEntity();</span><br><span class="line">        <span class="comment">// 如果采购失败</span></span><br><span class="line">        <span class="keyword">if</span> (item.getStatus() == WareConstant.PurchaseDetailStatusEnum.HASERROR.getCode()) &#123;</span><br><span class="line">            flag = <span class="keyword">false</span>;</span><br><span class="line">            detailEntity.setStatus(item.getStatus());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 3、将成功采购的进行入库</span></span><br><span class="line">            PurchaseDetailEntity entity = purchaseDetailService.getById(item.getItemId());</span><br><span class="line">            wareSkuService.addStock(entity.getSkuId(),entity.getWareId(),entity.getSkuNum());</span><br><span class="line">            detailEntity.setStatus(WareConstant.PurchaseDetailStatusEnum.FINISH.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">        detailEntity.setId(item.getItemId());</span><br><span class="line">        updates.add(detailEntity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 批量更新</span></span><br><span class="line">    purchaseDetailService.updateBatchById(updates);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、改变采购单状态</span></span><br><span class="line">    PurchaseEntity purchaseEntity = <span class="keyword">new</span> PurchaseEntity();</span><br><span class="line">    purchaseEntity.setId(id);</span><br><span class="line">    <span class="comment">// 设置状态根据变量判断</span></span><br><span class="line">    purchaseEntity.setStatus(flag?WareConstant.PurchaseStatusEnum.FINISH.getCode():WareConstant.PurchaseStatusEnum.HASERROR.getCode());</span><br><span class="line">    purchaseEntity.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line">    <span class="keyword">this</span>.updateById(purchaseEntity);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>addStock方法</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addStock</span><span class="params">(Long skuId, Long wareId, Integer skuNum)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先根据 skuId 和 ware_id 查询 是否拥有这个用户</span></span><br><span class="line">    List&lt;WareSkuEntity&gt; wareSkuEntities = wareSkuDao.selectList(<span class="keyword">new</span> QueryWrapper&lt;WareSkuEntity&gt;().eq(<span class="string">&quot;sku_id&quot;</span>, skuId).eq(<span class="string">&quot;ware_id&quot;</span>, wareId));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//没有这个用户 那就新增</span></span><br><span class="line">    <span class="keyword">if</span>(wareSkuEntities == <span class="keyword">null</span> || wareSkuEntities.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        WareSkuEntity wareSkuEntity = <span class="keyword">new</span> WareSkuEntity();</span><br><span class="line">        <span class="comment">// 根据属性值设置</span></span><br><span class="line">        wareSkuEntity.setSkuId(skuId);</span><br><span class="line">        wareSkuEntity.setStock(skuNum);</span><br><span class="line">        wareSkuEntity.setWareId(wareId);</span><br><span class="line">        wareSkuEntity.setStockLocked(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// TODO 远程查询sku的名字 如果失败整个事务不需要回滚</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 远程调用 根据 skuid进行查询</span></span><br><span class="line">            R info = productFeignService.info(skuId);</span><br><span class="line">            Map&lt;String,Object&gt; map = (Map&lt;String, Object&gt;) info.get(<span class="string">&quot;skuInfo&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (info.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                wareSkuEntity.setSkuName((String) map.get(<span class="string">&quot;skuName&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        wareSkuDao.insert(wareSkuEntity);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 有该记录那就进行更新</span></span><br><span class="line">    wareSkuDao.addStock(skuId,wareId,skuNum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>addStock 具体实现</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;insert id=<span class="string">&quot;addStock&quot;</span>&gt;</span><br><span class="line">UPDATE `wms_ware_sku` SET stock=stock+#&#123;skuNum&#125; WHERE sku_id=#&#123;skuId&#125; AND ware_id=#&#123;wareId&#125;</span><br><span class="line">&lt;/insert&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="14.3.4-spu%E8%A7%84%E6%A0%BC%E7%BB%B4%E6%8A%A4" id="14-3-4-Spu规格维护">14.3.4
                                    Spu规格维护</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>前端项目遇到的问题： 需要自己去 router目录下找到 index.js 增加改行配置，主要是配置规格维护的路径</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201025095926893.png"
                                        alt="image-20201025095926893" /></p>
                                <p>在 Spu管理上 点击规格后查询出相关规格信息</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201025100138990.png"
                                        alt="image-20201025100138990" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@GetMapping(&quot;/base/listforspu/&#123;spuId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">baseAttrListforspu</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span> </span>&#123;</span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; productAttrValueEntity = productAttrValueService.baseAttrListforspu(spuId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>,productAttrValueEntity);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ProductAttrValueEntity&gt; <span class="title">baseAttrListforspu</span><span class="params">(Long spuId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、根据spuid进行查询</span></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; attrValueEntities = <span class="keyword">this</span>.baseMapper.selectList(<span class="keyword">new</span> QueryWrapper&lt;ProductAttrValueEntity&gt;().eq(<span class="string">&quot;spu_id&quot;</span>, spuId));</span><br><span class="line">    <span class="keyword">return</span> attrValueEntities;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程：</strong></p>
                                <p>单表操作，根据 spu_id 查询出 <code>pms_product_attr_value</code> 表的信息</p>
                                <h3 id="14.3.5-spu%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C" id="14-3-5-Spu更新操作">14.3.5
                                    Spu更新操作</h3>
                                <p><strong>具体需求：</strong></p>
                                <p>根据spu_id 查询出规格信息后 ，修改对应信息 提交后会发送一个post请求，并同时带上请求参数</p>
                                <figure class="highlight json">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">[&#123;</span><br><span class="line">	<span class="attr">&quot;attrId&quot;</span>: <span class="number">7</span>,</span><br><span class="line">	<span class="attr">&quot;attrName&quot;</span>: <span class="string">&quot;入网型号&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;attrValue&quot;</span>: <span class="string">&quot;LIO-AL00&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;quickShow&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="attr">&quot;attrId&quot;</span>: <span class="number">14</span>,</span><br><span class="line">	<span class="attr">&quot;attrName&quot;</span>: <span class="string">&quot;机身材质工艺&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;attrValue&quot;</span>: <span class="string">&quot;玻璃&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;quickShow&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="attr">&quot;attrId&quot;</span>: <span class="number">16</span>,</span><br><span class="line">	<span class="attr">&quot;attrName&quot;</span>: <span class="string">&quot;CPU型号&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;attrValue&quot;</span>: <span class="string">&quot;HUAWEI Kirin 980&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;quickShow&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;]</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>刚好这四个参数和实体类的一致，就不需要创建 Vo来接收</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201025100424345.png"
                                        alt="image-20201025100424345" /></p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@RequestMapping(&quot;/update/&#123;spuId&#125;&quot;)</span></span><br><span class="line"><span class="comment">//@RequiresPermissions(&quot;product:attr:update&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">updateSpuAttr</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="meta">@RequestBody</span> List&lt;ProductAttrValueEntity&gt; productAttrValueEntityList)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    productAttrValueService.updateSpuAttr(spuId,productAttrValueEntityList);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 先删除 后更新</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> productAttrValueEntityList</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateSpuAttr</span><span class="params">(Long spuId, List&lt;ProductAttrValueEntity&gt; productAttrValueEntityList)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、根据spuid删除记录</span></span><br><span class="line">    <span class="keyword">this</span>.baseMapper.delete(<span class="keyword">new</span> QueryWrapper&lt;ProductAttrValueEntity&gt;().eq(<span class="string">&quot;spu_id&quot;</span>,spuId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、遍历传递过来的记录 设置 spuId</span></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; collect = productAttrValueEntityList.stream().map(item -&gt; &#123;</span><br><span class="line">        item.setSpuId(spuId);</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 3、批量保存</span></span><br><span class="line">    <span class="keyword">this</span>.saveBatch(collect);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>总结业务流程：</strong></p>
                                <ul>
                                    <li>更新操作，根据前端传递过来的参数来进行更新，前端传递了一个 <code>spu_id</code> 和多个 spu属性值 一个
                                        <code>spu_id</code>对多个 spu 属性值</li>
                                    <li>先根据 <code>spu_id</code> 删除存在 pms_product_attr_value 表的记录</li>
                                    <li>然后对多个 ProductAttrValueEntity 对象设置 sup_id ，最后进行批量保存</li>
                                </ul>
                                <h1 id="%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E7%AF%87%E6%80%BB%E7%BB%93">
                                    分布式基础篇总结</h1>
                                <h2 id="1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"
                                    id="1、分布式基础概念">1、分布式基础概念</h2>
                                <ul>
                                    <li>微服务、注册中心（Nacos）、配置中心（Nacos Cofig）、远程调用、Feign、网关</li>
                                </ul>
                                <h2 id="2%E3%80%81%E5%9F%BA%E7%A1%80%E5%BC%80%E5%8F%91" id="2、基础开发">2、基础开发</h2>
                                <ul>
                                    <li>SpringBoot2.0、SpringCloud、Mybatis-Plus、Vue组件化、阿里云对象存储</li>
                                </ul>
                                <h2 id="3%E3%80%81%E7%8E%AF%E5%A2%83" id="3、环境">3、环境</h2>
                                <ul>
                                    <li>Vagrant、Linux、Docker、MySQL、Redis、逆向工程&amp;人人开源</li>
                                </ul>
                                <h2 id="4%E3%80%81%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83" id="4、开发规范">
                                    <strong>4、开发规范</strong></h2>
                                <ul>
                                    <li>数据效验JSR303、全局异常处理、全局统一返回、全家跨越处理</li>
                                    <li>枚举状态、业务状态、VO与TO与PO划分、逻辑删除</li>
                                    <li>Lombok:@Data、@Slf4j</li>
                                </ul>
                                <h1 id="%3D%E5%88%86%E5%B8%83%E5%BC%8F%E9%AB%98%E7%BA%A7%E7%AF%87%3D">
                                    =<mark><mark><strong>分布式高级篇</strong></mark></mark>=</h1>
                                <h1 id="1%E3%80%81elasticsearch---%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2">1、Elasticsearch
                                    - 全文检索</h1>
                                <h3 id="%E7%AE%80%E4%BB%8B-2" id="简介-v3">简介</h3>
                                <p><a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/cn/what-is/elasticsearch/">https://www.elastic.co/cn/what-is/elasticsearch/</a>
                                </p>
                                <p>全文搜索属于最常见的需求，开源的 Elasticsearch 是目前全文搜索引擎的首选。</p>
                                <p>他可以快速地存储、搜索和分析海量数据。维基百科、Stack Overflow、Github 都采用他</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026084916698.png"
                                        alt="image-20201026084916698" /></p>
                                <p>Elatic 的底层是开源库吧Lucene。但是，你没法直接用，必须自己写代码调用它的接口，Elastic 是 Lunce 的封装，提供了 REST API
                                    的操作接口，开箱即用</p>
                                <p>REST API：天然的跨平台</p>
                                <p>官网文档：<a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a>
                                </p>
                                <p>官网中文：<a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a>
                                </p>
                                <p>社区中文：</p>
                                <p><a target="_blank" rel="noopener"
                                        href="http://doc.codingdict.com/elasticsearch/">http://doc.codingdict.com/elasticsearch/</a>
                                </p>
                                <h3 id="1.1%E3%80%81%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5" id="1-1、基本概念">1.1、基本概念</h3>
                                <h4 id="1.1.1-index(%E7%B4%A2%E5%BC%95)" id="1-1-1-index-索引">1.1.1 index(索引)</h4>
                                <p>动词，相当于 MySQL 中的 insert；</p>
                                <p>名词，相当于MySQL 中的 DataBase</p>
                                <h4 id="1.1.2-type(%E7%B1%BB%E5%9E%8B)" id="1-1-2-Type-类型">1.1.2 Type(类型)</h4>
                                <p>在 Index（索引）中，可以定义一个或多个类型</p>
                                <p>类似于 MySQL 中的 Table，每一种类型的数据放在一起</p>
                                <h4 id="1.1.3-document(%E6%96%87%E6%A1%A3)" id="1-1-3-Document-文档">1.1.3 Document(文档)
                                </h4>
                                <p>保存在某个索引（index）下，某种类型（Type）的一个数据（Document）,文档是 JSON 格式的，Document 就像是 MySQL 中某个 Table
                                    里面的内容</p>
                                <h4 id="1.1.4-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6" id="1-1-4-倒排索引机制">
                                    1.1.4 倒排索引机制</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026092738311.png"
                                        alt="image-20201026092738311" /></p>
                                <h3 id="1.2-docker-%E5%AE%89%E8%A3%85-es" id="1-2-Docker-安装-ES">1.2 Docker 安装 ES</h3>
                                <h4 id="1.2.1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F" id="1-2-1-下载镜像">1.2.1 下载镜像</h4>
                                <p>docker pull elasticsearch:7.4.2 存储和检索数据</p>
                                <p>docker pull kibana:7.4.2 可视化检索数据</p>
                                <h4 id="1.2.2-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B" id="1-2-2-创建实例">1.2.2 创建实例</h4>
                                <h5 id="1%E3%80%81elasticsearch" id="1、ElasticSearch">1、ElasticSearch</h5>
                                <p>配置</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">mkdir -p /mydata/elasticsearch/config <span class="comment"># 用来存放配置文件</span></span><br><span class="line">mkdir -p /mydata/elasticsearch/data  <span class="comment"># 数据</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;http.host: 0.0.0.0&quot;</span> &gt;/mydata/elasticsearch/config/elasticsearch.yml <span class="comment"># 允许任何机器访问</span></span><br><span class="line">chmod -R 777 /mydata/elasticsearch/ <span class="comment">## 设置elasticsearch文件可读写权限</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>启动</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \</span><br><span class="line">-e  <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">-e ES_JAVA_OPTS=<span class="string">&quot;-Xms64m -Xmx512m&quot;</span> \</span><br><span class="line">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v  /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-d elasticsearch:7.4.2 </span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>开机启动 elasticsearch</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker update elasticsearch --restart=always</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>以后再外面装好插件重启就可</p>
                                <p>特别注意：</p>
                                <p>-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx128m&quot; \ 测试环境下，设置 ES 的初始内存和最大内存，否则导致过大启动不了ES
                                </p>
                                <h5 id="2%E3%80%81kibana" id="2、Kibana">2、Kibana</h5>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker run --name kibana -e ELASTICSEARCH_HOSTS=http://192.168.56.10:9200 -p 5601:5601 -d kibana:7.4.2</span><br><span class="line"></span><br><span class="line">http://192.168.56.10:9200 改成自己Elasticsearch上的地址</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="3%E3%80%81%E5%AE%89%E8%A3%85nginx" id="3、安装nginx">3、安装nginx</h5>
                                <p>随便启动一个 nginx 实例，只是为了复制出配置</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker run -p80:80 --name nginx -d nginx:1.10   </span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>将容器内的配置文件拷贝到当前目录 （注意后面有个小点</p>
                                <p>）</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker container cp nginx:/etc/nginx .  </span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>创建nginx文件夹</p>
                                <figure class="highlight shell">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">mkdir -p /mydata/nginx/html</span><br><span class="line">mkdir -p /mydata/nginx/logs</span><br><span class="line"><span class="meta"> #</span><span class="bash">由于拷贝完成后会在config中存在一个nginx文件夹，所以需要将它的内容移动到conf中</span></span><br><span class="line"><span class="meta"> #</span><span class="bash">conf 文件夹下就是原先nginx的配置</span></span><br><span class="line">mv /mydata/nginx/conf/nginx/* /mydata/nginx/conf/</span><br><span class="line">rm -rf /mydata/nginx/conf/nginx</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>别忘了后面的点</p>
                                <p>修改文件名称：mv nginx.conf 把这个conf 移动到 /mydata/nginx 下</p>
                                <p>终止原容器， docker stop nginx</p>
                                <p>执行命令删除容器：docker rm $Containerid</p>
                                <p>创建新的 nginx 执行以下命令</p>
                                <figure class="highlight bash">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker run -p 80:80 --name nginx \</span><br><span class="line">-v /mydata/nginx/html:/usr/share/nginx/html \</span><br><span class="line">-v /mydata/nginx/logs:/var/<span class="built_in">log</span>/nginx \</span><br><span class="line">-v /mydata/nginx/conf/:/etc/nginx \</span><br><span class="line">-d nginx:1.10</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="1.3-%E5%88%9D%E6%AD%A5%E6%A3%80%E7%B4%A2" id="1-3-初步检索">1.3 初步检索</h3>
                                <h4 id="1.3.1%E3%80%81_cat" id="1-3-1、-cat">1.3.1、_cat</h4>
                                <p>GET /_cat/nodes：查看所有节点</p>
                                <p>GET /_cat/health：查看 es 健康状况</p>
                                <p>GET /_cat/master：查看主节点</p>
                                <p>GET /_cat/incices：查看所有索引 show databases;</p>
                                <h4 id="1.3.2-%E7%B4%A2%E5%BC%95%E4%B8%80%E4%B8%AA%E6%96%87%E6%A1%A3%EF%BC%88%E4%BF%9D%E5%AD%98%EF%BC%89"
                                    id="1-3-2-索引一个文档（保存）">1.3.2 索引一个文档（保存）</h4>
                                <p>保存一个数据，保存在哪个索引的哪个类型下，指定用哪个唯一标识</p>
                                <p>PUT customer/external/1; 在 customer 索引下的 external 类型下保存 1号数据为</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">PUT customer/external/1</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="1.3.3%E3%80%81%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3" id="1-3-3、查询文档">1.3.3、查询文档
                                </h4>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET custome/external/1</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>结果：</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;customer&quot;</span>, <span class="comment">// 在那个索引</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;external&quot;</span>, <span class="comment">// 在那个类型</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="comment">// 记录id</span></span><br><span class="line">    &quot;_version&quot;: 1, 。// 版本号</span><br><span class="line">    &quot;_seq_no&quot;: 0, // 并发控制字段，每次更新就会+1，用来做乐观锁</span><br><span class="line">    &quot;_primary_term&quot;: 1, //同上，主分片重新分配，如重启，就会变化</span><br><span class="line">    &quot;found&quot;: true, </span><br><span class="line">    &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;John Doe&quot; // 真正的内容</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">更新携带：?if_seq_no&#x3D;4&amp;if_primary_term&#x3D;1</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="1.3.4-%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3" id="1-3-4-更新文档">1.3.4 更新文档</h4>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">POST customer/external/1/_update</span><br><span class="line">&#123;</span><br><span class="line">	&quot;doc&quot;:&#123;</span><br><span class="line">		&quot;name&quot;:&quot;John Doew&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line">POST customer/external/1</span><br><span class="line">&#123;</span><br><span class="line">	&quot;name&quot;:&quot;John Doe2&quot;</span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line">PUT customer/external/1</span><br><span class="line">&#123;</span><br><span class="line">	&quot;name&quot;:&quot;jack&quot;</span><br><span class="line">&#125;</span><br><span class="line">不同：Post操作会对比源文档数据，如果相同不会有什么操作，文档 version 不增加 PUT操作总会将数据重新保存并增加 version 版本</span><br><span class="line">带 _update 对比元数据如果一样就不进行任何操作</span><br><span class="line">看场景</span><br><span class="line">对于大并发更新，不带update</span><br><span class="line">对于大并发查询并偶尔更新，带update 对比更新，重新计算分配规则</span><br><span class="line">更新同时增加属性</span><br><span class="line">POS customer/external/1/_update</span><br><span class="line">&#123;</span><br><span class="line">	&quot;doc&quot;:&#123;&quot;name&quot;:&quot;Jane Doe&quot;,&quot;age&quot;:20&#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT 和 POST 不带_update也可以</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="1.3.5-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3%26%E7%B4%A2%E5%BC%95"
                                    id="1-3-5-删除文档-索引">1.3.5 删除文档&amp;索引</h4>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">DELETE customer/external/1</span><br><span class="line">DELETE customer</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="1.3.6-bulk-%E6%89%B9%E9%87%8F-api" id="1-3-6-bulk-批量-API">1.3.6 bulk 批量 API</h4>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">POST customer/external/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>语法格式</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#123;action:&#123;metadata&#125;&#125;\n</span><br><span class="line">&#123;requeestBody&#125;\n</span><br><span class="line">&#123;action:&#123;metadata&#125;&#125;\n</span><br><span class="line">&#123;requesetbod &#125;\n</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>复杂实例：</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;my first blog post&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;my second blog post&quot;&#125;</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;my updated blog post&quot;&#125;&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>bulk API以此按顺序执行所有的action (动作)。如果一一个单个的动作因任何原因而失败，它将继续处理它后面剩余的动作。当bulkAPI
                                    返回时，它将提供每个动作的状态(与发送的顺序相同)，所以您可以检查是否一个指定的动作是不是失败了。</p>
                                <h4 id="1.3.7-%E6%A0%B7%E6%9C%AC%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE" id="1-3-7-样本测试数据">
                                    1.3.7 样本测试数据</h4>
                                <p>我准备了一份顾客银行账户信息虚构的 JSON 文档样本，每个用户都有下列的 schema （模式）：</p>
                                <figure class="highlight json">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;account_number&quot;</span>: <span class="number">1</span>,</span><br><span class="line">	<span class="attr">&quot;balance&quot;</span>: <span class="number">39225</span>,</span><br><span class="line">	<span class="attr">&quot;firstname&quot;</span>: <span class="string">&quot;Amber&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;lastname&quot;</span>: <span class="string">&quot;Duke&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;age&quot;</span>: <span class="number">32</span>,</span><br><span class="line">	<span class="attr">&quot;gender&quot;</span>: <span class="string">&quot;M&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;address&quot;</span>: <span class="string">&quot;880 Holmes Lane&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;employer&quot;</span>: <span class="string">&quot;Pyrami&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;email&quot;</span>: <span class="string">&quot;amberduke@pyrami.com&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;city&quot;</span>: <span class="string">&quot;Brogan&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;state&quot;</span>: <span class="string">&quot;IL&quot;</span></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><a target="_blank" rel="noopener"
                                        href="https://github.com/elastic/elasticsearch/edit/master/docs/src/test/resources/accounts.json">https://github.com/elastic/elasticsearch/edit/master/docs/src/test/resources/accounts.json</a>
                                </p>
                                <p>导入测试数据</p>
                                <p>POST bank/account/_bank</p>
                                <p>测试数据</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026114903942.png"
                                        alt="image-20201026114903942" /></p>
                                <h3 id="1.4-%E8%BF%9B%E9%98%B6%E6%A3%80%E7%B4%A2" id="1-4-进阶检索">1.4 进阶检索</h3>
                                <h4 id="1.4.1-searchapi" id="1-4-1-SearchAPI">1.4.1 SearchAPI</h4>
                                <p>ES 支持两种基本方式检索:</p>
                                <ul>
                                    <li>一个是通过使用 REST request URL,发送搜索参数，(uri + 检索参数)</li>
                                    <li>另一个是通过使用 REST request bod 来发送他们，(uri + 请求体)</li>
                                </ul>
                                <p>1、检索信息</p>
                                <p>一切检索从_search开始</p>
                                <p>GET /bank/_search 检索 bank 下的所有信息，包括 type 和 docs</p>
                                <p>GET /bank/_search?q=*&amp;sort=account_number:asc 请求参数方式检索</p>
                                <p>响应结果解释<br />
                                    took - Elasticearch执行搜索的时间(毫秒)</p>
                                <p>time_ out - 告诉我们搜索是否超时</p>
                                <p>_shards - 告诉我们多少个分片被搜索了，以及统计了成功/失败的搜索分片<br />
                                    hit - 搜索结果<br />
                                    hits.total - 搜索结果<br />
                                    hits.hits - 实际的搜索结果数组(默认为前10的文档)<br />
                                    sort - 结果的排序key (键) (没有则按 score 排序)<br />
                                    score 和 max score - 相关性得分和最高得分(全文检索用)</p>
                                <p>uri + 请求体进行检查</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match_all&quot;</span>: &#123;&#125; &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123; <span class="string">&quot;account_number&quot;</span>: <span class="string">&quot;asc&quot;</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>HTTP 客户端工具（POSTMAN）,get请求不能携带请求体，我们变为 post也是一样的 我们 POST 一个 JSON风格的查询请求体到 _search API
                                </p>
                                <p>需要了解，一旦搜索结果被返回，ES 就完成了这次请求的搜索，并且不会维护任何服务端的资源或者结果的 cursor（游标）</p>
                                <h4 id="1.4.2%E3%80%81querydsl" id="1-4-2、QueryDSL">1.4.2、QueryDSL</h4>
                                <h5 id="1%E3%80%81%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F" id="1、基本语法格式">
                                    1、基本语法格式</h5>
                                <p>ES 提供了一个可以执行查询的 Json 风格的 DSL （domain-specifig langurage 领域特定语言），这个被成为 Query DSL
                                    ，该查询语言非常全面，并且刚开始的时候优点复杂，真正学好对他的方法是从一些基础的示例开始的</p>
                                <p>一个查询语句 的典型结构</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME:&#123;</span><br><span class="line">        ARGUMENT:VALUE,</span><br><span class="line">        ARGUMENT:VALUE.....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>如果针对某个字段，那么它的结构如下</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME:&#123;</span><br><span class="line">        FIELD_NAME:&#123;</span><br><span class="line">            ARGUMENT:VALUE,</span><br><span class="line">            ARGUMENT:VALUE.....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123; &quot;account_number&quot;: &quot;asc&quot; &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;from&quot;: 10,</span><br><span class="line">  &quot;size&quot;: 10</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>query 定义如何查询</p>
                                <p>match_all 查询类型【代表查询所有的所有】，es中可以在 query中 组合非常多的查询类型完成复杂查询</p>
                                <p>除了 query 参数之外，我们也可以传递其他的参数改变查询结构，如 sort，size</p>
                                <p>from + size 限定，完成分页功能</p>
                                <p>sort排序，多字段排序，会在前序字段相等时后续字段内部排序，否则以前序为准</p>
                                <h5 id="2%E3%80%81%E8%BF%94%E5%9B%9E%E9%83%A8%E5%88%86%E5%AD%97%E6%AE%B5" id="2、返回部分字段">
                                    2、返回部分字段</h5>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;balance&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;from&quot;: 5,</span><br><span class="line">  &quot;size&quot;: 5,</span><br><span class="line">  &quot;_source&quot;: [&quot;firstname&quot;,&quot;lastname&quot;]</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="3%E3%80%81match%E3%80%90%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2%E3%80%91"
                                    id="3、match【匹配查询】">3、match【匹配查询】</h5>
                                <p>基本类型(非字符串)，精准匹配</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">   &quot;match&quot;: &#123;</span><br><span class="line">     &quot;address&quot;: &quot;mill lane&quot;</span><br><span class="line">   &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>全文检索按照评分进行排序，会对检索条件进行分词匹配</p>
                                <h5 id="4%E3%80%81match_phrase%E3%80%90%E7%9F%AD%E8%AF%AD%E5%8C%B9%E9%85%8D%E3%80%91"
                                    id="4、match-phrase【短语匹配】">4、match_phrase【短语匹配】</h5>
                                <p>将需要匹配的值当成一个整体单词（不分词）进行检索</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_phrase&quot;: &#123; &quot;address&quot;: &quot;mill lane&quot; &#125; &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="5%E3%80%81multi_match%E3%80%90%E5%A4%9A%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D%E3%80%91"
                                    id="5、multi-match【多字段匹配】">5、multi_match【多字段匹配】</h5>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;mill&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;address&quot;,&quot;city&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="6%E3%80%81bool-%E3%80%90%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2%E3%80%91"
                                    id="6、bool-【复合查询】">6、bool 【复合查询】</h5>
                                <p>bool 用来做复合查询</p>
                                <p>复合语句可以合并 任何 其他嵌套语句，包括复合语句，了解这一点是很重要的，这就意味着，复合语句之间可以互相嵌套，可以表达式非常复杂的逻辑</p>
                                <ul>
                                    <li>must：必须达到 must 列举的所有条件</li>
                                </ul>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;gender&quot;: &quot;M&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &quot;mill&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;:&#123;</span><br><span class="line">          &quot;age&quot;:&quot;18&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;lastname&quot;: &quot;Wallace&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <ul>
                                    <li>should:应该达到 should 列举的条件，如果达到会增加相关文档的评分，并不会改变查询的结果，如果 query 中只有 should
                                        且只有一种匹配规则，那么 should的条件就会被作为默认匹配条件而区改变查询结果</li>
                                </ul>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&quot;should&quot;: [</span><br><span class="line">       &#123;<span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">         <span class="attr">&quot;lastname&quot;</span>: <span class="string">&quot;Wallace&quot;</span></span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ]</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <ul>
                                    <li>must_not 必须不是指定的情况</li>
                                </ul>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&quot;must_not&quot;: [</span><br><span class="line">        &#123;<span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">          <span class="attr">&quot;age&quot;</span>:<span class="string">&quot;18&quot;</span></span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ],</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026052225903.png"
                                        alt="image-20201026052225903" /></p>
                                <h5 id="7%E3%80%81filter%E3%80%90%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4%E3%80%91"
                                    id="7、filter【结果过滤】">7、filter【结果过滤】</h5>
                                <p>并不是所有的查询都需要产生分数，特别是那些仅仅用于 filtering（过滤）的文档，为了不计算分数 ES 会自动检查场景并且优化查询的执行</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;balance&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 20000,</span><br><span class="line">            &quot;lte&quot;: 30000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="8%E3%80%81term" id="8、term">8、term</h5>
                                <p>和 match 一样，匹配某个属性的值，全文检索字段用 match，其他非text字段匹配用 term</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;789 Madison Street&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="9%E3%80%81aggregations%EF%BC%88%E6%89%A7%E8%A1%8C%E8%81%9A%E5%90%88%EF%BC%89"
                                    id="9、aggregations（执行聚合）">9、aggregations（执行聚合）</h5>
                                <p>聚合提供了从数据分组和提取数据的能力，最简单的聚合方法大致等于 SQL GROUP BY 和 SQL 聚合函数，在 ES 中，你有执行搜索返回 hits （命中结果）
                                    并且同时返回聚合结果，把一个响应中的所有
                                    hits（命中结果）分隔开的能力，这是非常强大有效的，你可以执行查询和多个聚合，并且在一个使用中得到各自的（任何一个的）返回结果，使用一次简洁简化的 API
                                    来避免网络往返</p>
                                <p><strong>搜索address中包含mill的所有人的年龄分布以及平均年龄</strong></p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;mill&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;ageAgg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ageAvg&quot;:&#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;balanceAvg&quot;:&#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;:0</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>按照年龄聚合，并且请求这些年龄段的这些人的平均薪资</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;ageAgg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ageAvg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>查出所有年龄分布，并且这些年龄段中M的平均薪资和 F 的平均薪资以及这个年龄段的总体平均薪资</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;ageAgg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">100</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;genderAgg&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span>,</span><br><span class="line">            <span class="string">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;balanceAvg&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="10%E3%80%81nested" id="10、nested">10、nested</h5>
                                <p>嵌套查询</p>
                                <p>数据类型概览</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201225063939652.png"
                                        alt="image-20201225063939652" /></p>
                                <p>参考博客：<a target="_blank" rel="noopener"
                                        href="https://elastic.blog.csdn.net/article/details/82950393">https://elastic.blog.csdn.net/article/details/82950393</a>
                                </p>
                                <h4 id="1.4.3-mapping" id="1-4-3-Mapping">1.4.3 Mapping</h4>
                                <h5 id="1%E3%80%81%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B" id="1、字段类型">1、字段类型</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026074813810.png"
                                        alt="image-20201026074813810" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026074841875.png"
                                        alt="image-20201026074841875" /></p>
                                <h5 id="2%E3%80%81%E6%98%A0%E5%B0%84" id="2、映射">2、映射</h5>
                                <p>Mapping（映射）</p>
                                <p>Mapping 是用来定义一个文档（document）,以及他所包含的属性（field）是如何存储索引的，比如使用 mapping来定义的：</p>
                                <ul>
                                    <li>哪些字符串属性应该被看做全文本属性（full text fields）</li>
                                    <li>那些属性包含数字，日期或者地理位置</li>
                                    <li>文档中的所有属性是能被索引（_all 配置）</li>
                                    <li>日期的格式</li>
                                    <li>自定义映射规则来执行动态添加属性</li>
                                </ul>
                                <p>查看 mapping 信息</p>
                                <p>GET bank/_mapping</p>
                                <p>修改 mapping 信息</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-types.html</a>
                                </p>
                                <p>自动猜测的映射类型</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026075424198.png"
                                        alt="image-20201026075424198" /></p>
                                <h5 id="3%E3%80%81%E6%96%B0%E7%89%88%E6%9C%AC%E6%94%B9%E5%8F%98" id="3、新版本改变">3、新版本改变
                                </h5>
                                <ul>
                                    <li>
                                        <p>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用，但ES中不是这样的。elasticsearch
                                            是基于Lucene开发的搜索引擎，而ES中不同type下名称相同的filed 最终在Lucene,中的处理方式是一样的。</p>
                                    </li>
                                    <li>
                                        <p>两个不同 type下的两个user_ name,
                                            在ES同-个索引下其实被认为是同一一个filed,你必须在两个不同的type中定义相同的filed映射。否则，不同typpe中的相同字段称就会在处理中出现神突的情况，导致Lucene处理效率下降。
                                        </p>
                                    </li>
                                    <li>
                                        <p>去掉type就是为了提高ES处理数据的效率。</p>
                                    </li>
                                </ul>
                                <p>ES 7.x</p>
                                <p>URL 中的 type 参数 可选，比如索引一个文档不再要求提供文档类型</p>
                                <p>ES 8.X</p>
                                <p>不在支持 URL 中的 type 参数</p>
                                <p>解决：</p>
                                <p>1、将索引从多类型迁移到单类型，每种类型文档一个独立的索引</p>
                                <p>2、将已存在的索引下的类型数据，全部迁移到指定位置即可，详见数据迁移</p>
                                <p><strong>1、创建映射</strong></p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;:&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;age&quot;:&#123;&quot;type&quot;:&quot;integer&quot;&#125;,</span><br><span class="line">      &quot;email&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>2、添加新的字段映射</strong></p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">PUT /my_index/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;:&#123;</span><br><span class="line">    &quot;employeeid&quot;:&#123;</span><br><span class="line">      &quot;type&quot;:&quot;keyword&quot;,</span><br><span class="line">      &quot;index&quot;:false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="3%E3%80%81%E6%9B%B4%E6%96%B0%E6%98%A0%E5%B0%84" id="3、更新映射">3、更新映射</h5>
                                <p>对于已经存在的映射字段，我们不能更新，更新必须创建新的索引进行数据迁移</p>
                                <p><strong>4、数据迁移</strong></p>
                                <p>先创 new_twitter 的正确映射，然乎使用如下方式进行数据迁移</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">POST _reindex [固定写法]</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;:&#123;</span><br><span class="line">    &quot;index&quot;:&quot;twitter&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;:&#123;</span><br><span class="line">    &quot;index&quot;:&quot;new_twitter&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">## 将旧索引的 type 下的数据进行迁移</span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;:&quot;twitter&quot;,</span><br><span class="line">    &quot;type&quot;:&quot;tweet&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;:&#123;</span><br><span class="line">    &quot;index&quot;:&quot;twweets&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>参考官网：<a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-types.html</a>
                                </p>
                                <p>参数映射规则：<a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-params.html#mapping-params">https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-params.html#mapping-params</a>
                                </p>
                                <h4 id="1.4.4-%E5%88%86%E8%AF%8D" id="1-4-4-分词">1.4.4 分词</h4>
                                <p>一个 <strong>tokenizer</strong>（分词器）接收一个字符流，将之分割为独立的
                                    <strong>tokens</strong>（词元，通常是独立的单词），然后输出 <strong>token</strong> 流</p>
                                <p>列如，witespace tokenizer 遇到的空白字符时分割文本，它会将文本 “Quick brown fox” 分割为 【Quick brown fox】</p>
                                <p>该 <strong>tokenizer</strong> (分词器)还负责记录各个<strong>term</strong> (词条)的顺序或
                                    <strong>position</strong> 位置(用于<strong>phrase</strong>短语和<strong>word</strong>
                                    proximity词近邻查询)，以及</p>
                                <p><strong>term</strong> (词条)所代表的原始 <strong>word</strong> (单词)的start(起始)和end (结束)的
                                    <strong>character</strong> <strong>offsets</strong> (字符偏移量) (用于 高亮显示搜索的内容)。</p>
                                <p><strong>Elasticsearch</strong> 提供了很多内置的分词器，可以用来构建custom analyzers(自定义分词器)</p>
                                <h5 id="1%E3%80%81%E5%AE%89%E8%A3%85-ik-%E5%88%86%E8%AF%8D%E5%99%A8" id="1、安装-ik-分词器">
                                    1、安装 ik 分词器</h5>
                                <p>注意:不能用默认的 elasticsearch-plugin.install xxx.zip 进行自动安装</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a>
                                    下载与 es对应的版本</p>
                                <p>安装后拷贝到 plugins 目录下</p>
                                <h5 id="2%E3%80%81%E6%B5%8B%E8%AF%95" id="2、测试">2、测试</h5>
                                <p>分词器</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201026092255250.png"
                                        alt="image-20201026092255250" /></p>
                                <p><strong>3、自定义词库</strong></p>
                                <p>修改 /usr/share/elasticsearch/plugins/ik/config/中的 IKAnalyzer.cfg.xml</p>
                                <p>/usr/share/elasticsearch/plugins/ik/config</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">        &lt;entry key=&quot;ext_dict&quot;&gt;&lt;/entry&gt;</span><br><span class="line">         &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">        &lt;entry key=&quot;ext_stopwords&quot;&gt;&lt;/entry&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br><span class="line">         &lt;entry key=<span class="string">&quot;remote_ext_dict&quot;</span>&gt;http:<span class="comment">//192.168.56.10/es/fenci.txt&lt;/entry&gt;</span></span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br><span class="line">        &lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="1.5-elasticsearch---rest---client" id="1-5-Elasticsearch-Rest-client">1.5
                                    Elasticsearch - Rest - client</h3>
                                <p>1、9300：TCP</p>
                                <p>Spring-data-elasticsearch:transport-api.jar</p>
                                <p>SpringBoot版本不同，<code>transport-api.jar</code> 不同，不能适配 es 版本</p>
                                <p>7.x 已经不在适合使用，8 以后就要废弃</p>
                                <p><strong>2、9200：HTTP</strong></p>
                                <p>JestClient 非官方，更新慢</p>
                                <p>RestTemplate:默认发送 HTTP 请求，ES很多操作都需要自己封装、麻烦</p>
                                <p>HttpClient：同上</p>
                                <p>Elasticsearch - Rest - Client：官方RestClient，封装了 ES 操作，API层次分明</p>
                                <p>最终选择 Elasticsearch - Rest - Client （elasticsearch - rest - high - level - client）</p>
                                <h4 id="1.5.1-springboot-%E6%95%B4%E5%90%88" id="1-5-1-SpringBoot-整合">1.5.1 SpringBoot
                                    整合</h4>
                                <p>1、Pom.xml</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">&lt;!-- 导入es的 rest-high-level-client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>为什么要导入这个？这个配置那里来的？</p>
                                <p>官网：<a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-maven.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-maven.html</a>
                                </p>
                                <h4 id="1.5.2-config%E9%85%8D%E7%BD%AE" id="1-5-2-Config配置">1.5.2 Config配置</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-10-26</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1、导入配置</span></span><br><span class="line"><span class="comment"> * 2、编写配置，给容器注入一个RestHighLevelClient</span></span><br><span class="line"><span class="comment"> * 3、参照API 官网进行开发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallElasticsearchConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestOptions COMMON_OPTIONS;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();</span><br><span class="line"><span class="comment">//        builder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + TOKEN);</span></span><br><span class="line"><span class="comment">//        builder.setHttpAsyncResponseConsumerFactory(</span></span><br><span class="line"><span class="comment">//                new HttpAsyncResponseConsumerFactory</span></span><br><span class="line"><span class="comment">//                        .HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024));</span></span><br><span class="line">        COMMON_OPTIONS = builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">esRestClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestClientBuilder builder = <span class="keyword">null</span>;</span><br><span class="line">        builder = RestClient.builder(<span class="keyword">new</span> HttpHost(<span class="string">&quot;192.168.56.10&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>));</span><br><span class="line"></span><br><span class="line">        RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(builder);</span><br><span class="line"><span class="comment">//        RestHighLevelClient client = new RestHighLevelClient(</span></span><br><span class="line"><span class="comment">//                RestClient.builder(</span></span><br><span class="line"><span class="comment">//                        new HttpHost(&quot;localhost&quot;, 9200, &quot;http&quot;),</span></span><br><span class="line"><span class="comment">//                        new HttpHost(&quot;localhost&quot;, 9201, &quot;http&quot;)));</span></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>官网：<a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-initialization.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-initialization.html</a>
                                </p>
                                <h4 id="1.5.3-%E4%BD%BF%E7%94%A8" id="1-5-3-使用">1.5.3 使用</h4>
                                <blockquote>
                                    <p>测试是否注入成功</p>
                                </blockquote>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(client);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>测试是否能 添加 或更新数据</p>
                                </blockquote>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加或者更新</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">indexData</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setAge(<span class="number">19</span>);</span><br><span class="line">    user.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">    user.setUserName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">    String jsonString = JSON.toJSONString(user);</span><br><span class="line">    indexRequest.source(jsonString,XContentType.JSON);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行操作</span></span><br><span class="line">    IndexResponse index = client.index(indexRequest, GulimallElasticsearchConfig.COMMON_OPTIONS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提取有用的响应数据</span></span><br><span class="line">    System.out.println(index);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>测试复杂检索</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 1、创建检索请求</span></span><br><span class="line">        SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        <span class="comment">// 指定索引</span></span><br><span class="line">        searchRequest.indices(<span class="string">&quot;bank&quot;</span>);</span><br><span class="line">        <span class="comment">// 指定 DSL，检索条件</span></span><br><span class="line">        SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line"></span><br><span class="line">        sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;mill&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、2 按照年龄值分布进行聚合</span></span><br><span class="line">        TermsAggregationBuilder aggAvg = AggregationBuilders.terms(<span class="string">&quot;ageAgg&quot;</span>).field(<span class="string">&quot;age&quot;</span>).size(<span class="number">10</span>);</span><br><span class="line">        sourceBuilder.aggregation(aggAvg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、3 计算平均薪资</span></span><br><span class="line">        AvgAggregationBuilder balanceAvg = AggregationBuilders.avg(<span class="string">&quot;balanceAvg&quot;</span>).field(<span class="string">&quot;balance&quot;</span>);</span><br><span class="line">        sourceBuilder.aggregation(balanceAvg);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;检索条件&quot;</span> + sourceBuilder.toString());</span><br><span class="line"></span><br><span class="line">        searchRequest.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、执行检索</span></span><br><span class="line">        SearchResponse searchResponse = client.search(searchRequest, GulimallElasticsearchConfig.COMMON_OPTIONS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、分析结果</span></span><br><span class="line">        System.out.println(searchResponse.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、拿到命中得结果</span></span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">// 5、搜索请求的匹配</span></span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">// 6、进行遍历</span></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            <span class="comment">// 7、拿到完整结果字符串</span></span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            <span class="comment">// 8、转换成实体类</span></span><br><span class="line">            Accout accout = JSON.parseObject(sourceAsString, Accout.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;account:&quot;</span> + accout );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9、拿到聚合</span></span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line"><span class="comment">//        for (Aggregation aggregation : aggregations) &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">// 10、通过先前名字拿到对应聚合</span></span><br><span class="line">        Terms ageAgg1 = aggregations.get(<span class="string">&quot;ageAgg&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : ageAgg1.getBuckets()) &#123;</span><br><span class="line">            <span class="comment">// 11、拿到结果</span></span><br><span class="line">            String keyAsString = bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;年龄:&quot;</span> + keyAsString);</span><br><span class="line">            <span class="keyword">long</span> docCount = bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;个数：&quot;</span> + docCount);</span><br><span class="line">        &#125;</span><br><span class="line">        Avg balanceAvg1 = aggregations.get(<span class="string">&quot;balanceAvg&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;平均薪资：&quot;</span> + balanceAvg1.getValue());</span><br><span class="line">        System.out.println(searchResponse.toString());</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>结果：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">accout:GulimallSearchApplicationTests.Accout(account_number=<span class="number">970</span>, balance=<span class="number">19648</span>, firstname=Forbes, lastname=Wallace, age=<span class="number">28</span>, gender=M, address=<span class="number">990</span> Mill Road, employer=Pheast, email=forbeswallace<span class="meta">@pheast</span>.com, city=Lopezo, state=AK)accout:GulimallSearchApplicationTests.Accout(account_number=<span class="number">136</span>, balance=<span class="number">45801</span>, firstname=Winnie, lastname=Holland, age=<span class="number">38</span>, gender=M, address=<span class="number">198</span> Mill Lane, employer=Neteria, email=winnieholland<span class="meta">@neteria</span>.com, city=Urie, state=IL)accout:GulimallSearchApplicationTests.Accout(account_number=<span class="number">345</span>, balance=<span class="number">9812</span>, firstname=Parker, lastname=Hines, age=<span class="number">38</span>, gender=M, address=<span class="number">715</span> Mill Avenue, employer=Baluba, email=parkerhines<span class="meta">@baluba</span>.com, city=Blackgum, state=KY)accout:GulimallSearchApplicationTests.Accout(account_number=<span class="number">472</span>, balance=<span class="number">25571</span>, firstname=Lee, lastname=Long, age=<span class="number">32</span>, gender=F, address=<span class="number">288</span> Mill Street, employer=Comverges, email=leelong<span class="meta">@comverges</span>.com, city=Movico, state=MT)年龄:<span class="number">38</span></span><br><span class="line">个数:<span class="number">2</span></span><br><span class="line">年龄:<span class="number">28</span></span><br><span class="line">个数:<span class="number">1</span></span><br><span class="line">年龄:<span class="number">32</span></span><br><span class="line">个数:<span class="number">1</span></span><br><span class="line">平均薪水:<span class="number">25208.0</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>总结：参考官网的API 和对应在 kibana 中发送的请求，在代码中通过调用对应API实现效果</p>
                                <p>官网：<a target="_blank" rel="noopener"
                                        href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html#java-rest-high-search-request-optional">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html#java-rest-high-search-request-optional</a>
                                </p>
                                <p>ELK</p>
                                <p>Elasticsearch 用于检索数据</p>
                                <p>logstach：存储数据</p>
                                <p>Kiban:视图化查看数据</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201027120603889.png"
                                        alt="image-20201027120603889" /></p>
                                <h1
                                    id="2%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6">
                                    2、商城业务 &amp; 商品上架</h1>
                                <p>上架的商品才可以在网站展示</p>
                                <p>上架的商品需要可以检索</p>
                                <h3 id="2.1-%E5%95%86%E5%93%81mapping" id="2-1-商品Mapping">2.1 商品Mapping</h3>
                                <p>分析：商品上架在 es 中是存入 sku 还是 spu ？</p>
                                <p>1、检索的时候输入名字，是需要按照 sku 的 title进行全文检索的</p>
                                <p>2、检索使用商品规格，规格是 spu 的公共属性，每个 spu 是一样的</p>
                                <p>3、按照分类 id 进去的 都是直接列出 spu的，还可以切换</p>
                                <p>4、我们如果将 sku 的 全量信息 保存在 es 中 （包括 spu 属性），就太多量字段了</p>
                                <p>5、如果我们将 spu 以及他包含的 sku 信息保存到 es 中，也可以方</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">PUT product</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;:&#123;</span><br><span class="line">    &quot;properties&quot;:&#123;</span><br><span class="line">      &quot;skuId&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">       &quot;spuId&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">       &quot;skuTitle&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">       &quot;skuPrice&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">       &quot;skuImg&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">       &quot;saleCount&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">       &quot;hasStock&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;boolean&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;hotScore&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandId&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catelogId&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandName&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandImg&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;keyword&quot;,</span><br><span class="line">         &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catalogName&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;keyword&quot;,</span><br><span class="line">         &quot;index&quot;: false,</span><br><span class="line">         &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;attrs&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;nested&quot;,</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;attrId&quot;:&#123;</span><br><span class="line">            &quot;type&quot;:&quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrName&quot;:&#123;</span><br><span class="line">            &quot;type&quot;:&quot;keyword&quot;,</span><br><span class="line">            &quot;index&quot;:false,</span><br><span class="line">            &quot;doc_values&quot;:false</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrValue&quot;: &#123;</span><br><span class="line">            &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="2.2-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99"
                                    id="2-2-商品上架接口编写">2.2 商品上架接口编写</h3>
                                <p><strong>需求分析：</strong></p>
                                <p>上架商品、将该商品相关属性上传到 Es中 为搜索服务做铺垫</p>
                                <img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201028152104489.png"
                                    alt="image-20201028152104489" style="zoom:200%;" />
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 商品上架</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&#123;spuId&#125;/up&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span></span>&#123;</span><br><span class="line">    spuInfoService.up(spuId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">up</span><span class="params">(Long spuId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、查出当前 spuid 对应的所有skuid信息，品牌的名字</span></span><br><span class="line">    List&lt;SkuInfoEntity&gt; skus = skuInfoService.getSkuBySpuId(spuId);</span><br><span class="line">    <span class="comment">// 取出 Skuid 组成集合</span></span><br><span class="line">    List&lt;Long&gt; skuIds = skus.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO 4、查询当前 sku 的所有可以用来被检索的规格属性</span></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; attrValueEntities = attrValueService.baseAttrListforspu(spuId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回所有 attrId</span></span><br><span class="line">    List&lt;Long&gt; attrIds = attrValueEntities.stream().map(attr -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 attrIds 查询出 检索属性，pms_attr表中 search_type为一 则是检索属性</span></span><br><span class="line">    List&lt;Long&gt; searchAttrIds = attrService.selectSearchAttrs(attrIds);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将查询出来的 attr_id 放到 set 集合中 用来判断 attrValueEntities 是否包含 attrId</span></span><br><span class="line">    Set&lt;Long&gt; idSet = <span class="keyword">new</span> HashSet&lt;&gt;(searchAttrIds);</span><br><span class="line"></span><br><span class="line">    List&lt;SkuEsModel.Attrs&gt; attrList = attrValueEntities.stream().filter(item -&gt; &#123;</span><br><span class="line">        <span class="comment">// 过滤掉不包含在 searchAttrIds集合中的元素</span></span><br><span class="line">        <span class="keyword">return</span> idSet.contains(item.getAttrId());</span><br><span class="line">    &#125;).map(item -&gt; &#123;</span><br><span class="line">        SkuEsModel.Attrs attrs1 = <span class="keyword">new</span> SkuEsModel.Attrs();</span><br><span class="line">        <span class="comment">// 属性对拷 将 ProductAttrValueEntity对象与 SkuEsModel.Attrs相同的属性进行拷贝</span></span><br><span class="line">        BeanUtils.copyProperties(item, attrs1);</span><br><span class="line">        <span class="keyword">return</span> attrs1;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO 1、发送远程调用，库存系统查询是否有库存</span></span><br><span class="line">    Map&lt;Long, Boolean&gt; stockMap = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        R r = wareFeignService.getSkuHasStock(skuIds);</span><br><span class="line">        <span class="comment">// key 是 SkuHasStockVo的 skuid value是 item的hasStock 是否拥有库存</span></span><br><span class="line">        TypeReference&lt;List&lt;SkuHasStockVo&gt;&gt; typeReference = <span class="keyword">new</span> TypeReference&lt;List&lt;SkuHasStockVo&gt;&gt;() &#123;</span><br><span class="line">        &#125;;</span><br><span class="line">        stockMap = r.getData(typeReference).stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, item -&gt; item.getHasStock()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;库存服务异常：原因：&#123;&#125;&quot;</span>,e);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、封装每个 sku 的信息</span></span><br><span class="line">    Map&lt;Long, Boolean&gt; finalStockMap = stockMap;</span><br><span class="line">    List&lt;SkuEsModel&gt; upProducts = skus.stream().map(sku -&gt; &#123;</span><br><span class="line">        <span class="comment">// 组装需要查询的数据</span></span><br><span class="line">        SkuEsModel skuEsModel = <span class="keyword">new</span> SkuEsModel();</span><br><span class="line">        BeanUtils.copyProperties(sku, skuEsModel);</span><br><span class="line">        skuEsModel.setSkuPrice(sku.getPrice());</span><br><span class="line">        skuEsModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置属性</span></span><br><span class="line">        skuEsModel.setAttrs(attrList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置库存信息</span></span><br><span class="line">        <span class="keyword">if</span> (finalStockMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 远程服务出现问题，任然设置为null</span></span><br><span class="line">            skuEsModel.setHasStock(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            skuEsModel.setHasStock(finalStockMap.get(sku.getSkuId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//TODO 2、热度频分 0</span></span><br><span class="line">        skuEsModel.setHotScore(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//TODO 3、查询品牌名字和分类的信息</span></span><br><span class="line">        BrandEntity brandEntity = brandService.getById(skuEsModel.getBrandId());</span><br><span class="line">        skuEsModel.setBrandName(brandEntity.getName());</span><br><span class="line">        skuEsModel.setBrandImg(brandEntity.getLogo());</span><br><span class="line">        CategoryEntity categoryEntity = categoryService.getById(skuEsModel.getCatalogId());</span><br><span class="line">        skuEsModel.setCatalogName(categoryEntity.getName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> skuEsModel;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO 5、将数据发送给 es保存 ，直接发送给 search服务</span></span><br><span class="line">    R r = esFeignClient.productStatusUp(upProducts);</span><br><span class="line">    <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 远程调用成功</span></span><br><span class="line">        <span class="comment">// TODO 6、修改当前 spu 的状态</span></span><br><span class="line">        baseMapper.updateSpuStatus(spuId, ProductConstant.StatusEnum.SPU_UP.getCode());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 远程调用失败</span></span><br><span class="line">        <span class="comment">//TODO 7、重复调用？ 接口冥等性 重试机制</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1、构造请求数据，将对象转成json</span></span><br><span class="line"><span class="comment">         * RequestTemplate template = buildTemplateFromArgs.create(argv);</span></span><br><span class="line"><span class="comment">         * 2、发送请求进行执行(执行成功进行解码)</span></span><br><span class="line"><span class="comment">         *  executeAndDecode(template);</span></span><br><span class="line"><span class="comment">         * 3、执行请求会有重试机制</span></span><br><span class="line"><span class="comment">         *  while (true) &#123;</span></span><br><span class="line"><span class="comment">         *       try &#123;</span></span><br><span class="line"><span class="comment">         *         return executeAndDecode(template);</span></span><br><span class="line"><span class="comment">         *       &#125; catch (RetryableException e) &#123;</span></span><br><span class="line"><span class="comment">         *         try &#123;</span></span><br><span class="line"><span class="comment">         *           retryer.continueOrPropagate(e);</span></span><br><span class="line"><span class="comment">         *         &#125; catch (RetryableException th) &#123;</span></span><br><span class="line"><span class="comment">         *              throw cause;</span></span><br><span class="line"><span class="comment">         *         &#125;</span></span><br><span class="line"><span class="comment">         *         continute</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2.2.1%E3%80%81%E5%8F%91%E9%80%81%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%8C%E5%BA%93%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%9F%A5%E8%AF%A2%E6%98%AF%E5%90%A6%E6%9C%89%E5%BA%93%E5%AD%98"
                                    id="2-2-1、发送远程调用，库存系统查询是否有库存">2.2.1、发送远程调用，库存系统查询是否有库存</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 skuIds 查询是否有库存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> skuIds</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/hasstock&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">getSkuHasStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; skuIds)</span> </span>&#123;</span><br><span class="line">    List&lt;SkuHasStockVo&gt; vos = wareSkuService.getSkusStock(skuIds);</span><br><span class="line"></span><br><span class="line">    R ok = R.ok();</span><br><span class="line">    ok.setData(vos);</span><br><span class="line">    <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;SkuHasStockVo&gt; <span class="title">getSkusStock</span><span class="params">(List&lt;Long&gt; skuIds)</span> </span>&#123;</span><br><span class="line">    List&lt;SkuHasStockVo&gt; collect = skuIds.stream().map(skuId -&gt; &#123;</span><br><span class="line">        SkuHasStockVo vo = <span class="keyword">new</span> SkuHasStockVo();</span><br><span class="line">        <span class="comment">// 查询当前 sku 的总库存良</span></span><br><span class="line">        <span class="comment">// SELECT SUM(stock-stock_locked) FROM `wms_ware_sku` WHERE sku_id = 1</span></span><br><span class="line">        Long count = baseMapper.getSkuStock(skuId);</span><br><span class="line"></span><br><span class="line">        vo.setSkuId(skuId);</span><br><span class="line">        vo.setHasStock(count == <span class="keyword">null</span>?<span class="keyword">false</span>:count&gt;<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2.2.2-%E5%B0%86%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81%E7%BB%99-es%E4%BF%9D%E5%AD%98-%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%8F%91%E9%80%81%E7%BB%99-search%E6%9C%8D%E5%8A%A1"
                                    id="2-2-2-将数据发送给-es保存-，直接发送给-search服务">2.2.2 将数据发送给 es保存 ，直接发送给 search服务</h4>
                                <p>controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上架商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuEsModelList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/product&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">productStatusUp</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;SkuEsModel&gt; skuEsModelList)</span></span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            b = productSaveService.productStatusUp(skuEsModelList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ElasticSaveController商品上架错误：&#123;&#125;&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> R.error(BizCodeEnume.PRODUCT_UP_EXCEPTION.getCode(),BizCodeEnume.PRODUCT_UP_EXCEPTION.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">            <span class="keyword">return</span> R.ok();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> R.error(BizCodeEnume.PRODUCT_UP_EXCEPTION.getCode(),BizCodeEnume.PRODUCT_UP_EXCEPTION.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">productStatusUp</span><span class="params">(List&lt;SkuEsModel&gt; skuEsModelList)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存到es</span></span><br><span class="line">    <span class="comment">// 批量保存</span></span><br><span class="line">    BulkRequest bulkRequest = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    <span class="keyword">for</span> (SkuEsModel model : skuEsModelList) &#123;</span><br><span class="line">        <span class="comment">// 1、构造请求 指定es索引</span></span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(EsConstant.PRODUCT_INDEX);</span><br><span class="line">        <span class="comment">// 1.1 指定id</span></span><br><span class="line">        indexRequest.id(model.getSkuId().toString());</span><br><span class="line">        <span class="comment">// 1.2 将对象esmodel对象转换成 json 进行存储</span></span><br><span class="line">        String s = JSON.toJSONString(model);</span><br><span class="line">        <span class="comment">// 1.3 设置文档源</span></span><br><span class="line">        indexRequest.source(s, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">        bulkRequest.add(indexRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, GulimallElasticsearchConfig.COMMON_OPTIONS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 1、 如果批量错误</span></span><br><span class="line">    <span class="keyword">boolean</span> b = bulk.hasFailures();</span><br><span class="line">    List&lt;String&gt; collect = Arrays.stream(bulk.getItems()).map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    log.error(<span class="string">&quot;商品上架完成：&#123;&#125;&quot;</span>,collect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>业务流程总结：</strong></p>
                                <p>前端点击上架后，发送请求并带上参数 spuid</p>
                                <ul>
                                    <li>
                                        <p>根据 <code>spuid</code> 查询 <code>pms_sku_info</code> 表得到商品相关属性</p>
                                    </li>
                                    <li>
                                        <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201028153205471.png"
                                                alt="image-20201028153205471" /></p>
                                    </li>
                                    <li>
                                        <p>根据 <code>spuid</code> 查询 <code>pms_product_attr_value</code> 表得到可以用来检索的规格属性
                                        </p>
                                    </li>
                                    <li>
                                        <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201028153038796.png"
                                                alt="image-20201028153038796" /></p>
                                    </li>
                                    <li>
                                        <p>从 <code>ProductAttrValueEntity</code> 中拿到所有的 attrId，根据 attrId 查询
                                            <code>pms_attr</code> 查询检索的属性</p>
                                    </li>
                                    <li>
                                        <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201028155204710.png"
                                                alt="image-20201028155204710" /></p>
                                    </li>
                                    <li>
                                        <p>x根据 <code>pms_attr</code> 查询到检索属性后，用检索属性和 原先根据 <code>spuid</code> 查询
                                            <code>pms_sku_info</code> 表得到商品相关属性进行比较，<code>pms_sku_info</code> 包含 从
                                            <code>pms_attr</code> 字段attr_id 则数据保存否则过滤</p>
                                    </li>
                                    <li>
                                        <p>根据 <code>skuIds</code> 去查询远程仓库中是否有库存 SELECT SUM(stock-stock_locked) FROM
                                            <code>wms_ware_sku</code> WHERE sku_id = 1</p>
                                    </li>
                                    <li>
                                        <p>组装数据 设置 SkuEsModel</p>
                                    </li>
                                    <li>
                                        <p>发送给 es 保存</p>
                                    </li>
                                </ul>
                                <h1
                                    id="3%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-%E9%A6%96%E9%A1%B5%E6%95%B4%E5%90%88">
                                    3、商城业务 &amp; 首页整合</h1>
                                <h3 id="3.1-%E6%95%B4%E5%90%88-thymeleaf-%E6%B8%B2%E6%9F%93%E9%A6%96%E9%A1%B5"
                                    id="3-1-整合-thymeleaf-渲染首页">3.1 整合 thymeleaf 渲染首页</h3>
                                <p><strong>需求分析：</strong></p>
                                <p>开发传统Java WEB工程时，我们可以使用JSP页面模板语言，但是在SpringBoot中已经不推荐使用了。SpringBoot支持如下页面模板语言</p>
                                <ul>
                                    <li>Thymeleaf</li>
                                    <li>FreeMarker</li>
                                    <li>Velocity</li>
                                    <li>Groovy</li>
                                    <li>JSP</li>
                                </ul>
                                <p>thymeleaf 官网：<a target="_blank" rel="noopener"
                                        href="https://www.thymeleaf.org/">https://www.thymeleaf.org/</a></p>
                                <p>官网文档给出了，语法、相关标签如何使用的步骤，由于官网文档都是英文，英文文档阅读能力好的同学可以选择阅读，英文不好的同学可以选择中文文档进行学习，为此我在网上找到了相关的中文文档：文档：thymeleaf<br />
                                    链接：<a target="_blank" rel="noopener"
                                        href="http://note.youdao.com/noteshare?id=7771a96e9031b30b91ed55c50528e918">http://note.youdao.com/noteshare?id=7771a96e9031b30b91ed55c50528e918</a>
                                </p>
                                <h4 id="3.1.2-springboot-%E6%95%B4%E5%90%88-thymeleaf"
                                    id="3-1-2-SpringBoot-整合-thymeleaf">3.1.2 SpringBoot 整合 thymeleaf</h4>
                                <p>Pom.xml</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 版本后由SpringBoot进行管理--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>application.yml</p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">Spring:</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span> <span class="comment"># 开发过程建议关闭缓存</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>resource 目录介绍：</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029102830164.png"
                                        alt="image-20201029102830164" /></p>
                                <p>index.html中使用</p>
                                <figure class="highlight html">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--使用thymeleaf中必须声明加上该行代码--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>  <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>相关语法使用</p>
                                <figure class="highlight html">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">&lt;!--和jsp相关表达式有点相似 具体使用过程参考文档--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;category : $&#123;categorys&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;header_main_left_a&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">th:attr</span>=<span class="string">&quot;ctg-data=$&#123;category.catId&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;category.name&#125;&quot;</span>&gt;</span>家用电器<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>默认SpringBoot会直接去找 templates 下的 index.html</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029103230550.png"
                                        alt="image-20201029103230550" /></p>
                                <h3 id="3.2-%E6%95%B4%E5%90%88dev-tools-%E6%B8%B2%E6%9F%93%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE"
                                    id="3-2-整合dev-tools-渲染分类数据">3.2 整合dev-tools 渲染分类数据</h3>
                                <p><strong>需求分析：</strong></p>
                                <p>我们需要在页面的侧边查询出分类的数据，并且选中一级分类数据后显示二级和三级分类数据</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029103544553.png"
                                        alt="image-20201029103544553" /></p>
                                <ul>
                                    <li>先获取一级分类数据</li>
                                    <li>用户选中后在查询二级分类数据</li>
                                </ul>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有一级分类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&#123;&quot;/&quot;,&quot;/index.html&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">indexPage</span><span class="params">(Model model)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// select * from category where parent_id = 0</span></span><br><span class="line">    <span class="comment">//TODO 1、查询所有的一级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; categoryEntityList = categoryService.getLevel1Categorys();</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">&quot;categorys&quot;</span>,categoryEntityList);</span><br><span class="line">    <span class="comment">// 查询所有的一级分类</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title">getLevel1Categorys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// parent_cid为0则是一级目录</span></span><br><span class="line">   <span class="keyword">return</span> baseMapper.selectList(<span class="keyword">new</span> QueryWrapper&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>,<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>一级分类数据能显示后，着手处理二级分类数据获取</p>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询完整分类数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/index/catalog.json&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; getCatelogJson() &#123;</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catelogJson = categoryService.getCatelogJson();</span><br><span class="line">    <span class="keyword">return</span> catelogJson;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; getCatelogJson() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、查询所有1级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; level1Categorys = getLevel1Categorys();</span><br><span class="line">    <span class="comment">// 2、封装数据封装成 map类型  key为 catId,value List&lt;Catelog2Vo&gt;</span></span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; categoryList = level1Categorys.stream().collect(Collectors.toMap(k -&gt; k.getCatId().toString(), v -&gt; &#123;</span><br><span class="line">        <span class="comment">// 1、每一个的一级分类，查询到这个一级分类的二级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; categoryEntities = baseMapper.selectList(<span class="keyword">new</span> QueryWrapper&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, v.getCatId()));</span><br><span class="line">        <span class="comment">// 2、封装上面的结果</span></span><br><span class="line">        List&lt;Catelog2Vo&gt; catelog2Vos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (categoryEntities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            catelog2Vos = categoryEntities.stream().map(l2 -&gt; &#123;</span><br><span class="line">                Catelog2Vo catelog2Vo = <span class="keyword">new</span> Catelog2Vo(v.getCatId().toString(), <span class="keyword">null</span>, l2.getCatId().toString(), l2.getName());</span><br><span class="line">                <span class="comment">// 1、查询当前二级分类的三级分类vo</span></span><br><span class="line">                List&lt;CategoryEntity&gt; categoryEntities1 = baseMapper.selectList(<span class="keyword">new</span> QueryWrapper&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, l2.getCatId()));</span><br><span class="line">                <span class="keyword">if</span> (categoryEntities1 != <span class="keyword">null</span> )&#123;</span><br><span class="line">                    <span class="comment">// 2、分装成指定格式</span></span><br><span class="line">                    List&lt;Catelog2Vo.catelog3Vo&gt; catelog3VoList = categoryEntities1.stream().map(l3 -&gt; &#123;</span><br><span class="line">                        Catelog2Vo.catelog3Vo catelog3Vo = <span class="keyword">new</span> Catelog2Vo.catelog3Vo(l2.getCatId().toString(), l3.getCatId().toString(), l3.getName());</span><br><span class="line">                        <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                    &#125;).collect(Collectors.toList());</span><br><span class="line">                    <span class="comment">// 3、设置分类数据</span></span><br><span class="line">                    catelog2Vo.setCatalog3List(catelog3VoList);</span><br><span class="line">                 &#125;</span><br><span class="line">                <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> catelog2Vos;</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="comment">// 2、封装数据</span></span><br><span class="line">    <span class="keyword">return</span> categoryList;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>上方代码具体业务逻辑：</strong></p>
                                <ul>
                                    <li>查询到一级分类，根据一级分类查询出二级分类并设置对应Vo对象，以此类推</li>
                                </ul>
                                <h1
                                    id="4%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-nginx-%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE">
                                    4、商城业务 &amp; Nginx 域名访问</h1>
                                <h3 id="4.1-nginx-%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E7%8E%AF%E5%A2%83%E4%B8%80%EF%BC%88%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%EF%BC%89"
                                    id="4-1-Nginx-搭建域名环境一（反向代理配置）">4.1 Nginx 搭建域名环境一（反向代理配置）</h3>
                                <p>什么是 反向代理?</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029051037570.png"
                                        alt="image-20201029051037570" /></p>
                                <p>vi nginx.conf 文件后在底部有该条语句：</p>
                                <ul>
                                    <li>引入nginx下的 conf.d 下面的conf文件</li>
                                    <li>那么我们开始在该目录下增加关于 谷粒商城的 nginx</li>
                                </ul>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029045921936.png"
                                        alt="image-20201029045921936" /></p>
                                <p>拷贝原先默认的 conf</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029050207857.png"
                                        alt="image-20201029050207857" /></p>
                                <p>修改</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029050136324.png"
                                        alt="image-20201029050136324" /></p>
                                <h3 id="4.2-nginx-%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E7%8E%AF%E5%A2%83%E4%BA%8C-%EF%BC%88%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%88%B0%E7%BD%91%E5%85%B3%EF%BC%89"
                                    id="4-2-Nginx-搭建域名环境二-（负载均衡到网关）">4.2 Nginx 搭建域名环境二 （负载均衡到网关）</h3>
                                <p>配置 UpStream</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029050256216.png"
                                        alt="image-20201029050256216" /></p>
                                <p>使用nginx实现负载平衡的最简单配置如下,官网地址：<a target="_blank" rel="noopener"
                                        href="https://nginx.org/en/docs/http/load_balancing.html">https://nginx.org/en/docs/http/load_balancing.html</a>
                                </p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">http &#123;</span><br><span class="line">    upstream myapp1 &#123;</span><br><span class="line">        server srv1.example.com;</span><br><span class="line">        server srv2.example.com;</span><br><span class="line">        server srv3.example.com;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://myapp1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>同时在 本机上 hosts 文件上那个配置 域名映射</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029050625740.png"
                                        alt="image-20201029050625740" /></p>
                                <p>将请求转接给网关后，需要在网关配置</p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">gulimall_host_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://gulimall-product</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=**.gulimall.com</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>最后放几张图方便理解哈</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029050828421.png"
                                        alt="image-20201029050828421" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029050901546.png"
                                        alt="image-20201029050901546" /></p>
                                <h1
                                    id="5%E3%80%81%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B-%26-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95">
                                    5、性能压测 &amp; 压力测试</h1>
                                <p><strong>简介</strong></p>
                                <p>压力测试考察当前软硬件环境下系统所能承受住的最大负荷并帮助找出系统的瓶颈所在，压测都是为了系统</p>
                                <p>在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数</p>
                                <p>使用压力测试，我们有希望找到很多种用其他测试方法更难发现的错误，有两种错误类型是：</p>
                                <p>内存泄漏、并发与同步</p>
                                <p>有效的压力测试系统将应用以下这些关键条件：重复、并发、量级、随机变化</p>
                                <h3 id="5.1-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87" id="5-1-性能指标">5.1 性能指标</h3>
                                <h4 id="5.1.1-jvm-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B" id="5-1-1-Jvm-内存模型">5.1.1 Jvm
                                    内存模型</h4>
                                <p>1、Jvm内存模型</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029112517466.png"
                                        alt="image-20201029112517466" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029113956043.png"
                                        alt="image-20201029113956043" /></p>
                                <h4 id="5.1.2-%E5%A0%86" id="5-1-2-堆">5.1.2 堆</h4>
                                <p>所有的对象实例以及数组都要在堆上分配，堆时垃圾收集器管理的主要区域，也被称为 &quot;GC堆&quot;，也是我们优化最多考虑的地方</p>
                                <p>堆可以细分为：</p>
                                <ul>
                                    <li>
                                        <p>新生代</p>
                                        <ul>
                                            <li>Eden空间</li>
                                            <li>From Survivor 空间</li>
                                            <li>To Survivor 空间</li>
                                        </ul>
                                    </li>
                                    <li>
                                        <p>老年代</p>
                                    </li>
                                    <li>
                                        <p>永久代/原空间</p>
                                        <ul>
                                            <li>Java8 以前永久代、受 JVM 管理、Java8 以后原空间，直接使用物理内存，因此默认情况下，原空间的大小仅受本地内存限制</li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>垃圾回收</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029114153244.png"
                                        alt="image-20201029114153244" /></p>
                                <p>从 Java8 开始,HotSpot 已经完全将永久代（Permanent Generation）移除，取而代之的是一个新的区域 - 元空间（MetaSpac)</p>
                                <img src="image-20201029114652885.png" alt="image-20201029114652885" />
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029114218716.png"
                                        alt="image-20201029114218716" /></p>
                                <h4 id="5.1.3-jconsole-%E4%B8%8E-jvisualvm" id="5-1-3-jconsole-与-jvisualvm">5.1.3
                                    jconsole 与 jvisualvm</h4>
                                <p>jdk 的两个小工具 jconsole、jvisualvm（升级版本的 jconsole）。通过命令行启动、可监控本地和远程应用、远程应用需要配置</p>
                                <p>1、jvisualvm 能干什么</p>
                                <p>监控内存泄漏、跟踪垃圾回收、执行时内存、cpu分析、线程分析.....</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029120502383.png"
                                        alt="image-20201029120502383" /></p>
                                <p>运行：正在运行的线程</p>
                                <p>休眠：sleep</p>
                                <p>等待：wait</p>
                                <p>驻留：线程池里面的空闲线程</p>
                                <p>监视：组赛的线程、正在等待锁</p>
                                <p>2、安装插件方便查看 gc</p>
                                <p>cmd 启动 jvisualvm</p>
                                <p>工具-&gt;插件</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029121108492.png"
                                        alt="image-20201029121108492" /></p>
                                <p>如果503 错误解决</p>
                                <p>打开网址： <a target="_blank" rel="noopener"
                                        href="https://visualvm.github.io/pluginscenters.html">https://visualvm.github.io/pluginscenters.html</a>
                                </p>
                                <p>cmd 查看自己的jdk版本，找到对应的</p>
                                <p>docker stats 查看相关命令</p>
                                <h4 id="5.1.4-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87" id="5-1-4-监控指标">5.1.4 监控指标</h4>
                                <p>SQL 耗时越小越好、一般情况下微妙级别</p>
                                <p>命中率越高越好、一般情况下不能低于95%</p>
                                <p>锁等待次数越低越好、等待时间越短越好</p>
                                <h5 id="1%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%8C%87%E6%A0%87" id="1、中间件指标">1、中间件指标
                                </h5>
                                <p>毫秒</p>
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="text-align:center">压测内容</th>
                                            <th>压测线程数</th>
                                            <th>吞吐量/ms</th>
                                            <th>90%响应时间/ms</th>
                                            <th>99%响应时间/ms</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="text-align:center"><strong>Nginx</strong></td>
                                            <td>50</td>
                                            <td>1834</td>
                                            <td>11</td>
                                            <td>40</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>GateWay</strong></td>
                                            <td>50b</td>
                                            <td>16577</td>
                                            <td>5</td>
                                            <td>19</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>简单服务</strong></td>
                                            <td>50</td>
                                            <td>17965</td>
                                            <td>5</td>
                                            <td>10</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>首页一级菜单渲染</strong></td>
                                            <td>50</td>
                                            <td>400（db,thymeleaf）</td>
                                            <td>149</td>
                                            <td>230</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>首页渲染(开缓存)</strong></td>
                                            <td>50</td>
                                            <td>467</td>
                                            <td>128</td>
                                            <td>209</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>首页渲染（开缓存、优化数据库，关日志）</strong></td>
                                            <td>50</td>
                                            <td>1300</td>
                                            <td>60</td>
                                            <td>107</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>三级分类数据获取</strong></td>
                                            <td>50</td>
                                            <td>4.4（db）/18（优化后）</td>
                                            <td>16622</td>
                                            <td>16832</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>三级分类数据获取（优化业务）</strong></td>
                                            <td>50</td>
                                            <td>163</td>
                                            <td>410</td>
                                            <td>585</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>三级分类数据获取（redis缓存）</strong></td>
                                            <td>50</td>
                                            <td>553</td>
                                            <td>113</td>
                                            <td>182</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center"><strong>首页全量数据获取</strong></td>
                                            <td>50</td>
                                            <td>10（静态资源）/12</td>
                                            <td>6183</td>
                                            <td>12358</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center">Nginx+Gateway</td>
                                            <td>50</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center">Gateway+简单服务</td>
                                            <td>50</td>
                                            <td>2685</td>
                                            <td>7</td>
                                            <td>10</td>
                                        </tr>
                                        <tr>
                                            <td style="text-align:center">全链路</td>
                                            <td>50</td>
                                            <td>900</td>
                                            <td>73</td>
                                            <td>971</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <p>中间件越多，性能损失越大，大多都损失在了网络交互</p>
                                <h5 id="2%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8C%87%E6%A0%87" id="2、数据库指标">2、数据库指标
                                </h5>
                                <ul>
                                    <li>
                                        <p><strong>响应时间</strong>（Response Time:RT）</p>
                                    </li>
                                    <li>
                                        <p>响应时间指用户从客户端发起一个请求开始，到客户端接收到服务器端返回的响应结束，整个过程所耗费的时间</p>
                                    </li>
                                    <li>
                                        <p><strong>HPS</strong>（Hits Per Second） ：每秒点击次数，单位是次/秒</p>
                                    </li>
                                    <li>
                                        <p><strong>TPS</strong>（Transaction per Second）：系统每秒处理交易数，单位是笔/秒</p>
                                    </li>
                                    <li>
                                        <p><strong>QPS</strong> (Query perSecond)
                                            :系统每秒处理查询次数，单位是次/秒。对于互联网业务中，如果某些业务有且仅有一个请求连接，那么TPS=QPS=HPS，一般情况下用TPS来衡量整个业务流程，用QPS来衡量接口查询次数，用HPS来表示对服务器单击请求。
                                        </p>
                                    </li>
                                    <li>
                                        <p>无论TPS、QPS、HPS,此指标是衡量系统处理能力非常重要的指标，越大越好，根据经验，一般情况下:</p>
                                        <ul>
                                            <li>金融行业: 1000TPS~50000TPS, 不包括互联网化的活动</li>
                                            <li>保险行业: 1007P-00000PS， 不包括互联网化的活动</li>
                                            <li>制造行业: 10TPS~5000TPS</li>
                                            <li>互联网电子商务: 10000TPS~-100000TPS</li>
                                            <li>互联网中型网站: 1000TPS~50000TPS</li>
                                            <li>互联网小型网站: 5007PS~10000TPS</li>
                                        </ul>
                                    </li>
                                    <li>
                                        <p><strong>最大响应时间</strong>(Max Response Time) 指用户发出请求或者指令到系统做出反应(响应)的最大时间。</p>
                                    </li>
                                    <li>
                                        <p><strong>最少响应时间</strong> （Mininum ResponseTime）指用户发出请求或者指令到系统做出反应（响应）的最少时间</p>
                                    </li>
                                    <li>
                                        <p><strong>90%响应时间</strong>（90% Response Time） 是指所有用户的响应时间进行排序、第90%的响应时间</p>
                                    </li>
                                    <li>
                                        <p>从外部看、性能测试主要关注如下三个指</p>
                                        <ul>
                                            <li>吞吐量：每秒钟系统能够处理的请求数、任务数</li>
                                            <li>响应时间：服务处理一个请求或一个任务的耗时</li>
                                            <li>错误率：一批请求中结果出错的请求所占比例</li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>吞吐量大:系统支持高并发，</p>
                                <p>响应时间：越短说明接口性能越好</p>
                                <h3 id="5.2-jmeter" id="5-2-JMeter">5.2 JMeter</h3>
                                <h4 id="5.2.1-jmeter-%E5%AE%89%E8%A3%85" id="5-2-1-JMeter-安装">5.2.1 JMeter 安装</h4>
                                <p>jmeter官网：<a target="_blank" rel="noopener"
                                        href="https://jmeter.apache.org/">https://jmeter.apache.org/</a></p>
                                <h4 id="5.2.2-jmeter-%E5%8E%8B%E6%B5%8B%E7%A4%BA%E4%BE%8B" id="5-2-2-JMeter-压测示例">5.2.2
                                    JMeter 压测示例</h4>
                                <h5 id="1%E3%80%81%E6%B7%BB%E5%8A%A0%E7%BA%BF%E7%A8%8B%E7%BB%84" id="1、添加线程组">1、添加线程组
                                </h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029084634498.png"
                                        alt="image-20201029084634498" /></p>
                                <h5 id="2%E3%80%81%E6%B7%BB%E5%8A%A0-http-%E8%AF%B7%E6%B1%82" id="2、添加-HTTP-请求">2、添加
                                    HTTP 请求</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029085843220.png"
                                        alt="image-20201029085843220" /></p>
                                <h5 id="3%E3%80%81%E6%B7%BB%E5%8A%A0%E7%9B%91%E5%90%AC%E5%99%A8" id="3、添加监听器">3、添加监听器
                                </h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029085942442.png"
                                        alt="image-20201029085942442" /></p>
                                <h5 id="4%E3%80%81%E5%90%AF%E5%8A%A8%E5%8E%8B%E6%B5%8B%26%E6%9F%A5%E7%9C%8B"
                                    id="4、启动压测-查看">4、启动压测&amp;查看</h5>
                                <p>汇总图</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029092357910.png"
                                        alt="image-20201029092357910" /></p>
                                <p>察看结果树</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029092436633.png"
                                        alt="image-20201029092436633" /></p>
                                <p>汇总报告</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029092454376.png"
                                        alt="image-20201029092454376" /></p>
                                <p>聚合报告</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201029092542876.png"
                                        alt="image-20201029092542876" /></p>
                                <h4 id="5.2.3-jmeter-address-already-in-use-%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3"
                                    id="5-2-3-JMeter-Address-Already-in-use-错误解决">5.2.3 JMeter Address Already in use
                                    错误解决</h4>
                                <p>windows本身提供的端口访问机制的问题。<br />
                                    Windows提供给TCP/IP 链接的端口为1024-5000，并且要四分钟来循环回收他们。就导致<br />
                                    我们在短时间内跑大量的请求时将端口占满了。</p>
                                <p>1.cmd中，用regedit命令打开注册表</p>
                                <p>2.在HKEY_ LOCAL MACHINE\SYSTEMCurrentControlSet\Services Tcpip\Parameters下，</p>
                                <p>​ 1.右击parameters,添加一个新的DWORD,名字为MaxUserPort<br />
                                    ​ 2.然后双击 MaxUserPort,输入数值数据为65534,基数选择十进制(如果是分布式运行的话，控制机器和负载机器都需要这样操作哦)</p>
                                <p>3.修改配置完毕之后记得重启机器才会生效</p>
                                <p>TCPTimedWaitDelay:30</p>
                                <h1 id="6%E3%80%81%E7%BC%93%E5%AD%98%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">
                                    6、缓存与分布式锁</h1>
                                <h3 id="6.1-%E7%BC%93%E5%AD%98" id="6-1-缓存">6.1 缓存</h3>
                                <h4 id="6.1.2-%E7%BC%93%E5%AD%98%E4%BD%BF%E7%94%A8" id="6-1-2-缓存使用">6.1.2 缓存使用</h4>
                                <p>为了系统性能的提升，我们一般都会将部分数据放入缓存中，加速访问，而 db 承担数据落盘工作</p>
                                <p><strong>哪些数据适合放入缓存？</strong></p>
                                <ul>
                                    <li><strong>即时性、数据一致性要求不高的</strong></li>
                                    <li><strong>访问量大且更新频率不高的数据（读多、写少）</strong></li>
                                </ul>
                                <p>举例：电商类应用、商品分类，商品列表等适合缓存并加一个失效时间（根据数据更新频率来定）后台如果发布一个商品、买家需要 5 分钟才能看到新商品一般还是可以接受的</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201030190425556.png"
                                        alt="image-20201030190425556" /></p>
                                <p>伪代码</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">data = cche.load(b); <span class="comment">//从缓存中加载数据</span></span><br><span class="line"><span class="keyword">if</span>(data == <span class="keyword">null</span>) &#123;</span><br><span class="line">    data = db.load(id); <span class="comment">// 从数据库加载数据</span></span><br><span class="line">    cache.put(id,data); <span class="comment">// 保存到 cache中</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> data;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>注意：在开发中，凡是放到缓存中的数据我们都应该制定过期时间，使其可以在系统即使没有主动更新数据也能自动触发数据加载的流程，避免业务奔溃导致的数据永久不一致的问题</p>
                                <h4 id="6.1.3-%E6%95%B4%E5%90%88-redis-%E4%BD%9C%E4%B8%BA%E7%BC%93%E5%AD%98"
                                    id="6-1-3-整合-redis-作为缓存">6.1.3 整合 redis 作为缓存</h4>
                                <h5 id="1%E3%80%81%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96" id="1、引入依赖">1、引入依赖</h5>
                                <p>SpringBoot 整合 redis，查看SpringBoot提供的 starts</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031154148722.png"
                                        alt="image-20201031154148722" /></p>
                                <p>官网：<a target="_blank" rel="noopener"
                                        href="https://docs.spring.io/spring-boot/docs/2.1.18.RELEASE/reference/html/using-boot-build-systems.html#using-boot-starter">https://docs.spring.io/spring-boot/docs/2.1.18.RELEASE/reference/html/using-boot-build-systems.html#using-boot-starter</a>
                                </p>
                                <p>pom.xml</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">&lt;!--引入redis--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--不加载自身的 lettuce--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">&lt;!--jedis--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="2%E3%80%81%E9%85%8D%E7%BD%AE" id="2、配置">2、配置</h5>
                                <p>application.yaml</p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">Spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>RedisAutoConfig.java</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031154710108.png"
                                        alt="image-20201031154710108" /></p>
                                <h5 id="3%E3%80%81%E6%B5%8B%E8%AF%95" id="3、测试">3、测试</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStringRedisTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world_&quot;</span> + UUID.randomUUID().toString());</span><br><span class="line">    String hello = stringRedisTemplate.opsForValue().get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;之前保存的数据是：&quot;</span> + hello);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="4%E3%80%81%E4%BC%98%E5%8C%96%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96"
                                    id="4、优化三级分类数据获取">4、优化三级分类数据获取</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 产生堆外内存溢出 OutOfDirectMemoryError</span></span><br><span class="line"><span class="comment"> * 1、SpringBoot2.0以后默认使用 Lettuce作为操作redis的客户端，它使用 netty进行网络通信</span></span><br><span class="line"><span class="comment"> * 2、lettuce 的bug导致netty堆外内存溢出，-Xmx300m netty 如果没有指定堆内存移除，默认使用 -Xmx300m</span></span><br><span class="line"><span class="comment"> *      可以通过-Dio.netty.maxDirectMemory 进行设置</span></span><br><span class="line"><span class="comment"> *   解决方案 不能使用 -Dio.netty.maxDirectMemory调大内存</span></span><br><span class="line"><span class="comment"> *   1、升级 lettuce客户端，2、 切换使用jedis</span></span><br><span class="line"><span class="comment"> *   redisTemplate:</span></span><br><span class="line"><span class="comment"> *   lettuce、jedis 操作redis的底层客户端，Spring再次封装</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; getCatelogJson() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给缓存中放 json 字符串、拿出的是 json 字符串，还要逆转为能用的对象类型【序列化和反序列化】</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、加入缓存逻辑，缓存中放的数据是 json 字符串</span></span><br><span class="line">    <span class="comment">// JSON 跨语言，跨平台兼容</span></span><br><span class="line">    String catelogJSON = redisTemplate.opsForValue().get(<span class="string">&quot;catelogJSON&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(catelogJSON)) &#123;</span><br><span class="line">        <span class="comment">// 2、缓存没有，从数据库中查询</span></span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catelogJsonFromDb = getCatelogJsonFromDb();</span><br><span class="line">        <span class="comment">// 3、查询到数据，将数据转成 JSON 后放入缓存中</span></span><br><span class="line">        String s = JSON.toJSONString(catelogJsonFromDb);</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;catelogJSON&quot;</span>,s);</span><br><span class="line">        <span class="keyword">return</span> catelogJsonFromDb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 转换为我们指定的对象</span></span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; result = JSON.parseObject(catelogJSON, <span class="keyword">new</span> TypeReference&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="6.2-%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88" id="6-2-缓存失效">6.2 缓存失效</h3>
                                <h4 id="%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"
                                    id="高并发下缓存失效问题">高并发下缓存失效问题</h4>
                                <h5 id="%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88" id="缓存失效">缓存失效</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031163704355.png"
                                        alt="" /></p>
                                <h5 id="%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9" id="缓存雪崩">缓存雪崩</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031163949881.png"
                                        alt="image-20201031163949881" /></p>
                                <h5 id="%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF" id="缓存击穿">缓存击穿</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031164021131.png"
                                        alt="image-20201031164021131" /></p>
                                <h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%8B%E5%A6%82%E4%BD%95%E5%8A%A0%E9%94%81"
                                    id="分布式下如何加锁">分布式下如何加锁</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031112235353.png"
                                        alt="image-20201031112235353" /></p>
                                <h3 id="6.4-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" id="6-4-分布式锁">6.4 分布式锁</h3>
                                <h4 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8"
                                    id="分布式锁原理与应用">分布式锁原理与应用</h4>
                                <h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"
                                    id="分布式锁基本原理">分布式锁基本原理</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031122557660.png"
                                        alt="image-20201031122557660" /></p>
                                <p>**理解：**就先当1000个人去占一个厕所，厕所只能有一个人占到这个坑，占到这个坑其他人就只能在外面等待，等待一段时间后可以再次来占坑，业务执行后，释放锁，那么其他人就可以来占这个坑
                                </p>
                                <h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%BC%94%E8%BF%9B---%E9%98%B6%E6%AE%B5%E4%B8%80"
                                    id="分布式锁演进-阶段一">分布式锁演进 - 阶段一</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031123441336.png"
                                        alt="image-20201031123441336" /></p>
                                <p><strong>代码：</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">Boolean lock = redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">           <span class="comment">// 加锁成功..执行业务</span></span><br><span class="line">           Map&lt;String,List&lt;Catelog2Vo&gt;&gt; dataFromDb = getDataFromDB();</span><br><span class="line">           redisTemplate.delete(<span class="string">&quot;lock&quot;</span>); <span class="comment">// 删除锁</span></span><br><span class="line">           <span class="keyword">return</span> dataFromDb;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 加锁失败，重试 synchronized()</span></span><br><span class="line">           <span class="comment">// 休眠100ms重试</span></span><br><span class="line">           <span class="keyword">return</span> getCatelogJsonFromDbWithRedisLock();</span><br><span class="line">       &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%BC%94%E8%BF%9B---%E9%98%B6%E6%AE%B5%E4%BA%8C"
                                    id="分布式锁演进-阶段二">分布式锁演进 - 阶段二</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031123640746.png"
                                        alt="image-20201031123640746" /></p>
                                <p><strong>代码：</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">Boolean lock = redisTemplate.opsForValue().setIfAbsent()</span><br><span class="line">       <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">           <span class="comment">// 加锁成功..执行业务</span></span><br><span class="line">           <span class="comment">// 设置过期时间</span></span><br><span class="line">           redisTemplate.expire(<span class="string">&quot;lock&quot;</span>,<span class="number">30</span>,TimeUnit.SECONDS);</span><br><span class="line">           Map&lt;String,List&lt;Catelog2Vo&gt;&gt; dataFromDb = getDataFromDB();</span><br><span class="line">           redisTemplate.delete(<span class="string">&quot;lock&quot;</span>); <span class="comment">// 删除锁</span></span><br><span class="line">           <span class="keyword">return</span> dataFromDb;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 加锁失败，重试 synchronized()</span></span><br><span class="line">           <span class="comment">// 休眠100ms重试</span></span><br><span class="line">           <span class="keyword">return</span> getCatelogJsonFromDbWithRedisLock();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%BC%94%E8%BF%9B---%E9%98%B6%E6%AE%B5%E4%B8%89"
                                    id="分布式锁演进-阶段三">分布式锁演进 - 阶段三</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031124210112.png"
                                        alt="image-20201031124210112" /></p>
                                <p><strong>代码：</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 设置值同时设置过期时间</span></span><br><span class="line">Boolean lock = redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,<span class="string">&quot;111&quot;</span>,<span class="number">300</span>,TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">if</span> (lock) &#123;</span><br><span class="line">    <span class="comment">// 加锁成功..执行业务</span></span><br><span class="line">    <span class="comment">// 设置过期时间,必须和加锁是同步的，原子的</span></span><br><span class="line">    redisTemplate.expire(<span class="string">&quot;lock&quot;</span>,<span class="number">30</span>,TimeUnit.SECONDS);</span><br><span class="line">    Map&lt;String,List&lt;Catelog2Vo&gt;&gt; dataFromDb = getDataFromDB();</span><br><span class="line">    redisTemplate.delete(<span class="string">&quot;lock&quot;</span>); <span class="comment">// 删除锁</span></span><br><span class="line">    <span class="keyword">return</span> dataFromDb;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 加锁失败，重试 synchronized()</span></span><br><span class="line">    <span class="comment">// 休眠100ms重试</span></span><br><span class="line">    <span class="keyword">return</span> getCatelogJsonFromDbWithRedisLock();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%BC%94%E8%BF%9B---%E9%98%B6%E6%AE%B5%E5%9B%9B"
                                    id="分布式锁演进-阶段四">分布式锁演进 - 阶段四</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031124615670.png"
                                        alt="image-20201031124615670" /></p>
                                <p>图解：</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031130547173.png"
                                        alt="image-20201031130547173" /></p>
                                <p>代码：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> String uuid = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">// 设置值同时设置过期时间</span></span><br><span class="line">        Boolean lock = redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,uuid,<span class="number">300</span>,TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// 加锁成功..执行业务</span></span><br><span class="line">            <span class="comment">// 设置过期时间,必须和加锁是同步的，原子的</span></span><br><span class="line"><span class="comment">//            redisTemplate.expire(&quot;lock&quot;,30,TimeUnit.SECONDS);</span></span><br><span class="line">            Map&lt;String,List&lt;Catelog2Vo&gt;&gt; dataFromDb = getDataFromDB();</span><br><span class="line"><span class="comment">//            String lockValue = redisTemplate.opsForValue().get(&quot;lock&quot;);</span></span><br><span class="line"><span class="comment">//            if (lockValue.equals(uuid)) &#123;</span></span><br><span class="line"><span class="comment">//                // 删除我自己的锁</span></span><br><span class="line"><span class="comment">//                redisTemplate.delete(&quot;lock&quot;); // 删除锁</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">// 通过使用lua脚本进行原子性删除</span></span><br><span class="line">            String script = <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;,KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">                <span class="comment">//删除锁</span></span><br><span class="line">                Long lock1 = redisTemplate.execute(<span class="keyword">new</span> DefaultRedisScript&lt;Long&gt;(script, Long.class), Arrays.asList(<span class="string">&quot;lock&quot;</span>), uuid);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dataFromDb;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 加锁失败，重试 synchronized()</span></span><br><span class="line">            <span class="comment">// 休眠100ms重试</span></span><br><span class="line">            <span class="keyword">return</span> getCatelogJsonFromDbWithRedisLock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%BC%94%E8%BF%9B---%E9%98%B6%E6%AE%B5%E4%BA%94-%E6%9C%80%E7%BB%88%E6%A8%A1%E5%BC%8F"
                                    id="分布式锁演进-阶段五-最终模式">分布式锁演进 - 阶段五 最终模式</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201031130201609.png"
                                        alt="image-20201031130201609" /></p>
                                <p>代码：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> String uuid = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">// 设置值同时设置过期时间</span></span><br><span class="line">        Boolean lock = redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,uuid,<span class="number">300</span>,TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;获取分布式锁成功&quot;</span>);</span><br><span class="line">            <span class="comment">// 加锁成功..执行业务</span></span><br><span class="line">            <span class="comment">// 设置过期时间,必须和加锁是同步的，原子的</span></span><br><span class="line"><span class="comment">//            redisTemplate.expire(&quot;lock&quot;,30,TimeUnit.SECONDS);</span></span><br><span class="line">            Map&lt;String,List&lt;Catelog2Vo&gt;&gt; dataFromDb;</span><br><span class="line"><span class="comment">//            String lockValue = redisTemplate.opsForValue().get(&quot;lock&quot;);</span></span><br><span class="line"><span class="comment">//            if (lockValue.equals(uuid)) &#123;</span></span><br><span class="line"><span class="comment">//                // 删除我自己的锁</span></span><br><span class="line"><span class="comment">//                redisTemplate.delete(&quot;lock&quot;); // 删除锁</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                dataFromDb = getDataFromDB();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                String script = <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;,KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">                <span class="comment">//删除锁</span></span><br><span class="line">                Long lock1 = redisTemplate.execute(<span class="keyword">new</span> DefaultRedisScript&lt;Long&gt;(script, Long.class), Arrays.asList(<span class="string">&quot;lock&quot;</span>), uuid);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> dataFromDb;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 加锁失败，重试 synchronized()</span></span><br><span class="line">            <span class="comment">// 休眠200ms重试</span></span><br><span class="line">            System.out.println(<span class="string">&quot;获取分布式锁失败，等待重试&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="number">200</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">            <span class="keyword">return</span> getCatelogJsonFromDbWithRedisLock();</span><br><span class="line">        &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>问题：</p>
                                <ul>
                                    <li>分布式加锁解锁都是这两套代码，可以封装成工具类</li>
                                    <li>分布式锁有更专业的框架</li>
                                </ul>
                                <h4 id="%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81---redisson" id="分布式锁-Redisson">分布式锁 -
                                    Redisson</h4>
                                <h5 id="1%E3%80%81%E7%AE%80%E4%BB%8B%26%E6%95%B4%E5%90%88" id="1、简介-整合">1、简介&amp;整合</h5>
                                <p>官网文档上详细说明了 不推荐使用 setnx来实现分布式锁，应该参考 the Redlock algorithm 的实现</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101050725534.png"
                                        alt="image-20201101050725534" /></p>
                                <p>the Redlock algorithm：<a target="_blank" rel="noopener"
                                        href="https://redis.io/topics/distlock">https://redis.io/topics/distlock</a></p>
                                <p>在Java 语言环境下使用 Redisson</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101050924914.png"
                                        alt="image-20201101050924914" /></p>
                                <p>github：<a target="_blank" rel="noopener"
                                        href="https://github.com/redisson/redisson">https://github.com/redisson/redisson</a>
                                </p>
                                <p>有对应的 中文文档</p>
                                <p>在 Maven 仓库中搜索也能搜索出 Redisson</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101051157803.png"
                                        alt="image-20201101051157803" /></p>
                                <p>Pom</p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">&lt;!--以后使用 redisson 作为分布锁，分布式对象等功能--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="2%E3%80%81redisson---lock-%E9%94%81%E6%B5%8B%E8%AF%95-%26-redisson---lock-%E7%9C%8B%E9%97%A8%E7%8B%97%E5%8E%9F%E7%90%86---redisson-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E6%AD%BB%E9%94%81"
                                    id="2、Redisson-Lock-锁测试-Redisson-Lock-看门狗原理-Redisson-如何解决死锁">2、Redisson - Lock 锁测试
                                    &amp; Redisson - Lock 看门狗原理 - Redisson 如何解决死锁</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1、获取一把锁，只要锁得名字一样，就是同一把锁</span></span><br><span class="line">    RLock lock = redission.getLock(<span class="string">&quot;my-lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、加锁</span></span><br><span class="line">    lock.lock(); <span class="comment">// 阻塞式等待，默认加的锁都是30s时间</span></span><br><span class="line">    <span class="comment">// 1、锁的自动续期，如果业务超长，运行期间自动给锁续上新的30s，不用担心业务时间长，锁自动过期后被删掉</span></span><br><span class="line">    <span class="comment">// 2、加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认会在30s以后自动删除</span></span><br><span class="line"></span><br><span class="line">    lock.lock(<span class="number">10</span>, TimeUnit.SECONDS); <span class="comment">//10s 后自动删除</span></span><br><span class="line">    <span class="comment">//问题 lock.lock(10, TimeUnit.SECONDS) 在锁时间到了后，不会自动续期</span></span><br><span class="line">    <span class="comment">// 1、如果我们传递了锁的超时时间，就发送给 redis 执行脚本，进行占锁，默认超时就是我们指定的时间</span></span><br><span class="line">    <span class="comment">// 2、如果我们为指定锁的超时时间，就是用 30 * 1000 LockWatchchdogTimeout看门狗的默认时间、</span></span><br><span class="line">    <span class="comment">//      只要占锁成功，就会启动一个定时任务，【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】,每隔10s就自动续期</span></span><br><span class="line">    <span class="comment">//      internalLockLeaseTime【看门狗时间】 /3,10s</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//最佳实践</span></span><br><span class="line">    <span class="comment">// 1、lock.lock(10, TimeUnit.SECONDS);省掉了整个续期操作，手动解锁</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;加锁成功，执行业务...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 解锁 将设解锁代码没有运行，reidsson会不会出现死锁</span></span><br><span class="line">        System.out.println(<span class="string">&quot;释放锁....&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>进入到 <code>Redisson</code> Lock 源码</p>
                                <p>1、进入 <code>Lock</code> 的实现 发现 他调用的也是 <code>lock</code> 方法参数 时间为 -1</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101051659465.png"
                                        alt="image-20201101051659465" /></p>
                                <p>2、再次进入 <code>lock</code> 方法</p>
                                <p>发现他调用了 tryAcquire</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101051925487.png"
                                        alt="image-20201101051925487" /></p>
                                <p>3、进入 tryAcquire</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101052008724.png"
                                        alt="image-20201101052008724" /></p>
                                <p>4、里头调用了 tryAcquireAsync</p>
                                <p>这里判断 laseTime != -1 就与刚刚的第一步传入的值有关系</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101052037959.png"
                                        alt="image-20201101052037959" /></p>
                                <p>5、进入到 <code>tryLockInnerAsync</code> 方法</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101052158592.png"
                                        alt="image-20201101052158592" /></p>
                                <p>6、<code>internalLockLeaseTime</code> 这个变量是锁的默认时间</p>
                                <p>这个变量在构造的时候就赋初始值</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101052346059.png"
                                        alt="image-20201101052346059" /></p>
                                <p>7、最后查看 <code>lockWatchdogTimeout</code> 变量</p>
                                <p>也就是30秒的时间</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101052428198.png"
                                        alt="image-20201101052428198" /></p>
                                <h5 id="3%E3%80%81reidsson---%E8%AF%BB%E5%86%99%E9%94%81" id="3、Reidsson-读写锁">3、Reidsson
                                    - 读写锁</h5>
                                <p>二话不说，上代码！！！</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保证一定能读取到最新数据，修改期间，写锁是一个排他锁（互斥锁，独享锁）读锁是一个共享锁</span></span><br><span class="line"><span class="comment">     * 写锁没释放读锁就必须等待</span></span><br><span class="line"><span class="comment">     * 读 + 读 相当于无锁，并发读，只会在 reids中记录好，所有当前的读锁，他们都会同时加锁成功</span></span><br><span class="line"><span class="comment">     * 写 + 读 等待写锁释放</span></span><br><span class="line"><span class="comment">     * 写 + 写 阻塞方式</span></span><br><span class="line"><span class="comment">     * 读 + 写 有读锁，写也需要等待</span></span><br><span class="line"><span class="comment">     * 只要有写的存在，都必须等待</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/write&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">writeValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RReadWriteLock lock = redission.getReadWriteLock(<span class="string">&quot;rw_lock&quot;</span>);</span><br><span class="line">        String s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        RLock rLock = lock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1、改数据加写锁，读数据加读锁</span></span><br><span class="line">            rLock.lock();</span><br><span class="line">            System.out.println(<span class="string">&quot;写锁加锁成功...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            s = UUID.randomUUID().toString();</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">3</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">&quot;writeValue&quot;</span>,s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rLock.unlock();</span><br><span class="line">            System.out.println(<span class="string">&quot;写锁释放...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/read&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RReadWriteLock lock = redission.getReadWriteLock(<span class="string">&quot;rw_lock&quot;</span>);</span><br><span class="line">        RLock rLock = lock.readLock();</span><br><span class="line">        String s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        rLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读锁加锁成功...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            s = (String) redisTemplate.opsForValue().get(<span class="string">&quot;writeValue&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">3</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rLock.unlock();</span><br><span class="line">            System.out.println(<span class="string">&quot;读锁释放...&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>来看下官网的解释</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101053042268.png"
                                        alt="image-20201101053042268" /></p>
                                <h5 id="4%E3%80%81redisson---%E9%97%AD%E9%94%81%E6%B5%8B%E8%AF%95" id="4、Redisson-闭锁测试">
                                    4、Redisson - 闭锁测试</h5>
                                <p>官网！！！</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101053053554.png"
                                        alt="image-20201101053053554" /></p>
                                <p>上代码</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 放假锁门</span></span><br><span class="line"><span class="comment"> * 1班没人了</span></span><br><span class="line"><span class="comment"> * 5个班级走完，我们可以锁们了</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/lockDoor&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">lockDoor</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    RCountDownLatch door = redission.getCountDownLatch(<span class="string">&quot;door&quot;</span>);</span><br><span class="line">    door.trySetCount(<span class="number">5</span>);</span><br><span class="line">    door.await();<span class="comment">//等待闭锁都完成</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;放假了....&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/gogogo/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">gogogo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">    RCountDownLatch door = redission.getCountDownLatch(<span class="string">&quot;door&quot;</span>);</span><br><span class="line">    door.countDown();<span class="comment">// 计数器减一</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> id + <span class="string">&quot;班的人走完了.....&quot;</span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>和 JUC 的 CountDownLatch 一致</p>
                                <p>await()等待闭锁完成</p>
                                <p>countDown() 把计数器减掉后 await就会放行</p>
                                <h5 id="5%E3%80%81redisson---%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%B5%8B%E8%AF%95"
                                    id="5、Redisson-信号量测试">5、Redisson - 信号量测试</h5>
                                <p>官网！！！</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101053450708.png"
                                        alt="image-20201101053450708" /></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 车库停车</span></span><br><span class="line"><span class="comment"> * 3车位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/park&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">park</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    RSemaphore park = redission.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">    <span class="keyword">boolean</span> b = park.tryAcquire();<span class="comment">//获取一个信号，获取一个值，占用一个车位</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok=&quot;</span> + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/go&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">go</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RSemaphore park = redission.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line"></span><br><span class="line">    park.release(); <span class="comment">//释放一个车位</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>类似 JUC 中的 Semaphore</p>
                                <h5 id="6%E3%80%81redission---%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%A3%E5%86%B3"
                                    id="6、Redission-缓存一致性解决">6、Redission - 缓存一致性解决</h5>
                                <h3 id="6.3-%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"
                                    id="6-3-缓存数据一致性">6.3 缓存数据一致性</h3>
                                <h4 id="%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7---%E5%8F%8C%E5%86%99%E6%A8%A1%E5%BC%8F"
                                    id="缓存数据一致性-双写模式">缓存数据一致性 - 双写模式</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101053613373.png"
                                        alt="image-20201101053613373" /></p>
                                <p>两个线程写 最终只有一个线程写成功，后写成功的会把之前写的数据给覆盖，这就会造成脏数据</p>
                                <h4 id="%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7---%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F"
                                    id="缓存数据一致性-失效模式">缓存数据一致性 - 失效模式</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201101053834126.png"
                                        alt="image-20201101053834126" /></p>
                                <p>三个连接</p>
                                <p>一号连接 写数据库 然后删缓存</p>
                                <p>二号连接 写数据库时网络连接慢，还没有写入成功</p>
                                <p>三号链接 直接读取数据，读到的是一号连接写入的数据，此时 二号链接写入数据成功并删除了缓存，三号开始更新缓存发现更新的是二号的缓存</p>
                                <h4 id="%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"
                                    id="缓存数据一致性解决方案">缓存数据一致性解决方案</h4>
                                <p>无论是双写模式还是失效模式，都会到这缓存不一致的问题，即多个实力同时更新会出事，怎么办？</p>
                                <ul>
                                    <li>1、如果是用户纯度数据（订单数据、用户数据），这并发几率很小，几乎不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可</li>
                                    <li>2、如果是菜单，商品介绍等基础数据，也可以去使用 canal 订阅，binlog 的方式</li>
                                    <li>3、缓存数据 + 过期时间也足够解决大部分业务对缓存的要求</li>
                                    <li>4、通过加锁保证并发读写，写写的时候按照顺序排好队，读读无所谓，所以适合读写锁，（业务不关心脏数据，允许临时脏数据可忽略）</li>
                                </ul>
                                <p>总结:</p>
                                <ul>
                                    <li>我们能放入缓存的数据本来就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前的最新值即可</li>
                                    <li>我们不应该过度设计，增加系统的复杂性</li>
                                    <li>遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点</li>
                                </ul>
                                <p>![](D:\java\gitee\java-learning-note\Evan
                                    Guo\项目笔记\谷粒商城项目开发文档\分布式高级篇\image\image-20201101054937769.png)</p>
                                <p>最后符上 三级分类数据 加上分布式锁</p>
                                <h3 id="6.5-spring-cache" id="6-5-Spring-Cache">6.5 Spring Cache</h3>
                                <h4 id="1%E3%80%81%E7%AE%80%E4%BB%8B-2" id="1、简介-v3">1、简介</h4>
                                <ul>
                                    <li>Spring 从3.1开始定义了 <code>org.springframework.cache.Cache</code> 和
                                        <code>org.sprngframework.cache.CacheManager</code> 接口睐统一不同的缓存技术</li>
                                    <li>并支持使用 <code>JCache</code>（JSR-107）注解简化我们的开发</li>
                                    <li>Cache 接口为缓存的组件规范定义，包含缓存的各种操作集合 <code>Cache</code> 接口下 Spring 提供了各种 XXXCache的实现，如
                                        <code>RedisCache</code>、<code>EhCache</code>,<code>ConcrrentMapCache</code>等等，
                                    </li>
                                    <li>每次调用需要缓存功能实现方法的时候，<code>Spring</code>
                                        会检查检查指定参数的马努表犯法是否已经被嗲用过，如果有就直接从缓存中获取方法调用后的结果，如果没有就调用方法并缓存结果后返回给用户，下次直接调用从缓存中获取
                                    </li>
                                    <li>使用 <code>Sprng</code> 缓存抽象时我们需要关注的点有以下两点
                                        <ul>
                                            <li>1、确定方法需要被缓存以及他们的的缓存策略</li>
                                            <li>2、从缓存中读取之前缓存存储的数据</li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>官网地址：<a target="_blank" rel="noopener"
                                        href="https://docs.spring.io/spring-framework/docs/5.2.10.RELEASE/spring-framework-reference/integration.html#cache-strategie">https://docs.spring.io/spring-framework/docs/5.2.10.RELEASE/spring-framework-reference/integration.html#cache-strategie</a>
                                </p>
                                <p>缓存注解配置</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201228171806703.png"
                                        alt="image-20201228171806703" /></p>
                                <h4 id="2%E3%80%81%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" id="2、基础概念">2、基础概念</h4>
                                <p>从3.1版本开始，Spring 框架就支持透明地向现有 Spring 应用程序添加缓存。与事务支持类似，缓存抽象允许在对代码影响最小的情况下一致地使用各种缓存解决方案。从
                                    Spring 4.1 开始，缓存抽象在JSR-107注释和更多定制选项的支持下得到了显著扩展。</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  8、整合SpringCache简化缓存开发</span></span><br><span class="line"><span class="comment">*      1、引入依赖</span></span><br><span class="line"><span class="comment">*          spring-boot-starter-cache</span></span><br><span class="line"><span class="comment">*      2、写配置</span></span><br><span class="line"><span class="comment">*          1、自动配置了那些</span></span><br><span class="line"><span class="comment">*              CacheAutoConfiguration会导入 RedisCacheConfiguration</span></span><br><span class="line"><span class="comment">*              自动配置好了缓存管理器，RedisCacheManager</span></span><br><span class="line"><span class="comment">*          2、配置使用redis作为缓存</span></span><br><span class="line"><span class="comment">*          Spring.cache.type=redis</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*       4、原理</span></span><br><span class="line"><span class="comment">*       CacheAutoConfiguration -&gt;RedisCacheConfiguration -&gt;</span></span><br><span class="line"><span class="comment">*       自动配置了 RedisCacheManager -&gt;初始化所有的缓存 -&gt; 每个缓存决定使用什么配置</span></span><br><span class="line"><span class="comment">*       -&gt;如果redisCacheConfiguration有就用已有的，没有就用默认的</span></span><br><span class="line"><span class="comment">*       -&gt;想改缓存的配置，只需要把容器中放一个 RedisCacheConfiguration 即可</span></span><br><span class="line"><span class="comment">*       -&gt;就会应用到当前 RedisCacheManager管理所有缓存分区中</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="3%E3%80%81%E6%B3%A8%E8%A7%A3" id="3、注解">3、注解</h4>
                                <p>对于缓存声明，Spring的缓存抽象提供了一组Java注解</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"><span class="doctag">@Cacheable</span>: Triggers cache population:触发将数据保存到缓存的操作</span></span><br><span class="line"><span class="comment"><span class="doctag">@CacheEvict</span>: Triggers cache eviction: 触发将数据从缓存删除的操作</span></span><br><span class="line"><span class="comment"><span class="doctag">@CachePut</span>: Updates the cache without interfering with the method execution:不影响方法执行更新缓存</span></span><br><span class="line"><span class="comment"><span class="doctag">@Caching</span>: Regroups multiple cache operations to be applied on a method:组合以上多个操作</span></span><br><span class="line"><span class="comment"><span class="doctag">@CacheConfig</span>: Shares some common cache-related settings at class-level:在类级别共享缓存的相同配置</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>注解使用</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、每一个需要缓存的数据我们都需要指定放到那个名字的缓存【缓存分区的划分【按照业务类型划分】】</span></span><br><span class="line"><span class="comment">     * 2、<span class="doctag">@Cacheable</span>(&#123;&quot;category&quot;&#125;)</span></span><br><span class="line"><span class="comment">     *      代表当前方法的结果需要缓存，如果缓存中有，方法不调用</span></span><br><span class="line"><span class="comment">     *      如果缓存中没有，调用方法，最后将方法的结果放入缓存</span></span><br><span class="line"><span class="comment">     * 3、默认行为:</span></span><br><span class="line"><span class="comment">     *      1、如果缓存中有，方法不用调用</span></span><br><span class="line"><span class="comment">     *      2、key默自动生成，缓存的名字:SimpleKey[](自动生成的key值)</span></span><br><span class="line"><span class="comment">     *      3、缓存中value的值，默认使用jdk序列化，将序列化后的数据存到redis</span></span><br><span class="line"><span class="comment">     *      3、默认的过期时间，-1</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *    自定义操作</span></span><br><span class="line"><span class="comment">     *      1、指定缓存使用的key     key属性指定，接收一个SpEl</span></span><br><span class="line"><span class="comment">     *      2、指定缓存数据的存活时间  配置文件中修改ttl</span></span><br><span class="line"><span class="comment">     *      3、将数据保存为json格式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">//value 缓存的别名</span></span><br><span class="line">     <span class="comment">// key redis中key的名称，默认是方法名称</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;,key = &quot;#root.method.name&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title">getLevel1Categorys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// parent_cid为0则是一级目录</span></span><br><span class="line">        List&lt;CategoryEntity&gt; categoryEntities = baseMapper.selectList(<span class="keyword">new</span> QueryWrapper&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;耗费时间：&quot;</span> + (System.currentTimeMillis() - l));</span><br><span class="line">        <span class="keyword">return</span> categoryEntities;</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="4%E3%80%81%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%AD%E6%B3%95" id="4、表达式语法">4、表达式语法
                                </h4>
                                <p>配置</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">package</span> com.atguigu.gulimall.product.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.cache.CacheProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(CacheProperties.class)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCacheConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置文件中的东西没有用上</span></span><br><span class="line"><span class="comment">     * 1、原来的配置吻技安绑定的配置类是这样子的</span></span><br><span class="line"><span class="comment">     *      <span class="doctag">@ConfigurationProperties</span>(prefix = &quot;Spring.cache&quot;)</span></span><br><span class="line"><span class="comment">     * 2、要让他生效</span></span><br><span class="line"><span class="comment">     *      <span class="doctag">@EnableConfigurationProperties</span>(CacheProperties.class)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cacheProperties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">RedisCacheConfiguration <span class="title">redisCacheConfiguration</span><span class="params">(CacheProperties cacheProperties)</span> </span>&#123;</span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        <span class="comment">// 设置key的序列化</span></span><br><span class="line">        config = config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> StringRedisSerializer()));</span><br><span class="line">        <span class="comment">// 设置value序列化 -&gt;JackSon</span></span><br><span class="line">        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()));</span><br><span class="line"></span><br><span class="line">        CacheProperties.Redis redisProperties = cacheProperties.getRedis();</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>yaml</p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">Spring:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">time-to-live:</span> <span class="number">3600000</span>           <span class="comment"># 过期时间</span></span><br><span class="line">      <span class="attr">key-prefix:</span> <span class="string">CACHE_</span>              <span class="comment"># key前缀</span></span><br><span class="line">      <span class="attr">use-key-prefix:</span> <span class="literal">true</span>            <span class="comment"># 是否使用写入redis前缀</span></span><br><span class="line">      <span class="attr">cache-null-values:</span> <span class="literal">true</span>         <span class="comment"># 是否允许缓存空值</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="5%E3%80%81%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"
                                    id="5、缓存穿透问题解决">5、缓存穿透问题解决</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、每一个需要缓存的数据我们都需要指定放到那个名字的缓存【缓存分区的划分【按照业务类型划分】】</span></span><br><span class="line"><span class="comment"> * 2、<span class="doctag">@Cacheable</span>(&#123;&quot;category&quot;&#125;)</span></span><br><span class="line"><span class="comment"> *      代表当前方法的结果需要缓存，如果缓存中有，方法不调用</span></span><br><span class="line"><span class="comment"> *      如果缓存中没有，调用方法，最后将方法的结果放入缓存</span></span><br><span class="line"><span class="comment"> * 3、默认行为:</span></span><br><span class="line"><span class="comment"> *      1、如果缓存中有，方法不用调用</span></span><br><span class="line"><span class="comment"> *      2、key默自动生成，缓存的名字:SimpleKey[](自动生成的key值)</span></span><br><span class="line"><span class="comment"> *      3、缓存中value的值，默认使用jdk序列化，将序列化后的数据存到redis</span></span><br><span class="line"><span class="comment"> *      3、默认的过期时间，-1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    自定义操作</span></span><br><span class="line"><span class="comment"> *      1、指定缓存使用的key     key属性指定，接收一个SpEl</span></span><br><span class="line"><span class="comment"> *      2、指定缓存数据的存活时间  配置文件中修改ttl</span></span><br><span class="line"><span class="comment"> *      3、将数据保存为json格式</span></span><br><span class="line"><span class="comment"> * 4、Spring-Cache的不足：</span></span><br><span class="line"><span class="comment"> *      1、读模式：</span></span><br><span class="line"><span class="comment"> *          缓存穿透:查询一个null数据，解决 缓存空数据：ache-null-values=true</span></span><br><span class="line"><span class="comment"> *          缓存击穿:大量并发进来同时查询一个正好过期的数据，解决:加锁 ？ 默认是无加锁</span></span><br><span class="line"><span class="comment"> *          缓存雪崩:大量的key同时过期，解决：加上随机时间，Spring-cache-redis-time-to-live</span></span><br><span class="line"><span class="comment"> *       2、写模式：（缓存与数据库库不一致）</span></span><br><span class="line"><span class="comment"> *          1、读写加锁</span></span><br><span class="line"><span class="comment"> *          2、引入canal，感知到MySQL的更新去更新数据库</span></span><br><span class="line"><span class="comment"> *          3、读多写多，直接去数据库查询就行</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    总结：</span></span><br><span class="line"><span class="comment"> *      常规数据（读多写少，即时性，一致性要求不高的数据）完全可以使用SpringCache 写模式（ 只要缓存数据有过期时间就足够了）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    特殊数据：特殊设计</span></span><br><span class="line"><span class="comment"> *      原理：</span></span><br><span class="line"><span class="comment"> *          CacheManager(RedisManager) -&gt; Cache(RedisCache) -&gt;Cache负责缓存的读写</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;,key = &quot;#root.method.name&quot;,sync = true)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title">getLevel1Categorys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// parent_cid为0则是一级目录</span></span><br><span class="line">    List&lt;CategoryEntity&gt; categoryEntities = baseMapper.selectList(<span class="keyword">new</span> QueryWrapper&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;耗费时间：&quot;</span> + (System.currentTimeMillis() - l));</span><br><span class="line">    <span class="keyword">return</span> categoryEntities;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="6%E3%80%81%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0" id="6、缓存更新">6、缓存更新</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 级联更新所有的关联数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CacheEvict</span> 失效模式</span></span><br><span class="line"><span class="comment">     * 1、同时进行多种缓存操作 <span class="doctag">@Caching</span></span></span><br><span class="line"><span class="comment">     * 2、指定删除某个分区下的所有数据 <span class="doctag">@CacheEvict</span>(value = &#123;&quot;category&quot;&#125;,allEntries = true)</span></span><br><span class="line"><span class="comment">     * 3、存储同一类型的数据，都可以指定成同一分区，分区名默认就是缓存的前缀</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Caching(evict = &#123;</span></span><br><span class="line"><span class="meta">            @CacheEvict(value = &#123;&quot;category&quot;&#125;,key = &quot;&#x27;getLevel1Categorys&#x27;&quot;),</span></span><br><span class="line"><span class="meta">            @CacheEvict(value = &#123;&quot;category&quot;&#125;,key = &quot;&#x27;getCatelogJson&#x27;&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line"><span class="comment">//    @CacheEvict(value = &#123;&quot;category&quot;&#125;,allEntries = true)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCascate</span><span class="params">(CategoryEntity category)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新自己表对象</span></span><br><span class="line">        <span class="keyword">this</span>.updateById(category);</span><br><span class="line">        <span class="comment">// 更新关联表对象</span></span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>总结业务流程：</p>
                                <p>如果忘了这个技术点看下做的笔记的例子，然后去官网看下文档，温故而知新</p>
                                <p>流程图</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201228171552816.png"
                                        alt="image-20201228171552816" /></p>
                                <h1
                                    id="7%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-%E5%95%86%E5%93%81%E6%A3%80%E7%B4%A2">
                                    7、商城业务 &amp; 商品检索</h1>
                                <h3 id="7.1-%E6%A3%80%E7%B4%A2%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90" id="7-1-检索业务分析">7.1
                                    检索业务分析</h3>
                                <h4 id="7.1.1-%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90%E6%8A%BD%E5%8F%96"
                                    id="7-1-1-检索查询参数模型分析抽取">7.1.1 检索查询参数模型分析抽取</h4>
                                <p>打个比例吧 你肯定上过京东、淘宝买过东西吧？ 那么你想要购买什么东西，你需要在搜索框中搜索你想要购买的物品，那么系统就会给你响应</p>
                                <p>我在京东搜索 <code>Iphone</code> 他会显示出相对应的产品</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201104152544243.png"
                                        alt="image-20201104152544243" /></p>
                                <p>那么我们开始对业务条件进行分析，并创建对应的VO类</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201104153118677.png"
                                        alt="image-20201104153118677" /></p>
                                <p>好的创建出来了........</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装页面所有可能传递过来的查询条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchParam</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页面传递过来的全文匹配关键字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 三级分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long catalog3Id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sort=saleCout_asc/desc</span></span><br><span class="line"><span class="comment">     * sort=skuPrice_asc/desc</span></span><br><span class="line"><span class="comment">     * sort=hotScore_asc/desc</span></span><br><span class="line"><span class="comment">     * 排序条件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sort;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hasStock(是否有货) skuPrice区间，brandId、catalog3Id、attrs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否显示有货</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer hasStock = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 价格区间查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String skuPrice;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照品牌进行查询，可以多选</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; brandId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照属性进行筛选</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; attrs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="7.1.2-%E6%A3%80%E7%B4%A2%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90%E6%8A%BD%E5%8F%96"
                                    id="7-1-2-检索返回结果模型分析抽取">7.1.2 检索返回结果模型分析抽取</h4>
                                <p>那么返回的数据我们是不是也要创建一个 VO 用来返回页面的数据？</p>
                                <p>借鉴京东的实例来做参考</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201104153950990.png"
                                        alt="image-20201104153950990" /></p>
                                <p>那么抽取实体类</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询结果返回</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchResult</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询到所有商品的商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuEsModel&gt; products;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以下是分页信息</span></span><br><span class="line"><span class="comment">     * 当前页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总共记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalPages;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前查询到的结果，所有设计的品牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BrandVo&gt; brands;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前查询结果，所有涉及到的分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;CatalogVo&gt; catalogs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前查询到的结果，所有涉及到的所有属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrVo&gt; attrs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; pageNavs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//==================以上是要返回给页面的所有信息</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandVo</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Long brandId;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌名字</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String brandName;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌图片</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String brandImg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CatalogVo</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 分类id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Long catalogId;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌名字</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String CatalogName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AttrVo</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 属性id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 属性名字</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 属性值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; attrValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="7.2-%E6%A3%80%E7%B4%A2%E8%AF%AD%E5%8F%A5%E6%9E%84%E5%BB%BA" id="7-2-检索语句构建">7.2
                                    检索语句构建</h3>
                                <h4 id="7.2.1-%E6%9F%A5%E8%AF%A2%E9%83%A8%E5%88%86-%26-%E8%81%9A%E5%90%88%E9%83%A8%E5%88%86"
                                    id="7-2-1-查询部分-聚合部分">7.2.1 查询部分 &amp; 聚合部分</h4>
                                <p>那么这个 DSL 编写我们就在 Kibana 中测试</p>
                                <figure class="highlight json">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"></span><br><span class="line">GET gulimall_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;skuTitle&quot;</span>: <span class="string">&quot;华为&quot;</span> <span class="comment">// 按照关键字查询</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;catalogId&quot;</span>: <span class="string">&quot;225&quot;</span> <span class="comment">// 根据分类id过滤</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;brandId&quot;</span>: [ <span class="comment">// 品牌id</span></span><br><span class="line">              <span class="string">&quot;1&quot;</span>,</span><br><span class="line">              <span class="string">&quot;5&quot;</span>,</span><br><span class="line">              <span class="string">&quot;9&quot;</span></span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;nested&quot;</span>: &#123; <span class="comment">// 根据属性id 以及属性值进行过滤</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;attrs&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;attrs.attrId&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;attrs.attrValue&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;2019&quot;</span></span><br><span class="line">                      ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;term&quot;</span>: &#123; <span class="comment">// 是否有库存</span></span><br><span class="line">            <span class="attr">&quot;hasStock&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                  <span class="attr">&quot;range&quot;</span>: &#123; <span class="comment">// 价格区间</span></span><br><span class="line">                    <span class="attr">&quot;skuPrice&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;gte&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                      <span class="attr">&quot;lte&quot;</span>: <span class="number">7000</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: [ <span class="comment">//排序</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;skuPrice&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>:<span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123; <span class="comment">// 对搜索田间进行高亮</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: &#123;<span class="attr">&quot;skuTitle&quot;</span>: &#123;&#125;&#125;, </span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;b style=color:red&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/b&gt;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;brand_agg&quot;</span>: &#123; <span class="comment">//品牌进行聚合</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;brandId&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;brand_name_agg&quot;</span>: &#123; <span class="comment">// 品牌名字</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;brandName&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;brand_img_agg&quot;</span>: &#123; <span class="comment">//品牌图片</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;brandImg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;catalog_agg&quot;</span>: &#123; <span class="comment">// 分类</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;catalogId&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;catalog_name_agg&quot;</span>: &#123; <span class="comment">//分类名字</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;catalogName&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;attr_agg&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;nested&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;attrs&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123; <span class="comment">//属性聚合</span></span><br><span class="line">        <span class="attr">&quot;attr_id_agg&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;attrs.attrId&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;attr_name_agg&quot;</span>: &#123; <span class="comment">//属性名字</span></span><br><span class="line">              <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;attrs.attrName&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;attr_value_agg&quot;</span>:&#123; <span class="comment">//属性的值</span></span><br><span class="line">              <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;attrs.attrValue&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>用代码实现</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 准备检索请求</span></span><br><span class="line"><span class="comment">    * #模糊匹配、过滤（按照属性、分类、品牌、价格区间、库存）、排序、分页、高亮、聚合分析</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> SearchRequest <span class="title">buildSearchRequest</span><span class="params">(SearchParam param)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); <span class="comment">//构建DSL语句</span></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 模糊匹配 过滤（按照属性、分类、品牌、价格区间、库存）</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">// 1、构建bool - query</span></span><br><span class="line">       BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();</span><br><span class="line">       <span class="comment">// 1.1 must - 模糊匹配</span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isEmpty(param.getKeyword())) &#123;</span><br><span class="line">           boolQuery.must(QueryBuilders.matchQuery(<span class="string">&quot;skuTitle&quot;</span>, param.getKeyword()));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 1.2 bool - filter 按照三级分类id来查询</span></span><br><span class="line">       <span class="keyword">if</span> (param.getCatalog3Id() != <span class="keyword">null</span>) &#123;</span><br><span class="line">           boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;catalogId&quot;</span>, param.getCatalog3Id()));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 1.2 bool - filter 按照品牌id来查询</span></span><br><span class="line">       <span class="keyword">if</span> (param.getBrandId() != <span class="keyword">null</span> &amp;&amp; param.getBrandId().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           boolQuery.filter(QueryBuilders.termsQuery(<span class="string">&quot;brandId&quot;</span>, param.getBrandId()));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 1.2 bool - filter 按照所有指定的属性来进行查询 *******不理解这个attr=1_5寸:8寸这样的设计</span></span><br><span class="line">       <span class="keyword">if</span> (param.getAttrs() != <span class="keyword">null</span> &amp;&amp; param.getAttrs().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (String attr : param.getAttrs()) &#123;</span><br><span class="line">               <span class="comment">// attr=1_5寸:8寸&amp;attrs=2_16G:8G</span></span><br><span class="line">               BoolQueryBuilder nestedboolQuery = QueryBuilders.boolQuery();</span><br><span class="line">               String[] s = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">               String attrId = s[<span class="number">0</span>];<span class="comment">// 检索的属性id</span></span><br><span class="line">               String[] attrValues = s[<span class="number">1</span>].split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">               nestedboolQuery.must(QueryBuilders.termQuery(<span class="string">&quot;attrs.attrId&quot;</span>, attrId));</span><br><span class="line">               nestedboolQuery.must(QueryBuilders.termsQuery(<span class="string">&quot;attrs.attrValue&quot;</span>, attrValues));</span><br><span class="line">               <span class="comment">// 每一个必须都生成一个nested查询</span></span><br><span class="line">               NestedQueryBuilder nestedQuery = QueryBuilders.nestedQuery(<span class="string">&quot;attrs&quot;</span>, nestedboolQuery, ScoreMode.None);</span><br><span class="line">               boolQuery.filter(nestedQuery);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 1.2 bool - filter 按照库存是否存在</span></span><br><span class="line">       boolQuery.filter(QueryBuilders.termQuery(<span class="string">&quot;hasStock&quot;</span>, param.getHasStock() == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>));</span><br><span class="line">       <span class="comment">// 1.2 bool - filter 按照价格区间</span></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 1_500/_500/500_</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isEmpty(param.getSkuPrice())) &#123;</span><br><span class="line">           RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery(<span class="string">&quot;skuPrice&quot;</span>);</span><br><span class="line">           String[] s = param.getSkuPrice().split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (s.length == <span class="number">2</span>) &#123;</span><br><span class="line">               <span class="comment">// 区间</span></span><br><span class="line">               rangeQuery.gte(s[<span class="number">0</span>]).lte(s[<span class="number">1</span>]);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s.length == <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (param.getSkuPrice().startsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">                   rangeQuery.lte(s[<span class="number">0</span>]);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (param.getSkuPrice().endsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">                   rangeQuery.gte(s[<span class="number">0</span>]);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           boolQuery.filter(rangeQuery);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//把以前所有条件都拿来进行封装</span></span><br><span class="line">       sourceBuilder.query(boolQuery);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 排序、分页、高亮</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//2.1、排序</span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isEmpty(param.getSort())) &#123;</span><br><span class="line">           String sort = param.getSort();</span><br><span class="line">           <span class="comment">//sort=hotScore_asc/desc</span></span><br><span class="line">           String[] s = sort.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">           SortOrder order = s[<span class="number">1</span>].equalsIgnoreCase(<span class="string">&quot;asc&quot;</span>) ? SortOrder.ASC : SortOrder.DESC;</span><br><span class="line">           sourceBuilder.sort(s[<span class="number">0</span>], order);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//2.2 分页 pageSize:5</span></span><br><span class="line">       <span class="comment">// pageNum:1 from 0 size:5 [0,1,2,3,4]</span></span><br><span class="line">       <span class="comment">// pageNum:2 from 5 size:5</span></span><br><span class="line">       <span class="comment">// from (pageNum - 1)*size</span></span><br><span class="line">       sourceBuilder.from((param.getPageNum() - <span class="number">1</span>) * EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line">       sourceBuilder.size(EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line">       <span class="comment">//2.3、高亮</span></span><br><span class="line">       <span class="keyword">if</span> (!StringUtils.isEmpty(param.getKeyword())) &#123;</span><br><span class="line">           HighlightBuilder builder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">           builder.field(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">           builder.preTags(<span class="string">&quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">           builder.postTags(<span class="string">&quot;&lt;/b&gt;&quot;</span>);</span><br><span class="line">           sourceBuilder.highlighter(builder);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 聚合分析</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//1、品牌聚合</span></span><br><span class="line">       TermsAggregationBuilder brand_agg = AggregationBuilders.terms(<span class="string">&quot;brand_agg&quot;</span>);</span><br><span class="line">       brand_agg.field(<span class="string">&quot;brandId&quot;</span>).size(<span class="number">50</span>);</span><br><span class="line">       <span class="comment">//品牌聚合的子聚合</span></span><br><span class="line">       brand_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;brand_name_agg&quot;</span>).field(<span class="string">&quot;brandName&quot;</span>).size(<span class="number">2</span>));</span><br><span class="line">       brand_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;brand_img_agg&quot;</span>).field(<span class="string">&quot;brandImg&quot;</span>).size(<span class="number">2</span>));</span><br><span class="line">       <span class="comment">// TODO 1、聚合brand</span></span><br><span class="line">       sourceBuilder.aggregation(brand_agg);</span><br><span class="line">       <span class="comment">//2、分类聚合</span></span><br><span class="line">       TermsAggregationBuilder catalog_agg = AggregationBuilders.terms(<span class="string">&quot;catalog_agg&quot;</span>).field(<span class="string">&quot;catalogId&quot;</span>).size(<span class="number">20</span>);</span><br><span class="line">       catalog_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;catalog_name_agg&quot;</span>).field(<span class="string">&quot;catalogName&quot;</span>).size(<span class="number">1</span>));</span><br><span class="line">       <span class="comment">// TODO 2、聚合catalog</span></span><br><span class="line">       sourceBuilder.aggregation(catalog_agg);</span><br><span class="line">       <span class="comment">//3、属性聚合 attr_agg</span></span><br><span class="line">       NestedAggregationBuilder attr_agg = AggregationBuilders.nested(<span class="string">&quot;attr_agg&quot;</span>, <span class="string">&quot;attrs&quot;</span>);</span><br><span class="line">       <span class="comment">// 聚合出当前所有的attrId</span></span><br><span class="line">       TermsAggregationBuilder attr_id_agg = AggregationBuilders.terms(<span class="string">&quot;attr_id_agg&quot;</span>).field(<span class="string">&quot;attrs.attrId&quot;</span>);</span><br><span class="line">       <span class="comment">//聚合分析出当前attr_id对应的名字</span></span><br><span class="line">       attr_id_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;attr_name_agg&quot;</span>).field(<span class="string">&quot;attrs.attrName&quot;</span>).size(<span class="number">1</span>));</span><br><span class="line">       <span class="comment">// 聚合分析出当前attr_id对应的可能的属性值attractValue</span></span><br><span class="line">       attr_id_agg.subAggregation(AggregationBuilders.terms(<span class="string">&quot;attr_value_agg&quot;</span>).field(<span class="string">&quot;attrs.attrValue&quot;</span>).size(<span class="number">50</span>));</span><br><span class="line">       attr_agg.subAggregation(attr_id_agg);</span><br><span class="line">       <span class="comment">// TODO 3、聚合attr</span></span><br><span class="line">       sourceBuilder.aggregation(attr_agg);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       String s = sourceBuilder.toString();</span><br><span class="line">       System.out.println(<span class="string">&quot;构建的DSL:&quot;</span> + s);</span><br><span class="line">       SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="keyword">new</span> String[]&#123;EsConstant.PRODUCT_INDEX&#125;, sourceBuilder);</span><br><span class="line">       <span class="keyword">return</span> searchRequest;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>代码实现基本上是 根据 json 来写 调用对应的 API</p>
                                <p>term 和 terms 不要调用错误</p>
                                <h3 id="7.3-%E7%BB%93%E6%9E%9C%E6%8F%90%E5%8F%96%E5%B0%81%E8%A3%85" id="7-3-结果提取封装">7.3
                                    结果提取封装</h3>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 自动将页面提交过来的所有请求查询参数自动封装成指定的对象</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> param</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/list.html&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">listPage</span><span class="params">(SearchParam param, Model model)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//1、根据传递来的页面参数，去es中检索商品</span></span><br><span class="line">       SearchResult result = mallSearchService.search(param);</span><br><span class="line">       model.addAttribute(<span class="string">&quot;result&quot;</span>,result);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SearchResult <span class="title">search</span><span class="params">(SearchParam param)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、动态构建出查询需要的DSL语句</span></span><br><span class="line">    SearchResult result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、准备检索请求</span></span><br><span class="line">    SearchRequest searchRequest = buildSearchRequest(param);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 2、执行检索请求</span></span><br><span class="line">        SearchResponse response = client.search(searchRequest, GulimallElasticsearchConfig.COMMON_OPTIONS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、分析响应数据封装成我们需要的格式</span></span><br><span class="line">        result = buildSearchResult(response, param);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>具体业务执行</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建结果数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SearchResult <span class="title">buildSearchResult</span><span class="params">(SearchResponse response, SearchParam param)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    SearchResult result = <span class="keyword">new</span> SearchResult();</span><br><span class="line">    SearchHits hits = response.getHits();</span><br><span class="line">    List&lt;SkuEsModel&gt; esModels = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (hits.getHits() != <span class="keyword">null</span> &amp;&amp; hits.getHits().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits.getHits()) &#123;</span><br><span class="line">            String sourceAsString = hit.getSourceAsString();</span><br><span class="line">            SkuEsModel skuEsModel = JSON.parseObject(sourceAsString, SkuEsModel.class);</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(param.getKeyword())) &#123;</span><br><span class="line">                HighlightField skuTitle = hit.getHighlightFields().get(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">                String string = skuTitle.getFragments()[<span class="number">0</span>].string();</span><br><span class="line">                skuEsModel.setSkuTitle(string);</span><br><span class="line">            &#125;</span><br><span class="line">            esModels.add(skuEsModel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//1、返回所有查询到的商品</span></span><br><span class="line">    result.setProducts(esModels);</span><br><span class="line">    <span class="comment">//2、当前所有商品设计到的所有属性信息</span></span><br><span class="line">    List&lt;SearchResult.AttrVo&gt; attrVos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    ParsedNested attr_agg = response.getAggregations().get(<span class="string">&quot;attr_agg&quot;</span>);</span><br><span class="line">    ParsedLongTerms attr_id_agg = attr_agg.getAggregations().get(<span class="string">&quot;attr_id_agg&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : attr_id_agg.getBuckets()) &#123;</span><br><span class="line">        SearchResult.AttrVo attrVo = <span class="keyword">new</span> SearchResult.AttrVo();</span><br><span class="line">        <span class="comment">// 1、得到属性的id</span></span><br><span class="line">        Long attrId = bucket.getKeyAsNumber().longValue();</span><br><span class="line">        <span class="comment">// 2、得到属性的名字</span></span><br><span class="line">        String attrName = ((ParsedStringTerms) bucket.getAggregations().get(<span class="string">&quot;attr_name_agg&quot;</span>)).getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        <span class="comment">// 3、得到属性的所有值</span></span><br><span class="line">        List&lt;String&gt; attrValue = ((ParsedStringTerms) bucket.getAggregations().get(<span class="string">&quot;attr_value_agg&quot;</span>)).getBuckets().stream().map(item -&gt; &#123;</span><br><span class="line">            String keyAsString = item.getKeyAsString();</span><br><span class="line">            <span class="keyword">return</span> keyAsString;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        attrVo.setAttrId(attrId);</span><br><span class="line">        attrVo.setAttrName(attrName);</span><br><span class="line">        attrVo.setAttrValue(attrValue);</span><br><span class="line">        attrVos.add(attrVo);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setAttrs(attrVos);</span><br><span class="line">    <span class="comment">//3、当前所有商品的分类信息</span></span><br><span class="line">    ParsedLongTerms Catalog_agg = response.getAggregations().get(<span class="string">&quot;catalog_agg&quot;</span>);</span><br><span class="line">    List&lt;SearchResult.CatalogVo&gt; catalogVos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;? extends Terms.Bucket&gt; buckets = Catalog_agg.getBuckets();</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">        SearchResult.CatalogVo catalogVo = <span class="keyword">new</span> SearchResult.CatalogVo();</span><br><span class="line">        <span class="comment">// 得到分类id</span></span><br><span class="line">        String keyAsString = bucket.getKeyAsString();</span><br><span class="line">        catalogVo.setCatalogId(Long.parseLong(keyAsString));</span><br><span class="line">        <span class="comment">// 得到分类名</span></span><br><span class="line">        ParsedStringTerms catalog_name_agg = bucket.getAggregations().get(<span class="string">&quot;catalog_name_agg&quot;</span>);</span><br><span class="line">        String catalog_name = catalog_name_agg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        catalogVo.setCatalogName(catalog_name);</span><br><span class="line">        catalogVos.add(catalogVo);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setCatalogs(catalogVos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、当前所有商品的品牌信息</span></span><br><span class="line">    List&lt;SearchResult.BrandVo&gt; brandVos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    ParsedLongTerms brand_agg = response.getAggregations().get(<span class="string">&quot;brand_agg&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : brand_agg.getBuckets()) &#123;</span><br><span class="line">        SearchResult.BrandVo brandVo = <span class="keyword">new</span> SearchResult.BrandVo();</span><br><span class="line">        <span class="comment">// 1、得到品牌的id</span></span><br><span class="line">        <span class="keyword">long</span> brandId = bucket.getKeyAsNumber().longValue();</span><br><span class="line">        <span class="comment">// 2、得到品牌的图片</span></span><br><span class="line">        String brandImg = ((ParsedStringTerms) bucket.getAggregations().get(<span class="string">&quot;brand_img_agg&quot;</span>)).getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        <span class="comment">// 3、得到品牌的姓名</span></span><br><span class="line">        String brandname = ((ParsedStringTerms) bucket.getAggregations().get(<span class="string">&quot;brand_name_agg&quot;</span>)).getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        brandVo.setBrandName(brandname);</span><br><span class="line">        brandVo.setBrandId(brandId);</span><br><span class="line">        brandVo.setBrandImg(brandImg);</span><br><span class="line">        brandVos.add(brandVo);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setBrands(brandVos);</span><br><span class="line">    <span class="comment">//5、分页信息 - 总记录数</span></span><br><span class="line">    <span class="keyword">long</span> total = hits.getTotalHits().value;</span><br><span class="line">    result.setTotal(total);</span><br><span class="line">    <span class="comment">//6、分页信息 - 页码</span></span><br><span class="line">    result.setPageNum(param.getPageNum());</span><br><span class="line">    <span class="comment">//7、分页信息 - 总页码</span></span><br><span class="line">    <span class="keyword">int</span> totalPages = (<span class="keyword">int</span>) total % EsConstant.PRODUCT_PAGESIZE == <span class="number">0</span> ? (<span class="keyword">int</span>) total / EsConstant.PRODUCT_PAGESIZE : ((<span class="keyword">int</span>) total / EsConstant.PRODUCT_PAGESIZE + <span class="number">1</span>);</span><br><span class="line">    result.setTotalPages(totalPages);</span><br><span class="line"></span><br><span class="line">    List&lt;Integer&gt; pageNavs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= totalPages; i++) &#123;</span><br><span class="line">        pageNavs.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setPageNavs(pageNavs);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="7.4-%E9%A1%B5%E9%9D%A2%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93" id="7-4-页面数据渲染">7.4
                                    页面数据渲染</h3>
                                <h4 id="7.4.1%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93" id="7-4-1基本数据渲染">
                                    7.4.1基本数据渲染</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105124530345.png"
                                        alt="image-20201105124530345" /></p>
                                <p>遍历后显示结果</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105124552833.png"
                                        alt="image-20201105124552833" /></p>
                                <h4 id="7.4.3-%E7%AD%9B%E9%80%89%E6%9D%A1%E4%BB%B6%E6%B8%B2%E6%9F%93" id="7-4-3-筛选条件渲染">
                                    7.4.3 筛选条件渲染</h4>
                                <p>品牌条件筛选</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105125018666.png"
                                        alt="image-20201105125018666" /></p>
                                <p>分类</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105125250519.png"
                                        alt="image-20201105125250519" /></p>
                                <p>属性筛选</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105125718289.png"
                                        alt="image-20201105125718289" /></p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">searchProducts</span>(<span class="params">name, value</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 跳转对应地址</span></span><br><span class="line">        location.href = replaceAndParamVal(location.href,name,value)</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则表达式替换</span></span><br><span class="line"><span class="comment">     * **/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">replaceAndParamVal</span>(<span class="params">url, paramName, replaceVal,forceAdd</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> oUrl = url.toString();</span><br><span class="line">        <span class="comment">// 1、如果没有就添加，有就替换</span></span><br><span class="line">        <span class="keyword">if</span> (oUrl.indexOf(paramName) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(forceAdd) &#123;</span><br><span class="line">                <span class="keyword">var</span> nUrl = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (oUrl.indexOf(<span class="string">&quot;?&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    nUrl = oUrl + <span class="string">&quot;&amp;&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    nUrl = oUrl + <span class="string">&quot;?&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> nUrl;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">var</span> re = <span class="built_in">eval</span>(<span class="string">&#x27;/(&#x27;</span> + paramName + <span class="string">&#x27;=)([^&amp;]*)/gi&#x27;</span>);</span><br><span class="line">                <span class="keyword">var</span> nUrl = oUrl.replace(re, paramName + <span class="string">&#x27;=&#x27;</span> + replaceVal)</span><br><span class="line">                <span class="keyword">return</span> nUrl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> nUrl = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (oUrl.indexOf(<span class="string">&quot;?&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                nUrl = oUrl + <span class="string">&quot;&amp;&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nUrl = oUrl + <span class="string">&quot;?&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> nUrl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="7.4.4-%E5%88%86%E9%A1%B5%E6%95%B0%E6%8D%AE%E7%AD%9B%E9%80%89" id="7-4-4-分页数据筛选">
                                    7.4.4 分页数据筛选</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105125925391.png"
                                        alt="image-20201105125925391" /></p>
                                <h4 id="7.4.5-%E9%A1%B5%E9%9D%A2%E6%8E%92%E5%BA%8F%E5%8A%9F%E8%83%BD" id="7-4-5-页面排序功能">
                                    7.4.5 页面排序功能</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105130422378.png"
                                        alt="image-20201105130422378" /></p>
                                <h4 id="7.4.6-%E9%A1%B5%E9%9D%A2%E4%BB%B7%E6%A0%BC%E7%AD%9B%E9%80%89" id="7-4-6-页面价格筛选">
                                    7.4.6 页面价格筛选</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105131105507.png"
                                        alt="image-20201105131105507" /></p>
                                <p>JS</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">$(<span class="string">&quot;#skuPriceSearchBtn&quot;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 1、拼上价格区间的查询条件</span></span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">from</span> = $(<span class="string">&quot;#skuPriceFrom&quot;</span>).val();</span><br><span class="line">    <span class="keyword">var</span> to = $(<span class="string">&quot;#skuPriceTo&quot;</span>).val();</span><br><span class="line">    <span class="comment">// 2、拼接语句</span></span><br><span class="line">    <span class="keyword">var</span> query = <span class="keyword">from</span> + <span class="string">&quot;_&quot;</span> + to;</span><br><span class="line">    <span class="comment">// 3、替换 skuPrice</span></span><br><span class="line">    location.href = replaceAndParamVal(location.href,<span class="string">&quot;skuPrice&quot;</span>,query);</span><br><span class="line">&#125;)</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="7.4.7-%E9%9D%A2%E5%8C%85%E5%B1%91%E5%AF%BC%E8%88%AA%EF%BC%88%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98%EF%BC%81%EF%BC%89"
                                    id="7-4-7-面包屑导航（遇到问题！）">7.4.7 面包屑导航（遇到问题！）</h4>
                                <p>前端页面：</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105131701322.png"
                                        alt="image-20201105131701322" /></p>
                                <p>在返回Vo类中 新增了</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105131841728.png"
                                        alt="image-20201105131841728" /></p>
                                <p>Controller中 的解析方法中</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 8、构建面包屑导航功能</span></span><br><span class="line">    <span class="keyword">if</span> (param.getAttrs()!=<span class="keyword">null</span> &amp;&amp; param.getAttrs().size() &gt;<span class="number">0</span>)&#123;</span><br><span class="line">        List&lt;SearchResult.NavVo&gt; collect = param.getAttrs().stream().map(attr -&gt; &#123;</span><br><span class="line">            <span class="comment">// 1、分析每个 attrs传递过来的值</span></span><br><span class="line">            SearchResult.NavVo navo = <span class="keyword">new</span> SearchResult.NavVo();</span><br><span class="line">            <span class="comment">// attrs=2_5寸：6寸</span></span><br><span class="line">            String[] s = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            navo.setNavValue(s[<span class="number">1</span>]);</span><br><span class="line">            R r = productFeignService.getAttrInfo(Long.parseLong(s[<span class="number">0</span>]));</span><br><span class="line">            result.getAttrIds().add(Long.parseLong(s[<span class="number">0</span>]));</span><br><span class="line">            <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                AttrResponseVo data = r.getData(<span class="string">&quot;attr&quot;</span>, <span class="keyword">new</span> TypeReference&lt;AttrResponseVo&gt;() &#123;</span><br><span class="line">                &#125;);</span><br><span class="line">                navo.setNavName(data.getAttrName());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                navo.setNavName(s[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 取消这个面包屑导航以后，我们要跳转到那个地方，将请求地址的url里面的当前置空</span></span><br><span class="line">            <span class="comment">//拿到所有的查询条件后，去掉当前</span></span><br><span class="line">            <span class="comment">// attrs=15_海思(Hisilicon)</span></span><br><span class="line"></span><br><span class="line">            String replace = replaceQueryString(param, attr,<span class="string">&quot;attrs&quot;</span>);</span><br><span class="line">            navo.setLink(<span class="string">&quot;http://search.gulimall.com/list.html?&quot;</span> + replace);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> navo;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        result.setNavs(collect);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 品牌、分类</span></span><br><span class="line">    <span class="keyword">if</span>(param.getBrandId() != <span class="keyword">null</span> &amp;&amp; param.getBrandId().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        List&lt;SearchResult.NavVo&gt; navs = result.getNavs();</span><br><span class="line">        SearchResult.NavVo navVo = <span class="keyword">new</span> SearchResult.NavVo();</span><br><span class="line">        navVo.setNavName(<span class="string">&quot;品牌&quot;</span>);</span><br><span class="line">        <span class="comment">//TODO 远程查询所有品牌</span></span><br><span class="line">        R info = productFeignService.info(param.getBrandId());</span><br><span class="line">        <span class="keyword">if</span> (info.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">            List&lt;BrandVo&gt; brand = info.getData(<span class="string">&quot;brand&quot;</span>, <span class="keyword">new</span> TypeReference&lt;List&lt;BrandVo&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            String replace = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (BrandVo brandVo : brand) &#123;</span><br><span class="line">                buffer.append(brandVo.getBrandName() + <span class="string">&quot;;&quot;</span>);</span><br><span class="line">                replace = replaceQueryString(param,brandVo.getBrandId() + <span class="string">&quot;&quot;</span>,<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            navVo.setNavValue(buffer.toString());</span><br><span class="line">            navVo.setLink(<span class="string">&quot;http://search.gulimall.com/list.html?&quot;</span> + replace);</span><br><span class="line">        &#125;</span><br><span class="line">        navs.add(navVo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO 分类：不需要导航</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h1 id="8%E3%80%81%E5%BC%82%E6%AD%A5-%26-%E7%BA%BF%E7%A8%8B%E6%B1%A0">8、异步 &amp; 线程池
                                </h1>
                                <h3 id="8.1-%E7%BA%BF%E7%A8%8B%E5%9B%9E%E9%A1%BE" id="8-1-线程回顾">8.1 线程回顾</h3>
                                <h4 id="8.1.1-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BA%BF%E7%A8%8B%E7%9A%84-4-%E7%A7%8D%E6%96%B9%E5%BC%8F"
                                    id="8-1-1-初始化线程的-4-种方式">8.1.1 初始化线程的 4 种方式</h4>
                                <p>1、继承 Thread</p>
                                <p>2、实现 Runnable</p>
                                <p>3、实现 Callable 接口 + FutureTask（可以拿到返回结果，可以处理异常）</p>
                                <p>4、线程池</p>
                                <p>方式一和方式二 主进程无法获取线程的运算结果，不适合当前场景</p>
                                <p>方式三：主进程可以获取当前线程的运算结果，但是不利于控制服务器种的线程资源，可以导致服务器资源耗尽</p>
                                <p>方式四：通过如下两种方式初始化线程池</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"><span class="keyword">new</span> ThreadPollExecutor(corePoolSize,maximumPoolSize,keepAliveTime,TimeUnit,unit,workQueue,threadFactory,handler);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><span
                                        style="color:blue;font-">通过线程池性能稳定，也可以获取执行结果，并捕获异常，但是</span>，<strong>在业务复杂情况下，一个异步调用可能会依赖另一个异步调用的执行结果</strong>
                                </p>
                                <h4 id="8.1.2-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84-7-%E5%A4%A7%E5%8F%82%E6%95%B0"
                                    id="8-1-2-线程池的-7-大参数">8.1.2 线程池的 7 大参数</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105154808826.png"
                                        alt="image-20201105154808826" /></p>
                                <p>运行流程：</p>
                                <p>1、线程池创建，准备好 <code>core</code> 数量 的核心线程，准备接受任务</p>
                                <p>2、新的任务进来，用 <code>core</code> 准备好的空闲线程执行</p>
                                <ul>
                                    <li><code>core</code> 满了，就将再进来的任务放入阻塞队列中，空闲的 core 就会自己去阻塞队列获取任务执行</li>
                                    <li>阻塞队列也满了，就直接开新线程去执行，最大只能开到 <code>max</code> 指定的数量</li>
                                    <li><code>max</code> 都执行好了，<code>Max-core</code> 数量空闲的线程会在
                                        <code>keepAliveTime</code> 指定的时间后自动销毁，终保持到 <code>core</code> 大小</li>
                                    <li>如果线程数开到了 <code>max</code> 数量，还有新的任务进来，就会使用 reject 指定的拒绝策略进行处理</li>
                                </ul>
                                <p>3、所有的线程创建都是由指定的 <code>factory</code> 创建的</p>
                                <p>面试;</p>
                                <p>一个线程池 core 7、max 20 ，queue 50 100 并发进来怎么分配的 ?</p>
                                <p>先有 7 个能直接得到运行，接下来 50 个进入队列排队，再多开 13 个继续执行，线程70个被安排上了，剩下30个默认拒绝策略</p>
                                <h4 id="8.1.3-%E5%B8%B8%E8%A7%81%E7%9A%84-4-%E7%A7%8D%E7%BA%BF%E7%A8%8B%E6%B1%A0"
                                    id="8-1-3-常见的-4-种线程池">8.1.3 常见的 4 种线程池</h4>
                                <ul>
                                    <li><code>newCacheThreadPool</code>
                                        <ul>
                                            <li>创建一个可缓存的线程池，如果线程池长度超过需要，可灵活回收空闲线程，若无可回收，则新建线程</li>
                                        </ul>
                                    </li>
                                    <li><code>newFixedThreadPool</code>
                                        <ul>
                                            <li>创建一个指定长度的线程池，可控制线程最大并发数，超出的线程会再队列中等待</li>
                                        </ul>
                                    </li>
                                    <li><code>newScheduleThreadPool</code>
                                        <ul>
                                            <li>创建一个定长线程池，支持定时及周期性任务执行</li>
                                        </ul>
                                    </li>
                                    <li><code>newSingleThreadExecutor</code>
                                        <ul>
                                            <li>创建一个单线程化的线程池，她只会用唯一的工作线程来执行任务，保证所有任务</li>
                                        </ul>
                                    </li>
                                </ul>
                                <h4 id="8.1.4-%E5%BC%80%E5%8F%91%E4%B8%AD%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0"
                                    id="8-1-4-开发中为什么使用线程池">8.1.4 开发中为什么使用线程池</h4>
                                <ul>
                                    <li>降低资源的消耗
                                        <ul>
                                            <li>通过重复利用已创建好的线程降低线程的创建和销毁带来的损耗</li>
                                        </ul>
                                    </li>
                                    <li>提高响应速度
                                        <ul>
                                            <li>因为线程池中的线程没有超过线程池的最大上限时，有的线程处于等待分配任务的状态，当任务来时无需创建新的线程就能执行</li>
                                        </ul>
                                    </li>
                                    <li>提高线程的客观理性
                                        <ul>
                                            <li>线程池会根据当前系统的特点对池内的线程进行优化处理，减少创建和销毁线程带来的系统开销，无限的创建和销毁线程不仅消耗系统资源，还降低系统的稳定性，使用线程池进行统一分配
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                                <h3 id="8.2-completablefuture-%E5%BC%82%E6%AD%A5%E7%BC%96%E6%8E%92"
                                    id="8-2-CompletableFuture-异步编排">8.2 CompletableFuture 异步编排</h3>
                                <p>业务场景：</p>
                                <p>查询商品详情页逻辑比较复杂，有些数据还需要远程调用，必然需要花费更多的时间</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105163535757.png"
                                        alt="image-20201105163535757" /></p>
                                <p>假如商品详情页的每个查询，需要如下标注时间才能完成</p>
                                <p>那么，用户需要5.5s后才能看到商品相详情页的内容，很显然是不能接受的</p>
                                <p>如果有多个线程同时完成这 6 步操作，也许只需要 1.5s 即可完成响应</p>
                                <h4 id="8.2.1-%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E5%AF%B9%E8%B1%A1" id="8-2-1-创建异步对象">
                                    8.2.1 创建异步对象</h4>
                                <p>CompletableFuture 提供了四个静态方法来创建一个异步操作</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105185420349.png"
                                        alt="image-20201105185420349" /></p>
                                <p>1、<strong>runXxx 都是没有返回结果的，supplyXxxx都是可以获取返回结果的</strong></p>
                                <p>2、可以传入自定义的线程池，否则就是用默认的线程池</p>
                                <p>3、根据方法的返回类型来判断是否该方法是否有返回类型</p>
                                <p>代码实现：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;main....start.....&quot;</span>);</span><br><span class="line">      CompletableFuture&lt;Void&gt; completableFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">          <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">          System.out.println(<span class="string">&quot;运行结果：&quot;</span> + i);</span><br><span class="line">      &#125;, executor);</span><br><span class="line"></span><br><span class="line">      CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">          System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">          <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">          System.out.println(<span class="string">&quot;运行结果：&quot;</span> + i);</span><br><span class="line">          <span class="keyword">return</span> i;</span><br><span class="line">      &#125;, executor);</span><br><span class="line">      Integer integer = future.get();</span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">&quot;main....stop.....&quot;</span> + integer);</span><br><span class="line">  &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="8.2.2-%E8%AE%A1%E7%AE%97%E5%AE%8C%E6%88%90%E6%97%B6%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95"
                                    id="8-2-2-计算完成时回调方法">8.2.2 计算完成时回调方法</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105185821263.png"
                                        alt="image-20201105185821263" /></p>
                                <p>whenComplete 可以处理正常和异常的计算结果，exceptionally 处理异常情况</p>
                                <p>whenComplete 和 whenCompleteAsync 的区别</p>
                                <p>​ whenComplete ：是执行当前任务的线程继续执行 whencomplete 的任务</p>
                                <p>​ whenCompleteAsync： 是执行把 whenCompleteAsync 这个任务继续提交给线程池来进行执行</p>
                                <p><strong>方法不以 Async 结尾，意味着 Action 使用相同的线程执行，而 Async
                                        可能会使用其他线程执行（如果是使用相同的线程池，也可能会被同一个线程选中执行）</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;运行结果：&quot;</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor).whenComplete((res,exception) -&gt;&#123;</span><br><span class="line">    <span class="comment">// 虽然能得到异常信息，但是没法修改返回的数据</span></span><br><span class="line">    System.out.println(<span class="string">&quot;异步任务成功完成了...结果是：&quot;</span> +res + <span class="string">&quot;异常是：&quot;</span> + exception);</span><br><span class="line">&#125;).exceptionally(throwable -&gt; &#123;</span><br><span class="line">    <span class="comment">// 可以感知到异常，同时返回默认值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="8.2.3-handle-%E6%96%B9%E6%B3%95" id="8-2-3-handle-方法">8.2.3 handle 方法</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105194503175.png"
                                        alt="image-20201105194503175" /></p>
                                <p>和 complete 一样，可以对结果做最后的处理（可处理异常），可改变返回值</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;运行结果：&quot;</span> + i);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;, executor).handle((res,thr) -&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (res != <span class="keyword">null</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> res * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (thr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="8.2.4-%E7%BA%BF%E7%A8%8B%E4%B8%B2%E8%A1%8C%E6%96%B9%E6%B3%95" id="8-2-4-线程串行方法">
                                    8.2.4 线程串行方法</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201105195632819.png"
                                        alt="image-20201105195632819" /></p>
                                <p>thenApply 方法：<strong>当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前任物的返回值</strong></p>
                                <p>thenAccept方法：<strong>消费处理结果，接受任务处理结果，并消费处理，无返回结果</strong></p>
                                <p>thenRun 方法：<strong>只要上面任务执行完成，就开始执行 thenRun ,只是处理完任务后，执行 thenRun的后续操作</strong></p>
                                <p>带有 Async 默认是异步执行的，同之前，</p>
                                <p>以上都要前置任务完成</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 线程串行化，</span></span><br><span class="line"><span class="comment">      * 1、thenRun:不能获取到上一步的执行结果，无返回值</span></span><br><span class="line"><span class="comment">      * .thenRunAsync(() -&gt;&#123;</span></span><br><span class="line"><span class="comment">      *             System.out.println(&quot;任务2启动了....&quot;);</span></span><br><span class="line"><span class="comment">      *         &#125;,executor);</span></span><br><span class="line"><span class="comment">      * 2、能接受上一步结果，但是无返回值 thenAcceptAsync</span></span><br><span class="line"><span class="comment">      * 3、thenApplyAsync 能收受上一步结果，有返回值</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">         <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">2</span>;</span><br><span class="line">         System.out.println(<span class="string">&quot;运行结果：&quot;</span> + i);</span><br><span class="line">         <span class="keyword">return</span> i;</span><br><span class="line">     &#125;, executor).thenApplyAsync(res -&gt; &#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;任务2启动了...&quot;</span> + res);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + res;</span><br><span class="line">     &#125;, executor);</span><br><span class="line">     String s = future.get();</span><br><span class="line"></span><br><span class="line">     System.out.println(<span class="string">&quot;main....stop.....&quot;</span> + s);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="8.2.5-%E4%B8%A4%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88---%E9%83%BD%E8%A6%81%E5%AE%8C%E6%88%90"
                                    id="8-2-5-两任务组合-都要完成">8.2.5 两任务组合 - 都要完成</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210102044028142.png"
                                        alt="image-20210102044028142" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210102044044914.png"
                                        alt="image-20210102044044914" /></p>
                                <p>两个任务必须都完成，触发该任务</p>
                                <p>thenCombine: 组合两个 future，获取两个 future的返回结果，并返回当前任务的返回值</p>
                                <p>thenAccpetBoth: 组合两个 future，获取两个 future 任务的返回结果，然后处理任务，没有返回值</p>
                                <p>runAfterBoth:组合 两个 future，不需要获取 future 的结果，只需要两个 future处理完成任务后，处理该任务，</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 两个都完成</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        CompletableFuture&lt;Integer&gt; future01 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务1当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">4</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务1结束：&quot;</span> + i);</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;String&gt; future02 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务2当前线程：&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;任务2结束：&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// f1 和 f2 执行完成后在执行这个</span></span><br><span class="line"><span class="comment">//        future01.runAfterBothAsync(future02,() -&gt; &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;任务3开始&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;,executor);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回f1 和 f2 的运行结果</span></span><br><span class="line"><span class="comment">//        future01.thenAcceptBothAsync(future02,(f1,f2) -&gt; &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;任务3开始....之前的结果:&quot; + f1 + &quot;==&gt;&quot; + f2);</span></span><br><span class="line"><span class="comment">//        &#125;,executor);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// f1 和 f2 单独定义返回结果</span></span><br><span class="line">        CompletableFuture&lt;String&gt; future = future01.thenCombineAsync(future02, (f1, f2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> f1 + <span class="string">&quot;:&quot;</span> + f2 + <span class="string">&quot;-&gt; Haha&quot;</span>;</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;main....end.....&quot;</span> + future.get());</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="8.2.6-%E4%B8%A4%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88---%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%88%90"
                                    id="8-2-6-两任务组合-一个完成">8.2.6 两任务组合 - 一个完成</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201106101904880.png"
                                        alt="image-20201106101904880" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201106101918013.png"
                                        alt="image-20201106101918013" /></p>
                                <p>当两个任务中，任意一个future 任务完成时，执行任务</p>
                                <p><strong>applyToEither</strong>;两个任务有一个执行完成，获取它的返回值，处理任务并有新的返回值</p>
                                <p><strong>acceptEither</strong>: 两个任务有一个执行完成，获取它的返回值，处理任务，没有新的返回值</p>
                                <p><strong>runAfterEither</strong>:两个任务有一个执行完成，不需要获取 future 的结果，处理任务，也没有返回值</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 两个任务，只要有一个完成，我们就执行任务</span></span><br><span class="line"><span class="comment">         * runAfterEnitherAsync：不感知结果，自己没有返回值</span></span><br><span class="line"><span class="comment">         * acceptEitherAsync：感知结果，自己没有返回值</span></span><br><span class="line"><span class="comment">         *  applyToEitherAsync：感知结果，自己有返回值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        future01.runAfterEitherAsync(future02,() -&gt;&#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;任务3开始...之前的结果:&quot;);</span></span><br><span class="line"><span class="comment">//        &#125;,executor);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        future01.acceptEitherAsync(future02,(res) -&gt; &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;任务3开始...之前的结果:&quot; + res);</span></span><br><span class="line"><span class="comment">//        &#125;,executor);</span></span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;String&gt; future = future01.applyToEitherAsync(future02, res -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;任务3开始...之前的结果：&quot;</span> + res);</span><br><span class="line">            <span class="keyword">return</span> res.toString() + <span class="string">&quot;-&gt;哈哈&quot;</span>;</span><br><span class="line">        &#125;, executor);</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="8.2.7-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88" id="8-2-7-多任务组合">8.2.7
                                    多任务组合</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201106104031315.png"
                                        alt="image-20201106104031315" /></p>
                                <p>allOf：<strong>等待所有任务完成</strong></p>
                                <p>anyOf:<strong>只要有一个任务完成</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">        CompletableFuture&lt;String&gt; futureImg = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;查询商品的图片信息&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello.jpg&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;String&gt; futureAttr = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;查询商品的属性&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;黑色+256G&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;String&gt; futureDesc = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">3</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;查询商品介绍&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;华为&quot;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待全部执行完</span></span><br><span class="line"><span class="comment">//        CompletableFuture&lt;Void&gt; allOf = CompletableFuture.allOf(futureImg, futureAttr, futureDesc);</span></span><br><span class="line"><span class="comment">//        allOf.get();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 只需要有一个执行完</span></span><br><span class="line">        CompletableFuture&lt;Object&gt; anyOf = CompletableFuture.anyOf(futureImg, futureAttr, futureDesc);</span><br><span class="line">        anyOf.get();</span><br><span class="line">        System.out.println(<span class="string">&quot;main....end.....&quot;</span> + anyOf.get());</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>都是操作 CompletableFuture 类 更多方法还请参考该类</p>
                                <h1 id="9%E3%80%81%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85">9、商品详情</h1>
                                <h3 id="9.1-%E8%AF%A6%E6%83%85%E6%95%B0%E6%8D%AE" id="9-1-详情数据">9.1 详情数据</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201229121729595.png"
                                        alt="image-20201229121729595" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201109080935340.png"
                                        alt="image-20201109080935340" /></p>
                                <p>**需求分析：**通过 <code>skuId</code> 查询出商品的相关信息，图片、标题、价格，属性对应版本等等</p>
                                <h4 id="9.1.1-%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96"
                                    id="9-1-1-返回数据模型抽取">9.1.1 返回数据模型抽取</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SkuItemVo</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、sku基本获取 pms_sku_info</span></span><br><span class="line">    SkuInfoEntity skuInfo;</span><br><span class="line">    <span class="comment">// 是否有库存</span></span><br><span class="line">    <span class="keyword">boolean</span>  hasStock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 2、sku的图片信息 pms_sku_images</span></span><br><span class="line">    List&lt;SkuImagesEntity&gt; images;</span><br><span class="line">    <span class="comment">// 3、获取spu的销售属性组</span></span><br><span class="line">    List&lt;SkuItemSalAttrVo&gt; saleAttr;</span><br><span class="line">    <span class="comment">// 4、获取spu的介绍</span></span><br><span class="line">    SpuInfoDescEntity desc;</span><br><span class="line">    <span class="comment">// 5、获取spu的规格参数信息</span></span><br><span class="line">    List&lt;SpuItemAttrGroupVo&gt; groupAttrs;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SkuItemSalAttrVo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long attrId;</span><br><span class="line">    <span class="keyword">private</span> String attrName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrValueWithSkuIdVo&gt; attrValues;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttrValueWithSkuIdVo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String attrValue;</span><br><span class="line">    <span class="keyword">private</span> String skuIds;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="9.2-%E6%9F%A5%E8%AF%A2%E8%AF%A6%E6%83%85" id="9-2-查询详情">9.2 查询详情</h3>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SkuItemVo <span class="title">item</span><span class="params">(Long skuId)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">    SkuItemVo skuItemVo = <span class="keyword">new</span> SkuItemVo();</span><br><span class="line">    <span class="comment">// 1、sku基本获取 pms_sku_info</span></span><br><span class="line">    CompletableFuture&lt;SkuInfoEntity&gt; infoFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 根据 skuid 查询出 spuInfo对象</span></span><br><span class="line">        SkuInfoEntity info = getById(skuId);</span><br><span class="line">        skuItemVo.setSkuInfo(info);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Void&gt; saleAttrFuture = infoFuture.thenAcceptAsync((res) -&gt; &#123;</span><br><span class="line">        <span class="comment">// 3、获取spu的销售属性组合</span></span><br><span class="line">        List&lt;SkuItemSalAttrVo&gt; saleAttrVos = skuSaleAttrValueService.getSaleAttrBySpuId(res.getSpuId());</span><br><span class="line">        skuItemVo.setSaleAttr(saleAttrVos);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Void&gt; descFuture = infoFuture.thenAcceptAsync(res -&gt; &#123;</span><br><span class="line">        <span class="comment">// 4、获取spu的介绍</span></span><br><span class="line">        <span class="comment">// 通过spuid查询出spu描述信息</span></span><br><span class="line">        SpuInfoDescEntity spuInfoDescEntity = spuInfoDescService.getById(res.getSpuId());</span><br><span class="line">        skuItemVo.setDesc(spuInfoDescEntity);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Void&gt; baseFuture = infoFuture.thenAcceptAsync(res -&gt; &#123;</span><br><span class="line">        <span class="comment">// 5、获取spu的规格参数信息</span></span><br><span class="line">        List&lt;SpuItemAttrGroupVo&gt; attrGroupVos = attrGroupService.getAttrGroupWithAttrBySpuId(res.getSpuId(), res.getCatalogId());</span><br><span class="line">        skuItemVo.setGroupAttrs(attrGroupVos);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Void&gt; imageFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 2、sku的图片信息 pms_sku_images</span></span><br><span class="line">        List&lt;SkuImagesEntity&gt; images = imagesService.getImagesBySkuId(skuId);</span><br><span class="line">        skuItemVo.setImages(images);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待所有任务完成</span></span><br><span class="line">    CompletableFuture.allOf(saleAttrFuture, descFuture, baseFuture, imageFuture).get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skuItemVo;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>获取spu的销售属性组合</p>
                                <figure class="highlight">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;select id=<span class="string">&quot;getSaleAttrBySpuId&quot;</span> resultMap=<span class="string">&quot;SkuItemSaleAttrVo&quot;</span>&gt;</span><br><span class="line">           SELECT</span><br><span class="line">        ssav.`attr_id` attr_id,</span><br><span class="line">        ssav.`attr_name` attr_name,</span><br><span class="line">        ssav.`attr_value` ,</span><br><span class="line">        GROUP_CONCAT(DISTINCT info.`sku_id`) sku_ids</span><br><span class="line">      FROM</span><br><span class="line">        `pms_sku_info` info</span><br><span class="line">        LEFT JOIN `pms_sku_sale_attr_value` ssav</span><br><span class="line">          ON ssav.`sku_id` = info.`sku_id`</span><br><span class="line">      WHERE info.`spu_id` = #&#123;spuId&#125;</span><br><span class="line">      GROUP BY ssav.`attr_id`,ssav.`attr_name`,ssav.`attr_value`</span><br><span class="line">  &lt;/select&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>获取spu的规格参数信息</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&lt;select id&#x3D;&quot;getAttrGroupWithAttrsBySpuId&quot;</span><br><span class="line">        resultMap&#x3D;&quot;spuItemAttrGroupVo&quot;&gt;</span><br><span class="line">    SELECT</span><br><span class="line">      pav.&#96;spu_id&#96;,</span><br><span class="line">      ag.&#96;attr_group_name&#96; ,</span><br><span class="line">      ag.&#96;attr_group_id&#96;,</span><br><span class="line">      aar.&#96;attr_id&#96;,</span><br><span class="line">      attr.&#96;attr_name&#96;,</span><br><span class="line">      pav.&#96;attr_value&#96;</span><br><span class="line">    FROM</span><br><span class="line">      &#96;pms_attr_group&#96; ag</span><br><span class="line">      LEFT JOIN &#96;pms_attr_attrgroup_relation&#96; aar</span><br><span class="line">        ON aar.&#96;attr_group_id&#96; &#x3D; ag.&#96;attr_group_id&#96;</span><br><span class="line">      LEFT JOIN &#96;pms_attr&#96; attr</span><br><span class="line">        ON attr.&#96;attr_id&#96; &#x3D; aar.&#96;attr_id&#96;</span><br><span class="line">      LEFT JOIN &#96;pms_product_attr_value&#96; pav</span><br><span class="line">        ON pav.&#96;attr_id&#96; &#x3D; attr.&#96;attr_id&#96;</span><br><span class="line">    WHERE ag.&#96;catelog_id&#96; &#x3D; #&#123;catalogId&#125;</span><br><span class="line">      AND pav.&#96;spu_id&#96; &#x3D; #&#123;spuId&#125;</span><br><span class="line">&lt;&#x2F;select&gt;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>其他都是通过对应关联的 <code>id</code> 进行查询，就上面两个查询销售属性、规格参数属性 比较难，SQL这块比较难以理解</p>
                                <h3 id="9.3-sku-%E7%BB%84%E5%90%88%E5%88%87%E6%8D%A2" id="9-3-sku-组合切换">9.3 sku 组合切换
                                </h3>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// sku 组合切换</span></span><br><span class="line">   $(<span class="string">&quot;.sku_attr_value&quot;</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">var</span> skus = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">       <span class="comment">// 1、点击的元素添加上自定义属性,为了识别我们刚在被点击的</span></span><br><span class="line">       $(<span class="built_in">this</span>).addClass(<span class="string">&quot;clicked&quot;</span>)</span><br><span class="line">       <span class="comment">// 1.1、当前被选中的属性的skus信息</span></span><br><span class="line">       <span class="keyword">var</span> curr = $(<span class="built_in">this</span>).attr(<span class="string">&quot;skus&quot;</span>).split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">       <span class="comment">// 2、添加到数组中</span></span><br><span class="line">       skus.push(curr);</span><br><span class="line">       <span class="comment">// 3、去掉同一行的所有的 checked  a-&gt;dd-&gt;dl</span></span><br><span class="line">       $(<span class="built_in">this</span>).parent().parent().find(<span class="string">&quot;.sku_attr_value&quot;</span>).removeClass(<span class="string">&quot;checked&quot;</span>)</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 4、其他项也需要添加到数组里面</span></span><br><span class="line">       $(<span class="string">&quot;a[class=&#x27;sku_attr_value checked&#x27;]&quot;</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">           skus.push($(<span class="built_in">this</span>).attr(<span class="string">&quot;skus&quot;</span>).split(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">       &#125;)</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 5、取出他们的交集 jquery 中使用 filter方法来取出他们的交集</span></span><br><span class="line">       <span class="comment">// 5.1 属性项可能有多个，内存、版本等等，所以需要遍历</span></span><br><span class="line">       <span class="keyword">var</span> filterEle = skus[<span class="number">0</span>]</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; skus.length; i++) &#123;</span><br><span class="line">           filterEle = $(filterEle).filter(skus[i])</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 6、跳转到交集页面</span></span><br><span class="line">       <span class="built_in">console</span>.log(filterEle[<span class="number">0</span>])</span><br><span class="line">       location.href = <span class="string">&quot;http://item.gulimall.com/&quot;</span> + filterEle[<span class="number">0</span>] + <span class="string">&quot;.html&quot;</span></span><br><span class="line">   &#125;)</span><br><span class="line">   $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="comment">// 默认父元素是灰色</span></span><br><span class="line">       $(<span class="string">&quot;.sku_attr_value&quot;</span>).parent().css(&#123;<span class="string">&quot;border&quot;</span>: <span class="string">&quot;solid 1px #CCC&quot;</span>&#125;);</span><br><span class="line">       <span class="comment">// 拥有checked样式表示选中当前元素</span></span><br><span class="line">       $(<span class="string">&quot;a[class=&#x27;sku_attr_value checked&#x27;]&quot;</span>).parent().css(&#123;<span class="string">&quot;border&quot;</span>: <span class="string">&quot;solid 1px red&quot;</span>&#125;);</span><br><span class="line">   &#125;) 	</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h1
                                    id="10%E3%80%81%E5%95%86%E5%93%81%E4%B8%9A%E5%8A%A1-%26-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1">
                                    10、商品业务 &amp; 认证服务</h1>
                                <h3 id="10.1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA" id="10-1-环境搭建">10.1 环境搭建</h3>
                                <ul>
                                    <li>为登录和注册创建一个服务</li>
                                    <li>讲提供的前端放到 <code>templates</code> 目录下</li>
                                </ul>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110084252039.png"
                                        alt="image-20201110084252039" /></p>
                                <h3 id="10.2-%E5%89%8D%E7%AB%AF%E9%AA%8C%E8%AF%81%E7%A0%81%E5%80%92%E8%AE%A1%E6%97%B6"
                                    id="10-2-前端验证码倒计时">10.2 前端验证码倒计时</h3>
                                <p>定义id 使用 <code>Jquery</code> 触发点击事件</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110084521166.png"
                                        alt="image-20201110084521166" /></p>
                                <p>Jquery</p>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码发送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    $(<span class="string">&quot;#sendCode&quot;</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//判断是否有该样式</span></span><br><span class="line">        <span class="keyword">if</span> ($(<span class="built_in">this</span>).hasClass(<span class="string">&quot;disabled&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 正在倒计时</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 发送验证码</span></span><br><span class="line">            $.get(<span class="string">&quot;/sms/sendCode?phone=&quot;</span> + $(<span class="string">&quot;#phoneNum&quot;</span>).val(), <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (data.code != <span class="number">0</span>) &#123;</span><br><span class="line">                    alert(data.msg)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            timeoutChangeStyle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 60秒</span></span><br><span class="line"><span class="keyword">var</span> num = <span class="number">60</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">timeoutChangeStyle</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 先添加样式，防止重复点击</span></span><br><span class="line">    $(<span class="string">&quot;#sendCode&quot;</span>).attr(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;disabled&quot;</span>)</span><br><span class="line">    <span class="comment">// 到达0秒后 重置时间，去除样式</span></span><br><span class="line">    <span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</span><br><span class="line">        $(<span class="string">&quot;#sendCode&quot;</span>).text(<span class="string">&quot;发送验证码&quot;</span>)</span><br><span class="line">        num = <span class="number">60</span>;</span><br><span class="line">        <span class="comment">// 时间到达后清除样式</span></span><br><span class="line">        $(<span class="string">&quot;#sendCode&quot;</span>).attr(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> str = num + <span class="string">&quot;s 后再次发送&quot;</span></span><br><span class="line">        $(<span class="string">&quot;#sendCode&quot;</span>).text(str);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="string">&quot;timeoutChangeStyle()&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    num--;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>对应效果</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110084733372.png"
                                        alt="image-20201110084733372" /></p>
                                <h3 id="10.3-%E6%95%B4%E5%90%88%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81"
                                    id="10-3-整合短信验证码">10.3 整合短信验证码</h3>
                                <h4 id="1%E3%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E6%88%91%E4%BB%AC%E9%80%89%E6%8B%A9%E7%9A%84%E6%98%AF%E9%98%BF%E9%87%8C%E4%BA%91%E7%9A%84%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1"
                                    id="1、短信验证我们选择的是阿里云的短信服务">1、短信验证我们选择的是阿里云的短信服务</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110084936446.png"
                                        alt="image-20201110084936446" /></p>
                                <h4 id="2%E3%80%81%E9%80%89%E6%8B%A9%E5%AF%B9%E5%BA%94%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E5%BC%80%E9%80%9A"
                                    id="2、选择对应短信服务进行开通">2、选择对应短信服务进行开通</h4>
                                <p>在云市场就能看到购买的服务</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110085141506.png"
                                        alt="image-20201110085141506" /></p>
                                <h4 id="3%E3%80%81%E9%AA%8C%E8%AF%81%E7%9F%AD%E4%BF%A1%E5%8A%9F%E8%83%BD%E6%98%AF%E5%90%A6%E8%83%BD%E5%8F%91%E9%80%81"
                                    id="3、验证短信功能是否能发送">3、验证短信功能是否能发送</h4>
                                <p>在购买短信的页面，能进行调试短信</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110085315288.png"
                                        alt="image-20201110085315288" /></p>
                                <p>输入对应手机号，appCode 具体功能不做演示</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110085348103.png"
                                        alt="image-20201110085348103" /></p>
                                <h4 id="4%E3%80%81%E4%BD%BF%E7%94%A8-java-%E6%B5%8B%E8%AF%95%E7%9F%AD%E4%BF%A1%E6%98%AF%E5%90%A6%E8%83%BD%E8%BF%9B%E8%A1%8C%E5%8F%91%E9%80%81"
                                    id="4、使用-Java-测试短信是否能进行发送">4、使用 Java 测试短信是否能进行发送</h4>
                                <p>往下拉找到对应 Java 代码</p>
                                <p><strong>注意：</strong></p>
                                <p>​ 服务商提供的<strong>接口地址</strong>，<strong>请求参数</strong>都不同，请参考服务商提供的测试代码</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   String host = <span class="string">&quot;http://dingxin.market.alicloudapi.com&quot;</span>;</span><br><span class="line">	    String path = <span class="string">&quot;/dx/sendSms&quot;</span>;</span><br><span class="line">	    String method = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">	    String appcode = <span class="string">&quot;你自己的AppCode&quot;</span>;</span><br><span class="line">	    Map&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">	    <span class="comment">//最后在header中的格式(中间是英文空格)为Authorization:APPCODE 83359fd73fe94948385f570e3c139105</span></span><br><span class="line">	    headers.put(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;APPCODE &quot;</span> + appcode);</span><br><span class="line">	    Map&lt;String, String&gt; querys = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">	    querys.put(<span class="string">&quot;mobile&quot;</span>, <span class="string">&quot;159xxxx9999&quot;</span>);</span><br><span class="line">	    querys.put(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;code:1234&quot;</span>);</span><br><span class="line">	    querys.put(<span class="string">&quot;tpl_id&quot;</span>, <span class="string">&quot;TP1711063&quot;</span>);</span><br><span class="line">	    Map&lt;String, String&gt; bodys = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">	    	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	    	* 重要提示如下:</span></span><br><span class="line"><span class="comment">	    	* HttpUtils请从</span></span><br><span class="line"><span class="comment">	    	* https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/src/main/java/com/aliyun/api/gateway/demo/util/HttpUtils.java</span></span><br><span class="line"><span class="comment">	    	* 下载</span></span><br><span class="line"><span class="comment">	    	*</span></span><br><span class="line"><span class="comment">	    	* 相应的依赖请参照</span></span><br><span class="line"><span class="comment">	    	* https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/pom.xml</span></span><br><span class="line"><span class="comment">	    	*/</span></span><br><span class="line">	    	HttpResponse response = HttpUtils.doPost(host, path, method, headers, querys, bodys);</span><br><span class="line">	    	System.out.println(response.toString());</span><br><span class="line">	    	<span class="comment">//获取response的body</span></span><br><span class="line">	    	<span class="comment">//System.out.println(EntityUtils.toString(response.getEntity()));</span></span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	    	e.printStackTrace();</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>需要导入对应工具类，参照注释就行</p>
                                <h3 id="10.4-%E9%AA%8C%E8%AF%81%E7%A0%81%E9%98%B2%E5%88%B7%E6%A0%A1%E9%AA%8C"
                                    id="10-4-验证码防刷校验">10.4 验证码防刷校验</h3>
                                <p>用户要是一直提交验证码</p>
                                <ul>
                                    <li>
                                        <p>前台：限制一分钟后提交</p>
                                    </li>
                                    <li>
                                        <p>后台：存入redis 如果有就返回</p>
                                    </li>
                                </ul>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送短信验证码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> phone 手机号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/sms/sendCode&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span> String phone)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO 1、接口防刷</span></span><br><span class="line">    <span class="comment">// 先从redis中拿取</span></span><br><span class="line">    String redisCode = redisTemplate.opsForValue().get(AuthServerConstant.SMS_CODE_CACHE_PREFIX + phone);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(redisCode)) &#123;</span><br><span class="line">        <span class="comment">// 拆分</span></span><br><span class="line">        <span class="keyword">long</span> l = Long.parseLong(redisCode.split(<span class="string">&quot;_&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">// 当前系统事件减去之前验证码存入的事件 小于60000毫秒=60秒</span></span><br><span class="line">        <span class="keyword">if</span> (System.currentTimeMillis() -l &lt; <span class="number">60000</span>) &#123;</span><br><span class="line">            <span class="comment">// 60秒内不能再发</span></span><br><span class="line">            R.error(BizCodeEnume.SMS_CODE_EXCEPTION.getCode(),BizCodeEnume.SMS_CODE_EXCEPTION.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2、验证码的再次效验</span></span><br><span class="line">    <span class="comment">// 数据存入 =》redis key-phone value - code sms:code:131xxxxx - &gt;45678</span></span><br><span class="line">    String code = UUID.randomUUID().toString().substring(<span class="number">0</span>,<span class="number">5</span>).toUpperCase();</span><br><span class="line">    <span class="comment">// 拼接验证码</span></span><br><span class="line">    String substring = code+<span class="string">&quot;_&quot;</span> + System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// redis缓存验证码 防止同一个phone在60秒内发出多次验证吗</span></span><br><span class="line">    redisTemplate.opsForValue().set(AuthServerConstant.SMS_CODE_CACHE_PREFIX+phone,substring,<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用第三方服务发送验证码</span></span><br><span class="line">    thirdPartFeignService.sendCode(phone,code);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="10.5-%E4%B8%80%E6%AD%A5%E4%B8%80%E5%9D%91%E6%B3%A8%E5%86%8C%E9%A1%B5%E7%8E%AF%E5%A2%83"
                                    id="10-5-一步一坑注册页环境">10.5 一步一坑注册页环境</h3>
                                <h4 id="1%E3%80%81%E7%BC%96%E5%86%99-vo-%E6%8E%A5%E6%94%B6%E9%A1%B5%E9%9D%A2%E6%8F%90%E4%BA%A4"
                                    id="1、编写-vo-接收页面提交">1、编写 vo 接收页面提交</h4>
                                <ul>
                                    <li>使用到了 JSR303校验</li>
                                </ul>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册数据封装Vo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRegistVo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;用户名必须提交&quot;)</span></span><br><span class="line">    <span class="meta">@Length(min = 6,max = 18,message = &quot;用户名必须是6-18位字符&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;密码必须填写&quot;)</span></span><br><span class="line">    <span class="meta">@Length(min = 6,max = 18,message = &quot;密码必须是6-18位字符&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;手机号码必须提交&quot;)</span></span><br><span class="line">    <span class="meta">@Pattern(regexp = &quot;^[1]([3-9])[0-9]&#123;9&#125;$&quot;,message = &quot;手机格式不正确&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;验证码必须填写&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2%E3%80%81%E9%A1%B5%E9%9D%A2%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E4%B8%8Evo%E4%B8%80%E8%87%B4"
                                    id="2、页面提交数据与Vo一致">2、页面提交数据与Vo一致</h4>
                                <p>设置 <code>name</code> 属性与 <code>Vo</code> 一致，方便将传递过来的数据转换成 JSON</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110100732631.png"
                                        alt="image-20201110100732631" /></p>
                                <h4 id="3%E3%80%81%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C" id="3、数据校验">3、数据校验</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * //TODO 重定向携带数据，利用session原理，将数据放在session中，</span></span><br><span class="line"><span class="comment"> * 只要跳转到下一个页面取出这个数据，session中的数据就会删掉</span></span><br><span class="line"><span class="comment"> * //TODO分布式下 session 的问题</span></span><br><span class="line"><span class="comment"> * RedirectAttributes redirectAttributes 重定向携带数据</span></span><br><span class="line"><span class="comment"> * redirectAttributes.addFlashAttribute(&quot;errors&quot;, errors); 只能取一次</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> vo 数据传输对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> result 用于验证参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> redirectAttributes 数据重定向</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/regist&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">regist</span><span class="params">(<span class="meta">@Valid</span> UserRegistVo vo, BindingResult result,</span></span></span><br><span class="line"><span class="function"><span class="params">                     RedirectAttributes redirectAttributes)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 校验是否通过</span></span><br><span class="line">    <span class="keyword">if</span> (result.hasErrors()) &#123;</span><br><span class="line">        <span class="comment">// 拿到错误信息转换成Map</span></span><br><span class="line">        Map&lt;String, String&gt; errors = result.getFieldErrors().stream().collect(Collectors.toMap(FieldError::getField, FieldError::getDefaultMessage));</span><br><span class="line">        <span class="comment">//用一次的属性</span></span><br><span class="line">        redirectAttributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>,errors);</span><br><span class="line">        <span class="comment">// 校验出错，转发到注册页</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将传递过来的验证码 与 存redis中的验证码进行比较</span></span><br><span class="line">    String code = vo.getCode();</span><br><span class="line">    String s = redisTemplate.opsForValue().get(AuthServerConstant.SMS_CODE_CACHE_PREFIX + vo.getPhone());</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(s)) &#123;</span><br><span class="line">        <span class="comment">// 验证码和redis中的一致</span></span><br><span class="line">        <span class="keyword">if</span>(code.equals(s.split(<span class="string">&quot;_&quot;</span>)[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="comment">// 删除验证码：令牌机制</span></span><br><span class="line">            redisTemplate.delete(AuthServerConstant.SMS_CODE_CACHE_PREFIX + vo.getPhone());</span><br><span class="line">            <span class="comment">// 调用远程服务，真正注册</span></span><br><span class="line">            R r = memberFeignService.regist(vo);</span><br><span class="line">            <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 远程调用注册服务成功</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Map&lt;String, String&gt; errors = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                errors.put(<span class="string">&quot;msg&quot;</span>,r.getData(<span class="keyword">new</span> TypeReference&lt;String&gt;()&#123;&#125;));</span><br><span class="line">                redirectAttributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>, errors);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map&lt;String, String&gt; errors = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            errors.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">            redirectAttributes.addFlashAttribute(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">            <span class="comment">// 校验出错，转发到注册页</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; errors = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        errors.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">        redirectAttributes.addFlashAttribute(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">        <span class="comment">// 校验出错，转发到注册页</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="4%E3%80%81%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E6%8E%A5%E6%94%B6%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF"
                                    id="4、前端页面接收错误信息">4、前端页面接收错误信息</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110101306173.png"
                                        alt="image-20201110101306173" /></p>
                                <h4 id="5%E3%80%81%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6-%26-%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C"
                                    id="5、异常机制-用户注册">5、异常机制 &amp; 用户注册</h4>
                                <ul>
                                    <li>用户注册单独抽出了一个服务</li>
                                </ul>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> registVo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/regist&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">regist</span><span class="params">(<span class="meta">@RequestBody</span> MemberRegistVo registVo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        memberService.regist(registVo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PhoneExsitException e) &#123;</span><br><span class="line">        <span class="comment">// 返回对应的异常信息</span></span><br><span class="line">       <span class="keyword">return</span> R.error(BizCodeEnume.PHONE_EXIST_EXCEPTION.getCode(),BizCodeEnume.PHONE_EXIST_EXCEPTION.getMsg());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UserNameExistException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCodeEnume.USER_EXIST_EXCEPTION.getCode(),BizCodeEnume.USER_EXIST_EXCEPTION.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">regist</span><span class="params">(MemberRegistVo registVo)</span> </span>&#123;</span><br><span class="line">    MemberDao memberDao = <span class="keyword">this</span>.baseMapper;</span><br><span class="line">    MemberEntity entity = <span class="keyword">new</span> MemberEntity();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认等级</span></span><br><span class="line">    MemberLevelEntity memberLevelEntity = memberLevelDao.getDefaultLevel();</span><br><span class="line">    entity.setLevelId(memberLevelEntity.getId());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查手机号和用户名是否唯一</span></span><br><span class="line">    checkPhoneUnique(registVo.getPhone());</span><br><span class="line">    checkUserNameUnique(registVo.getUserName());</span><br><span class="line"></span><br><span class="line">    entity.setMobile(registVo.getPhone());</span><br><span class="line">    entity.setUsername(registVo.getUserName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//密码要加密存储</span></span><br><span class="line">    BCryptPasswordEncoder passwordEncoder = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    String encode = passwordEncoder.encode(registVo.getPassword());</span><br><span class="line">    entity.setPassword(encode);</span><br><span class="line"></span><br><span class="line">    memberDao.insert(entity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPhoneUnique</span><span class="params">(String phone)</span> <span class="keyword">throws</span> PhoneExsitException </span>&#123;</span><br><span class="line">    MemberDao memberDao = <span class="keyword">this</span>.baseMapper;</span><br><span class="line">    Integer mobile = memberDao.selectCount(<span class="keyword">new</span> QueryWrapper&lt;MemberEntity&gt;().eq(<span class="string">&quot;mobile&quot;</span>, phone));</span><br><span class="line">    <span class="keyword">if</span> (mobile &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PhoneExsitException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkUserNameUnique</span><span class="params">(String username)</span> <span class="keyword">throws</span> UserNameExistException </span>&#123;</span><br><span class="line">    MemberDao memberDao = <span class="keyword">this</span>.baseMapper;</span><br><span class="line">    Integer count = memberDao.selectCount(<span class="keyword">new</span> QueryWrapper&lt;MemberEntity&gt;().eq(<span class="string">&quot;username&quot;</span>, username));</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PhoneExsitException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>此处引入一个问题</p>
                                <ul>
                                    <li>密码是直接存入数据库吗？ 这样子会导致数据的不安全，</li>
                                    <li>引出了使用 MD5进行加密，但是MD5加密后，别人任然可以暴力破解</li>
                                    <li>可以使用加盐的方式，将密码加密后，得到一串随机字符，</li>
                                    <li>随机字符和密码和进行验证相同结果返回true否则false</li>
                                </ul>
                                <p>至此注册相关结束~</p>
                                <h3 id="10.6-%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95" id="10-6-账号密码登录">
                                    10.6 账号密码登录</h3>
                                <h4 id="1%E3%80%81%E5%AE%9A%E4%B9%89-vo-%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE%E6%8F%90%E4%BA%A4"
                                    id="1、定义-Vo-接收数据提交">1、定义 Vo 接收数据提交</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLoginVo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String loginacct;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>同时需要保证前端页面提交字段与 Vo 类中一致</p>
                                <h4 id="2%E3%80%81%E5%9C%A8-member-%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%BC%96%E5%86%99%E6%8E%A5%E5%8F%A3"
                                    id="2、在-Member-服务中编写接口">2、在 Member 服务中编写接口</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MemberEntity <span class="title">login</span><span class="params">(MemberLoginVo vo)</span> </span>&#123;</span><br><span class="line">    String loginacct = vo.getLoginacct();</span><br><span class="line">    String password = vo.getPassword();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、去数据库查询 select * from  ums_member where username=? or mobile =?</span></span><br><span class="line">    MemberDao memberDao = <span class="keyword">this</span>.baseMapper;</span><br><span class="line">    MemberEntity memberEntity = memberDao.selectOne(<span class="keyword">new</span> QueryWrapper&lt;MemberEntity&gt;()</span><br><span class="line">            .eq(<span class="string">&quot;username&quot;</span>, loginacct).or().</span><br><span class="line">                    eq(<span class="string">&quot;mobile&quot;</span>, loginacct));</span><br><span class="line">    <span class="keyword">if</span> (memberDao == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 登录失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获取数据库的密码</span></span><br><span class="line">        String passwordDB = memberEntity.getPassword();</span><br><span class="line">        BCryptPasswordEncoder passwordEncoder = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        <span class="comment">// 和用户密码进行校验</span></span><br><span class="line">        <span class="keyword">boolean</span> matches = passwordEncoder.matches(password, passwordDB);</span><br><span class="line">        <span class="keyword">if</span>(matches) &#123;</span><br><span class="line">            <span class="comment">// 密码验证成功 返回对象</span></span><br><span class="line">            <span class="keyword">return</span> memberEntity;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="11.7-%E5%88%86%E5%B8%83%E5%BC%8F-session%E4%B8%8D%E5%85%B1%E4%BA%AB%E4%B8%8D%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98"
                                    id="11-7-分布式-Session不共享不同步问题">11.7 分布式 Session不共享不同步问题</h3>
                                <p>我们在auth.gulimall.com中保存session，但是网址跳转到
                                    gulimall.com中，取不出auth.gulimall.com中保存的session，这就造成了微服务下的session不同步问题</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111103637615.png"
                                        alt="image-20201111103637615" /></p>
                                <h4 id="1%E3%80%81session%E5%90%8C%E6%AD%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%8Bsession%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"
                                    id="1、Session同步解决方案-分布式下session共享问题">1、Session同步解决方案-分布式下session共享问题</h4>
                                <p>同一个服务复制多个，但是session还是只能在一个服务上保存，浏览器也是只能读取到一个服务的session</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111104758917.png"
                                        alt="image-20201111104758917" /></p>
                                <h4 id="2%E3%80%81session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3-session%E5%A4%8D%E5%88%B6"
                                    id="2、Session共享问题解决-session复制">2、Session共享问题解决-session复制</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111104851977.png"
                                        alt="image-20201111104851977" /></p>
                                <h4 id="3%E3%80%81session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8"
                                    id="3、Session共享问题解决-客户端存储">3、Session共享问题解决-客户端存储</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111104913888.png"
                                        alt="image-20201111104913888" /></p>
                                <h4 id="4%E3%80%81session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3-hash%E4%B8%80%E8%87%B4%E6%80%A7"
                                    id="4、Session共享问题解决-hash一致性">4、Session共享问题解决-hash一致性</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111105039741.png"
                                        alt="image-20201111105039741" /></p>
                                <h4 id="5%E3%80%81session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3-%E7%BB%9F%E4%B8%80%E5%AD%98%E5%82%A8"
                                    id="5、Session共享问题解决-统一存储">5、Session共享问题解决-统一存储</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111105135178.png"
                                        alt="image-20201111105135178" /></p>
                                <h3 id="11.8-springsession%E6%95%B4%E5%90%88" id="11-8-SpringSession整合">11.8
                                    SpringSession整合</h3>
                                <h4 id="1%E3%80%81%E5%AE%98%E7%BD%91%E6%96%87%E6%A1%A3-%E9%98%85%E8%AF%BB"
                                    id="1、官网文档-阅读">1、官网文档 阅读</h4>
                                <ul>
                                    <li>进入到 Spring Framework</li>
                                </ul>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111144109273.png"
                                        alt="image-20201111144109273" /></p>
                                <h5 id="2%E3%80%81%E9%80%89%E6%8B%A9spring-session%E6%96%87%E6%A1%A3"
                                    id="2、选择Spring-Session文档">2、选择Spring Session文档</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111144350506.png"
                                        alt="image-20201111144350506" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111144438592.png"
                                        alt="image-20201111144438592" /></p>
                                <h5 id="3%E3%80%81%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8spring-session"
                                    id="3、开始使用Spring-Session">3、开始使用Spring Session</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111144639786.png"
                                        alt="image-20201111144639786" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111144718176.png"
                                        alt="image-20201111144718176" /></p>
                                <h4 id="2%E3%80%81%E6%95%B4%E5%90%88springboot" id="2、整合SpringBoot">2、整合SpringBoot</h4>
                                <h5 id="1%E3%80%81%E6%B7%BB%E5%8A%A0pom.xml%E4%BE%9D%E8%B5%96" id="1、添加Pom-xml依赖">
                                    1、添加Pom.xml依赖</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111144914600.png"
                                        alt="image-20201111144914600" /></p>
                                <h5 id="2%E3%80%81application.yml-%E9%85%8D%E7%BD%AE" id="2、application-yml-配置">
                                    2、application.yml 配置</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111145601673.png"
                                        alt="image-20201111145601673" /></p>
                                <h5 id="3%E3%80%81reids%E9%85%8D%E7%BD%AE" id="3、reids配置">3、reids配置</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111150056671.png"
                                        alt="image-20201111150056671" /></p>
                                <h5 id="4%E3%80%81%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%8A%A0%E4%B8%8A-%40enableredishttpsession"
                                    id="4、启动类加上-EnableRedisHttpSession">4、启动类加上 @EnableRedisHttpSession</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@EnableRedisHttpSession</span> <span class="comment">// 整合spring session</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="3%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89-springsession-%E5%AE%8C%E6%88%90-session-%E5%AD%90%E5%9F%9F%E5%85%B1%E4%BA%AB"
                                    id="3、自定义-SpringSession-完成-Session-子域共享">3、自定义 SpringSession 完成 Session 子域共享</h4>
                                <h5 id="cookieserializer" id="CookieSerializer"><code>CookieSerializer</code></h5>
                                <p>api文档参考：<a target="_blank" rel="noopener"
                                        href="https://docs.spring.io/spring-session/docs/2.4.1/reference/html5/index.html#api-cookieserializer">https://docs.spring.io/spring-session/docs/2.4.1/reference/html5/index.html#api-cookieserializer</a>
                                </p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210101124234037.png"
                                        alt="image-20210101124234037" /></p>
                                <h5 id="%E6%8C%87%E5%AE%9Aredis%E5%BA%8F%E5%88%97%E5%8C%96" id="指定redis序列化">指定redis序列化
                                </h5>
                                <p>文档地址：</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://docs.spring.io/spring-session/docs/2.4.1/reference/html5/index.html#api-redisindexedsessionrepository-config">https://docs.spring.io/spring-session/docs/2.4.1/reference/html5/index.html#api-redisindexedsessionrepository-config</a>
                                </p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210101124513827.png"
                                        alt="image-20210101124513827" /></p>
                                <p>redis中json序列化</p>
                                <p>官网文档地址：<a target="_blank" rel="noopener"
                                        href="https://docs.spring.io/spring-session/docs/2.4.1/reference/html5/index.html#samples">https://docs.spring.io/spring-session/docs/2.4.1/reference/html5/index.html#samples</a>
                                </p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210101125216426.png"
                                        alt="image-20210101125216426" /></p>
                                <p>提供的实例：</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://github.com/spring-projects/spring-session/blob/2.4.1/spring-session-samples/spring-session-sample-boot-redis-json/src/main/java/sample/config/SessionConfig.java">https://github.com/spring-projects/spring-session/blob/2.4.1/spring-session-samples/spring-session-sample-boot-redis-json/src/main/java/sample/config/SessionConfig.java</a>
                                </p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210101125303807.png"
                                        alt="image-20210101125303807" /></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpringSession整合子域</span></span><br><span class="line"><span class="comment"> * 以及redis数据存储为json</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GulimallSessionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置cookie信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieSerializer <span class="title">CookieSerializer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultCookieSerializer cookieSerializer = <span class="keyword">new</span> DefaultCookieSerializer();</span><br><span class="line">        <span class="comment">// 设置一个域名的名字</span></span><br><span class="line">        cookieSerializer.setDomainName(<span class="string">&quot;gulimall.com&quot;</span>);</span><br><span class="line">        <span class="comment">// cookie的路径</span></span><br><span class="line">        cookieSerializer.setCookieName(<span class="string">&quot;GULIMALLSESSION&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cookieSerializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置json转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisSerializer&lt;Object&gt; <span class="title">springSessionDefaultRedisSerializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 使用jackson提供的转换器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="4%E3%80%81springsession-%E5%8E%9F%E7%90%86" id="4、SpringSession-原理">
                                    4、SpringSession 原理</h4>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 核心原理</span></span><br><span class="line"><span class="comment"> * 1、<span class="doctag">@EnableRedisHttpSession</span>导入RedisHttpSessionConfiguration配置</span></span><br><span class="line"><span class="comment"> *      1、给容器中添加了一个组件</span></span><br><span class="line"><span class="comment"> *          sessionRepository = 》》》【RedisOperationsSessionRepository】 redis 操作 session session的增删改查封装类</span></span><br><span class="line"><span class="comment"> *      2、SessionRepositoryFilter==&gt;:session存储过滤器，每个请求过来必须经过Filter</span></span><br><span class="line"><span class="comment"> *          1、创建的时候，就自动从容器中获取到了SessionRepostiory</span></span><br><span class="line"><span class="comment"> *          2、原始的request,response都被包装了 SessionRepositoryRequestWrapper、SessionRepositoryResponseWrapper</span></span><br><span class="line"><span class="comment"> *          3、以后获取session.request.getSession()</span></span><br><span class="line"><span class="comment"> *              SessionRepositoryResponseWrapper</span></span><br><span class="line"><span class="comment"> *          4、wrappedRequest.getSession() ==&gt;SessionRepository</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *          装饰者模式</span></span><br><span class="line"><span class="comment"> *          spring-redis的相关功能:</span></span><br><span class="line"><span class="comment"> *                 执行session相关操作后，redis里面存储的时间也会刷新</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>核心源码是：</p>
                                <ul>
                                    <li>
                                        <p><code>SessionRepositoryFilter</code> 类下面的 <code>doFilterInternal</code> 方法
                                        </p>
                                    </li>
                                    <li>
                                        <p>及那个 <code>request</code>、<code>response</code> 包装成
                                            <code>SessionRepositoryRequestWrapper</code></p>
                                        <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111195249024.png"
                                                alt="image-20201111195249024" /></p>
                                    </li>
                                </ul>
                                <h1
                                    id="11%E3%80%81%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E5%92%8C%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95">
                                    11、单点登录和社交登录</h1>
                                <h3 id="11.1-%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95" id="11-1-社交登录">11.1 社交登录</h3>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110124933726.png"
                                        alt="image-20201110124933726" /></p>
                                <p>QQ、微博，github等网站的用户量非常大，别的网站为了简化网站的登陆和注册逻辑，引入社交登录功能</p>
                                <p>步骤</p>
                                <p>1、用户点击 QQ按钮</p>
                                <p>2、引导跳转进 QQ 授权页</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110124945111.png"
                                        alt="image-20201110124945111" /></p>
                                <p>3、用户主动点击授权，跳回之前网页</p>
                                <h4 id="11.1.1-oauth2.0" id="11-1-1-OAuth2-0">11.1.1 OAuth2.0</h4>
                                <ul>
                                    <li>
                                        <p>**OAuth：**OAuth（开放授权）是一个开放标准，允许用户授权第三方网站访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方网站或分享他们的数据的内容
                                        </p>
                                    </li>
                                    <li>
                                        <p>**OAuth2.0：**对于用户相关的
                                            OpenAPI（例如获取用户信息，动态同步，照片，日志，分享等），为了保存用户数据的安全和隐私，第三方网站访问用户数据前都需要显示向用户授权</p>
                                    </li>
                                    <li>
                                        <p>官方版流程</p>
                                        <p><img src="/oAuth2_01.gif" alt="img" /></p>
                                    </li>
                                </ul>
                                <p>文档地址：</p>
                                <p>相关流程分析</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110154532752.png"
                                        alt="image-20201110154532752" /></p>
                                <h4 id="11.2-%E5%BE%AE%E5%8D%9A%E7%99%BB%E5%BD%95%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"
                                    id="11-2-微博登录准备工作">11.2 微博登录准备工作</h4>
                                <h5 id="1%E3%80%81%E8%BF%9B%E5%85%A5%E5%BE%AE%E5%8D%9A%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0"
                                    id="1、进入微博开放平台">1、进入微博开放平台</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110154702360.png"
                                        alt="image-20201110154702360" /></p>
                                <h5 id="2%E3%80%81%E7%99%BB%E5%BD%95%E5%BE%AE%E5%8D%9A%EF%BC%8C%E8%BF%9B%E5%85%A5%E5%BE%AE%E8%BF%9E%E6%8E%A5%EF%BC%8C%E9%80%89%E6%8B%A9%E7%BD%91%E7%AB%99%E6%8E%A5%E5%85%A5"
                                    id="2、登录微博，进入微连接，选择网站接入">2、登录微博，进入微连接，选择网站接入</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110160834589.png"
                                        alt="image-20201110160834589" /></p>
                                <h5 id="3%E3%80%81%E9%80%89%E6%8B%A9%E7%AB%8B%E5%8D%B3%E6%8E%A5%E5%85%A5" id="3、选择立即接入">
                                    3、选择立即接入</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110161001013.png"
                                        alt="image-20201110161001013" /></p>
                                <h5 id="4%E3%80%81%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%BA%94%E7%94%A8"
                                    id="4、创建自己的应用">4、创建自己的应用</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110161032203.png"
                                        alt="image-20201110161032203" /></p>
                                <h5 id="5%E3%80%81%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5"
                                    id="5、我们可以在开发阶段">5、我们可以在开发阶段</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110161152105.png"
                                        alt="image-20201110161152105" /></p>
                                <h5 id="6%E3%80%81%E8%BF%9B%E5%85%A5%E9%AB%98%E7%BA%A7%E4%BF%A1%E6%81%AF" id="6、进入高级信息">
                                    6、进入高级信息</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110161407018.png"
                                        alt="image-20201110161407018" /></p>
                                <h5 id="7%E3%80%81%E6%B7%BB%E5%8A%A0%E6%B5%8B%E8%AF%95%E8%B4%A6%E5%8F%B7" id="7、添加测试账号">
                                    7、添加测试账号</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110161451881.png"
                                        alt="image-20201110161451881" /></p>
                                <h5 id="8%E3%80%81%E8%BF%9B%E5%85%A5%E6%96%87%E6%A1%A3" id="8、进入文档">8、进入文档</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201110161634486.png"
                                        alt="image-20201110161634486" /></p>
                                <h4 id="11.3-%E5%BE%AE%E5%8D%9A%E7%99%BB%E5%BD%95%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"
                                    id="11-3-微博登录代码实现">11.3 微博登录代码实现</h4>
                                <h5 id="%E7%99%BB%E9%99%86%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B%E5%9B%BE" id="登陆注册流程图">
                                    登陆注册流程图</h5>
                                <p>看不清，放大一点</p>
                                <h5 id="%E5%BE%AE%E5%8D%9A%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"
                                    id="微博登录流程image-20201231084733753"><strong>微博登录流程</strong><img
                                        src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201231084733753.png"
                                        alt="image-20201231084733753" /></h5>
                                <h6 id="%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B" id="注册流程"><strong>注册流程</strong></h6>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201231084909415.png"
                                        alt="image-20201231084909415" /></p>
                                <h6 id="%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%EF%BC%9A"
                                    id="账号密码登录流程："><strong>账号密码登录流程：</strong></h6>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201231012134722.png"
                                        alt="image-20201231012134722" /></p>
                                <h6 id="%E6%89%8B%E6%9C%BA%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B%EF%BC%9A"
                                    id="手机验证码发送流程："><strong>手机验证码发送流程：</strong></h6>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201231012207446.png"
                                        alt="image-20201231012207446" /></p>
                                <h5 id="11.3.1-%E6%9F%A5%E7%9C%8B%E5%BE%AE%E5%8D%9A%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0%E6%96%87%E6%A1%A3"
                                    id="11-3-1-查看微博开放平台文档">11.3.1 查看微博开放平台文档</h5>
                                <p><a target="_blank" rel="noopener"
                                        href="https://open.weibo.com/wiki/%E6%8E%88%E6%9D%83%E6%9C%BA%E5%88%B6%E8%AF%B4%E6%98%8E">https://open.weibo.com/wiki/授权机制说明</a>
                                </p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111093019560.png"
                                        alt="image-20201111093019560" /></p>
                                <h5 id="11.3.2-%E7%82%B9%E5%87%BB%E5%BE%AE%E5%8D%9A%E7%99%BB%E5%BD%95%E5%90%8E%EF%BC%8C%E8%B7%B3%E8%BD%AC%E5%88%B0%E5%BE%AE%E5%8D%9A%E6%8E%88%E6%9D%83%E9%A1%B5%E9%9D%A2"
                                    id="11-3-2-点击微博登录后，跳转到微博授权页面">11.3.2 点击微博登录后，跳转到微博授权页面</h5>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201111093153199.png"
                                        alt="image-20201111093153199" /></p>
                                <h5 id="11.3.3-%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83%E5%90%8E%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%B9%B6%E5%B8%A6%E4%B8%8A%E5%8F%82%E6%95%B0code%E6%8D%A2%E5%8F%96accesstoken"
                                    id="11-3-3-用户授权后调用回调接口，并带上参数code换取AccessToken">11.3.3
                                    用户授权后调用回调接口，并带上参数code换取AccessToken</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回调接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/oauth2.0/weibo/success&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">weibo</span><span class="params">(<span class="meta">@RequestParam(&quot;code&quot;)</span> String code)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1、根据code换取accessToken</span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;client_id&quot;</span>, <span class="string">&quot;1133714539&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;client_secret&quot;</span>, <span class="string">&quot;f22eb330342e7f8797a7dbe173bd9424&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;grant_type&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;redirect_uri&quot;</span>, <span class="string">&quot;http://auth.gulimall.com/oauth2.0/weibo/success&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HttpResponse response = HttpUtils.doPost(<span class="string">&quot;https://api.weibo.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/oauth2/access_token&quot;</span>,</span><br><span class="line">                <span class="string">&quot;post&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> HashMap&lt;&gt;(),</span><br><span class="line">                map,</span><br><span class="line">                <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 状态码为200请求成功</span></span><br><span class="line">        <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span> )&#123;</span><br><span class="line">            <span class="comment">// 获取到了accessToken</span></span><br><span class="line">            String json = EntityUtils.toString(response.getEntity());</span><br><span class="line">            SocialUser socialUser = JSON.parseObject(json, SocialUser.class);</span><br><span class="line">            R r = memberFeignService.OAuthlogin(socialUser);</span><br><span class="line">            <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                MemberRespVo data = r.getData(<span class="string">&quot;data&quot;</span>, <span class="keyword">new</span> TypeReference&lt;MemberRespVo&gt;() &#123;</span><br><span class="line">                &#125;);</span><br><span class="line">                log.info(<span class="string">&quot;登录成功:用户:&#123;&#125;&quot;</span>,data.toString());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 2、登录成功跳转到首页</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:http://gulimall.com&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 注册失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 请求失败</span></span><br><span class="line">            <span class="comment">// 注册失败</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、登录成功跳转到首页</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:http://gulimall.com&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="11.3.4-%E6%8B%BF%E5%88%B0accesstoken-%E8%AF%B7%E6%B1%82%E5%AF%B9%E5%BA%94%E6%8E%A5%E5%8F%A3%E6%8B%BF%E5%88%B0%E4%BF%A1%E6%81%AF"
                                    id="11-3-4-拿到AccessToken-请求对应接口拿到信息">11.3.4 拿到AccessToken 请求对应接口拿到信息</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MemberEntity <span class="title">login</span><span class="params">(SocialUser vo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 登录和注册合并逻辑</span></span><br><span class="line">    String uid = vo.getUid();</span><br><span class="line">    MemberDao memberDao = <span class="keyword">this</span>.baseMapper;</span><br><span class="line">    <span class="comment">// 根据社交用户的uuid查询</span></span><br><span class="line">    MemberEntity memberEntity = memberDao.selectOne(<span class="keyword">new</span> QueryWrapper&lt;MemberEntity&gt;()</span><br><span class="line">            .eq(<span class="string">&quot;social_uid&quot;</span>, uid));</span><br><span class="line">    <span class="comment">// 能查询到该用户</span></span><br><span class="line">    <span class="keyword">if</span> (memberEntity != <span class="keyword">null</span> )&#123;</span><br><span class="line">        <span class="comment">// 更新对应值</span></span><br><span class="line">        MemberEntity update = <span class="keyword">new</span> MemberEntity();</span><br><span class="line">        update.setId(memberEntity.getId());</span><br><span class="line">        update.setAccessToken(vo.getAccess_token());</span><br><span class="line">        update.setExpiresIn(vo.getExpires_in());</span><br><span class="line"></span><br><span class="line">        memberDao.updateById(update);</span><br><span class="line"></span><br><span class="line">        memberEntity.setAccessToken(vo.getAccess_token());</span><br><span class="line">        memberEntity.setExpiresIn(vo.getExpires_in());</span><br><span class="line">        <span class="keyword">return</span> memberEntity;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 2、没有查询到当前社交用户对应的记录就需要注册一个</span></span><br><span class="line">        MemberEntity regist = <span class="keyword">new</span> MemberEntity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String,String&gt; query = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="comment">// 设置请求参数</span></span><br><span class="line">            query.put(<span class="string">&quot;access_token&quot;</span>,vo.getAccess_token());</span><br><span class="line">            query.put(<span class="string">&quot;uid&quot;</span>,vo.getUid());</span><br><span class="line">            <span class="comment">// 发送get请求获取社交用户信息</span></span><br><span class="line">            HttpResponse response = HttpUtils.doGet(<span class="string">&quot;https://api.weibo.com/&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;2/users/show.json&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;get&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> HashMap&lt;&gt;(),</span><br><span class="line">                    query);</span><br><span class="line">            <span class="comment">// 状态码为200 说明请求成功</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>)&#123;</span><br><span class="line">                <span class="comment">// 将返回结果转换成json</span></span><br><span class="line">                String json = EntityUtils.toString(response.getEntity());</span><br><span class="line">                <span class="comment">// 利用fastjson将请求返回的json转换为对象</span></span><br><span class="line">                JSONObject jsonObject = JSON.parseObject(json);</span><br><span class="line">                <span class="comment">// 拿到需要的值</span></span><br><span class="line">                String name = jsonObject.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                String gender = jsonObject.getString(<span class="string">&quot;gender&quot;</span>);</span><br><span class="line">                <span class="comment">//.. 拿到多个信息</span></span><br><span class="line">                regist.setNickname(name);</span><br><span class="line">                regist.setGender(<span class="string">&quot;m&quot;</span>.equals(gender) ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置社交用户相关信息</span></span><br><span class="line">        regist.setSocialUid(vo.getUid());</span><br><span class="line">        regist.setAccessToken(vo.getAccess_token());</span><br><span class="line">        regist.setExpiresIn(vo.getExpires_in());</span><br><span class="line">        memberDao.insert(regist);</span><br><span class="line">        <span class="keyword">return</span> regist;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="11.2-sso(%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95)" id="11-2-SSO-单点登录">11.2
                                    SSO(单点登录)</h3>
                                <h4 id="1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFsso" id="1、什么是SSO">1、什么是SSO</h4>
                                <p>单点登录(SingleSignOn，SSO)，就是通过用户的一次性鉴别登录。当用户在身份认证服务器上登录一次以后，即可获得访问单点登录系统中其他关联系统和应用软件的权限，同时这种实现是不需要管理员对用户的登录状态或其他信息进行修改的，这意味着在多个应用系统中，用户只需一次登录就可以访问所有相互信任的应用系统。这种方式减少了由登录产生的时间消耗，辅助了用户管理，是目前比较流行的
                                    [1]</p>
                                <h4 id="2%E3%80%81%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86" id="2、前置知识">2、前置知识</h4>
                                <p><a target="_blank" rel="noopener"
                                        href="https://gitee.com/xuxueli0323/xxl-sso">https://gitee.com/xuxueli0323/xxl-sso</a>
                                </p>
                                <h4 id="3%E3%80%81%E5%90%8C%E5%9F%9F%E4%B8%8B%E7%9A%84%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95"
                                    id="3、同域下的单点登录">3、同域下的单点登录</h4>
                                <h4 id="4%E3%80%81%E4%B8%8D%E5%90%8C%E5%9F%9F%E4%B8%8B%E7%9A%84%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95"
                                    id="4、不同域下的单点登录">4、不同域下的单点登录</h4>
                                <h4 id="5%E3%80%81%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E6%A1%86%E6%9E%B6-%26-%E5%8E%9F%E7%90%86%E6%BC%94%E7%A4%BA"
                                    id="5、单点登录框架-原理演示">5、单点登录框架 &amp; 原理演示</h4>
                                <p>XXL-SSO 是一个分布式单点登录框架。只需要登录一次就可以访问所有相互信任的应用系统。
                                    拥有&quot;轻量级、分布式、跨域、Cookie+Token均支持、Web+APP均支持&quot;等特性。现已开放源代码，开箱即用。</p>
                                <p>首先对整个项目进行：mvn clean package -Dmaven.skip.test=true</p>
                                <p>xxl-sso-server:</p>
                                <ul>
                                    <li>
                                        <p>8080/xxl-sso-server</p>
                                    </li>
                                    <li>
                                        <p>编排：</p>
                                        <ul>
                                            <li><a target="_blank" rel="noopener"
                                                    href="http://ssoserver.com">ssoserver.com</a> 登陆验证服务器</li>
                                            <li><a target="_blank" rel="noopener"
                                                    href="http://client1.com">client1.com</a> 客户端1</li>
                                            <li><a target="_blank" rel="noopener"
                                                    href="http://client2.com">client2.com</a> 客户端2</li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>先启动xxl-sso-server 然后启动client1</p>
                                <p>只要 <code>client1</code> 登录成功 <code>client2</code> 就不用进行登录直接登录成功</p>
                                <p>代码测试:</p>
                                <p>sso-client</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;sso.server.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ssoServerUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无需登录就可以访问</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要验证的连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 只要是ssoserver登陆成功回来就会带上</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/employees&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">employees</span><span class="params">(Model model, HttpSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="meta">@RequestParam(value=&quot;token&quot;,required = false)</span> String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="comment">// 去ssoserver登录成功调回来就会带上</span></span><br><span class="line">            <span class="comment">//TODO 1、去ssoserver获取当前token真正对应的用户信息</span></span><br><span class="line">            RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">            <span class="comment">// 使用restTemplate进行远程请求</span></span><br><span class="line">            ResponseEntity&lt;String&gt; forEntity = restTemplate.getForEntity(<span class="string">&quot;http://ssoserver.com:8080/userInfo?token=&quot;</span> + token, String.class);</span><br><span class="line">            <span class="comment">// 拿到数据</span></span><br><span class="line">            String body = forEntity.getBody();</span><br><span class="line">            <span class="comment">// 设置到session中</span></span><br><span class="line">            session.setAttribute(<span class="string">&quot;loginUser&quot;</span>,body);</span><br><span class="line">        &#125;</span><br><span class="line">        Object loginUser = session.getAttribute(<span class="string">&quot;loginUser&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (loginUser == <span class="keyword">null</span> )&#123;</span><br><span class="line">            <span class="comment">// 没有登录重定向到登陆页面，并带上当前地址</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span> + ssoServerUrl + <span class="string">&quot;?redirect_url=http://client1.com:8081/employees&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List&lt;String&gt; emps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            emps.add(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">            emps.add(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">            model.addAttribute(<span class="string">&quot;emps&quot;</span>,emps);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>sso-server</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据token从redis中查询用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">userInfo</span><span class="params">(<span class="meta">@RequestParam(&quot;token&quot;)</span> String token)</span> </span>&#123;</span><br><span class="line">        String s = redisTemplate.opsForValue().get(token);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;login.html&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(<span class="meta">@RequestParam(&quot;redirect_url&quot;)</span> String url, Model model,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@CookieValue(value = &quot;sso_token&quot;,required = false)</span>String sso_token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(sso_token)) &#123;</span><br><span class="line">            <span class="comment">//说明有人之前登录过，给浏览器留下了痕迹</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span> + url + <span class="string">&quot;?token=&quot;</span> + sso_token;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加url到model地址中，在前端页面进行取出</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;url&quot;</span>,url);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url client端带过来的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/doLogin&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doLogin</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="meta">@RequestParam(&quot;password&quot;)</span> String password,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="meta">@RequestParam(&quot;url&quot;)</span> String url,</span></span></span><br><span class="line"><span class="function"><span class="params">                          HttpServletResponse response)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 账号密码不为空 </span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(username) &amp;&amp; !StringUtils.isEmpty(password)) &#123;</span><br><span class="line">            <span class="comment">// 登陆成功</span></span><br><span class="line">            <span class="comment">// 把登录成功的用户存起来</span></span><br><span class="line">            String uuid = UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">            redisTemplate.opsForValue().set(uuid,username);</span><br><span class="line">            <span class="comment">// 将uuid存入cookie</span></span><br><span class="line">            Cookie token = <span class="keyword">new</span> Cookie(<span class="string">&quot;sso_token&quot;</span>,uuid);</span><br><span class="line">            response.addCookie(token);</span><br><span class="line">            <span class="comment">// 保存到cookie</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span> + url + <span class="string">&quot;?token=&quot;</span> + uuid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 登录失败，展示登录页</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="6%E3%80%81%E4%BD%BF%E7%94%A8-jwt" id="6、使用-jwt">6、使用 jwt</h4>
                                <h3 id="11.3-jwt" id="11-3-JWT">11.3 JWT</h3>
                                <h1 id="12%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6">12、购物车</h1>
                                <h3 id="12.1-%E8%B4%AD%E7%89%A9%E8%BD%A6%E9%9C%80%E6%B1%82" id="12-1-购物车需求">12.1 购物车需求
                                </h3>
                                <h4 id="1%E3%80%81%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0%EF%BC%9A" id="1、需求描述：">1、需求描述：
                                </h4>
                                <p>用户可以在<strong>登录状态</strong>下将商品添加到购物车**【登录购物车/在线购物车】**</p>
                                <p>放入数据库</p>
                                <p>mongodb</p>
                                <p><strong>放入 redis（采用）</strong></p>
                                <p>用户可以在<strong>未登录状态</strong>下将商品添加到购物车**【游客购物车/离线购物车】**</p>
                                <p>放入 localstorage</p>
                                <p>cookie</p>
                                <p>WebSQL</p>
                                <p><strong>放入 redis (采用)</strong></p>
                                <p>用户可以使用购物车一起结算下单</p>
                                <p>用户可以<strong>查询自己的购物车</strong></p>
                                <p>用户可以在<strong>购物中修改购买商品的数量</strong></p>
                                <p>用户可以在<strong>购物车中删除商品</strong></p>
                                <p><strong>选中不选中商品</strong></p>
                                <p>在购物车中<strong>展示商品优惠信息</strong></p>
                                <p>提示购物车商品价格变化</p>
                                <p>购物车数据结构</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201113110938713.png"
                                        alt="image-20201113110938713" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201115154652394.png"
                                        alt="image-20201115154652394" /></p>
                                <p>每一个购物项信息，都是一个对象，基本字段包括</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">skuId:<span class="number">123123</span>, <span class="comment">// 商品id</span></span><br><span class="line">check:<span class="keyword">true</span>, <span class="comment">// 是否选中</span></span><br><span class="line">title:<span class="string">&quot;apple phone&quot;</span>, <span class="comment">// 商品标题</span></span><br><span class="line">defaultImage:<span class="string">&#x27;&#x27;</span>, <span class="comment">// 商品默认显示的图片</span></span><br><span class="line">price:<span class="number">4999</span>, <span class="comment">// 商品价格</span></span><br><span class="line">count:<span class="number">1</span>, <span class="comment">// 商品数量</span></span><br><span class="line">totalPrice:<span class="number">4999</span> <span class="comment">// 购物车中选中商品总价格</span></span><br><span class="line">skuSaleVo:&#123;&#125; <span class="comment">// 。。。。</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>另外，购物车中不止一条数据，因此最终会是对象的数组</p>
                                <figure class="highlight plain">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">&#123;...&#125;,&#123;....&#125;,&#123;....&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Redis有5种不同数据结构，这里选择哪一种 比较合适呢? Map&lt;String, List<String>&gt;
                                        首先<strong>不同用户应该有独立的购物车</strong>。</p>
                                <p>因此购物车应该以用户的作为key来存储，<strong>Value是用户的所有购物车信息</strong>。这样看来基本的 k-v 结构就可以了。</p>
                                <p>但是，我们对购物车中的商品进行增、删、改操作，<strong>基本都需要根据商品id进行判断</strong>，为了方便后期处理，我们的购物车也应该是 k-v
                                    结构，<strong>key 是商品 id, value 才是这个商品的购物车信息。</strong></p>
                                <p>综上所述，我们的购物车结构是一一个<strong>双层Map:
                                        Map&lt;String,Map&lt;String,String&gt;&gt;</strong>，在redis中类型为 hash</p>
                                <p><strong>外头key就是用户的id,里面的key就是skuid</strong></p>
                                <p>redis中：</p>
                                <p>新增商品：hset gulimall:cart:7 <strong>(key)334488[商品skuid] (value)商品的信息</strong></p>
                                <p>增加商品数量：hincrby shopcar:uuid1024 334477 1</p>
                                <p>商品总数：hlen shopcar:uuid</p>
                                <p>全部选择：hgetall shopcar:uuid1024</p>
                                <p><img src="image-20201115155054434.png" alt="image-20201115155054434" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210102202926973.png"
                                        alt="image-20210102202926973" /></p>
                                <h3 id="12.2-vo%E7%BC%96%E5%86%99-%26-threadlocal%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"
                                    id="12-2-Vo编写-ThreadLocal身份验证">12.2 Vo编写 &amp; ThreadLocal身份验证</h3>
                                <h4 id="12.2.1-vo-%E7%BC%96%E5%86%99" id="12-2-1-Vo-编写">12.2.1 Vo 编写</h4>
                                <p>购物车</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 整个购物车</span></span><br><span class="line"><span class="comment"> * 需要计算的属性，必须重写他的get方法，保证每次获取属性都会进行计算</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cart</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;CartItem&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer countNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品类型数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer countType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品总价</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  减免价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal reduce = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCountType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (items !=<span class="keyword">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (CartItem item : items) &#123;</span><br><span class="line">                count+=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getTotalAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BigDecimal amount = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="comment">// 1、计算购物项总价</span></span><br><span class="line">        <span class="keyword">if</span> (items != <span class="keyword">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (CartItem item : items) &#123;</span><br><span class="line">                <span class="comment">// 拿到购物车中单个商品的总金额</span></span><br><span class="line">                BigDecimal totalPrice = item.getTotalPrice();</span><br><span class="line">                <span class="comment">// 添加到购物总价中</span></span><br><span class="line">                amount = amount.add(totalPrice);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2、减去优惠总价</span></span><br><span class="line">        BigDecimal subtract = amount.subtract(getReduce());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> subtract;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>购物车中的实体</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CartItem</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车中是否选中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean check = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的标题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String image;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; skuAttr;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车价格 使用自定义get、set</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalPrice;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  计算购物项价格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getTotalPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//价格乘以数量</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.price.multiply(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;&quot;</span> + <span class="keyword">this</span>.count));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="12.2.3-threadlocal-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"
                                    id="12-2-3-ThreadLocal-身份验证">12.2.3 ThreadLocal 身份验证</h4>
                                <p>需求分析：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 浏览器有一个cookie：user-key,标识用户身份，一个月后过期</span></span><br><span class="line"><span class="comment">    * 如果第一次使用jd的购物车功能，都会给一个临时的用户身份</span></span><br><span class="line"><span class="comment">    * 浏览器以后保存，每次访问都会带上这个cookie</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 登录 session 有</span></span><br><span class="line"><span class="comment">    * 没登录，按照cookie中的user-key来做</span></span><br><span class="line"><span class="comment">    * 第一次：如果没有临时用户，帮忙创建一个临时用户 --&gt; 使用拦截器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">    */</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>代码</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">**</span><br><span class="line"> * 在执行目标方法之前,判断用户的登录状态，并封装给Controller目标请求</span><br><span class="line"> * <span class="meta">@author</span> gcq</span><br><span class="line"> * <span class="meta">@Create</span> <span class="number">2020</span>-<span class="number">11</span>-<span class="number">13</span></span><br><span class="line"> */</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CartInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;UserInfo&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 目标方法执行之前</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">        <span class="comment">// 拿到session</span></span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        <span class="comment">// 查看session中是否保存了用户的值</span></span><br><span class="line">        MemberRespVo member = (MemberRespVo) session.getAttribute(AuthServerConstant.LOGIN_USER);</span><br><span class="line">        <span class="keyword">if</span> (member != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 用户登录</span></span><br><span class="line">            userInfo.setUserId(member.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="keyword">null</span> &amp;&amp; cookies.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">                String name = cookie.getName();</span><br><span class="line">                <span class="comment">// 拿到cookie名字进行判断如果包含 user-key 就复制到userInfo中</span></span><br><span class="line">                <span class="keyword">if</span> (name.equals(CartConstant.TEMP_USER_COOKIE_NAME)) &#123;</span><br><span class="line">                    userInfo.setUserKey(cookie.getValue());</span><br><span class="line">                    userInfo.setTempUser(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有临时用户一定要分配一个临时用户</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userInfo.getUserKey())) &#123;</span><br><span class="line">            String uuid = UUID.randomUUID().toString();</span><br><span class="line">            userInfo.setUserKey(uuid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 全部放行</span></span><br><span class="line">        threadLocal.set(userInfo);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务执行之后,分配临时用户，让浏览器保存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modelAndView</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到用户信息</span></span><br><span class="line">        UserInfo userInfo = threadLocal.get();</span><br><span class="line">        <span class="comment">// 如果没有临时用户一定要保存一个临时用户</span></span><br><span class="line">        <span class="keyword">if</span> (!userInfo.isTempUser()) &#123;</span><br><span class="line">            <span class="comment">// 持续的延长临时用户的过期时间</span></span><br><span class="line">            Cookie cookie = <span class="keyword">new</span> Cookie(CartConstant.TEMP_USER_COOKIE_NAME, userInfo.getUserKey());</span><br><span class="line">            cookie.setDomain(<span class="string">&quot;gulimall.com&quot;</span>);</span><br><span class="line">            cookie.setMaxAge(CartConstant.TEMP_USER_COOKIE_TIMEOUT);</span><br><span class="line">            response.addCookie(cookie);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="12.3-%E6%B7%BB%E5%8A%A0%E8%B4%AD%E7%89%A9%E8%BD%A6" id="12-3-添加购物车">12.3 添加购物车
                                </h3>
                                <p>在页面点击加入购物车后将商品添加进购物车</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201115155956396.png"
                                        alt="image-20201115155956396" /></p>
                                <p>需求分析：</p>
                                <p>首先需要在页面拿到要提交的参数，skuid，购买数量，并提交后台完成购物车数据添加</p>
                                <p>后端如何处理这个数据？</p>
                                <ol>
                                    <li><strong>通过 <code>skuid</code> 远程查询这个商品的信息</strong></li>
                                    <li><strong>远程查询sku组合的信息</strong></li>
                                    <li><strong>如果购物车中已经有该数据如何进行提交</strong>？
                                        <ol>
                                            <li><strong>如果有该数据，那么就行更改</strong>，根据 skuid 从 reids 中取出数据</li>
                                            <li>将数据转换成对象然后加上对应的数量，<strong>再次转换为json存入redis</strong></li>
                                        </ol>
                                    </li>
                                    <li><strong>前端页面频繁添加购物车如何解决？</strong>
                                        <ol>
                                            <li>请求发送过来后我们<strong>重定向到其他的页面用来显示数据</strong>，这时候用户刷新的话也是在其他页面进行刷新</li>
                                        </ol>
                                    </li>
                                </ol>
                                <figure class="highlight javascript">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 加入到购物车</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   $(<span class="string">&quot;#addToCartA&quot;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="comment">// 购买的数量</span></span><br><span class="line">       <span class="keyword">var</span> num = $(<span class="string">&quot;#numInput&quot;</span>).val();</span><br><span class="line">       <span class="comment">// skuid</span></span><br><span class="line">       <span class="keyword">var</span> skuid = $(<span class="built_in">this</span>).attr(<span class="string">&quot;skuId&quot;</span>);</span><br><span class="line">       location.href=<span class="string">&quot;http://cart.gulimall.com/addToCart?skuId=&quot;</span> + skuid + <span class="string">&quot;&amp;num=&quot;</span> + num;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">   &#125;)</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>请求发送到Controller后</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@GetMapping(&quot;/addToCart&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">addToCart</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@RequestParam(&quot;num&quot;)</span> Integer num,</span></span></span><br><span class="line"><span class="function"><span class="params">                        RedirectAttributes  res)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">    cartService.addToCart(skuId,num);</span><br><span class="line">    <span class="comment">//将数据拼接到url后面</span></span><br><span class="line">    res.addAttribute(<span class="string">&quot;skuId&quot;</span>,skuId);</span><br><span class="line">    <span class="comment">// 重定向到对应的地址</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/addToCartSuccess.html&quot;</span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给购物车里面添加商品</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> skuId 商品id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> num 数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ExecutionException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> * 如果远程查询比较慢，比如方法当中有好几个远程查询，都要好几秒以上，等整个方法返回就需要很久，这块你是怎么处理的?</span></span><br><span class="line"><span class="comment"> *  1、为了提交远程查询的效率，可以使用线程池的方式，异步进行请求</span></span><br><span class="line"><span class="comment"> *  2、要做的操作就是将所有的线程全部放到自己手写的线程池里面</span></span><br><span class="line"><span class="comment"> *  3、每一个服务都需要配置一个自己的线程池</span></span><br><span class="line"><span class="comment"> *  4、完全使用线程池来控制所有的请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addToCart</span><span class="params">(Long skuId, Integer num)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 获取到要操作的购物车</span></span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</span><br><span class="line">    <span class="comment">// 1、如果购物车中已有该商品那么需要做的就是修改商品的数量，如果没有该商品需要进行添加该商品到购物车中</span></span><br><span class="line">    String result = (String) cartOps.get(skuId.toString()); <span class="comment">// 商品id作为键，先去Redis里面查看有没有这个相同的商品</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(result)) &#123; <span class="comment">// 如果返回为空，那么说明购物车中没有这个商品，那就要执行添加</span></span><br><span class="line">        <span class="comment">// 2、添加商品到购物车</span></span><br><span class="line">        <span class="comment">// 第一个异步任务,查询当前商品信息</span></span><br><span class="line">        CartItem cartItem = <span class="keyword">new</span> CartItem(); <span class="comment">// 购物车中每一个都是一个购物项，封装购物车的内容</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; completableFutureSkuInfo = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 2.1、远程查询出当前要添加的商品信息</span></span><br><span class="line">            <span class="comment">// 添加哪个商品到购物车，先查询到这个商品的信息</span></span><br><span class="line">            R r = productFeignService.getSkuInfo(skuId);</span><br><span class="line">            <span class="comment">// 获取远程返回的数据，远程数据都封装在skuInfo中</span></span><br><span class="line">            SkuInfoVo skuInfo = r.getData(<span class="string">&quot;skuInfo&quot;</span>, <span class="keyword">new</span> TypeReference&lt;SkuInfoVo&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            cartItem.setCheck(<span class="keyword">true</span>); <span class="comment">// 添加商品到购物车，那么这个商品一定是选中的</span></span><br><span class="line">            cartItem.setSkuId(skuInfo.getSkuId()); <span class="comment">// 查询的是哪个商品的id，那么这个商品id就是哪个</span></span><br><span class="line">            cartItem.setImage(skuInfo.getSkuDefaultImg()); <span class="comment">// 当前商品的图片信息</span></span><br><span class="line">            cartItem.setPrice(skuInfo.getPrice()); <span class="comment">// 当前商品的价格</span></span><br><span class="line">            cartItem.setTitle(skuInfo.getSkuTitle()); <span class="comment">// 当前商品的标题</span></span><br><span class="line">            cartItem.setCount(num); <span class="comment">// 当前商品添加的数量</span></span><br><span class="line">        &#125;, executor);</span><br><span class="line">        <span class="comment">// 3、第二个异步任务，远程查询sku组合信息</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; completableFutureSkuAttr = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; skuSaleAttrValues = productFeignService.getSkuSaleAttrValues(skuId); <span class="comment">// 根据skuid来查</span></span><br><span class="line">            cartItem.setSkuAttr(skuSaleAttrValues); <span class="comment">// 远程查询出来到sku组合信息，需要在购物车中进行显示</span></span><br><span class="line">        &#125;, executor);</span><br><span class="line">        <span class="comment">// 4、两个异步任务都完成，才能把数据放到redis中</span></span><br><span class="line">        CompletableFuture.allOf(completableFutureSkuInfo,completableFutureSkuAttr).get();</span><br><span class="line">        <span class="comment">// 把购物项的数据保存redis中</span></span><br><span class="line">        String cartItemJson = JSON.toJSONString(cartItem);</span><br><span class="line">        cartOps.put(skuId.toString(),cartItemJson); <span class="comment">// 添加商品到购物车中</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果购物车中有这个商品，那么需要做的就是将商品的数量进行更改,也即是新添加的商品数量加上当前购物车中商品数量</span></span><br><span class="line">        CartItem cartItem = JSON.parseObject(result, CartItem.class);</span><br><span class="line">        cartItem.setCount(cartItem.getCount() + num);</span><br><span class="line">        String cartItemJson = JSON.toJSONString(cartItem);</span><br><span class="line">        <span class="comment">// 更新redis</span></span><br><span class="line">        cartOps.put(skuId.toString(),cartItemJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>解决刷新问题</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跳转到成功页面</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> skuId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/addToCartSuccess.html&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">addToCartSuccessPage</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId,Model model)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重定向到成功页面，再次查询购物车数据</span></span><br><span class="line">    CartItem item = cartService.getCartItem(skuId);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;item&quot;</span>,item);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="12.4-%E8%8E%B7%E5%8F%96%E5%90%88%E5%B9%B6%E8%B4%AD%E7%89%A9%E8%BD%A6"
                                    id="12-4-获取合并购物车">12.4 获取合并购物车</h3>
                                <h4 id="12.4.1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" id="12-4-1-需求分析">12.4.1 需求分析</h4>
                                <ol>
                                    <li><strong>如果用户登录，临时购物车的数据如何显示</strong>？
                                        <ol>
                                            <li>将临时购物车的数据合并到用户购物车中</li>
                                        </ol>
                                    </li>
                                    <li><strong>如何显示购物车的数据？</strong>
                                        <ol>
                                            <li>从 redis 取出数据放到对象中并渲染出来</li>
                                        </ol>
                                    </li>
                                </ol>
                                <h4 id="12.4.2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99" id="12-4-2-代码编写">12.4.2 代码编写</h4>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@GetMapping(&quot;/cart.html&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">cartListPage</span><span class="params">(Model model)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">    Cart cart = cartService.getCart();</span><br><span class="line">    model.addAttribute(<span class="string">&quot;cart&quot;</span>,cart);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cartList&quot;</span>;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <p>拼装 <code>Key</code> 从 <code>redis</code> 中查询数据</p>
                                <p>临时购物车如果有数据，当前状态是登录，那就将临时购物车的数据合并到当前用户的购物车</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Cart <span class="title">getCart</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 需求分析1</span></span><br><span class="line"><span class="comment">       *   1、如果用户登录后，那么临时购物车的数据如何处理？</span></span><br><span class="line"><span class="comment">       *      将临时购物车的数据，放到用户购物车中进行合并</span></span><br><span class="line"><span class="comment">       *   2、如何显示购物车中的数据？</span></span><br><span class="line"><span class="comment">       *      从redis中查询到数据放到对象中，返回到页面进行渲染</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      Cart cart = <span class="keyword">new</span> Cart();</span><br><span class="line">      <span class="comment">// 1、购物车的获取操作，分为登录后购物车 和 没登录购物车</span></span><br><span class="line">      UserInfo userInfo = CartIntercept.threadLocal.get(); <span class="comment">// 拿到共享数据</span></span><br><span class="line">      <span class="keyword">if</span> (userInfo.getUserId() != <span class="keyword">null</span>) &#123; <span class="comment">// 登录后的购物车</span></span><br><span class="line">          String cartKey = CART_PREFIX + userInfo.getUserKey();</span><br><span class="line">          String tempCartKey = CART_PREFIX + userInfo.getUserKey();</span><br><span class="line">          <span class="comment">// 如果临时购物车中还有数据，那就需要将临时购物车合并到已登录购物车里面</span></span><br><span class="line">          <span class="comment">// 判断临时购物车中是否有数据</span></span><br><span class="line">          List&lt;CartItem&gt; cartItems = getCartItems(tempCartKey);</span><br><span class="line">          <span class="keyword">if</span> (cartItems != <span class="keyword">null</span> ) &#123; <span class="comment">// 临时购物车中有数据，需要将临时购物车的数据合并到登录后的购物车</span></span><br><span class="line">              <span class="keyword">for</span> (CartItem item : cartItems) &#123; <span class="comment">// 拿到临时购物车的所有数据，将他添加到已登录购物车里面来</span></span><br><span class="line">                  <span class="comment">// 调用addToCart()这个方法，他会根据登录状态进行添加，当前是登录状态</span></span><br><span class="line">                  <span class="comment">// 所以这个方法会将临时购物车的数据添加到已登录购物车中</span></span><br><span class="line">                  addToCart(item.getSkuId(),item.getCount()); <span class="comment">// 合并临时和登录后的购物车</span></span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// 合并完成后还需要将临时购物车中的数据删除</span></span><br><span class="line">              clearCart(tempCartKey);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 再次获取用户登录后的购物车【包含临时购物车数据和已登录购物车数据】</span></span><br><span class="line">          List&lt;CartItem&gt; cartItemList = getCartItems(cartKey);</span><br><span class="line">          cart.setItems(cartItemList);<span class="comment">// 将多个购物项设置到购物车中</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 没有登录的购物车，拿到没有登录购物车的数据</span></span><br><span class="line">          String cartKey = CART_PREFIX + userInfo.getUserKey();</span><br><span class="line">          <span class="comment">// 获取购物车中的所有购物项</span></span><br><span class="line">          List&lt;CartItem&gt; cartItems = getCartItems(cartKey);</span><br><span class="line">          cart.setItems(cartItems);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> cart;</span><br><span class="line">  &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>getCaerItems</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定用户 (登录用户/临时用户) 购物车里面的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cartKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;CartItem&gt; <span class="title">getCartItems</span><span class="params">(String cartKey)</span> </span>&#123;</span><br><span class="line">        BoundHashOperations&lt;String, Object, Object&gt; operations = redisTemplate.boundHashOps(cartKey);</span><br><span class="line">        List&lt;Object&gt; values = operations.values(); <span class="comment">// 拿到多个购物项</span></span><br><span class="line">        <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">            List&lt;CartItem&gt; cartItemList = values.stream().map((obj) -&gt; &#123;</span><br><span class="line">                String s = (String) obj;</span><br><span class="line">                CartItem cartItem = JSON.parseObject(s, CartItem.class);</span><br><span class="line">                <span class="keyword">return</span> cartItem;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> cartItemList;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="12.5-%E9%80%89%E4%B8%AD%E8%B4%AD%E7%89%A9%E9%A1%B9-%26-%E6%94%B9%E5%8F%98%E8%B4%AD%E7%89%A9%E9%A1%B9%E7%9A%84%E6%95%B0%E9%87%8F-%26-%E5%88%A0%E9%99%A4%E8%B4%AD%E7%89%A9%E9%A1%B9"
                                    id="12-5-选中购物项-改变购物项的数量-删除购物项">12.5 选中购物项 &amp; 改变购物项的数量 &amp; 删除购物项</h3>
                                <h4 id="12.5.1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%EF%BC%9A" id="12-5-1-需求分析：">12.5.1
                                    需求分析：</h4>
                                <h5 id="1%E3%80%81%E9%80%89%E4%B8%AD%E8%B4%AD%E7%89%A9%E9%A1%B9" id="1、选中购物项">1、选中购物项
                                </h5>
                                <ol>
                                    <li>在页面中选中购物项后，数据应该要和redis中的数据进行同步</li>
                                    <li>页面选中，reids中数据就要更改</li>
                                </ol>
                                <h5 id="2%E3%80%81%E6%94%B9%E5%8F%98%E8%B4%AD%E7%89%A9%E9%A1%B9%E6%95%B0%E9%87%8F"
                                    id="2、改变购物项数量">2、改变购物项数量</h5>
                                <ol>
                                    <li>购物车中，增加了商品的数量，对应的价格，总价也需要进行改变</li>
                                </ol>
                                <h5 id="3%E3%80%81%E5%88%A0%E9%99%A4%E8%B4%AD%E7%89%A9%E9%A1%B9" id="3、删除购物项">3、删除购物项
                                </h5>
                                <ol>
                                    <li>在购物项中删除该条数据，从redis中根据skuid删除这条记录</li>
                                </ol>
                                <h5 id="4%E3%80%81%E5%B0%86%E6%95%B0%E6%8D%AE%E4%BF%AE%E6%94%B9%E6%88%96%E5%88%A0%E9%99%A4%E5%90%8E%EF%BC%8C%E9%87%8D%E6%96%B0%E8%B7%B3%E8%BD%AC%E5%88%B0cart.html-%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE"
                                    id="4、将数据修改或删除后，重新跳转到cart-html-重新加载数据">4、将数据修改或删除后，重新跳转到cart.html 重新加载数据</h5>
                                <h4 id="12.5.2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" id="12-5-2-代码实现">12.5.2 代码实现</h4>
                                <p>前端页面方法</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">// 选中购物项</span></span><br><span class="line">    $(<span class="string">&quot;.itemCheck&quot;</span>).click(function () &#123;</span><br><span class="line">        <span class="keyword">var</span> skuId = $(<span class="keyword">this</span>).attr(<span class="string">&quot;skuId&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> check = $(<span class="keyword">this</span>).prop(<span class="string">&quot;checked&quot;</span>);</span><br><span class="line">        location.href = <span class="string">&quot;http://cart.gulimall.com/checkItem?skuId=&quot;</span> + skuId + <span class="string">&quot;&amp;check=&quot;</span> + (check?<span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 改变购物项数量</span></span><br><span class="line">    $(<span class="string">&quot;.countOpsBtn&quot;</span>).click(function() &#123;</span><br><span class="line">        <span class="keyword">var</span> skuId = $(<span class="keyword">this</span>).parent().attr(<span class="string">&quot;skuId&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> num = $(<span class="keyword">this</span>).parent().find(<span class="string">&quot;.countOpsNum&quot;</span>).text();</span><br><span class="line">        location.href = <span class="string">&quot;http://cart.gulimall.com/countItem?skuId=&quot;</span> + skuId + <span class="string">&quot;&amp;num=&quot;</span> + num;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> deleteId = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 删除购物项</span></span><br><span class="line">    <span class="function">function <span class="title">deleteItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        location.href = <span class="string">&quot;http://cart.gulimall.com/deleteItem?skuId=&quot;</span> + deleteId;</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">&quot;.deleteItemBtn&quot;</span>).click(function() &#123;</span><br><span class="line">        deleteId = $(<span class="keyword">this</span>).attr(<span class="string">&quot;skuId&quot;</span>);</span><br><span class="line">    &#125;)</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Controller</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @需求描述: 系统管理员 购物车组 模块 用户选中购物项更新redis中对象</span></span><br><span class="line"><span class="comment">   * @创建人: </span></span><br><span class="line"><span class="comment">   * @创建时间: 2021/01/04 15:37</span></span><br><span class="line"><span class="comment">   * @修改需求:</span></span><br><span class="line"><span class="comment">   * @修改人:</span></span><br><span class="line"><span class="comment">   * @修改时间:</span></span><br><span class="line"><span class="comment">   * @需求思路:</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/checkItem&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">checkItem</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="meta">@RequestParam(&quot;checked&quot;)</span> Integer checked)</span> </span>&#123;</span><br><span class="line">       cartService.checkItem(skuId,checked);</span><br><span class="line">       <span class="comment">// 重定向到购物车页面，重新获取购物车数据</span></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @需求描述: 系统管理员 购物车组 模块 用户更改购物车中购物项的数量</span></span><br><span class="line"><span class="comment">   * @创建人: </span></span><br><span class="line"><span class="comment">   * @创建时间: 2021/01/04 16:05</span></span><br><span class="line"><span class="comment">   * @修改需求:</span></span><br><span class="line"><span class="comment">   * @修改人:</span></span><br><span class="line"><span class="comment">   * @修改时间:</span></span><br><span class="line"><span class="comment">   * @需求思路:</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/updateItem&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">updateItem</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="meta">@RequestParam(&quot;count&quot;)</span> Integer count)</span> </span>&#123;</span><br><span class="line">       cartService.updateItem(skuId,count);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @需求描述: 系统管理员 购物车服务 模块 用户删除购物车中的购物项</span></span><br><span class="line"><span class="comment">   * @创建人: </span></span><br><span class="line"><span class="comment">   * @创建时间: 2021/01/04 16:40</span></span><br><span class="line"><span class="comment">   * @修改需求:</span></span><br><span class="line"><span class="comment">   * @修改人:</span></span><br><span class="line"><span class="comment">   * @修改时间:</span></span><br><span class="line"><span class="comment">   * @需求思路:</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/deleteItem&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">deleteItem</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId)</span> </span>&#123;</span><br><span class="line">       cartService.deleteItem(skuId);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkItem</span><span class="params">(Long skuId, Integer checked)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1、从redis中查出购物项设置购物项是否选中。</span></span><br><span class="line">        BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</span><br><span class="line">        String cart = (String) cartOps.get(skuId.toString());</span><br><span class="line">        CartItem cartItem = JSON.parseObject(cart, CartItem.class);</span><br><span class="line">        cartItem.setCheck(checked == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>);</span><br><span class="line">        String jsonStirng = JSON.toJSONString(cartItem);</span><br><span class="line">        cartOps.put(skuId.toString(),jsonStirng); <span class="comment">// 更新redis</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateItem</span><span class="params">(Long skuId, Integer count)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1、用户在页面对某个购物项增加或减少购物项的数量，那么redis中应该也要进行更新</span></span><br><span class="line">        CartItem cartItem = getCartItem(skuId);</span><br><span class="line">        cartItem.setCount(count);</span><br><span class="line">        BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</span><br><span class="line">        cartOps.put(skuId.toString(),JSON.toJSONString(cartItem)); <span class="comment">// 更新redis中数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteItem</span><span class="params">(Long skuId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取到当前购物车，然后根据id删除购物车里面的购物项</span></span><br><span class="line">        BoundHashOperations&lt;String, Object, Object&gt; cartOps = getCartOps();</span><br><span class="line">        cartOps.delete(skuId.toString());</span><br><span class="line">    &#125;	</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h1 id="13%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97---mq">13、消息队列 - MQ</h1>
                                <h3 id="13.1-rabbitmq" id="13-1-RabbitMQ">13.1 RabbitMQ</h3>
                                <h4 id="%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86" id="异步处理">异步处理</h4>
                                <p>消息发送的时间取决于业务执行的最长的时间</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210104205412477.png"
                                        alt="image-20210104205412477" /></p>
                                <h4 id="%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6" id="应用解耦">应用解耦</h4>
                                <p>原本是需要<strong>订单系统</strong>直接调用<strong>库存系统</strong></p>
                                <p>只需要将请求发送给消息队列，其他的就不需要去处理了，节省了处理业务逻辑的时间</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210104210738678.png"
                                        alt="image-20210104210738678" /></p>
                                <h4 id="%E6%B5%81%E9%87%8F%E6%B6%88%E5%B3%B0" id="流量消峰">流量消峰</h4>
                                <p>某一时刻如果请求特别的大，那就先把它放入消息队列，从而达到流量消峰的作用</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210104210725093.png"
                                        alt="image-20210104210725093" /></p>
                                <p>流程图地址：<a target="_blank" rel="noopener"
                                        href="https://www.processon.com/view/link/5fbda8c35653bb1d54f7077b">https://www.processon.com/view/link/5fbda8c35653bb1d54f7077b</a>
                                </p>
                                <h3 id="13.2-%E6%A6%82%E8%BF%B0" id="13-2-概述">13.2 概述</h3>
                                <ol>
                                    <li>大多应用中，可通过消息服务中间件来提升系统异步通信，扩展解耦能力</li>
                                    <li>消息服务中两个重要概念：
                                        <ol>
                                            <li><strong>消息代理（message broker）</strong> 和
                                                <strong>目的地（destination）</strong></li>
                                        </ol>
                                    </li>
                                    <li>当消息发送者发送消息后，将由消息代理接管，消息代理保证消息传递到指定目的地</li>
                                    <li>消息队列主要有两种形式的目的地
                                        <ol>
                                            <li><strong>队列（Queue）</strong>:点对点消息通信（point - to - point）</li>
                                            <li><strong>主题（topic）</strong>：发布（publish）/订阅（subscribe）消息通信</li>
                                        </ol>
                                    </li>
                                    <li>点对点式：
                                        <ol>
                                            <li>消息发送者发送消息，消息代理将其放入一个队列中，消息接收者从队列中获取消息内容，消息读取后被移出队列</li>
                                            <li>消息只有唯一的发送者和接受者，单并不是说只能有一个接收者</li>
                                        </ol>
                                    </li>
                                    <li>发布订阅式:
                                        <ol>
                                            <li>发送者（发布者）发到消息到主题，多个接收者（订阅者）监听（订阅）这个主题，那么就会在消息到达时同时收到消息</li>
                                        </ol>
                                    </li>
                                    <li><strong>JMS（Java Message Service） Java消息服务：</strong>
                                        <ol>
                                            <li>基于JVM消息代理的规范，ActiveMQ、HornetMQ是JMS的实现</li>
                                        </ol>
                                    </li>
                                    <li>AMQP（Advanced Message Queuing Protocol）
                                        <ol>
                                            <li>高级消息队列协议，也是一个消息代理的规范，兼容JMS</li>
                                            <li>RabbitMQ是AMQP的实现</li>
                                        </ol>
                                    </li>
                                    <li>Spring 支持
                                        <ol>
                                            <li>spring - jms提供了对JMS的支持</li>
                                            <li>spring - rabbit提供了对AMQP的支持</li>
                                            <li>需要ConnectionFactory的实现来连接消息代理</li>
                                            <li>提供 <strong>JmsTemplate</strong>、<strong>RabbitTemplate</strong> 来发送消息
                                            </li>
                                            <li>@JmsListener（JMS）、@RabbitListener（AMQP）注解在方法上监听消息代理发布的消息</li>
                                            <li>@EnableJms、@EnableRabbit开启支持</li>
                                        </ol>
                                    </li>
                                    <li>Spring Boot 自动配置
                                        <ol>
                                            <li>JmsAutoConfiguration</li>
                                            <li>RabbitAutoConfiguration</li>
                                        </ol>
                                    </li>
                                    <li>市面上的MQ产品
                                        <ol>
                                            <li>ActiveMQ、RabbitMQ、RocketMQ，kafka</li>
                                        </ol>
                                    </li>
                                </ol>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116091205853.png"
                                        alt="image-20201116091205853" /></p>
                                <h3 id="13.3-rabbitmq%E6%A6%82%E5%BF%B5" id="13-3-RabbitMQ概念">13.3 RabbitMQ概念</h3>
                                <p>RabbitMQ简介：</p>
                                <p>RabbitMQ是一由erlang开发的AMQP（Advanved Message Queue Protocol）的开源实现</p>
                                <p>核心概念</p>
                                <p><strong>Message</strong></p>
                                <p>消息，消息是不具名的，它是由消息头和消息体组成，消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括 <strong>routing - key
                                        （路由键）</strong>，<strong>priority（相对于其他消息的优先权）</strong>，**delivery -
                                    mode（指出该消息可能需要持久性存储）**等</p>
                                <p><strong>Publisher</strong></p>
                                <p>消息的生产者，也是一个像交换器发布消息的客户端应用程序</p>
                                <p><strong>Exchange</strong></p>
                                <p>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列</p>
                                <p>Exchange有4种类型：<strong>direct(默认)</strong>、<strong>fanout</strong>、<strong>topic</strong>，和<strong>heades</strong>，不同类型的
                                    <strong>Exchange</strong> 转发消息的策略有所区别</p>
                                <p><strong>Queue</strong></p>
                                <p>消息队列，用来保存消息直到发送给<strong>消费者</strong>，<strong>他是消息的容器</strong>，也是消息的重点，一个消息可以投入一个或多个队列，消息一直在队列里面，等待消费者连接到这个队列将其取走
                                </p>
                                <p><strong>Binding</strong></p>
                                <p>绑定，<strong>用于消息队列和交换器之间的关联</strong>，一个绑定就是基于路由键将交换器和消息队列连接起来的规则，所有可以将交换器理解成一个由绑定构成的路由表
                                </p>
                                <p><strong>Connection</strong></p>
                                <p>网路连接，比如一个TCP连接</p>
                                <p><strong>Channel</strong></p>
                                <p>信道，多路复用连接中的一个独立的双向数据流通道，信道是建立在真实的TCP连接的内的虚拟连接，AMQP
                                    命令都是通过信息到发送出去的，不管是发布消息，订阅队列还是接收消息，这些动作都是通过队列完成，因为对应操作系统来说建立和销毁 TCP
                                    都是非常昂贵的开销，所以引入了信道的概念，以复用一条TCP连接</p>
                                <p><strong>Consumer</strong></p>
                                <p>消息的消费者，表示一个消息队列中取得消息的客户端应用程序</p>
                                <p><strong>Virtual Host</strong></p>
                                <p>虚拟主机，表示交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个Virtual host本质上就是一个 mini 版的RabbitMQ
                                    服务器,拥有自己的队列、交换器、绑定和权限机制。Virtual host 是 AMQP 概念的基础，必须在连接时指定,RabbitMQ默认的vhost是/。</p>
                                <p><strong>Broker</strong></p>
                                <p>表示消息队列服务器实体</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116100431093.png"
                                        alt="image-20201116100431093" /></p>
                                <h3 id="13.4-docker-%E5%AE%89%E8%A3%85rabbitmq" id="13-4-Docker-安装RabbitMQ">13.4 Docker
                                    安装RabbitMQ</h3>
                                <figure class="highlight shell">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:management</span><br><span class="line"></span><br><span class="line">4369, 25672 (Erlang发现&amp;集群端口)</span><br><span class="line">5672, 5671 (AMQP端口)</span><br><span class="line">15672 (web管理后台端口)</span><br><span class="line">61613, 61614 (STOMP协议端口)</span><br><span class="line">1883, 8883 (MQTT协议端口)</span><br><span class="line"><span class="meta"> #</span><span class="bash"> 自动启动</span></span><br><span class="line">docker update rabbitmq --restart=always</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116102734767.png"
                                        alt="image-20201116102734767" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116103446291.png"
                                        alt="image-20201116103446291" /></p>
                                <h3 id="13.5-rabbitmq-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6" id="13-5-RabbitMQ-运行机制">13.5
                                    RabbitMQ 运行机制</h3>
                                <p>AMQP 中的消息路由</p>
                                <p>AMQP 中消息的路由过程和 Java 开发者熟悉的 JMS 存在一些差别，AMQP中增加了 <strong>Exchange</strong> 和
                                    <strong>Binding</strong> 的角色 生产者把消息发布到 Exchange 上，消息最终到达队列并被消费者接收，而 Binding
                                    决定交换器的消息应该发送给那个队列</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116104235856.png"
                                        alt="image-20201116104235856" /></p>
                                <p><strong>Exchange 类型</strong></p>
                                <p>Exchange 分发消息时根据类型的不同分发策略有区别，目前共四种类型：direct、tanout、topic、headers header匹配AMQP消息的
                                    header 而不是路由键，headers 交换器和 direct 交换器完全一致，但性能差能多，目前几乎用不到了，所以直接看另外三种类型</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116104546717.png"
                                        alt="image-20201116104546717" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116104918897.png"
                                        alt="image-20201116104918897" /></p>
                                <h3 id="13.6-rabbitmq-%E6%95%B4%E5%90%88" id="13-6-RabbitMQ-整合">13.6 RabbitMQ 整合</h3>
                                <h4 id="1%E3%80%81%E5%BC%95%E5%85%A5-spring-boot-starter-amqp"
                                    id="1、引入-Spring-boot-starter-amqp">1、引入 Spring-boot-starter-amqp</h4>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2%E3%80%81application.yml%E9%85%8D%E7%BD%AE" id="2、application-yml配置">
                                    2、application.yml配置</h4>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="3%E3%80%81%E6%B5%8B%E8%AF%95rabbitmq" id="3、测试RabbitMQ">3、测试RabbitMQ</h4>
                                <h5 id="1%E3%80%81amqpadmin%3A%E7%AE%A1%E7%90%86%E7%BB%84%E4%BB%B6"
                                    id="1、AmqpAdmin-管理组件">1、AmqpAdmin:管理组件</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建Exchange</span></span><br><span class="line"><span class="comment">     * 1、如何利用Exchange,Queue,Binding</span></span><br><span class="line"><span class="comment">     *      1、使用AmqpAdmin进行创建</span></span><br><span class="line"><span class="comment">     * 2、如何收发信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//	public DirectExchange(</span></span><br><span class="line">        <span class="comment">//	String name, 交换机的名字</span></span><br><span class="line">        <span class="comment">//	boolean durable, 是否持久</span></span><br><span class="line">        <span class="comment">//	boolean autoDelete, 是否自动删除</span></span><br><span class="line">        <span class="comment">//	Map&lt;String, Object&gt; arguments)</span></span><br><span class="line">        <span class="comment">//	&#123;</span></span><br><span class="line">        DirectExchange directExchange = <span class="keyword">new</span> DirectExchange(<span class="string">&quot;hello-java.exchange&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</span><br><span class="line">        amqpAdmin.declareExchange(directExchange);</span><br><span class="line">        log.info(<span class="string">&quot;Exchange[&#123;&#125;]创建成功：&quot;</span>,<span class="string">&quot;hello-java.exchange&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// public Queue(String name, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments) &#123;</span></span><br><span class="line">        Queue queue = <span class="keyword">new</span> Queue(<span class="string">&quot;hello-java-queue&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>);</span><br><span class="line">        amqpAdmin.declareQueue(queue);</span><br><span class="line">        log.info(<span class="string">&quot;Queue[&#123;&#125;]:&quot;</span>,<span class="string">&quot;创建成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createBinding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// public Binding(String destination, 目的地</span></span><br><span class="line">        <span class="comment">// DestinationType destinationType, 目的地类型</span></span><br><span class="line">        <span class="comment">// String exchange,交换机</span></span><br><span class="line">        <span class="comment">// String routingKey,//路由键</span></span><br><span class="line">        Binding binding = <span class="keyword">new</span> Binding(<span class="string">&quot;hello-java-queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;hello-java.exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;hello.java&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        amqpAdmin.declareBinding(binding);</span><br><span class="line">        log.info(<span class="string">&quot;Binding[&#123;&#125;]创建成功&quot;</span>,<span class="string">&quot;hello-java-binding&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="2%E3%80%81rabbittemplate%EF%BC%9A%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E5%A4%84%E7%90%86%E7%BB%84%E4%BB%B6"
                                    id="2、RabbitTemplate：消息发送处理组件">2、RabbitTemplate：消息发送处理组件</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;=<span class="number">5</span>; i++) &#123;</span><br><span class="line">           <span class="keyword">if</span>(i%<span class="number">2</span>==<span class="number">0</span>) &#123;</span><br><span class="line">               OrderReturnReasonEntity reasonEntity = <span class="keyword">new</span> OrderReturnReasonEntity();</span><br><span class="line">               reasonEntity.setId(<span class="number">1l</span>);</span><br><span class="line">               reasonEntity.setCreateTime(<span class="keyword">new</span> java.util.Date());</span><br><span class="line">               reasonEntity.setName(<span class="string">&quot;哈哈&quot;</span>);</span><br><span class="line">               <span class="comment">//</span></span><br><span class="line">               String msg = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">               <span class="comment">// 发送的对象类型的消息，可以是一个json</span></span><br><span class="line">               rabbitTemplate.convertAndSend(<span class="string">&quot;hello-java.exchange&quot;</span>,<span class="string">&quot;hello.java&quot;</span>,reasonEntity);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               OrderEntity orderEntity = <span class="keyword">new</span> OrderEntity();</span><br><span class="line">               orderEntity.setOrderSn(UUID.randomUUID().toString());</span><br><span class="line">               rabbitTemplate.convertAndSend(<span class="string">&quot;hello-java.exchange&quot;</span>,<span class="string">&quot;hello.java&quot;</span>,orderEntity);</span><br><span class="line">           &#125;</span><br><span class="line">           log.info(<span class="string">&quot;消息发送完成&#123;&#125;&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="13.7-rabbitmq%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6---%E5%8F%AF%E9%9D%A0%E5%88%B0%E8%BE%BE"
                                    id="13-7-RabbitMQ消息确认机制-可靠到达">13.7 RabbitMQ消息确认机制 - 可靠到达</h3>
                                <ul>
                                    <li>保证消息不丢失，可靠抵达，可以使用事务消息，性能下降250倍，为此引入确认机制</li>
                                    <li><strong>publisher</strong> confirmCallback 确认模式</li>
                                    <li><strong>publisher</strong> returnCallback 未投递到 queue 退回</li>
                                    <li><strong>consumer</strong> ack 机制</li>
                                </ul>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201116163631107.png"
                                        alt="image-20201116163631107" /></p>
                                <h4 id="%E5%8F%AF%E9%9D%A0%E6%8A%B5%E8%BE%BE---confirmcallback"
                                    id="可靠抵达-ConfirmCallback">可靠抵达 - ConfirmCallback</h4>
                                <p>spring.rabbitmq.publisher-confirms=true</p>
                                <p>在创建 <code>connectionFactory</code> 的时候设置 PublisherConfirms(true) 选项，开启
                                    <code>confirmcallback</code>。</p>
                                <p><code>CorrelationData</code> 用来表示当前消息唯一性</p>
                                <p>消息只要被 broker 接收到就会执行 confirmCallback,如果 cluster 模式，需要所有 broker 接收到才会调用
                                    confirmCallback</p>
                                <p>被 broker 接收到只能表示 message 已经到达服务器，并不能保证消息一定会被投递到目标 queue 里，所以需要用到接下来的 returnCallback
                                </p>
                                <h4 id="%E5%8F%AF%E9%9D%A0%E6%8A%B5%E8%BE%BE---returncallback" id="可靠抵达-ReturnCallback">
                                    可靠抵达 - ReturnCallback</h4>
                                <p>spring.rabbitmq.publisher-retuns=true</p>
                                <p>spring.rabbitmq.template.mandatory=true</p>
                                <p>confirm 模式只能保证消息到达 broker，不能保证消息准确投递到目标 queue 里。在有些模式业务场景下，我们需要保证消息一定要投递到目标 queue
                                    里，此时就需要用到 return 退回模式</p>
                                <p>这样如果未能投递到目标 queue 里将调用 returnCallback，可以记录下详细到投递数据，定期的巡检或者自动纠错都需要这些数据</p>
                                <h4 id="%E5%8F%AF%E9%9D%A0%E6%8A%B5%E8%BE%BE---ack-%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"
                                    id="可靠抵达-Ack-消息确认机制">可靠抵达 - Ack 消息确认机制</h4>
                                <ul>
                                    <li>消费者获取到消息，成功处理，可以回复Ack给Broker
                                        <ul>
                                            <li>basic.ack 用于肯定确认：broker 将移除此消息</li>
                                            <li>basic.nack 用于否定确认：可以指定 beoker 是否丢弃此消息，可以批量</li>
                                            <li>basic.reject用于否定确认，同上，但不能批量</li>
                                        </ul>
                                    </li>
                                    <li>默认，消息被消费者收到，就会从broker的queue中移除</li>
                                    <li>消费者收到消息，默认自动ack，但是如果无法确定此消息是否被处理完成，或者成功处理，我们可以开启手动ack模式
                                        <ul>
                                            <li>消息处理成功，ack()，接受下一条消息，此消息broker就会移除</li>
                                            <li>消息处理失败，nack()/reject() 重新发送给其他人进行处理，或者容错处理后ack</li>
                                            <li>消息一直没有调用ack/nack方法，brocker认为此消息正在被处理，不会投递给别人，此时客户端断开，消息不会被broker移除，会投递给别人
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                                <h3 id="13.8-rabbitmq-%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97(%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1)"
                                    id="13-8-RabbitMQ-延时队列-实现定时任务">13.8 RabbitMQ 延时队列(实现定时任务)</h3>
                                <p><strong>场景:</strong></p>
                                <p>比如未付款的订单，超过一定时间后，系统自动取消订单并释放占有物品</p>
                                <p><strong>常用解决方案：</strong></p>
                                <p>Spring的schedule 定时任务轮询数据库</p>
                                <p><strong>缺点：</strong></p>
                                <p>消耗系统内存，增加了数据库的压力，存在较大的时间误差</p>
                                <p>**解决：**rabbitmq的消息TTL和死信Exchange结合</p>
                                <h4 id="%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" id="使用场景">使用场景</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120120737525.png"
                                        alt="image-20201120120737525" /></p>
                                <p>时效问题</p>
                                <p>上一轮扫描刚好扫描，而这个时候刚好下了订单，就没有扫描到，下一轮扫描的时候，订单还没有过期，等到订单过期后30分钟才被扫描到</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120120914320.png"
                                        alt="image-20201120120914320" /></p>
                                <h4 id="%E6%B6%88%E6%81%AF%E7%9A%84ttl%EF%BC%88time-to-live%EF%BC%89"
                                    id="消息的TTL（Time-To-Live）">消息的TTL（Time To Live）</h4>
                                <ul>
                                    <li>消息的TTL 就是<strong>消息的存活时间</strong>，</li>
                                    <li>RabbitMQ可以对<strong>队列</strong>还有<strong>消息</strong>分别设置TTL
                                        <ul>
                                            <li>对队列设置就是没有消费者连着的保持时间，<strong>也可以对每一个消息单独的设置，超过了这个时间我们可以认为这个消息他死了，称之为死信</strong>
                                            </li>
                                            <li>如果队列设置了，消息也设置了，那么会<strong>取小</strong>，所以一个消息如果被路由到不同的队列中，这个消息死亡时间有可能不一样的（不同队列设置），这里讲的是单个TTL
                                                因为他是实现延时任务的关键，可以通过<strong>设置消息的 expiration 字段或者 x-message-ttl</strong>
                                                来设置时间两者是一样的效果</li>
                                        </ul>
                                    </li>
                                </ul>
                                <h4 id="dead-letter-exchange%EF%BC%88dlx%EF%BC%89" id="Dead-Letter-Exchange（DLX）">Dead
                                    Letter Exchange（DLX）</h4>
                                <ul>
                                    <li>一个消息在满足如下条件下，会进<strong>死信路由</strong>，记住这里是路由不是队列，一个路由可以对应很多队列，（什么是死信）
                                        <ul>
                                            <li>一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不被再次放在队列里，被其他消费者使用。(basic.reject/
                                                basic.nack)</li>
                                            <li>requeue= false上面的消息的TTL到了，消息过期了。</li>
                                            <li>队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上</li>
                                        </ul>
                                    </li>
                                    <li>Dead Letter Exchange其实就是一种普通的exchange, 和创建其他exchange没有两样。只是在某一个设置 Dead Letter
                                        Exchange的队列中有消息过期了自动触发消息的转发，发送到Dead Letter Exchange中去。</li>
                                    <li>我们既可以控制消息在一段时间后变成死信， 又可以控制变成死信的消息被路由到某一个指定的交换机， 结合C者，其实就可以实现一个延时队列</li>
                                </ul>
                                <h4 id="%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0---1" id="延时队列实现-1">延时队列实现
                                    - 1</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120132805292.png"
                                        alt="image-20201120132805292" /></p>
                                <p>延时队列实现 - 2</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120132922164.png"
                                        alt="image-20201120132922164" /></p>
                                <p>代码实现：</p>
                                <p>下单场景</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120133054368.png"
                                        alt="image-20201120133054368" /></p>
                                <p>模式升级</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120133258725.png"
                                        alt="image-20201120133258725" /></p>
                                <p>代码实现：</p>
                                <p>SpringBoot可以使用@Bean 来初始化Queue、exchange、Biding等</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听队列信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderEntity</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;order.release.order.queue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listener</span><span class="params">(OrderEntity orderEntity, Channel channel, Message message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;收到过期的订单信息，准备关闭订单&quot;</span> + orderEntity.getOrderSn());</span><br><span class="line">    <span class="comment">// 确认接收到消息，不批量接收</span></span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 容器中的 Binding、Queue、exchange 都会自动创建，(RabbitMQ没有的情况下)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">orderDelayQueue</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 特殊参数</span></span><br><span class="line">    Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 设置交换器</span></span><br><span class="line"></span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;order-event-exchange&quot;</span>);</span><br><span class="line">    <span class="comment">// 路由键</span></span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,<span class="string">&quot;order.release.order&quot;</span>);</span><br><span class="line">    <span class="comment">// 消息过期时间</span></span><br><span class="line">    map.put(<span class="string">&quot;x-message-ttl&quot;</span>,<span class="number">60000</span>);</span><br><span class="line">    Queue queue = <span class="keyword">new</span> Queue(<span class="string">&quot;order.delay.queue&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,map);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">orderReleaseOrderQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Queue queue = <span class="keyword">new</span> Queue(<span class="string">&quot;order.release.order.queue&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Exchange <span class="title">orderEventExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(<span class="string">&quot;order-event-exchange&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绑定关系 将delay.queue和event-exchange进行绑定</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">orderCreateOrderBingding</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Binding(<span class="string">&quot;order.delay.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;order-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;order.create.order&quot;</span>,</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 release.queue 和 event-exchange进行绑定</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">orderReleaseOrderBinding</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Binding(<span class="string">&quot;order.release.order.queue&quot;</span>,</span><br><span class="line">            Binding.DestinationType.QUEUE,</span><br><span class="line">            <span class="string">&quot;order-event-exchange&quot;</span>,</span><br><span class="line">            <span class="string">&quot;order.release.order&quot;</span>,</span><br><span class="line">            <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="13.9-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7---%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1-%26-%E6%B6%88%E6%81%AF%E9%87%8D%E5%A4%8D"
                                    id="13-9-如何保证消息可靠性-消息丢失-消息重复">13.9 如何保证消息可靠性 - 消息丢失 &amp; 消息重复</h3>
                                <h4 id="1%E3%80%81%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1" id="1、消息丢失">1、消息丢失</h4>
                                <ul>
                                    <li><strong>消息发送出去，由于网络问题没有抵达服务器</strong>
                                        <ul>
                                            <li>做好容错方法(try-Catch) ，发送消息可能会网络失败，失败后要有重试机制，可记录到数据库，采用定期扫描重发的方式</li>
                                            <li>做好日志记录，每个消息状态是否都被服务器收到都应该记录</li>
                                            <li>做好定期重发，如果消息没有发送成功，定期去数据库扫描未成功的消息进行重发</li>
                                        </ul>
                                    </li>
                                    <li><strong>消息抵达Broker, Broker要将消息写入磁盘(持久化)才算成功。此时Broker尚未持久化完成，宕机。</strong>
                                        <ul>
                                            <li>publisher也必须加入确认回调机制，确认成功的消息，修改数据库消息状态。</li>
                                        </ul>
                                    </li>
                                    <li><strong>自动ACK的状态下。消费者收到消息，但没来得及消息然后宕机</strong>
                                        <ul>
                                            <li>一定开启手动ACK，消费成功才移除，失败或者没来得及处理就noAck并重新入队</li>
                                        </ul>
                                    </li>
                                </ul>
                                <h4 id="2%E3%80%81%E6%B6%88%E6%81%AF%E9%87%8D%E5%A4%8D" id="2、消息重复">2、消息重复</h4>
                                <ul>
                                    <li><strong>消息消费成功，事务已经提交，ack时，机器宕机。导致没有ack成功，Broker的消息重新由unack变为ready,并发送给其他消费者</strong>
                                    </li>
                                    <li><strong>消息消费失败，由于重试机制，自动又将消息发送出去</strong></li>
                                    <li><strong>成功消费，ack时宕机，消息由unack变为ready, Broker又重新发送</strong>
                                        <ul>
                                            <li>消费者的业务消费接口应该设计为<strong>幂等性</strong>的。比如扣库存有工作单的状态标志</li>
                                            <li>使用<strong>防重表</strong>(redis/mysq|) ，发送消息每一 个都有业务的唯一 标识，处理过就不用处理</li>
                                            <li>rabbitMQ的每一个消息都有redelivered字段，
                                                可以获取<strong>是否是被重新投递过来的</strong>，而不是第一次投递过来的</li>
                                        </ul>
                                    </li>
                                </ul>
                                <h4 id="3%E3%80%81%E6%B6%88%E6%81%AF%E7%A7%AF%E5%8E%8B" id="3、消息积压">3、消息积压</h4>
                                <ul>
                                    <li><strong>消费者积压</strong></li>
                                    <li><strong>消费者消费能力不足积压</strong></li>
                                    <li><strong>发送者发送流量太大</strong>
                                        <ul>
                                            <li>上线更多消费者，进行正常消费</li>
                                            <li>上线专门的队列消费服务，将消息先批量取出来，记录数据库，离线慢慢处理</li>
                                        </ul>
                                    </li>
                                </ul>
                                <h1 id="14%E3%80%81%E8%AE%A2%E5%8D%95">14、订单</h1>
                                <h3 id="14.1-%E8%AE%A2%E5%8D%95%E4%B8%AD%E5%BF%83" id="14-1-订单中心">14.1 订单中心</h3>
                                <p>1、订单中心</p>
                                <p>电商系列涉及到 3 流，分别为信息流、资金流、物流，而订单系统作为中枢将三者有机的集合起来</p>
                                <p>订单模块是电商系统的枢纽，在订单这个模块上获取多个模块的数据和信息，同时对这些信息进行加工处理后流向下个环节，这一系列就构成了订单的信息疏通</p>
                                <h4 id="1%E3%80%81%E8%AE%A2%E5%8D%95%E6%9E%84%E6%88%90" id="1、订单构成">1、订单构成</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201117102129127.png"
                                        alt="image-20201117102129127" /></p>
                                <h5 id="1%E3%80%81%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF" id="1、用户信息">1、用户信息</h5>
                                <p>用户信息包括是用户账号、用户等级、用户的收货地址、收货人、收货人电话、用户账号需要绑定手机号码，但是用户绑定的手机号码不一定是收货信息上的电话。用户可以添加多个收货信息，用户等级信息可以用来和促销系统进行匹配，获取商品折扣，同时用户等级还可以获取积分的奖励等
                                </p>
                                <h5 id="2%E3%80%81%E8%AE%A2%E5%8D%95%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF" id="2、订单基础信息">
                                    2、订单基础信息</h5>
                                <p>订单基础信息是订单流转的核心，其包括订单类型，父/子订单、订单编号、订单状态、订单流转时间等</p>
                                <ol>
                                    <li>订单类型包括实体订单和虚拟订单商品等，这个根据商城商品和服务类型进行区分</li>
                                    <li>同时订单都需要做父子订单处理，之前在初创公司一直只有一个订单，没有做父子订单处理后期需</li>
                                    <li>要进行拆单的时候就比较麻烦，尤其是多商户商场，和不同仓库商品的时候，父子订单就是为后期做拆单准备的。</li>
                                    <li>订单编号不多说了，需要强调的一点是父子订单都需要有订单编号，需要完善的时候可以对订单编号的每个字段进行统一定义和诠释。</li>
                                    <li>订单状态记录订单每次流转过程，后面会对订单状态进行单独的说明。</li>
                                    <li>订单流转时间需要记录下单时间，支付时间，发货时间，结束时间/关闭时间等等</li>
                                </ol>
                                <h5 id="3%E3%80%81%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF" id="3、商品信息">3、商品信息</h5>
                                <p>商品信息从商品库中获取商品的SKU信息、图片、名称、属性规格、商品单价、商户信息等，从用户</p>
                                <p>下单行为记录的用户下单数量，商品合计价格等</p>
                                <h5 id="4%E3%80%81%E4%BC%98%E6%83%A0%E4%BF%A1%E6%81%AF" id="4、优惠信息">4、优惠信息</h5>
                                <p>优惠信息记录用户参与过的优惠活动，包括优惠促销活动，比如满减、满赠、秒杀等，用户使用的优</p>
                                <p>惠卷信息，优惠卷满足条件的优惠卷需要展示出来，另外虚拟币抵扣信息等进行记录</p>
                                <p>为什么把优惠信息单独拿出来而不放在支付信息里面呢?</p>
                                <p>因为优惠信息只是记录用户使用的条目，而支付信息需要加入数据进行计算，所以做为区分。</p>
                                <h5 id="5%E3%80%81%E6%94%AF%E4%BB%98%E4%BF%A1%E6%81%AF" id="5、支付信息">5、支付信息</h5>
                                <p>支付流水单号，这个流水单号是在唤起网关支付后支付通道返回给电商业务平台的支付流水号，财务</p>
                                <p>通过订单号和流水单号与支付通道进行对账使用。</p>
                                <p>支付方式用户使用的支付方式，比如微信支付、支付宝支付、钱包支付、快捷支付等。支付方式有时候可能有两个一-余额支付+第三方支付。</p>
                                <p>商品总金额，每个商品加总后的金额:运费，物流产生的费用;优惠总金额，包括促销活动的优惠金额，</p>
                                <p>优惠券优惠金额，虚拟积分或者虛拟币抵扣的金額，会员折扣的金额等之和;实付金额，用户实际需要</p>
                                <p>付款的金额。</p>
                                <p><strong>用户实付金额=商品总金额+运费 - 优惠总金额</strong></p>
                                <h5 id="6%E3%80%81%E7%89%A9%E6%B5%81%E4%BF%A1%E6%81%AF" id="6、物流信息">6、物流信息</h5>
                                <p>物流信息包括配送方式，物流公司，物流单号，物流状态，物流状态可以通过第三方接口来<br />
                                    获取和向用户展示物流每个状态节点。</p>
                                <h4 id="2%E3%80%81%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81" id="2、订单状态">2、订单状态</h4>
                                <h5 id="1%E3%80%81%E5%BE%85%E4%BB%98%E6%AC%BE" id="1、待付款">1、待付款</h5>
                                <p>用户提交订单后，订单进行预下单，目前主流电商网站都会唤起支付，便于用户快速完成支<br />
                                    付，需要注意的是待付款状态下可以对库存进行锁定，锁定库存需要配置支付超时时间，超<br />
                                    时后将自动取消订单，订单变更关闭状态。</p>
                                <h5 id="2%E3%80%81%E5%B7%B2%E4%BB%98%E6%AC%BE%2F%E4%BB%A3%E5%8F%91%E8%B4%A7"
                                    id="2、已付款-代发货">2、已付款/代发货</h5>
                                <p>用户完成订单支付，订单系统需要记录支付时间，支付流水单号便于对账，订单下放到WMS系统，仓库进行调动、配货、分拣，出库等操作</p>
                                <h5 id="3%E3%80%81%E5%BE%85%E6%94%B6%E8%B4%A7%2F%E5%B7%B2%E5%8F%91%E8%B4%A7"
                                    id="3、待收货-已发货">3、待收货/已发货</h5>
                                <p>仓库将商品出库后，订单进入物流环节，订单系统需要同步物流信息，便于用户实时熟悉商品的物流状态</p>
                                <h5 id="4%E3%80%81%E5%B7%B2%E5%AE%8C%E6%88%90" id="4、已完成">4、已完成</h5>
                                <p>用户确认收货后吗，订单交易完成，后续支付则进行计算，如果订单存在问题进入售后状态</p>
                                <h5 id="5%E3%80%81%E5%B7%B2%E5%8F%96%E6%B6%88" id="5、已取消">5、已取消</h5>
                                <p>付款之前取消订单，包括超时未付款或用户商户取消订单都会产生这种订单状态</p>
                                <h5 id="6%E3%80%81%E5%94%AE%E5%90%8E%E4%B8%AD" id="6、售后中">6、售后中</h5>
                                <p>用户在付款后申请退款，或商家发货后用户申请退货</p>
                                <p>售后也同样存在各种状态，当发起售后申请后生成售后订单，售后订单状态为待审核，等待</p>
                                <p>商家审核，商家审核通过后订单状态变更为待退货，等待用户将商品寄回，商家收货后订单</p>
                                <p>状态更新为待退款状态，退款到用户原账户后订单状态更新为售后成功。</p>
                                <h3 id="14.2-%E8%AE%A2%E5%8D%95%E6%B5%81%E7%A8%8B" id="14-2-订单流程">14.2 订单流程</h3>
                                <p>订单流程是指从订单产生到完成整个流转的过程，从而行程了-套标准流程规则。而不同的产品类型或业务类型在系统中的流程会千差万别，比如上面提到的线上实物订单和虚拟订单的流程，线上实物订单与020订单等，所以需要根据不同的类型进行构建订单流程。不管类型如何订单都包括正向流程和逆向流程，对应的场景就是购买商品和退换货流程，正向流程就是一一个正常的网购步骤:订单生成&gt;支付订单-&gt;卖家发货一确认收货&gt;交易成功。而每个步骤的背后，订单是如何在多系统之间交互流转的，
                                </p>
                                <p>可概括如下图</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201117104613032.png"
                                        alt="image-20201117104613032" /></p>
                                <p>1、订单创建与支付</p>
                                <ol>
                                    <li>订单创建前需要预览订单，选择收货信息等</li>
                                    <li>订单创建需要锁定库存，库存有才可创建，否则不能创建</li>
                                    <li>订单创建后超时未支付需要解锁库存</li>
                                    <li>支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单</li>
                                    <li>支付的每笔流水都需要记录，以待查账</li>
                                    <li>订单创建，支付成功等状态都需要给MQ发送消息，方便其他系统感知订阅</li>
                                </ol>
                                <p>2、逆向流程</p>
                                <ol>
                                    <li>修改订单，用户没有提交订单，可以对订单一些信息进行修改，比如配送信息，优惠信息，及其他一些订单可修改范围的内容，此时只需对数据进行变更即可。</li>
                                    <li>订单取消**，用户主动取消订单和用户超时未支付**，两种情况下订单都会取消订单，而超时情况是系统自动关闭订单，所以在订单支付的响应机制上面要做支付的</li>
                                </ol>
                                <h3 id="14.3-%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86" id="14-3-幂等性处理">14.3 幂等性处理
                                </h3>
                                <h3 id="14.4-%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1" id="14-4-订单业务">14.4 订单业务</h3>
                                <h4 id="1%E3%80%81%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83" id="1、搭建环境">1、搭建环境</h4>
                                <p>在订单服务下准备好页面</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210105095210202.png"
                                        alt="image-20210105095210202" /></p>
                                <p>可以发现订单结算页，包含以下信息:</p>
                                <p>1.收货人信息:有更多地址，即有多个收货地址，其中有一个默认收货地址</p>
                                <p>2.支付方式:货到付款下在线支付，不需要后台提供</p>
                                <p>3.送货清单:配送方式(不做)及商品列表(根据购物车选中的skuld到数据库中查询)</p>
                                <p>4.发票:不做</p>
                                <p>5.优惠:查询用户领取的优惠券(不做)及可用积分(京豆)</p>
                                <h5 id="1.1%E3%80%81%E6%95%B4%E5%90%88springsession" id="1-1、整合SpringSession">
                                    1.1、整合SpringSession</h5>
                                <p><strong>1、引入pom</strong></p>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">&lt;!--整合spring session 解决session问题--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>2、配置文件添加</strong></p>
                                <figure class="highlight yaml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="attr">Spring:</span></span><br><span class="line">	<span class="attr">session:</span></span><br><span class="line">    	<span class="attr">store-type:</span> <span class="string">redis</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>3、启动类加注解</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@EnableRedisHttpSession</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>4、修改页面中登录</strong></p>
                                <figure class="highlight html">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">&quot;border: 0;&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;session.loginUser != null &#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;aa&quot;</span>&gt;</span>[[$&#123;session.loginUser.nickname&#125;]]<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;session.loginUser == null &#125;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://auth.gulimall.com/login.html&quot;</span>&gt;</span>你好请登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;session.loginUser == null &#125;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color: red;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://auth.gulimall.com/reg.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;li_2&quot;</span>&gt;</span>免费注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="1.2%E3%80%81%E8%AE%A2%E5%8D%95%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA"
                                    id="1-2、订单登录拦截">1.2、订单登录拦截</h5>
                                <p>任何请求都需要先经过拦截器的验证，才能去执行目标方法，这里是用户是否登录，用户登录了则放行，否则跳转到登陆页面</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 目标方法执行之前</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      String requestURI = request.getRequestURI();</span><br><span class="line">      <span class="comment">// 指定的请求不拦截</span></span><br><span class="line">      <span class="keyword">boolean</span> match1 = <span class="keyword">new</span> AntPathMatcher().match(<span class="string">&quot;/order/order/status/**&quot;</span>, requestURI);</span><br><span class="line">      <span class="keyword">boolean</span> match2 = <span class="keyword">new</span> AntPathMatcher().match(<span class="string">&quot;/payed/notify&quot;</span>, requestURI);</span><br><span class="line">      <span class="keyword">if</span> (match1 || match2) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      MemberRespVo memberRespVo= (MemberRespVo) request.getSession().getAttribute(AuthServerConstant.LOGIN_USER);</span><br><span class="line">      <span class="keyword">if</span> (memberRespVo != <span class="keyword">null</span>) &#123; <span class="comment">// 用户登陆了</span></span><br><span class="line">          loginUser.set(memberRespVo); <span class="comment">// 放到共享数据中</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// 用户没登录</span></span><br><span class="line">          <span class="comment">// 给前端显示提示信息</span></span><br><span class="line">          request.getSession().setAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;请先进行登录&quot;</span>);</span><br><span class="line">          <span class="comment">// 重定向到登录页面</span></span><br><span class="line">          response.sendRedirect(<span class="string">&quot;http://auth.gulimall.com/login.html&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2%E3%80%81%E8%AE%A2%E5%8D%95%E7%A1%AE%E8%AE%A4%E9%A1%B5" id="2、订单确认页">2、订单确认页
                                </h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210105142735857.png"
                                        alt="image-20210105142735857" /></p>
                                <p><strong>根据图片中商品信息抽取成Vo</strong></p>
                                <h5 id="2.1%E3%80%81%E6%8A%BD%E5%8F%96vo" id="2-1、抽取Vo">2.1、抽取Vo</h5>
                                <p><strong>订单确认OrderConfirmVo</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单确认页需要的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderConfirmVo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收货地址，ums_member_receive_address</span></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    List&lt;MemberAddressVo&gt; address;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有选中的购物项</span></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    List&lt;OrderItemVo&gt; item;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发票记录...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 优惠卷信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    Integer integration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单总额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BigDecimal total;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getTotal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BigDecimal sum = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(item != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OrderItemVo orderItemVo : item) &#123;</span><br><span class="line">                BigDecimal multiply = orderItemVo.getPrice().multiply(<span class="keyword">new</span> BigDecimal(orderItemVo.getCount().toString()));</span><br><span class="line">                sum = sum.add(multiply);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    Map&lt;Long,Boolean&gt; stocks;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应付价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BigDecimal payPrice;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getPayPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BigDecimal sum = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(item != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OrderItemVo orderItemVo : item) &#123;</span><br><span class="line">                BigDecimal multiply = orderItemVo.getPrice().multiply(<span class="keyword">new</span> BigDecimal(orderItemVo.getCount().toString()));</span><br><span class="line">                sum = sum.add(multiply);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 遍历item 拿到商品的数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Integer i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (item != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OrderItemVo orderItemVo : item) &#123;</span><br><span class="line">                i+=orderItemVo.getCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String orderToken;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>商品项orderItemVo</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 商品项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItemVo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车中是否选中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean check = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的标题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String image;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; skuAttr;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车价格 使用自定义get、set</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalPrice;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal weight;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><strong>用户地址MemberAddressVo</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户地址信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberAddressVo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * member_id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long memberId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收货人姓名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 电话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮政编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String postCode;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 省份/直辖市</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 城市</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String region;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 详细地址(街道)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String detailAddress;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 省市区代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String areacode;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否默认</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer defaultStatus;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="2.2%E3%80%81%E8%AE%A2%E5%8D%95%E7%A1%AE%E8%AE%A4%E9%A1%B5%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"
                                    id="2-2、订单确认页数据查询">2.2、订单确认页数据查询</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> OrderConfirmVo <span class="title">confirmOrder</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">     OrderConfirmVo confirmVo = <span class="keyword">new</span> OrderConfirmVo();</span><br><span class="line">     MemberRespVo memberRespVo = OrderInterceptor.loginUser.get();<span class="comment">// 获取当前登录后的用户</span></span><br><span class="line">     <span class="comment">// 异步任务执行之前，先共享数据</span></span><br><span class="line">     RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">     <span class="comment">// 1、第一个异步任务 远程查询用户地址信息</span></span><br><span class="line">     CompletableFuture&lt;Void&gt; memberFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">         <span class="comment">// 在主线程中拿到原来的数据，在父线程里面共享RequestContextHolder</span></span><br><span class="line">         <span class="comment">// 只有共享，拦截其中才会有数据</span></span><br><span class="line">         RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line">         <span class="comment">// 根据会员id查出之前会员保存过的收货地址信息</span></span><br><span class="line">         <span class="comment">// 远程查询会员服务的收获地址信息</span></span><br><span class="line">         List&lt;MemberAddressVo&gt; address = memberFeignService.getAddress(memberRespVo.getId());</span><br><span class="line">         log.error(<span class="string">&quot;address:&#123;&#125;&quot;</span>,address);</span><br><span class="line">         confirmVo.setAddress(address);</span><br><span class="line">     &#125;, executor);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 2、第二个异步任务远程查询购物车中选中给的购物项</span></span><br><span class="line">     CompletableFuture&lt;Void&gt; addressFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">         <span class="comment">// 每一个线程都来共享之前的请求数据</span></span><br><span class="line">         RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line">         <span class="comment">// 远程查询购物车中的购物项信息，用来结账</span></span><br><span class="line">         List&lt;OrderItemVo&gt; currentUserCartItem = cartFeignServicea.getCurrentUserCartItem();<span class="comment">// 获取当前用户的购物项数据</span></span><br><span class="line">         log.error(<span class="string">&quot;currentUserCartItem:&#123;&#125;&quot;</span>,currentUserCartItem);</span><br><span class="line">         confirmVo.setItem(currentUserCartItem);</span><br><span class="line">         <span class="comment">// 查询到购物项信息后，再看查询购物的库存信息</span></span><br><span class="line">     &#125;, executor).thenRunAsync(() -&gt; &#123; <span class="comment">// 只要上面任务执行完成，就开始执行thenRunAsync的任务</span></span><br><span class="line">         <span class="comment">// 3、商品是否有库存</span></span><br><span class="line">         List&lt;OrderItemVo&gt; items = confirmVo.getItem();</span><br><span class="line">         <span class="comment">// 批量查询每一个商品的信息</span></span><br><span class="line">         <span class="comment">// 收集好商品id</span></span><br><span class="line">         List&lt;Long&gt; collect = items.stream().map(item -&gt; item.getSkuId()).collect(Collectors.toList());</span><br><span class="line">         <span class="comment">// 远程查询购物项对应的库存信息</span></span><br><span class="line">         R data = wareFeignService.hasStock(collect);</span><br><span class="line">         <span class="comment">// 得到每一个商品的库存状态信息</span></span><br><span class="line">         List&lt;SkuHasStockVo&gt; hasStockVo = data.getData(<span class="keyword">new</span> TypeReference&lt;List&lt;SkuHasStockVo&gt;&gt;() &#123;</span><br><span class="line">         &#125;);</span><br><span class="line">         <span class="keyword">if</span> (hasStockVo != <span class="keyword">null</span>) &#123;</span><br><span class="line">             Map&lt;Long, Boolean&gt; stockMap = hasStockVo.stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, SkuHasStockVo::getHasStock));</span><br><span class="line">             confirmVo.setStocks(stockMap);</span><br><span class="line">             log.error(<span class="string">&quot;stockMap:&#123;&#125;&quot;</span>,stockMap);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;,executor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 4、查询积分信息</span></span><br><span class="line">     Integer integration = confirmVo.getIntegration();</span><br><span class="line">     confirmVo.setIntegration(integration);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 等两个异步任务都完成</span></span><br><span class="line">     CompletableFuture.allOf(memberFuture, addressFuture).get();</span><br><span class="line">    <span class="comment">// 4、防重令牌</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 接口幂等性就是用户对同一操作发起的一次请求和多次请求结果是一致的</span></span><br><span class="line"><span class="comment">      * 不会因为多次点击而产生了副作用，比如支付场景，用户购买了商品，支付扣款成功，</span></span><br><span class="line"><span class="comment">      * 但是返回结果的时候出现了网络异常，此时钱已经扣了，用户再次点击按钮，</span></span><br><span class="line"><span class="comment">      * 此时就会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱了，</span></span><br><span class="line"><span class="comment">      * 流水记录也变成了两条。。。这就没有保证接口幂等性</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="comment">// 先是再页面中生成一个随机码把他叫做token先存到redis中，然后放到对象中在页面进行渲染。</span></span><br><span class="line">     <span class="comment">// 用户提交表单的时候，带着这个token和redis里面去匹配如果一直那么可以执行下面流程。</span></span><br><span class="line">     <span class="comment">// 匹配成功后再redis中删除这个token，下次请求再过来的时候就匹配不上直接返回</span></span><br><span class="line">     <span class="comment">// 生成防重令牌</span></span><br><span class="line">     String token = UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">     <span class="comment">// 存到redis中 设置30分钟超时</span></span><br><span class="line">     redisTemplate.opsForValue().set(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberRespVo.getId(),token,<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">     <span class="comment">// 放到页面进行显示token，然后订单中带着token来请求</span></span><br><span class="line">     confirmVo.setOrderToken(token);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> confirmVo;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="3%E3%80%81%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95" id="3、创建订单">3、创建订单</h4>
                                <h5 id="1%E3%80%81orderwebcontroller" id="1、OrderWebController">1、OrderWebController
                                </h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @需求描述: 系统管理员 订单组 模块 用户下单功能</span></span><br><span class="line"><span class="comment">   * @创建人: 郭承乾</span></span><br><span class="line"><span class="comment">   * @创建时间: 2021/01/06 12:01</span></span><br><span class="line"><span class="comment">   * @修改需求:</span></span><br><span class="line"><span class="comment">   * @修改人:</span></span><br><span class="line"><span class="comment">   * @修改时间:</span></span><br><span class="line"><span class="comment">   * @需求思路:</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@PostMapping(&quot;/submitOrder&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">submitOrder</span><span class="params">(OrderSubmitVo vo, Model model, RedirectAttributes redirectAttributes)</span> </span>&#123;</span><br><span class="line">       SubmitOrderResponseVo responseVo = orderService.submitOrder(vo);</span><br><span class="line">       log.error(<span class="string">&quot;======================订单创建成功&#123;&#125;:&quot;</span>,responseVo);</span><br><span class="line">       <span class="comment">// 根据vo中定义的状态码来验证</span></span><br><span class="line">       <span class="keyword">if</span> (responseVo.getCode() == <span class="number">0</span> ) &#123; <span class="comment">// 订单创建成功</span></span><br><span class="line">           <span class="comment">// 下单成功返回到支付页</span></span><br><span class="line">           model.addAttribute(<span class="string">&quot;submitOrderResp&quot;</span>,responseVo);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;pay&quot;</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">// 下单失败</span></span><br><span class="line">           <span class="comment">// 根据状态码验证对应的状态</span></span><br><span class="line">           String msg = <span class="string">&quot;下单失败&quot;</span>;</span><br><span class="line">           <span class="keyword">switch</span> (responseVo.getCode()) &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">1</span>: msg += <span class="string">&quot;订单信息过期，请刷新后再次提交&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">2</span>: msg += <span class="string">&quot;订单商品价格发生变化，请确认后再次提交&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">3</span>: msg += <span class="string">&quot;库存锁定失败，商品库存不足&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           redirectAttributes.addFlashAttribute(<span class="string">&quot;msg&quot;</span>,msg);</span><br><span class="line">           <span class="comment">// 重新回到订单确认页面</span></span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="2%E3%80%81service" id="2、Service">2、Service</h5>
                                <p>具体业务</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"> <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SubmitOrderResponseVo <span class="title">submitOrder</span><span class="params">(OrderSubmitVo vo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先将参数放到共享变量中，方便之后方法使用该参数</span></span><br><span class="line">        confirmVoThreadLocal.set(vo);</span><br><span class="line">        <span class="comment">// 接收返回数据</span></span><br><span class="line">        SubmitOrderResponseVo response = <span class="keyword">new</span> SubmitOrderResponseVo();</span><br><span class="line">        response.setCode(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 通过拦截器拿到用户的数据</span></span><br><span class="line">        MemberRespVo memberRespVo = LoginInterceptor.loginUser.get();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 不使用原子性验证令牌</span></span><br><span class="line"><span class="comment">         *      1、用户带着两个订单，提交速度非常快，两个订单的令牌都是123，去redis里面查查到的也是123。</span></span><br><span class="line"><span class="comment">         *          两个对比都通过，然后来删除令牌，那么就会出现用户重复提交的问题，</span></span><br><span class="line"><span class="comment">         *      2、第一次差的快，第二次查的慢，只要没删就会出现这些问题</span></span><br><span class="line"><span class="comment">         *      3、因此令牌的【验证和删除必须保证原子性】</span></span><br><span class="line"><span class="comment">         *      String orderToken = vo.getOrderToken();</span></span><br><span class="line"><span class="comment">         *      String redisToken = redisTemplate.opsForValue().get(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberRespVo.getId());</span></span><br><span class="line"><span class="comment">         *         if (orderToken != null &amp;&amp; orderToken.equals(redisToken)) &#123;</span></span><br><span class="line"><span class="comment">         *             // 令牌验证通过 进行删除</span></span><br><span class="line"><span class="comment">         *             redisTemplate.delete(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberRespVo.getId());</span></span><br><span class="line"><span class="comment">         *         &#125; else &#123;</span></span><br><span class="line"><span class="comment">         *             // 不通过</span></span><br><span class="line"><span class="comment">         *         &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 验证令牌【令牌的对比和删除必须保证原子性】</span></span><br><span class="line">        <span class="comment">// 因此使用redis中脚本来进行验证并删除令牌</span></span><br><span class="line">        <span class="comment">// 0【删除失败/验证失败】 1【删除成功】</span></span><br><span class="line">        String script = <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;,KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * redis lur脚本命令解析</span></span><br><span class="line"><span class="comment">         * if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;,KEYS[1]) else return 0 end</span></span><br><span class="line"><span class="comment">         *  1、redis调用get方法来获取一个key的值，如果这个get出来的值等于我们传过来的值</span></span><br><span class="line"><span class="comment">         *  2、然后就执行删除，根据这个key进行删除，删除成功返回1，验证失败返回0</span></span><br><span class="line"><span class="comment">         *  3、删除否则就是0</span></span><br><span class="line"><span class="comment">         *  总结：相同的进行删除，不相同的返回0</span></span><br><span class="line"><span class="comment">         * 脚本大致意思</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 拿到令牌</span></span><br><span class="line">        String orderToken = vo.getOrderToken();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 	public &lt;T&gt; T execute(RedisScript&lt;T&gt; script // redis的脚本</span></span><br><span class="line"><span class="comment">         * 	    , List&lt;K&gt; keys // 对应的key 参数中使用了Array.asList 将参数转成list集合</span></span><br><span class="line"><span class="comment">         * 	    , Object... args) &#123; // 要删除的值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 原子验证和删除</span></span><br><span class="line">        Long result = redisTemplate.execute(<span class="keyword">new</span> DefaultRedisScript&lt;Long&gt;(script, Long.class)</span><br><span class="line">                , Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberRespVo.getId())</span><br><span class="line">                , orderToken);</span><br><span class="line">        <span class="keyword">if</span> (result  == <span class="number">0L</span>) &#123; <span class="comment">// 验证令牌验证失败</span></span><br><span class="line">            <span class="comment">// 验证失败直接返回结果</span></span><br><span class="line">            response.setCode(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 原子验证令牌成功</span></span><br><span class="line">            <span class="comment">// 下单 创建订单、验证令牌、验证价格、验证库存</span></span><br><span class="line">            <span class="comment">// 1、创建订单、订单项信息</span></span><br><span class="line">            OrderCreateTo order = createOrder();</span><br><span class="line">            <span class="comment">// 2、应付总额</span></span><br><span class="line">            BigDecimal payAmount = order.getOrder().getPayAmount();</span><br><span class="line">            <span class="comment">// 应付价格</span></span><br><span class="line">            BigDecimal payPrice = vo.getPayPrice();</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 电商项目对付款的金额精确到小数点后面两位</span></span><br><span class="line"><span class="comment">             * 订单创建好的应付总额 和购物车中计算好的应付价格求出绝对值。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span>(Math.abs(payAmount.subtract(payPrice).doubleValue()) &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">                <span class="comment">// 金额对比成功 保存订单</span></span><br><span class="line">                saveOrder(order);</span><br><span class="line">                <span class="comment">// 创建锁定库存Vo</span></span><br><span class="line">                WareSkuLockedVo wareSkuLockedVo = <span class="keyword">new</span> WareSkuLockedVo();</span><br><span class="line">                <span class="comment">// 准备好商品项</span></span><br><span class="line">                List&lt;OrderItemVo&gt; lock = order.getOrderItem().stream().map(orderItemEntity -&gt; &#123;</span><br><span class="line">                    OrderItemVo orderItemVo = <span class="keyword">new</span> OrderItemVo();</span><br><span class="line">                    <span class="comment">// 商品购买数量</span></span><br><span class="line">                    orderItemVo.setCount(orderItemEntity.getSkuQuantity());</span><br><span class="line">                    <span class="comment">// skuid 用来查询商品信息</span></span><br><span class="line">                    orderItemVo.setSkuId(orderItemEntity.getSkuId());</span><br><span class="line">                    <span class="comment">// 商品标题</span></span><br><span class="line">                    orderItemVo.setTitle(orderItemEntity.getSkuName());</span><br><span class="line">                    <span class="keyword">return</span> orderItemVo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">                <span class="comment">// 订单号</span></span><br><span class="line">                wareSkuLockedVo.setOrderSn(order.getOrder().getOrderSn());</span><br><span class="line">                <span class="comment">// 商品项</span></span><br><span class="line">                wareSkuLockedVo.setLocks(lock);</span><br><span class="line">                <span class="comment">// 远程调用库存服务锁定库存</span></span><br><span class="line">                R r = wareFeignService.orderLockStock(wareSkuLockedVo);</span><br><span class="line">                <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123; <span class="comment">// 库存锁定成功</span></span><br><span class="line">                    <span class="comment">// 将订单对象放到返回Vo中</span></span><br><span class="line">                    response.setOrder(order.getOrder());</span><br><span class="line">                    <span class="comment">// 设置状态码</span></span><br><span class="line">                    response.setCode(<span class="number">0</span>);</span><br><span class="line">                    <span class="comment">// 订单创建成功发送消息给MQ</span></span><br><span class="line">                    rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span></span><br><span class="line">                            ,<span class="string">&quot;order.create.order&quot;</span></span><br><span class="line">                            ,order.getOrder());</span><br><span class="line">                    <span class="keyword">return</span> response;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 远程锁定库存失败</span></span><br><span class="line">                    response.setCode(<span class="number">3</span>);</span><br><span class="line">                    <span class="keyword">return</span> response;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 商品价格比较失败</span></span><br><span class="line">                response.setCode(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单和订单项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OrderCreateTo <span class="title">createOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OrderCreateTo orderCreateTo = <span class="keyword">new</span> OrderCreateTo();</span><br><span class="line">        <span class="comment">// 1、生成订单号</span></span><br><span class="line">        String orderSn = IdWorker.getTimeId();</span><br><span class="line">        <span class="comment">// 2、构建订单</span></span><br><span class="line">        OrderEntity orderEntity = buildOrder(orderSn);</span><br><span class="line">        <span class="comment">// 3、构建订单项</span></span><br><span class="line">        List&lt;OrderItemEntity&gt; itemEntities = builderOrderItems(orderSn);</span><br><span class="line">        <span class="comment">// 4、设置价格、积分相关信息</span></span><br><span class="line">        computPrice(orderEntity,itemEntities);</span><br><span class="line">        <span class="comment">// 5、设置订单项</span></span><br><span class="line">        orderCreateTo.setOrderItem(itemEntities);</span><br><span class="line">        <span class="comment">// 6、设置订单</span></span><br><span class="line">        orderCreateTo.setOrder(orderEntity);</span><br><span class="line">        <span class="keyword">return</span> orderCreateTo;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderSn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OrderEntity <span class="title">buildOrder</span><span class="params">(String orderSn)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到共享数据</span></span><br><span class="line">        OrderSubmitVo orderSubmitVo = confirmVoThreadLocal.get();</span><br><span class="line">        <span class="comment">// 用户登录登录数据</span></span><br><span class="line">        MemberRespVo memberRespVo = LoginInterceptor.loginUser.get();</span><br><span class="line"></span><br><span class="line">        OrderEntity orderEntity = <span class="keyword">new</span> OrderEntity();</span><br><span class="line">        <span class="comment">// 设置订单号</span></span><br><span class="line">        orderEntity.setOrderSn(orderSn);</span><br><span class="line">        <span class="comment">// 用户id</span></span><br><span class="line">        orderEntity.setMemberId(memberRespVo.getId());</span><br><span class="line">        <span class="comment">// 根据用户收货地址id查询出用户的收获地址信息</span></span><br><span class="line">        R fare = wareFeignService.getFare(orderSubmitVo.getAddrId());</span><br><span class="line">        FareVo data = fare.getData(<span class="keyword">new</span> TypeReference&lt;FareVo&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//将查询到的会员收货地址信息设置到订单对象中</span></span><br><span class="line">        <span class="comment">// 运费金额</span></span><br><span class="line">        orderEntity.setFreightAmount(data.getFare());</span><br><span class="line">        <span class="comment">// 城市</span></span><br><span class="line">        orderEntity.setReceiverCity(data.getMemberAddressVo().getCity());</span><br><span class="line">        <span class="comment">// 详细地区</span></span><br><span class="line">        orderEntity.setReceiverDetailAddress(data.getMemberAddressVo().getDetailAddress());</span><br><span class="line">        <span class="comment">// 收货人姓名</span></span><br><span class="line">        orderEntity.setReceiverName(data.getMemberAddressVo().getName());</span><br><span class="line">        <span class="comment">// 收货人手机号</span></span><br><span class="line">        orderEntity.setReceiverPhone(data.getMemberAddressVo().getPhone());</span><br><span class="line">        <span class="comment">// 区</span></span><br><span class="line">        orderEntity.setReceiverRegion(data.getMemberAddressVo().getRegion());</span><br><span class="line">        <span class="comment">// 省份直辖市</span></span><br><span class="line">        orderEntity.setReceiverProvince(data.getMemberAddressVo().getProvince());</span><br><span class="line">        <span class="comment">// 订单刚创建状态设置为 待付款，用户支付成功后将该该状态改成已付款</span></span><br><span class="line">        orderEntity.setStatus(OrderStatusEnum.CREATE_NEW.getCode());</span><br><span class="line">        <span class="comment">// 自动确认时间</span></span><br><span class="line">        orderEntity.setAutoConfirmDay(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderEntity;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建订单项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderSn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;OrderItemEntity&gt; <span class="title">builderOrderItems</span><span class="params">(String orderSn)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取购物车中选中的商品</span></span><br><span class="line">        List&lt;OrderItemVo&gt; currentUserCartItem = cartFeignServicea.getCurrentUserCartItem();</span><br><span class="line">        <span class="keyword">if</span> (currentUserCartItem != <span class="keyword">null</span> &amp;&amp; currentUserCartItem.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            List&lt;OrderItemEntity&gt; collect = currentUserCartItem.stream().map(orderItemVo -&gt; &#123;</span><br><span class="line">                <span class="comment">// 构建订单项</span></span><br><span class="line">                OrderItemEntity itemEntity = builderOrderItem(orderItemVo);</span><br><span class="line">                itemEntity.setOrderSn(orderSn);</span><br><span class="line">                <span class="keyword">return</span> itemEntity;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">return</span> collect;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建订单项信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cartItem</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OrderItemEntity <span class="title">builderOrderItem</span><span class="params">(OrderItemVo cartItem)</span> </span>&#123;</span><br><span class="line">        OrderItemEntity itemEntity = <span class="keyword">new</span> OrderItemEntity();</span><br><span class="line">        <span class="comment">// 1、根据skuid查询关联的spuinfo信息</span></span><br><span class="line">        Long skuId = cartItem.getSkuId();</span><br><span class="line">        R spuinfo = productFeignService.getSpuInfoBySkuId(skuId);</span><br><span class="line">        SpuInfoVo spuInfoVo = spuinfo.getData(<span class="keyword">new</span> TypeReference&lt;SpuInfoVo&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 2、设置商品项spu信息</span></span><br><span class="line">        <span class="comment">// 品牌信息</span></span><br><span class="line">        itemEntity.setSpuBrand(spuInfoVo.getBrandId().toString());</span><br><span class="line">        <span class="comment">// 商品分类信息</span></span><br><span class="line">        itemEntity.setCategoryId(spuInfoVo.getCatalogId());</span><br><span class="line">        <span class="comment">// spuid</span></span><br><span class="line">        itemEntity.setSpuId(spuInfoVo.getId());</span><br><span class="line">        <span class="comment">// spu_name 商品名字</span></span><br><span class="line">        itemEntity.setSpuName(spuInfoVo.getSpuName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、设置商品sku信息</span></span><br><span class="line">        <span class="comment">// skuid</span></span><br><span class="line">        itemEntity.setSkuId(skuId);</span><br><span class="line">        <span class="comment">// 商品标题</span></span><br><span class="line">        itemEntity.setSkuName(cartItem.getTitle());</span><br><span class="line">        <span class="comment">// 商品图片</span></span><br><span class="line">        itemEntity.setSkuPic(cartItem.getImage());</span><br><span class="line">        <span class="comment">// 商品sku价格</span></span><br><span class="line">        itemEntity.setSkuPrice(cartItem.getPrice());</span><br><span class="line">        <span class="comment">// 商品属性以 ; 拆分</span></span><br><span class="line">        String skuAttr = StringUtils.collectionToDelimitedString(cartItem.getSkuAttr(), <span class="string">&quot;;&quot;</span>);</span><br><span class="line">        itemEntity.setSkuAttrsVals(skuAttr);</span><br><span class="line">        <span class="comment">// 商品购买数量</span></span><br><span class="line">        itemEntity.setSkuQuantity(cartItem.getCount());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、设置商品优惠信息【不做】</span></span><br><span class="line">        <span class="comment">// 5、设置商品积分信息</span></span><br><span class="line">        <span class="comment">// 赠送积分 移弃小数值</span></span><br><span class="line">        itemEntity.setGiftIntegration(cartItem.getPrice().multiply(<span class="keyword">new</span> BigDecimal(cartItem.getCount().toString())).intValue());</span><br><span class="line">        <span class="comment">// 赠送成长值</span></span><br><span class="line">        itemEntity.setGiftGrowth(cartItem.getPrice().multiply(<span class="keyword">new</span> BigDecimal(cartItem.getCount().toString())).intValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、订单项的价格信息</span></span><br><span class="line">        <span class="comment">// 这里需要计算商品的分解信息</span></span><br><span class="line">        <span class="comment">// 商品促销分解金额</span></span><br><span class="line">        itemEntity.setPromotionAmount(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">        <span class="comment">// 优惠券优惠分解金额</span></span><br><span class="line">        itemEntity.setCouponAmount(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">        <span class="comment">// 积分优惠分解金额</span></span><br><span class="line">        itemEntity.setIntegrationAmount(<span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">        <span class="comment">// 商品价格乘以商品购买数量=总金额(未包含优惠信息)</span></span><br><span class="line">        BigDecimal origin = itemEntity.getSkuPrice().multiply(<span class="keyword">new</span> BigDecimal(itemEntity.getSkuQuantity().toString()));</span><br><span class="line">        <span class="comment">// 总价格减去优惠卷-积分优惠-商品促销金额 = 总金额</span></span><br><span class="line">        origin.subtract(itemEntity.getPromotionAmount())</span><br><span class="line">                .subtract(itemEntity.getCouponAmount())</span><br><span class="line">                .subtract(itemEntity.getIntegrationAmount());</span><br><span class="line">        <span class="comment">// 该商品经过优惠后的分解金额</span></span><br><span class="line">        itemEntity.setRealAmount(origin);</span><br><span class="line">        <span class="keyword">return</span> itemEntity;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算订单涉及到的积分、优惠卷抵扣、促销优惠信息等信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderEntity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> itemEntities</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OrderEntity <span class="title">computPrice</span><span class="params">(OrderEntity orderEntity, List&lt;OrderItemEntity&gt; itemEntities)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1、定义好相关金额，然后遍历购物项进行计算</span></span><br><span class="line">        <span class="comment">// 总价格</span></span><br><span class="line">        BigDecimal total = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="comment">//相关优惠信息</span></span><br><span class="line">        <span class="comment">// 优惠卷抵扣金额</span></span><br><span class="line">        BigDecimal coupon = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="comment">// 积分优惠金额</span></span><br><span class="line">        BigDecimal integration = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="comment">// 促销优惠金额</span></span><br><span class="line">        BigDecimal promotion = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="comment">// 积分</span></span><br><span class="line">        BigDecimal gift = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="comment">// 成长值</span></span><br><span class="line">        BigDecimal growth = <span class="keyword">new</span> BigDecimal(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历订单项将所有的优惠信息进行相加</span></span><br><span class="line">        <span class="keyword">for</span> (OrderItemEntity itemEntity : itemEntities) &#123;</span><br><span class="line">            coupon = coupon.add(itemEntity.getCouponAmount()); <span class="comment">// 优惠卷抵扣</span></span><br><span class="line">            integration = integration.add(itemEntity.getIntegrationAmount()); <span class="comment">// 积分优惠分解金额</span></span><br><span class="line">            promotion = promotion.add(itemEntity.getPromotionAmount()); <span class="comment">// 商品促销分解金额</span></span><br><span class="line">            gift = gift.add(<span class="keyword">new</span> BigDecimal(itemEntity.getGiftIntegration().toString())); <span class="comment">// 赠送积分</span></span><br><span class="line">            growth = growth.add(<span class="keyword">new</span> BigDecimal(itemEntity.getGiftGrowth())); <span class="comment">// 赠送成长值</span></span><br><span class="line">            total = total.add(itemEntity.getRealAmount()); <span class="comment">//优惠后的总金额</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、设置订单金额</span></span><br><span class="line">        <span class="comment">// 订单总金额</span></span><br><span class="line">        orderEntity.setTotalAmount(total);</span><br><span class="line">        <span class="comment">// 应付总额 = 订单总额 + 运费信息</span></span><br><span class="line">        orderEntity.setPayAmount(total.add(orderEntity.getFreightAmount()));</span><br><span class="line">        <span class="comment">// 促销优化金额（促销价、满减、阶梯价）</span></span><br><span class="line">        orderEntity.setPromotionAmount(promotion);</span><br><span class="line">        <span class="comment">// 优惠券抵扣金额</span></span><br><span class="line">        orderEntity.setCouponAmount(coupon);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、设置积分信息</span></span><br><span class="line">        <span class="comment">// 订单购买后可以获得的成长值</span></span><br><span class="line">        orderEntity.setGrowth(growth.intValue());</span><br><span class="line">        <span class="comment">// 积分抵扣金额</span></span><br><span class="line">        orderEntity.setIntegrationAmount(integration);</span><br><span class="line">        <span class="comment">// 可以获得的积分</span></span><br><span class="line">        orderEntity.setIntegration(gift.intValue());</span><br><span class="line">        <span class="comment">// 删除状态【0-&gt;未删除；1-&gt;已删除】</span></span><br><span class="line">        orderEntity.setDeleteStatus(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> orderEntity;</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="3%E3%80%81%E5%BA%93%E5%AD%98%E8%87%AA%E5%8A%A8%E8%A7%A3%E9%94%81---%3Emq"
                                    id="3、库存自动解锁-MQ">3、库存自动解锁---&gt;MQ</h5>
                                <h6 id="%E5%BA%93%E5%AD%98%E8%A7%A3%E9%94%81%E3%80%81stockreleaselistener"
                                    id="库存解锁、StockReleaseListener">库存解锁、StockReleaseListener</h6>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">package</span> com.atguigu.gulimall.ware.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.to.mq.OrderTo;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.common.to.mq.StockLockedTo;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gulimall.ware.service.WareSkuService;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听库存延时队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2021-01-07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;stock.release.stock.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockReleaseListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    WareSkuService wareSkuService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听库存队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockedTo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStockLockedRelease</span><span class="params">(StockLockedTo lockedTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到解锁库存的信息&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unLockStock(lockedTo);</span><br><span class="line">            <span class="comment">//库存解锁成功没有抛出异常，自动ack机制确认</span></span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// 重发</span></span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单释放</span></span><br><span class="line"><span class="comment">     *  订单30分钟未支付，订单关闭后发送的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerOrderCloseRelease</span><span class="params">(OrderTo orderTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;订单关闭准备解锁库存......&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unLockStock(orderTo);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 解锁库存</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> lockedTo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLockStock</span><span class="params">(StockLockedTo lockedTo)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 工作单详情</span></span><br><span class="line">       StockDetailTo detail = lockedTo.getDetail();</span><br><span class="line">       <span class="comment">// 工作单详情id</span></span><br><span class="line">       Long detailId = detail.getId();</span><br><span class="line">       <span class="comment">// 查询到库存工作单详情</span></span><br><span class="line">       WareOrderTaskDetailEntity taskDetailEntity = wareOrderTaskDetailService.getById(detailId);</span><br><span class="line">       <span class="keyword">if</span> (taskDetailEntity != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 解锁库存</span></span><br><span class="line">           <span class="comment">// 库存工作单id</span></span><br><span class="line">           Long id = lockedTo.getId();</span><br><span class="line">           <span class="comment">// 查询到库存工作单</span></span><br><span class="line">           WareOrderTaskEntity TaskEntity = wareOrderTaskService.getById(id);</span><br><span class="line">           <span class="comment">// 拿到订单号</span></span><br><span class="line">           String orderSn = TaskEntity.getOrderSn();</span><br><span class="line">           <span class="comment">// 根据订单号查询订单的状态</span></span><br><span class="line">           R orderStatus = orderFeignService.getOrderStatus(orderSn);</span><br><span class="line">           <span class="keyword">if</span> (orderStatus.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">               OrderVo data = orderStatus.getData(<span class="keyword">new</span> TypeReference&lt;OrderVo&gt;() &#123;</span><br><span class="line">               &#125;);</span><br><span class="line">               <span class="comment">// 订单状态为已关闭,那么就需要解锁库存</span></span><br><span class="line">               <span class="keyword">if</span> (data == <span class="keyword">null</span> || data.getStatus() == <span class="number">4</span>) &#123;</span><br><span class="line">                   <span class="comment">// 库存工作单锁定状态为锁定才进行解锁</span></span><br><span class="line">                   <span class="keyword">if</span> (taskDetailEntity.getLockStatus() == <span class="number">1</span>) &#123;</span><br><span class="line">                       unLockStock(detail.getSkuId(), detail.getWareId(), detail.getSkuNum(), detailId);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 消息被拒绝后重新放到队列里面，让别人继续消费解锁</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;远败&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="4%E3%80%81%E6%94%AF%E4%BB%98" id="4、支付">4、支付</h4>
                                <p>选择的是支付宝支付，根据老师所提供的素材 <strong>alipayTemplate、PayVo、PaySyncVo</strong>,引入到项目中进行开发</p>
                                <h5 id="1%E3%80%81controller" id="1、Controller">1、Controller</h5>
                                <p>跳转到支付宝支付页面，<strong>支付完成后跳转到支付成功的回调页面</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、跳转到支付页面</span></span><br><span class="line"><span class="comment">     * 2、用户支付成功后，我们要跳转到用户的订单列表页</span></span><br><span class="line"><span class="comment">     * produces 明确方法会返回什么类型，这里返回的是html页面</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderSn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AlipayApiException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payOrder&quot;,produces = &quot;text/html&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payOrder</span><span class="params">(<span class="meta">@RequestParam(&quot;orderSn&quot;)</span> String orderSn)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line"><span class="comment">//        PayVo payVo = new PayVo();</span></span><br><span class="line"><span class="comment">//        payVo.setBody(); // 商品描述</span></span><br><span class="line"><span class="comment">//        payVo.setSubject(); //订单名称</span></span><br><span class="line"><span class="comment">//        payVo.setOut_trade_no(); // 订单号</span></span><br><span class="line"><span class="comment">//        payVo.setTotal_amount(); //总金额</span></span><br><span class="line">        PayVo payvo = orderService.payOrder(orderSn);</span><br><span class="line">        <span class="comment">// 将返回支付宝的支付页面，需要将这个页面进行显示</span></span><br><span class="line">        String pay = alipayTemplate.pay(payvo);</span><br><span class="line">        System.out.println(pay);</span><br><span class="line">        <span class="keyword">return</span> pay;</span><br><span class="line">    &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="2%E3%80%81service-1" id="2、Service-v2">2、Service</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 计算商品支付需要的信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> orderSn</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PayVo <span class="title">payOrder</span><span class="params">(String orderSn)</span> </span>&#123;</span><br><span class="line">       PayVo payVo = <span class="keyword">new</span> PayVo();</span><br><span class="line">       OrderEntity orderEntity = <span class="keyword">this</span>.getOrderByOrderSn(orderSn);<span class="comment">// 根据订单号查询到商品</span></span><br><span class="line">       <span class="comment">// 数据库中付款金额小数有4位，但是支付宝只接受2位，所以向上取整两位数</span></span><br><span class="line">       BigDecimal decimal = orderEntity.getPayAmount().setScale(<span class="number">2</span>, BigDecimal.ROUND_UP);</span><br><span class="line">       payVo.setTotal_amount(decimal.toString());</span><br><span class="line">       <span class="comment">// 商户订单号</span></span><br><span class="line">       payVo.setOut_trade_no(orderSn);</span><br><span class="line">       <span class="comment">// 查询出订单项，用来设置商品的描述和商品名称</span></span><br><span class="line">       List&lt;OrderItemEntity&gt; itemEntities = orderItemService.list(<span class="keyword">new</span> QueryWrapper&lt;OrderItemEntity&gt;()</span><br><span class="line">               .eq(<span class="string">&quot;order_sn&quot;</span>, orderSn));</span><br><span class="line">       OrderItemEntity itemEntity = itemEntities.get(<span class="number">0</span>);</span><br><span class="line">       <span class="comment">// 订单名称使用商品项的名字</span></span><br><span class="line">       payVo.setSubject(itemEntity.getSkuName());</span><br><span class="line">       <span class="comment">// 商品的描述使用商品项的属性</span></span><br><span class="line">       payVo.setBody(itemEntity.getSkuAttrsVals());</span><br><span class="line">       <span class="keyword">return</span> payVo;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="3%E3%80%81%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E5%90%8E%E8%B7%B3%E8%BD%AC%E9%A1%B5%E9%9D%A2"
                                    id="3、支付成功后跳转页面">3、支付成功后跳转页面</h5>
                                <p>支付成功后跳转到<strong>订单页面</strong></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @需求描述: 系统管理员 会员服务组 模块 用户支付成功后跳转到该页面</span></span><br><span class="line"><span class="comment">   * @创建人: </span></span><br><span class="line"><span class="comment">   * @创建时间: 2021/01/08 11:13</span></span><br><span class="line"><span class="comment">   * @修改需求:</span></span><br><span class="line"><span class="comment">   * @修改人:</span></span><br><span class="line"><span class="comment">   * @修改时间:</span></span><br><span class="line"><span class="comment">   * @需求思路:</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/memberOrder.html&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">memberList</span><span class="params">(<span class="meta">@RequestParam(value = &quot;pageNum&quot;,defaultValue = &quot;1&quot;)</span> Integer pageNum, Model model)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 准备分页参数</span></span><br><span class="line">       Map&lt;String,Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">       params.put(<span class="string">&quot;page&quot;</span>,pageNum);</span><br><span class="line">       <span class="comment">// 远程查询当前用户的所有订单</span></span><br><span class="line">       R r = orderFeignService.listwithItem(params);</span><br><span class="line">       System.out.println(JSON.toJSONString(r));</span><br><span class="line">       <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">           model.addAttribute(<span class="string">&quot;orders&quot;</span>,r);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询当前用户所有订单</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PageUtils <span class="title">queryPageWithItem</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 当前用户登录数据</span></span><br><span class="line">       MemberRespVo memberRespVo = LoginInterceptor.loginUser.get();</span><br><span class="line">       <span class="comment">// 查询当前用户所有的订单记录</span></span><br><span class="line">       IPage&lt;OrderEntity&gt; page = <span class="keyword">this</span>.page(</span><br><span class="line">               <span class="keyword">new</span> Query&lt;OrderEntity&gt;().getPage(params),</span><br><span class="line">               <span class="keyword">new</span> QueryWrapper&lt;OrderEntity&gt;()</span><br><span class="line">                       .eq(<span class="string">&quot;member_id&quot;</span>,memberRespVo.getId())</span><br><span class="line">                       .orderByDesc(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">       );</span><br><span class="line">       List&lt;OrderEntity&gt; records = page.getRecords(); <span class="comment">// 拿到分页查询结果</span></span><br><span class="line">       List&lt;OrderEntity&gt; orderEntityList = records.stream().map(item -&gt; &#123;</span><br><span class="line">           <span class="comment">// 根据订单号查询当订单号对应的订单项</span></span><br><span class="line">           List&lt;OrderItemEntity&gt; itemEntities = orderItemService.list(<span class="keyword">new</span> QueryWrapper&lt;OrderItemEntity&gt;()</span><br><span class="line">                   .eq(<span class="string">&quot;order_sn&quot;</span>, item.getOrderSn()));</span><br><span class="line">           item.setOrderEntityItem(itemEntities);</span><br><span class="line">           <span class="keyword">return</span> item;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line">       <span class="comment">// 重新设置分页数据</span></span><br><span class="line">       page.setRecords(orderEntityList);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> PageUtils(page);</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>然后页面渲染数据</p>
                                <p>支付宝文档地址:</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://opendocs.alipay.com/open/270/105900">https://opendocs.alipay.com/open/270/105900</a>
                                </p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210108143131033.png"
                                        alt="image-20210108143131033" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210105093259313.png"
                                        alt="image-20210105093259313" /></p>
                                <h4 id="5%E3%80%81%E6%94%B6%E5%8D%95" id="5、收单">5、收单</h4>
                                <h5 id="%E8%AE%A2%E5%8D%95%EF%BC%9Aorderlistener" id="订单：OrderListener">订单：OrderListener
                                </h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;order.release.order.queue&quot;)</span> <span class="comment">// 监听订单的释放队列，能到这个里面的消息都是30分钟后过来的</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单定时关单</span></span><br><span class="line"><span class="comment">     *      商品下单后，会向MQ中发送一条消息告诉MQ订单创建成功。</span></span><br><span class="line"><span class="comment">     *      那么订单创建30分钟后用户还没有下单，MQ就会关闭该订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderEntity 订单对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel 信道</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listener</span><span class="params">(OrderEntity orderEntity, Channel channel, Message message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到过期的订单信息，准备关闭订单：&quot;</span> + orderEntity.getOrderSn());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderService.closeOrder(orderEntity);</span><br><span class="line">            <span class="comment">// 关闭订单成功后，ack信息确认</span></span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeOrder</span><span class="params">(OrderEntity orderEntity)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 订单30分钟的时间可能有属性变动，所以需要根据属性再次查询一次</span></span><br><span class="line">     OrderEntity entity = <span class="keyword">this</span>.getById(orderEntity.getId());</span><br><span class="line">     <span class="comment">// 当前状态为待付款，说明用户30分钟内还没有付款</span></span><br><span class="line">     <span class="keyword">if</span>(entity.getStatus() == OrderStatusEnum.CREATE_NEW.getCode()) &#123;</span><br><span class="line">         OrderEntity updateOrder = <span class="keyword">new</span> OrderEntity();</span><br><span class="line">         <span class="comment">// 根据订单id更新</span></span><br><span class="line">         updateOrder.setId(entity.getId());</span><br><span class="line">         <span class="comment">// 订单状态改成已取消</span></span><br><span class="line">         updateOrder.setStatus(OrderStatusEnum.CANCLED.getCode());</span><br><span class="line">         <span class="comment">// 根据订单对象更新</span></span><br><span class="line">         <span class="keyword">this</span>.updateById(updateOrder);</span><br><span class="line">         <span class="comment">// 准备共享对象用于发送到MQ中</span></span><br><span class="line">         OrderTo orderTo = <span class="keyword">new</span> OrderTo();</span><br><span class="line">         <span class="comment">// 拷贝属性</span></span><br><span class="line">         BeanUtils.copyProperties(entity,orderTo);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span>,<span class="string">&quot;order.release.other&quot;</span>,orderTo);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210105093437013.png"
                                        alt="image-20210105093437013" /></p>
                                <ul>
                                    <li>订单在支付页，不支付，一直刷新，订单过期了才支付，订单状态改为已支付了，但是库存解锁了。
                                        <ul>
                                            <li>使用支付宝自动收单功能解决。只要一段时间不支付，就不能支付了。</li>
                                        </ul>
                                    </li>
                                    <li>由于时延等问题。订单解锁完成，正在解锁库存的时候，异步通知才到
                                        <ul>
                                            <li>订单解锁，手动调用收单</li>
                                        </ul>
                                    </li>
                                    <li>网络阻塞问题，订单支付成功的异步通知一直不到达
                                        <ul>
                                            <li>查询订单列表时，ajax获取当前未支付的订单状态，查询订单状态时，再获取一下支付宝此订单的状态</li>
                                        </ul>
                                    </li>
                                    <li>其他各种问题
                                        <ul>
                                            <li>每天晚上闲时下载支付宝对账单，一 一 进行对账</li>
                                        </ul>
                                    </li>
                                </ul>
                                <h1 id="15%E3%80%81%E5%B9%82%E7%AD%89%E6%80%A7">15、幂等性</h1>
                                <h3 id="15.1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%82%E7%AD%89%E6%80%A7" id="15-1-什么是幂等性">
                                    15.1 什么是幂等性</h3>
                                <p><strong>接口幂等性就是用户对同一操作发起的一次请求和多次请求结果是一致的</strong>，不会因为多次点击而产生了副作用，比如支付场景，用户购买了商品，支付扣款成功，但是返回结果的时候出现了网络异常，此时钱已经扣了，用户再次点击按钮，此时就会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱了，流水记录也变成了两条。。。这就没有保证接口幂等性
                                </p>
                                <h3 id="15.2-%E9%82%A3%E4%BA%9B%E6%83%85%E5%86%B5%E9%9C%80%E8%A6%81%E9%98%B2%E6%AD%A2"
                                    id="15-2-那些情况需要防止">15.2 那些情况需要防止</h3>
                                <p>用户多次点击按钮</p>
                                <p>用户页面回退再次提交</p>
                                <p>微服务互相调用，由于网络问题，导致请求失败，feign触发重试机制</p>
                                <p>其他业务情况</p>
                                <h3 id="15.3-%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E9%9C%80%E8%A6%81%E5%B9%82%E7%AD%89"
                                    id="15-3-什么情况下需要幂等">15.3 什么情况下需要幂等</h3>
                                <p>以 SQL 为例，有些操作时天然<strong>幂等</strong>的</p>
                                <p>SELECT * FROM table WHERE id =? 无论执行多少次都不会改变状态是天然的<strong>幂等</strong></p>
                                <p>UPDATE tab1 SET col1=1 WHERE col2=2 无论执行成功多少状态都是一致的，也是<strong>幂等</strong>操作</p>
                                <p>delete from user where userid=1 多次操作，结果一样，具备<strong>幂等</strong>性</p>
                                <p>insert into user(userid,name) values(1,' a' )
                                    如userid为唯一主键，即重复上面的业务，只会插入一条用户记录，具备<strong>幂等</strong>性</p>
                                <hr />
                                <p>UPDATE tab1 SET col1=col1+1 WHERE col2=2,每次执行的结果都会发生变化，不是<strong>幂等</strong>的。insert
                                    into user(userid,name)
                                    values(,a&quot;)如userid不是主键，可以重复，那上面业务多次操作，数据都会新增多条，不具备<strong>幂等</strong>性。</p>
                                <h3 id="15.4-%E5%B9%82%E7%AD%89%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" id="15-4-幂等解决方案">
                                    15.4 幂等解决方案</h3>
                                <h4 id="1%E3%80%81token-%E6%9C%BA%E5%88%B6" id="1、token-机制">1、token 机制</h4>
                                <p>1、服务端提供了发送 <code>token</code> 的接口，我们在分析业务的时候，哪些业务是存在幂等性问题的，就必须在执行业务前，先获取
                                    <code>token</code>，服务器会把 <code>token</code> 保存到 redis 中</p>
                                <p>2、然后调用业务接口请求时， 把 <code>token</code> 携带过去，一般放在请求头部</p>
                                <p>3、服务器判断 <code>token</code> 是否存在 <code>redis</code>，存在表示第一次请求，然后删除
                                    <code>token</code>，继续执行业务</p>
                                <p>4、如果判断 <code>token</code> 不存在 <code>redis</code> 中，就表示重复操作，直接返回重复标记给
                                    <code>client</code>，这样就保证了业务代码，不被重复执行</p>
                                <p>危险性：</p>
                                <p><strong>1、先删除 token 还是后删除 token：</strong></p>
                                <ol>
                                    <li>先删除可能导致，业务确实没有执行，重试还得带上之前的 token, 由于防重设计导致，请求还是不能执行</li>
                                    <li>后删除可能导致，业务处理成功，但是服务闪断，出现超时，没有删除掉token，别人继续重试，导致业务被执行两次</li>
                                    <li>我们最后设计为先删除 token，如果业务调用失败，就重新获取 token 再次请求</li>
                                </ol>
                                <p><strong>2、Token 获取，比较 和删除 必须是原子性</strong></p>
                                <ol>
                                    <li>redis.get（token），token.equals、redis.del（token）,如果说这两个操作都不是原子，可能导致，在高并发下，都 get
                                        同样的数据，判断都成功，继续业务并发执行</li>
                                    <li>可以在 redis 使用 lua 脚本完成这个操作</li>
                                </ol>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;,KEYS[1]) else return 0 end&quot;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h4 id="2%E3%80%81%E5%90%84%E7%A7%8D%E9%94%81%E6%9C%BA%E5%88%B6" id="2、各种锁机制">2、各种锁机制
                                </h4>
                                <h5 id="1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E6%82%B2%E8%A7%82%E9%94%81" id="1、数据库悲观锁">
                                    1、数据库悲观锁</h5>
                                <p>select * from xxx where id = 1 for update;</p>
                                <p>for update 查询的时候锁定这条记录 别人需要等待</p>
                                <p>悲观锁使用的时候一般伴随事务一起使用，数据锁定时间可能会很长，需要根据实际情况选用，另外需要注意的是，id字段一定是主键或唯一索引，不然可能造成锁表的结果，处理起来会非常麻烦
                                </p>
                                <h5 id="2%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%B9%90%E8%A7%82%E9%94%81"
                                    id="2、数据库的乐观锁">2、数据库的乐观锁</h5>
                                <p>这种方法适合在更新的场景中</p>
                                <p>update t_goods set count = count - 1,version = version + 1 where good_id = 2 and
                                    version = 1</p>
                                <p>根据 version 版本，也就是在操作数据库存前先获取当前商品的 version 版本号，然后操作的时候带上 version
                                    版本号，我们梳理下，我们第一次操作库存时，得</p>
                                <p>到 version 为 1，调用库存服务 version = 2，但返回给订单服务出现了问题，订单服务又一次调用了库存服务，当订单服务传的 version 还是
                                    1，再执行上面的</p>
                                <p>sql 语句 就不会执行，因为 version 已经变成 2 了，where 条件不成立，这样就保证了不管调用几次，只会真正处理一次，乐观锁主要使用于处理读多写少的问题
                                </p>
                                <h5 id="3%E3%80%81%E4%B8%9A%E5%8A%A1%E5%B1%82%E5%88%86%E5%B8%83%E9%94%81" id="3、业务层分布锁">
                                    3、业务层分布锁</h5>
                                <p>如果多个机器可能在同一时间处理相同的数据，比如多台机器定时任务拿到了相同的数据，我们就可以加分布式锁，锁定此数据，处理完成后后释放锁，获取锁必须先判断这个数据是否被处理过
                                </p>
                                <h4 id="3%E3%80%81%E5%90%84%E7%A7%8D%E5%94%AF%E4%B8%80%E7%BA%A6%E6%9D%9F" id="3、各种唯一约束">
                                    3、各种唯一约束</h4>
                                <h5 id="1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%94%AF%E4%B8%80%E7%BA%A6%E6%9D%9F"
                                    id="1、数据库唯一约束">1、数据库唯一约束</h5>
                                <p>插入数据，应该按照唯一索引进行插入，比如订单号，相同订单就不可能有两条订单插入，我们在数据库层面防止重复</p>
                                <p>这个机制利用了数据库的主键唯一约束的特性，解决了 insert场 景时幂等问题，但主键的要求不是自增的主键，这样就需要业务生成全局唯一的主键</p>
                                <p>如果是分库分表场景下，路由规则要保证相同请求下，落地在同一个数据库和同一表中，要不然数据库主键约束就不起效果了，因为是不同的数据库和表主键不相关</p>
                                <h5 id="2%E3%80%81redis-set-%E9%98%B2%E9%87%8D" id="2、redis-set-防重">2、redis set 防重</h5>
                                <p>很多数据需要处理，只能被处理一次，比如我们可以计算数据的 MD5 将其放入 redis 的</p>
                                <p>set,每次处理数据，先看这个 MD5 是否已经存在，存在就不处理</p>
                                <h4 id="4%E3%80%81%E9%98%B2%E9%87%8D%E8%A1%A8" id="4、防重表">4、防重表</h4>
                                <p>使用订单表 <code>orderNo</code>
                                    做为去重表的唯一索引，把唯一索引插入去重表，再进行业务操作，且他们在同一个事务中，这样就保证了重复请求时，因为去重表有唯一</p>
                                <p>约束，导致请求失败，避免了幂等性等问题，去重表和业务表应该在同一个库中，这样就保证了在同一个事务，即使业务操作失败，也会把去重表的数据回滚，这</p>
                                <p>个很好的保证了数据的一致性，</p>
                                <p>redis防重也算</p>
                                <h4 id="5%E3%80%81%E5%85%A8%E5%B1%80%E8%AF%B7%E6%B1%82%E5%94%AF%E4%B8%80id"
                                    id="5、全局请求唯一id">5、全局请求唯一id</h4>
                                <p>调用接口时，生成一个唯一的id，redis 将数据保存到集合中（去重），存在即处理过，可以使用 nginx 设置每一个请求一个唯一id</p>
                                <p>proxy_set_header X-Request-Id $Request_id</p>
                                <h1 id="16%E3%80%81%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1">16、本地事务</h1>
                                <h3 id="16.1-%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%80%A7%E8%B4%A8"
                                    id="16-1-事务的基本性质">16.1 事务的基本性质</h3>
                                <p>数据库事物的几个特性：原子性（Atomiccity）、一致性（Consistetcy）、隔离性或独立性（Isolation）和持久性（Durabilily），简称ACID
                                </p>
                                <ul>
                                    <li>**原子性：**一系列操作整体不可拆分，要么同时成功要么同时失败</li>
                                    <li><strong>一致性</strong>：数据在业务的前后，业务整体一致
                                        <ul>
                                            <li>转账 A:1000 B:1000 转200 事务成功 A：800 B：1200</li>
                                        </ul>
                                    </li>
                                    <li>**隔离性：**事物之间需要相互隔离</li>
                                    <li>**持久性：**一旦事务成功，数据一定会落盘在数据库</li>
                                </ul>
                                <p>在以往的单体应用中，我们多个业务操作使用同一条连接操作不同的表，一旦有异常我们很容易整体回滚</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201119115615054.png"
                                        alt="image-20201119115615054" /></p>
                                <p><strong>Business</strong>：我们具体的业务代码<br />
                                    <strong>Storage</strong>：库存业务代码;扣库存<br />
                                    <strong>Order</strong>：订单业务代码;保存订单<br />
                                    <strong>Account</strong>：账号业务代码:减账户余额<br />
                                    比如买东西业务，扣库存，下订单，账户扣款，是一个整体；必须同时成功或者失败
                                </p>
                                <p>一个事务开始，代表以下的所有操作都在同一个连接里面</p>
                                <h3 id="16.2-%E4%BA%8B%E7%89%A9%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"
                                    id="16-2-事物的隔离级别">16.2 事物的隔离级别</h3>
                                <ul>
                                    <li><strong>READ UNCOMMITEED(读未提交)</strong>
                                        <ul>
                                            <li>该隔离级别的事务会读到其他未提交事务的数据，此现象也称为脏读</li>
                                        </ul>
                                    </li>
                                    <li><strong>READ COMMITTED（读提交）</strong>
                                        <ul>
                                            <li>一个事物可以读取另一个已提交的事务，多次读取会造成不一样的结果，此现象称为不可重复读，复读问题，Oracle 和SQL Server
                                                的默认隔离级别</li>
                                        </ul>
                                    </li>
                                    <li><strong>REPEATABLE READ（可重复读）</strong>
                                        <ul>
                                            <li>该隔离级别是 MySQL 默认的隔离级别，在同一个事物中，SELECT 的结果是事务开始时时间点的状态，因此，同样的 SELECT
                                                操作读到的结果会是一致</li>
                                            <li>但是会有幻读一致,MySQL的 InnoDB 引擎可以通过 next-key locks 机制 来避免幻读</li>
                                        </ul>
                                    </li>
                                    <li><strong>SERIALIZABLE（序列化）</strong>
                                        <ul>
                                            <li>在该隔离级别下事务都是串行顺序执行的，MySQL 数据库的 InnoDB
                                                引擎会给读操作隐士加一把读共享锁，从而避免了脏读、不可重复读、幻读等问题</li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>越大的隔离级别，并发能力越低</p>
                                <h3 id="16.3-%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA" id="16-3-事务传播行为">
                                    16.3 事务传播行为</h3>
                                <p>**PROPAGATION_REQUIRED：**如果当前没事事务，就创建一个新事务，如果当前存在事务，就加入该事务，该设置时最常使用的配置</p>
                                <p>**PROPAGATION_SUPPORTS：**支持当前事务。如果当前存在事务，就加入该事务，如果当前不存在事务，就以非事务执行</p>
                                <p>**PROPAGATION_MANDATORY：**支持当前事务，如果当前存在事务，就加入该事务，如果当前不存在该事务，就抛出异常</p>
                                <p>**PROPAGATION_REQUIRES_NEW：**创建新事务，无论当前存不存在事务，都创建新事务</p>
                                <p>**PROPAGATION_NOT_SUPPORTED：**以非事务的方式执行操作，如果当前存在事务，就把当前事务挂起</p>
                                <p>**PROPAGATION_NEVER：**以非事务方式运行，如果当前存在事务，则抛出异常</p>
                                <p>**PROPAGATION_NESTED：**如果当前存在事务，就嵌套在该事务内执行，如果当前没有事务，则执行PROPAGATION_REQUIRED相关操作</p>
                                <h3 id="16.4-springboot-%E4%BA%8B%E5%8A%A1%E5%85%B3%E9%94%AE%E7%82%B9"
                                    id="16-4-SpringBoot-事务关键点">16.4 SpringBoot 事务关键点</h3>
                                <p>在同一个事物内编写两个方法，内部调用的时候，会导致事务失效，原因是没有用到代理对象的缘故</p>
                                <p>解决</p>
                                <p>0)、导入spring-boot-starter-aop<br />
                                    1)、@EnableTransactionManagement(proxyTargetClass= true)<br />
                                    2)、@EnableAspectJAutoProxy(lexposeProxy-true)<br />
                                    3)、AopContext.currentProxy() 调用方法</p>
                                <h4 id="1%E3%80%81%E4%BA%8B%E7%89%A9%E7%9A%84%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"
                                    id="1、事物的自动配置">1、事物的自动配置</h4>
                                <h4 id="2%E3%80%81%E4%BA%8B%E7%89%A9%E7%9A%84%E5%9D%91" id="2、事物的坑">2、事物的坑</h4>
                                <h1 id="17%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1">17、分布式事务</h1>
                                <h3 id="17.1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"
                                    id="17-1-为什么要有分布式事务">17.1 为什么要有分布式事务</h3>
                                <p>分布式系统经常出现的异常</p>
                                <p>机器宕机、网络异常、消息丢失、消息乱序、不可靠的TCP、存储数据丢失....</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201119170602679.png"
                                        alt="image-20201119170602679" /></p>
                                <p>分布式事务是企业中集成的一个难点，也是每一个分布式系统架构中都会涉及到的一个东西，特别是在微服务架构中，几乎是无法避免的</p>
                                <h3 id="17.2-cap-%E5%AE%9A%E7%90%86%E4%B8%8E-base-%E7%90%86%E8%AE%BA"
                                    id="17-2-CAP-定理与-BASE-理论">17.2 CAP 定理与 BASE 理论</h3>
                                <h4 id="1%E3%80%81cap-%E5%AE%9A%E7%90%86" id="1、CAP-定理">1、CAP 定理</h4>
                                <p>CAP 原则又称 CAP 定理指的是在一个分布式系统中</p>
                                <ul>
                                    <li><strong>一致性（Consistency）</strong>
                                        <ul>
                                            <li>在分布式系统中所有数据备份，在同一时刻是否是同样的值，（等同于所有节点访问同一份最新数据的副本）</li>
                                        </ul>
                                    </li>
                                    <li><strong>可用性（Avaliability）</strong>
                                        <ul>
                                            <li>在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求，（对数据更新具备高可用性）</li>
                                        </ul>
                                    </li>
                                    <li><strong>分区容错性（Partition tolerance）</strong>
                                        <ul>
                                            <li>大多数分布式系统都分布在多个子网络，每个自网络叫做一个区（partition）。分区容错性的意思是，区间通信可能失败，比如，一台服务器放在中国另一台服务器放在美国，这就是两个区，它们之间可能无法通信
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                                <p>CAP 的原则是，这三个要素最多只能满足两个点，<strong>不可能三者兼顾</strong></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201119194354467.png"
                                        alt="image-20201119194354467" /></p>
                                <p>一般来说，分区容错无法避免，因此我们可以认为 CAP 的 P 总是成立，CAP 定理告诉我们 剩下的 C 和 A 无法同时做到</p>
                                <p>分布式实现一致性的 raft 算法</p>
                                <p><a target="_blank" rel="noopener"
                                        href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a>
                                </p>
                                <h4 id="2%E3%80%81%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE" id="2、面临的问">2、面临的问</h4>
                                <p>对于大多数互联网应用的场景、主机众多、部署分散，而且集群规模越来越大，所以节点故障，网络故障是常态，而且要保证服务可用性达到99.999%，即保证P 和 A,舍弃C
                                </p>
                                <h4 id="3%E3%80%81base-%E7%90%86%E8%AE%BA" id="3、BASE-理论">3、BASE 理论</h4>
                                <p>是对CAP的延申，思想即是无法做到强一致性（CAP的一致性就是强一致性），但可以采用适当的弱一致性，即<strong>最终一致性</strong></p>
                                <p>BASE 是指</p>
                                <ul>
                                    <li>基本可用（Basically Avaliable）
                                        <ul>
                                            <li>基本可用是指分布式系统中在出现故障的时候，允许损失部分可用性（列入响应时间，功能上的可用性）允许损失部分可用性。需要注意的是基本可用不等价于系统不可用
                                            </li>
                                            <li>响应时间上的损失，正常情况下搜索引擎需要在0.5秒之内返回给用户相应的查询结果，但由于出现故障（比如系统部分机房断电断网故障），查询的结果响应时间增加到了1~2秒
                                            </li>
                                            <li>功能上的损失，购物网站双十一购物高峰，为了保证系统的稳定性，部分消费者会被引入到一个降级页面</li>
                                        </ul>
                                    </li>
                                    <li><strong>软状态（Soft State）</strong>
                                        <ul>
                                            <li>软状态是指允许 系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据会有
                                                多个副本，允许不同副本同步的延时就是软状态的体现。mysglreplication的异步复制也是一种体现。</li>
                                        </ul>
                                    </li>
                                    <li><strong>最终一致性( Eventual Consistency)</strong>
                                        <ul>
                                            <li>最终致性是指系统中的所有数据副本经过一定时间后，最终能够达到一 致的状态。弱一致性和强一致性相反，最终-致性是弱一致性的一种特殊情况。</li>
                                        </ul>
                                    </li>
                                </ul>
                                <h4 id="4%E3%80%81%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E3%80%81%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7%E3%80%81%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"
                                    id="4、强一致性、弱一致性、最终一致性">4、强一致性、弱一致性、最终一致性</h4>
                                <p>从客户端角度，多进程并发访问时，更新过的数据在不同进程如何获取的不同策略，决定了不同的一致性。对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。如果能容忍后续的部分或者全部访问不到，则是弱一致性。如果经过一段时间后要求能访问到更新后的数据，则是最终一致性
                                </p>
                                <h3 id="17.3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%A1%88"
                                    id="17-3-分布式事务的几种方案">17.3 分布式事务的几种方案</h3>
                                <h4 id="1%E3%80%812pc-%E6%A8%A1%E5%BC%8F" id="1、2PC-模式">1、2PC 模式</h4>
                                <p>数据库支持的 2PC[2 phase commit 二阶提交]，又叫 XA Transactions</p>
                                <p>MySQL 从5.5版本开始支持，Sql Server 2005 开始支持，oracle7 开始支持</p>
                                <p>其中，XA 是一个两阶段提交协议，该协议分为两个阶段：</p>
                                <p>第一阶段：事务协调器要求每个涉及到事务的数据库预提交（precommit）此操作，并反应是否可以提交</p>
                                <p>第二阶段：事务协调器要求每个数据库提交数据</p>
                                <p>其中，如果有任何一个数据库否认这次提交，那么所有数据库都会要求回滚他们在此事务中的那部分信息</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120090516086.png"
                                        alt="image-20201120090516086" /></p>
                                <ul>
                                    <li>XA协议比较简单，而且一旦商业数据库实现了XA协议，使用分布式事务的成本也比较低。</li>
                                    <li>XA性能不理想，特别是在交易下单链路，往往并发量很高，XA无法满足高并发场景</li>
                                    <li>XA目前在商业数据库支持的比较理想，在mysq!数据库中支持的不太理想，mysgl的</li>
                                    <li>XA实现，没有记录prepare阶段日志，主备切换回导致主库与备库数据不一致。</li>
                                    <li>许多nosgI也没有支持XA，这让XA的应用场景变得非常狭隘。</li>
                                    <li>也有3PC,引入了超时机制(无论协调者还是参与者，在向对方发送请求后，若长时间未收到回应则做出相应处理)</li>
                                </ul>
                                <h4 id="2%E3%80%81%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1---tcc-%E4%BA%8B%E5%8A%A1"
                                    id="2、柔性事务-TCC-事务">2、柔性事务 - TCC 事务</h4>
                                <p>刚性事务:遵循ACID原则，强一致性。<br />
                                    柔性事务:遵循BASE理论，最终一致性;<br />
                                    与刚性事务不同，柔性事务允许一定时间内，不同节点的数据不一致，但要求最终一致。</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201120090923734.png"
                                        alt="image-20201120090923734" /></p>
                                <p>一阶段 prepare 行为:调用自定义的 prepare 逻辑。<br />
                                    二阶段 commit 行为:调用自定义的 commit 逻辑。<br />
                                    二阶段 rollback行为:调用自定义的 rollback 逻辑。<br />
                                    所谓TCC模式，是指支持把自定义的分支事务纳入到全局事务的管理中。</p>
                                <h4 id="3%E3%80%81%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1---%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%E5%9E%8B%E6%96%B9%E6%A1%88"
                                    id="3、柔性事务-最大努力通知型方案">3、柔性事务 - 最大努力通知型方案</h4>
                                <p>按规律进行通知，<strong>不保证数据定能通知成功，
                                        但会提供可查询操作接口进行核对</strong>。这种方案主要用在与第三方系统通讯时，比如:调用微信或支付宝支付后的支付结果通知。这种方案也是结合MQ进行实现，例如:通过MQ发送http请求，设置最大通知次数。达到通知次数后即不再通知。
                                </p>
                                <p>案例:银行通知、商户通知等(各大交易业务平台间的商户通知:多次通知、查询校对、对账文件)，支付宝的支付成功异步回调</p>
                                <h4 id="4%E3%80%81%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1---%E5%8F%AF%E9%9D%A0%E4%BF%A1%E6%81%AF-%2B-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5%E5%9E%8B%EF%BC%89"
                                    id="4、柔性事务-可靠信息-最终一致性方案（异步通知型）">4、柔性事务 - 可靠信息 + 最终一致性方案（异步通知型）</h4>
                                <p>实现:业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，实时消息服务只记录消息数据，而不是真正的发送。业务处理服务在业务事务提交之后，向实时消息服务确认发送。只有在得到确认发送指令后，实时消息服务才会真正发送。
                                </p>
                                <h1 id="18%E3%80%81%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98">18、支付宝支付</h1>
                                <h3 id="1%E3%80%81%E8%BF%9B%E5%85%A5%E8%9A%82%E8%9A%81%E9%87%91%E6%9C%8D%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0"
                                    id="1、进入蚂蚁金服开放平台">1、进入蚂蚁金服开放平台</h3>
                                <p><a target="_blank" rel="noopener"
                                        href="https://open.alipay.com/platform/home.htm">https://open.alipay.com/platform/home.htm</a>
                                </p>
                                <p>2、下载支付宝官方Demo，进行配置和测试</p>
                                <p>文档地址：</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://openhome.alipay.com/docCenter/docCenter.htm">https://openhome.alipay.com/docCenter/docCenter.htm</a>
                                    创建应用对应文档</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://opendocs.alipay.com/open/200/105304">https://opendocs.alipay.com/open/200/105304</a>
                                    网页移动应用文档</p>
                                <p><a target="_blank" rel="noopener"
                                        href="https://opendocs.alipay.com/open/54/cyz7do">https://opendocs.alipay.com/open/54/cyz7do</a>
                                    相关Demo</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201122123349754.png"
                                        alt="image-20201122123349754" /></p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201122114005616.png"
                                        alt="image-20201122114005616" />密码</p>
                                <p>创建应用</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201122113922427.png"
                                        alt="image-20201122113922427" /></p>
                                <h3 id="3%E3%80%81%E4%BD%BF%E7%94%A8%E6%B2%99%E7%AE%B1%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"
                                    id="3、使用沙箱进行测试">3、使用沙箱进行测试</h3>
                                <p><a target="_blank" rel="noopener"
                                        href="https://openhome.alipay.com/platform/appDaily.htm?tab=info">https://openhome.alipay.com/platform/appDaily.htm?tab=info</a>
                                </p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201122125716179.png"
                                        alt="image-20201122125716179" /></p>
                                <h3 id="4%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E5%85%AC%E9%92%A5%E3%80%81%E7%A7%81%E9%92%A5%E3%80%81%E5%8A%A0%E5%AF%86%E3%80%81%E7%AD%BE%E5%90%8D%E5%92%8C%E9%AA%8C%E7%AD%BE%3F"
                                    id="4、什么是公钥、私钥、加密、签名和验签">4、什么是公钥、私钥、加密、签名和验签?</h3>
                                <p>1、公钥私钥<br />
                                    公钥和私钥是一一个相对概念</p>
                                <p>它们的公私性是相对于生成者来说的。</p>
                                <p>一对密钥生成后，保存在生成者手里的就是私钥，生成者发布出去大家用的就是公钥</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201122174141878.png"
                                        alt="image-20201122174141878" /></p>
                                <h3 id="5%E3%80%81%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B"
                                    id="5、支付宝支付流程">5、支付宝支付流程</h3>
                                <p><a target="_blank" rel="noopener"
                                        href="https://opendocs.alipay.com/open/270/105898">https://opendocs.alipay.com/open/270/105898</a>
                                </p>
                                <h4 id="1%E3%80%81%E5%BC%95%E5%AF%BC%E7%94%A8%E6%88%B7%E8%BF%9B%E5%85%A5%E5%88%B0%E6%94%AF%E4%BB%98%E5%AE%9D%E9%A1%B5%E9%9D%A2"
                                    id="1、引导用户进入到支付宝页面">1、引导用户进入到支付宝页面</h4>
                                <h5 id="1%E3%80%81pom.xml" id="1、pom-xml">1、pom.xml</h5>
                                <figure class="highlight xml">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">&lt;!--支付宝模块--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9.28.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="2%E3%80%81%E5%B0%86%E7%B4%A0%E6%9D%90%E6%8F%90%E4%BE%9B%E7%9A%84%E6%96%87%E4%BB%B6%E5%BC%95%E5%85%A5%E5%88%B0%E9%A1%B9%E7%9B%AE%E4%B8%AD"
                                    id="2、将素材提供的文件引入到项目中">2、将素材提供的文件引入到项目中</h5>
                                <p><strong>AlipayTemplate、PayVo、PaySyncVo</strong></p>
                                <h6 id="alipaytemplate" id="AlipayTemplate">AlipayTemplate</h6>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">package</span> com.atguigu.gulimall.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayApiException;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.DefaultAlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.request.AlipayTradePagePayRequest;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.gulimall.order.vo.PayVo;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;alipay&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlipayTemplate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在支付宝创建的应用的id</span></span><br><span class="line">    <span class="keyword">private</span>   String app_id = <span class="string">&quot;2016092200568607&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商户私钥，您的PKCS8格式RSA2私钥</span></span><br><span class="line">    <span class="keyword">private</span>  String merchant_private_key = <span class="string">&quot;XXX&quot;</span>;</span><br><span class="line">    <span class="comment">// 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。</span></span><br><span class="line">    <span class="keyword">private</span>  String alipay_public_key = <span class="string">&quot;XXX&quot;</span>;</span><br><span class="line">    <span class="comment">// 服务器[异步通知]页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">// 支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息</span></span><br><span class="line">    <span class="keyword">private</span>  String notify_url = <span class="string">&quot;http://member.gulimall.com/memberOrder.html&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 页面跳转同步通知页面路径 需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">//同步通知，支付成功，一般跳转到成功页</span></span><br><span class="line">    <span class="keyword">private</span>  String return_url = <span class="string">&quot;http://member.gulimall.com/memberOrder.html&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 签名方式</span></span><br><span class="line">    <span class="keyword">private</span>  String sign_type = <span class="string">&quot;RSA2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符编码格式</span></span><br><span class="line">    <span class="keyword">private</span>  String charset = <span class="string">&quot;utf-8&quot;</span>;</span><br><span class="line">    <span class="comment">// 订单超时时间，到达超时时间后自动关闭订单不能再继续支付</span></span><br><span class="line">    <span class="keyword">private</span> String timeout = <span class="string">&quot;30m&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支付宝网关； https://openapi.alipaydev.com/gateway.do</span></span><br><span class="line">    <span class="keyword">private</span>  String gatewayUrl = <span class="string">&quot;https://openapi.alipaydev.com/gateway.do&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">pay</span><span class="params">(PayVo vo)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, &quot;json&quot;, AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);</span></span><br><span class="line">        <span class="comment">//1、根据支付宝的配置生成一个支付客户端</span></span><br><span class="line">        AlipayClient alipayClient = <span class="keyword">new</span> DefaultAlipayClient(gatewayUrl,</span><br><span class="line">                app_id, merchant_private_key, <span class="string">&quot;json&quot;</span>,</span><br><span class="line">                charset, alipay_public_key, sign_type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、创建一个支付请求 //设置请求参数</span></span><br><span class="line">        AlipayTradePagePayRequest alipayRequest = <span class="keyword">new</span> AlipayTradePagePayRequest();</span><br><span class="line">        alipayRequest.setReturnUrl(return_url);</span><br><span class="line">        alipayRequest.setNotifyUrl(notify_url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//商户订单号，商户网站订单系统中唯一订单号，必填</span></span><br><span class="line">        String out_trade_no = vo.getOut_trade_no();</span><br><span class="line">        <span class="comment">//付款金额，必填</span></span><br><span class="line">        String total_amount = vo.getTotal_amount();</span><br><span class="line">        <span class="comment">//订单名称，必填</span></span><br><span class="line">        String subject = vo.getSubject();</span><br><span class="line">        <span class="comment">//商品描述，可空</span></span><br><span class="line">        String body = vo.getBody();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// timeout_express 订单支付超时时间</span></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">&quot;&#123;\&quot;out_trade_no\&quot;:\&quot;&quot;</span>+ out_trade_no +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;total_amount\&quot;:\&quot;&quot;</span>+ total_amount +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;subject\&quot;:\&quot;&quot;</span>+ subject +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;body\&quot;:\&quot;&quot;</span>+ body +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;timeout_express\&quot;:\&quot;&quot;</span> + timeout + <span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;product_code\&quot;:\&quot;FAST_INSTANT_TRADE_PAY\&quot;&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String result = alipayClient.pageExecute(alipayRequest).getBody();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//会收到支付宝的响应，响应的是一个页面，只要浏览器显示这个页面，就会自动来到支付宝的收银台页面</span></span><br><span class="line">        System.out.println(<span class="string">&quot;支付宝的响应：&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h6 id="payvo" id="PayVo">PayVo</h6>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">package</span> com.atguigu.gulimall.order.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付使用Vo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayVo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String out_trade_no; <span class="comment">// 商户订单号 必填</span></span><br><span class="line">    <span class="keyword">private</span> String subject; <span class="comment">// 订单名称 必填</span></span><br><span class="line">    <span class="keyword">private</span> String total_amount;  <span class="comment">// 付款金额 必填</span></span><br><span class="line">    <span class="keyword">private</span> String body; <span class="comment">// 商品描述 可空</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h6 id="payasyncvo" id="payAsyncVo">payAsyncVo</h6>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="keyword">package</span> com.atguigu.gulimall.order.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付宝回调参数Vo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayAsyncVo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String gmt_create;</span><br><span class="line">    <span class="keyword">private</span> String charset;</span><br><span class="line">    <span class="keyword">private</span> String gmt_payment;</span><br><span class="line">    <span class="keyword">private</span> Date notify_time;</span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line">    <span class="keyword">private</span> String sign;</span><br><span class="line">    <span class="keyword">private</span> String buyer_id;<span class="comment">//支付者的id</span></span><br><span class="line">    <span class="keyword">private</span> String body;<span class="comment">//订单的信息</span></span><br><span class="line">    <span class="keyword">private</span> String invoice_amount;<span class="comment">//支付金额</span></span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line">    <span class="keyword">private</span> String notify_id;<span class="comment">//通知id</span></span><br><span class="line">    <span class="keyword">private</span> String fund_bill_list;</span><br><span class="line">    <span class="keyword">private</span> String notify_type;<span class="comment">//通知类型； trade_status_sync</span></span><br><span class="line">    <span class="keyword">private</span> String out_trade_no;<span class="comment">//订单号</span></span><br><span class="line">    <span class="keyword">private</span> String total_amount;<span class="comment">//支付的总额</span></span><br><span class="line">    <span class="keyword">private</span> String trade_status;<span class="comment">//交易状态  TRADE_SUCCESS</span></span><br><span class="line">    <span class="keyword">private</span> String trade_no;<span class="comment">//流水号</span></span><br><span class="line">    <span class="keyword">private</span> String auth_app_id;<span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> String receipt_amount;<span class="comment">//商家收到的款</span></span><br><span class="line">    <span class="keyword">private</span> String point_amount;<span class="comment">//</span></span><br><span class="line">    <span class="keyword">private</span> String app_id;<span class="comment">//应用id</span></span><br><span class="line">    <span class="keyword">private</span> String buyer_pay_amount;<span class="comment">//最终支付的金额</span></span><br><span class="line">    <span class="keyword">private</span> String sign_type;<span class="comment">//签名类型</span></span><br><span class="line">    <span class="keyword">private</span> String seller_id;<span class="comment">//商家的id</span></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h5 id="3%E3%80%81%E7%BC%96%E5%86%99%E4%B8%9A%E5%8A%A1%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%94%AF%E4%BB%98%E9%A1%B5%E9%9D%A2"
                                    id="3、编写业务跳转到支付页面">3、编写业务跳转到支付页面</h5>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2021-01-08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayWebController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AlipayTemplate alipayTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、跳转到支付页面</span></span><br><span class="line"><span class="comment">     * 2、用户支付成功后，我们要跳转到用户的订单列表页</span></span><br><span class="line"><span class="comment">     * produces 明确方法会返回什么类型，这里返回的是html页面</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderSn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AlipayApiException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payOrder&quot;,produces = &quot;text/html&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">payOrder</span><span class="params">(<span class="meta">@RequestParam(&quot;orderSn&quot;)</span> String orderSn)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line"><span class="comment">//        PayVo payVo = new PayVo();</span></span><br><span class="line"><span class="comment">//        payVo.setBody(); // 商品描述</span></span><br><span class="line"><span class="comment">//        payVo.setSubject(); //订单名称</span></span><br><span class="line"><span class="comment">//        payVo.setOut_trade_no(); // 订单号</span></span><br><span class="line"><span class="comment">//        payVo.setTotal_amount(); //总金额</span></span><br><span class="line">        PayVo payvo = orderService.payOrder(orderSn);</span><br><span class="line">        <span class="comment">// 将返回支付宝的支付页面，需要将这个页面进行显示</span></span><br><span class="line">        String pay = alipayTemplate.pay(payvo);</span><br><span class="line">        System.out.println(pay);</span><br><span class="line">        <span class="keyword">return</span> pay;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h6 id="service" id="Service">Service</h6>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 计算商品支付需要的信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> orderSn</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PayVo <span class="title">payOrder</span><span class="params">(String orderSn)</span> </span>&#123;</span><br><span class="line">       PayVo payVo = <span class="keyword">new</span> PayVo();</span><br><span class="line">       OrderEntity orderEntity = <span class="keyword">this</span>.getOrderByOrderSn(orderSn); <span class="comment">// 根据订单号查询到商品</span></span><br><span class="line">       <span class="comment">// 数据库中付款金额小数有4位，但是支付宝只接受2位，所以向上取整两位数</span></span><br><span class="line">       BigDecimal decimal = orderEntity.getPayAmount().setScale(<span class="number">2</span>, BigDecimal.ROUND_UP);</span><br><span class="line">       payVo.setTotal_amount(decimal.toString());</span><br><span class="line">       <span class="comment">// 商户订单号</span></span><br><span class="line">       payVo.setOut_trade_no(orderSn);</span><br><span class="line">       <span class="comment">// 查询出订单项，用来设置商品的描述和商品名称</span></span><br><span class="line">       List&lt;OrderItemEntity&gt; itemEntities = orderItemService.list(<span class="keyword">new</span> QueryWrapper&lt;OrderItemEntity&gt;()</span><br><span class="line">               .eq(<span class="string">&quot;order_sn&quot;</span>, orderSn));</span><br><span class="line">       OrderItemEntity itemEntity = itemEntities.get(<span class="number">0</span>);</span><br><span class="line">       <span class="comment">// 订单名称使用商品项的名字</span></span><br><span class="line">       payVo.setSubject(itemEntity.getSkuName());</span><br><span class="line">       <span class="comment">// 商品的描述使用商品项的属性</span></span><br><span class="line">       payVo.setBody(itemEntity.getSkuAttrsVals());</span><br><span class="line">       <span class="keyword">return</span> payVo;</span><br><span class="line">   &#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>最后生成页面</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210108162512457.png"
                                        alt="image-20210108162512457" /></p>
                                <h4 id="2%E3%80%81%E7%94%A8%E6%88%B7%E7%82%B9%E5%87%BB%E4%BB%98%E6%AC%BE" id="2、用户点击付款">
                                    2、用户点击付款</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210108162541917.png"
                                        alt="image-20210108162541917" /></p>
                                <h4 id="3%E3%80%81%E4%BB%98%E6%AC%BE%E6%88%90%E5%8A%9F%E5%90%8E%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%88%90%E5%8A%9F%E9%A1%B5%E9%9D%A2"
                                    id="3、付款成功后跳转到成功页面">3、付款成功后跳转到成功页面</h4>
                                <p><span style="color:red">跳转的页面是根据AlipayTemplate定义的回调地址来进行跳转</span></p>
                                <ul>
                                    <li>notify_url：<strong>支付成功异步回调，返回支付成功相关的信息</strong></li>
                                    <li>return_url：<strong>同步通知，支付成功后页面跳转到那里</strong></li>
                                </ul>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line">   <span class="comment">// 服务器[异步通知]页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">// 支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息</span></span><br><span class="line">    <span class="keyword">private</span>  String notify_url = <span class="string">&quot;http://member.gulimall.com/memberOrder.html&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面跳转同步通知页面路径 需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">//同步通知，支付成功，一般跳转到成功页</span></span><br><span class="line">    <span class="keyword">private</span>  String return_url = <span class="string">&quot;http://member.gulimall.com/memberOrder.html&quot;</span>;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <blockquote>
                                    <p>这里跳转到的<strong>会员服务的订单页面</strong>，需要自己处理请求,<strong>已在14.4.4.3节完成该功能</strong></p>
                                </blockquote>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210108162610017.png"
                                        alt="image-20210108162610017" /></p>
                                <h5 id="1%E3%80%81%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E5%90%8E%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3%E5%A4%84%E7%90%86"
                                    id="1、支付成功后异步回调接口处理">1、支付成功后异步回调接口处理</h5>
                                <p><span style="color:blue;font-size:18px">需要有服务器或配置了内网穿透才能接收到该方法</span></p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付宝成功异步回调</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2021-01-08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderPayedListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AlipayTemplate alipayTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付宝异步通知回调接口,需要拥有内网穿透或服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/payed/notify&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleAlipayed</span><span class="params">(PayAsyncVo vo, HttpServletRequest request)</span> <span class="keyword">throws</span> UnsupportedEncodingException, AlipayApiException </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 重要一步验签名</span></span><br><span class="line"><span class="comment">         *  防止别人通过postman给我们发送一个请求，告诉我们请求成功，为了防止这种效果通过验签</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Map&lt;String,String&gt; params = <span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line">        Map&lt;String,String[]&gt; requestParams = request.getParameterMap();</span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;String&gt; iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;</span><br><span class="line">            String name = (String) iter.next();</span><br><span class="line">            String[] values = (String[]) requestParams.get(name);</span><br><span class="line">            String valueStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">                valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                        : valueStr + values[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//乱码解决，这段代码在出现乱码时使用</span></span><br><span class="line">            valueStr = <span class="keyword">new</span> String(valueStr.getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>), <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            params.put(name, valueStr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 支付宝验签 防止恶意提交</span></span><br><span class="line">        <span class="keyword">boolean</span> signVerified = AlipaySignature.rsaCheckV1(params</span><br><span class="line">                , alipayTemplate.getAlipay_public_key()</span><br><span class="line">                , alipayTemplate.getCharset()</span><br><span class="line">                , alipayTemplate.getSign_type());</span><br><span class="line">        <span class="keyword">if</span> (signVerified) &#123;</span><br><span class="line">            String result = orderService.handleAlipayed(vo);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>Service</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">handleAlipayed</span><span class="params">(PayAsyncVo vo)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 保存交易流水信息,每个月和支付宝进行对账</span></span><br><span class="line">       PaymentInfoEntity infoEntity = <span class="keyword">new</span> PaymentInfoEntity();</span><br><span class="line">       <span class="comment">// 设置核心字段</span></span><br><span class="line">       infoEntity.setOrderSn(vo.getOut_trade_no());</span><br><span class="line">       infoEntity.setAlipayTradeNo(vo.getTrade_no());</span><br><span class="line">       infoEntity.setPaymentStatus(vo.getTrade_status());</span><br><span class="line">       infoEntity.setCallbackTime(vo.getNotify_time());</span><br><span class="line">       <span class="comment">// 保存订单流水</span></span><br><span class="line">       paymentInfoService.save(infoEntity);</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 支付宝交易状态说明</span></span><br><span class="line"><span class="comment">        *      https://opendocs.alipay.com/open/270/105902</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">// TRADE_FINISHED 交易结束、不可退款</span></span><br><span class="line">       <span class="comment">// TRADE_SUCCESS 交易支付成功</span></span><br><span class="line">       <span class="keyword">if</span> (vo.getTrade_status().equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>) || vo.getTrade_status().equals(<span class="string">&quot;TRADE_FINISHED&quot;</span>)) &#123;</span><br><span class="line">           String outTradeNo = vo.getOut_trade_no();</span><br><span class="line">           <span class="comment">// 支付宝回调成功后，更改订单的支付状态位已支付</span></span><br><span class="line">           <span class="keyword">this</span>.baseMapper.updateOrderStatus(outTradeNo,OrderStatusEnum.PAYED.getCode());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="6%E3%80%81%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F" id="6、内网穿透">6、内网穿透</h3>
                                <h4 id="1%E3%80%81%E7%AE%80%E4%BB%8B-3" id="1、简介-v4">1、简介</h4>
                                <p>内网穿透功能可以允许我们使用外网的网址来访问主机<br />
                                    正常的外网需要访问我们项目的流程是:</p>
                                <p>1、买服务器并且有公网固定IP</p>
                                <p>2、买域名映射到服务器的IP</p>
                                <p>3、域名需要进行备案和审核</p>
                                <h4 id="2%E3%80%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" id="2、使用场景">2、使用场景</h4>
                                <p>1、开发测试(微信、支付宝)</p>
                                <p>2、智慧互联</p>
                                <p>3、远程控制</p>
                                <p>4、私有云</p>
                                <h4 id="3%E3%80%81%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B8%B8%E7%94%A8%E7%9A%84%E8%BD%AF%E4%BB%B6"
                                    id="3、内网穿透常用的软件">3、内网穿透常用的软件</h4>
                                <p>1、natapp:<a target="_blank" rel="noopener"
                                        href="https://natapp.cn/">https://natapp.cn/</a><br />
                                    2、续断: www.zhexi.tech<br />
                                    3、花生壳: <a target="_blank" rel="noopener"
                                        href="https://www.oray.com/">https://www.oray.com/</a></p>
                                <h1 id="19%E3%80%81%E7%A7%92%E6%9D%80">19、秒杀</h1>
                                <h3 id="19.1-%E7%A7%92%E6%9D%80%E4%B8%9A%E5%8A%A1" id="19-1-秒杀业务">19.1 秒杀业务</h3>
                                <p>秒杀具有瞬间高并发的特点，针对这一特点，必须要做到限流 + 异步 + 缓存（页面静态化） + <strong>独立部署</strong></p>
                                <p>限流方式：</p>
                                <p>1、前端限流，一些高并发的网站直接在前端页面开始限流，列如：小米的验证码</p>
                                <p>2、nginx限流，直接负载部分请求到错误的静态页面，令牌算法、漏斗算法</p>
                                <p>3、网关限流、限流的过滤器</p>
                                <p>4、代码中使用分布式信号量</p>
                                <p>5、rabbitmq限流（能者多劳 channel.basicQos(1)）保证发挥服务器的所用性能</p>
                                <h3 id="19.2-%E7%A7%92%E6%9D%80%E6%B5%81%E7%A8%8B" id="19-2-秒杀流程">19.2 秒杀流程</h3>
                                <p>参考京东秒杀流程</p>
                                <p>见秒杀流程图</p>
                                <p>完整流程图地址：<a target="_blank" rel="noopener"
                                        href="https://www.processon.com/view/link/5fbda8c35653bb1d54f7077b">https://www.processon.com/view/link/5fbda8c35653bb1d54f7077b</a>
                                </p>
                                <h4 id="%E7%A7%92%E6%9D%80%E6%96%B9%E5%BC%8F%E4%B8%80" id="秒杀方式一">秒杀方式一</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210108164514905.png"
                                        alt="image-20210108164514905" /></p>
                                <h4 id="%E7%A7%92%E6%9D%80%E6%96%B9%E5%BC%8F2" id="秒杀方式2">秒杀方式2</h4>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20210108164555957.png"
                                        alt="image-20210108164555957" /></p>
                                <h3 id="19.3-%E9%99%90%E6%B5%81" id="19-3-限流">19.3 限流</h3>
                                <h3 id="19.4-%E7%A7%92%E6%9D%80%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1" id="19-4-秒杀核心业务">
                                    19.4 秒杀核心业务</h3>
                                <h1 id="20%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">20、定时任务</h1>
                                <h3 id="20.1-cron%E8%A1%A8%E8%BE%BE%E5%BC%8F" id="20-1-cron表达式">20.1 cron表达式</h3>
                                <p>语法：秒 分 时 日 月 周 年（Spring不支持）</p>
                                <p><a target="_blank" rel="noopener"
                                        href="http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html">http://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/crontrigger.html</a>
                                </p>
                                <p><img src="D:/Documents/JianGuo/_posts/Draft/2021/image-20201123095003586.png"
                                        alt="image-20201123095003586" /></p>
                                <p>特殊字符：</p>
                                <ul>
                                    <li><code>*</code>（ <em>“所有值”</em>）-用于选择字段中的所有值。例如，分钟字段中的“ ***** ”表示*“每分钟”*。</li>
                                    <li><code>？</code>（
                                        <em>“无特定值”</em>）-当您需要在允许使用字符的两个字段之一中指定某个内容而在另一个不允许的字段中指定某些内容时很有用。例如，如果我希望在某个月的某个特定日期（例如，第10天）触发触发器，但不在乎一周中的哪一天发生，则将“
                                        10”设置为月字段，以及“？” 在“星期几”字段中。请参阅下面的示例以进行澄清。</li>
                                    <li><code>--</code>用于指定范围。例如，小时字段中的“ 10-12”表示*“小时10、11和12”*。</li>
                                    <li><code>，</code> -用于指定其他值。例如，“星期几”字段中的“ MON，WED，FRI”表示*“星期一，星期三和星期五的日子”*。</li>
                                    <li><code>/</code> -用于指定增量。例如，秒字段中的“ 0/15”表示*“秒<em>0、15、30</em>和45”<em>。秒字段中的“
                                            5/15”表示</em>“秒<em>5、20、35</em>和50”<em>。您还可以在“ <strong>”字符</strong>后指定“ /”
                                            <strong>-在这种情况下，“</strong> ”等效于在“ /”之前使用“ 0”。每月日期字段中的“
                                            1/3”表示</em>“从该月的第一天开始每三天触发一次”*。</li>
                                    <li><code>L</code>（ <em>“最后一个”</em>）-在允许使用的两个字段中都有不同的含义。例如，“月”字段中的值“
                                        L”表示*“<em>月</em>的最后一天”，即<em>非January年的1月31日，2月28日。如果单独用于星期几字段，则仅表示“ 7”或“
                                            SAT”。但是，如果在星期几字段中使用另一个值，则表示</em>“该月的最后xxx天”<em>，例如“
                                            6L”表示</em>“该月的最后一个星期五”*。您还可以指定与该月最后一天的偏移量，例如“ L-3”，这表示日历月的倒数第三天。 <em>使用“
                                            L”选项时，不要指定列表或值的范围很重要，因为这样会导致混淆/意外结果。</em></li>
                                    <li><code>W</code>（ <em>“工作日”</em>）-用于指定最接近给定日期的工作日（星期一至星期五）。例如，如果您要指定“
                                        15W”作为“月日”字段的值，则含义是：
                                        <em>“离月15日最近的工作日”</em>。因此，如果15号是星期六，则触发器将在14号星期五触发。如果15日是星期日，则触发器将在16日星期一触发。如果15号是星期二，那么它将在15号星期二触发。但是，如果您将“
                                        1W”指定为月份的值，并且第一个是星期六，则触发器将在第3个星期一触发，因为它不会“跳过”一个月日的边界。仅当月份中的某天是一天，而不是范围或天数列表时，才可以指定“
                                        W”字符。</li>
                                </ul>
                                <blockquote>
                                    <p>“ L”和“ W”字符也可以在“月日”字段中组合以产生“ LW”，这表示*“每月的最后一个工作日” *。</p>
                                </blockquote>
                                <ul>
                                    <li><code>＃</code> -用于指定每月的第“ XXX”天。例如，“星期几”字段中的值“
                                        6＃3”表示*“该月的第三个星期五”<em>（第6天=星期五，“＃3” =该</em>月的第三个星期五*）。其他示例：“ 2＃1” =该月的第一个星期一，“
                                        4＃5” =该月的第五个星期三。请注意，如果您指定“＃5”，并且该月的指定星期几中没有5个，则该月将不会触发。</li>
                                </ul>
                                <blockquote>
                                    <p>法定字符以及月份和星期几的名称不区分大小写。<code>MON</code> 与<code>mon</code>相同。</p>
                                </blockquote>
                                <h3 id="20.2-cron-%E7%A4%BA%E4%BE%8B" id="20-2-cron-示例">20.2 cron 示例</h3>
                                <p>阅读技巧：秒 分 时 日 月 周</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201123095544841.png"
                                        alt="image-20201123095544841" /></p>
                                <p>使用谷歌翻译后中文意思是这样的</p>
                                <p><img src="http://rcy276gfy.hd-bkt.clouddn.com/work/image-20201123095718609.png"
                                        alt="image-20201123095718609" /></p>
                                <h3 id="20.3-springboot%E6%95%B4%E5%90%88%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"
                                    id="20-3-SpringBoot整合定时任务">20.3 SpringBoot整合定时任务</h3>
                                <p>定时任务相关注解:</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// 启用Spring异步任务支持</span></span><br><span class="line"><span class="meta">@EnableScheduling</span> <span class="comment">// 启用Spring的计划任务执行功能</span></span><br><span class="line"><span class="meta">@Async</span> 异步</span><br><span class="line"><span class="meta">@Scheduled(cron = &quot;* * * * * ?&quot;)</span></span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <p>代码：</p>
                                <figure class="highlight java">
                                    <table>
                                        <tr>
                                            <td class="gutter">
                                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                                            </td>
                                            <td class="code">
                                                <pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> gcq</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2020-11-23</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 定时任务</span></span><br><span class="line"><span class="comment"> *      1、<span class="doctag">@EnableScheduling</span> 开启定时任务</span></span><br><span class="line"><span class="comment"> *      2、Scheduled 开启一个定时任务</span></span><br><span class="line"><span class="comment"> *      3、自动配置类 TaskSchedulingAutoConfiguration 属性绑定在TaskExecutionProperties</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 异步任务</span></span><br><span class="line"><span class="comment"> *      1、<span class="doctag">@EnableAsync</span> 开启异步任务功能</span></span><br><span class="line"><span class="comment"> *      2、<span class="doctag">@Async</span> 给希望异步执行的方法上标注</span></span><br><span class="line"><span class="comment"> *      3、自动配置类 TaskExecutionAutoConfiguration</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// 启用Spring异步任务支持</span></span><br><span class="line"><span class="meta">@EnableScheduling</span> <span class="comment">// 启用Spring的计划任务执行功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloSchedule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、Spring中6位组成，不允许第7位的年</span></span><br><span class="line"><span class="comment">     * 2、在周几的位置，1-7代表周一到周日：MON-SUN</span></span><br><span class="line"><span class="comment">     * 3、定时任务应该阻塞，默认是阻塞的</span></span><br><span class="line"><span class="comment">     *      1、可以让业务以异步的方式运行，自己提交到线程池</span></span><br><span class="line"><span class="comment">     *          CompletableFuture.runAsync(() -&gt; &#123;</span></span><br><span class="line"><span class="comment">     *              xxxService.hello();</span></span><br><span class="line"><span class="comment">     *          &#125;)</span></span><br><span class="line"><span class="comment">     *      2、支持定时任务线程池，设置 TaskSchedulingProperties</span></span><br><span class="line"><span class="comment">     *          spring.task.scheduling.pool.size=5</span></span><br><span class="line"><span class="comment">     *      3、让定时任务异步执行</span></span><br><span class="line"><span class="comment">     *          异步执行</span></span><br><span class="line"><span class="comment">     *     解决：使用异步 + 定时任务来完成定时任务不阻塞的功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Async 异步</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = &quot;* * * * * ?&quot;)</span></span><br><span class="line"><span class="comment">//    public void hello() &#123;</span></span><br><span class="line"><span class="comment">//        log.info(&quot;hello...&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </figure>
                                <h3 id="20.4-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"
                                    id="20-4-分布式定时任务">20.4 分布式定时任务</h3>
                                <h3 id="20.5%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E9%97%AE%E9%A2%98"
                                    id="20-5定时任务的问题">20.5定时任务的问题</h3>
                                <h3 id="20.6-%E6%89%A9%E5%B1%95---%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E6%95%B4"
                                    id="20-6-扩展-分布式调整">20.6 扩展 - 分布式调整</h3>
                                <h1
                                    id="21%E3%80%81%E7%A7%92%E6%9D%80%EF%BC%88%E9%AB%98%E5%B9%B6%E5%8F%91%EF%BC%89%E7%B3%BB%E7%BB%9F%E5%85%B3%E6%B3%A8%E7%9A%84%E9%97%AE%E9%A2%98">
                                    21、秒杀（高并发）系统关注的问题</h1>
                                <h3 id="21.1-%E6%9C%8D%E5%8A%A1%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3" id="21-1-服务单一职责">
                                    21.1 服务单一职责</h3>
                                <p>秒杀服务即使自己扛不住压力，挂掉，不要影响别人</p>
                                <h3 id="21.2-%E7%A7%92%E6%9D%80%E9%93%BE%E6%8E%A5%E5%8A%A0%E5%AF%86" id="21-2-秒杀链接加密">
                                    21.2 秒杀链接加密</h3>
                                <p>防止恶意攻击模拟秒杀请求，1000次/s攻击<br />
                                    防止连接暴露，自己工作人员，提前秒杀商品</p>
                                <h3 id="21.3-%E5%BA%93%E5%AD%98%E9%A2%84%E7%83%AD-%2B-%E5%BF%AB%E9%80%9F%E6%89%A3%E5%87%8F"
                                    id="21-3-库存预热-快速扣减">21.3 库存预热 + 快速扣减</h3>
                                <p>提前把数据加载缓存中，</p>
                                <h3 id="21.4-%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB" id="21-4-动静分离">21.4 动静分离</h3>
                                <p>nginx做好动静分离，保证秒杀和商品详情页的动态请求才打到后端的服务集群</p>
                                <p>使用 CDN 网络，分担服务器压力</p>
                                <h3 id="21.5-%E6%81%B6%E6%84%8F%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA" id="21-5-恶意请求拦截">
                                    21.5 恶意请求拦截</h3>
                                <p>识别非法攻击的请求并进行拦截 ，网管层</p>
                                <h3 id="21.6-%E6%B5%81%E9%87%8F%E9%94%99%E5%B3%B0" id="21-6-流量错峰">21.6 流量错峰</h3>
                                <p>使用各种手段，将流量分担到更大宽度的时间点，比如验证码，加入购物车</p>
                                <h3 id="21.7-%E9%99%90%E6%B5%81-%26-%E7%86%94%E6%96%AD-%26-%E9%99%8D%E7%BA%A7"
                                    id="21-7-限流-熔断-降级">21.7 限流 &amp; 熔断 &amp; 降级</h3>
                                <p>前端限流 + 后端限流</p>
                                <p>限制次数，限制总量，快速失败降级运行，熔断隔离防止雪崩</p>
                                <h3 id="21.8-%E9%98%9F%E5%88%97%E6%B6%88%E5%B3%B0" id="21-8-队列消峰">21.8 队列消峰</h3>
                                <p>1万个请求，每个1000件被秒杀，双11所有秒杀成功的请求，进入队列，慢慢创建订单，扣减库存即可</p>
                                <script type="text/javascript"
                                    src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script>
                                <script type="text/javascript"
                                    src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script>
                                <script defer="true" type="text/javascript"
                                    src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script>
                                <link rel="stylesheet" type="text/css"
                                    href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
                            </div>
                            <div class="article-licensing box">
                                <div class="licensing-title">
                                    <p>谷粒商城</p>
                                    <p><a
                                            href="http://mrdemonlxl.github.io/2021/01/20/Draft/2021/谷粒商城/">http://mrdemonlxl.github.io/2021/01/20/Draft/2021/谷粒商城/</a>
                                    </p>
                                </div>
                                <div class="licensing-meta level is-mobile">
                                    <div class="level-left">
                                        <div class="level-item is-narrow">
                                            <div>
                                                <h6>作者</h6><a href="http://MrDemonlxl.github.io">
                                                    <p>魑魅先生</p>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="level-item is-narrow">
                                            <div>
                                                <h6>发布于</h6>
                                                <p>2021-01-20</p>
                                            </div>
                                        </div>
                                        <div class="level-item is-narrow">
                                            <div>
                                                <h6>更新于</h6>
                                                <p>2022-06-04</p>
                                            </div>
                                        </div>
                                        <div class="level-item is-narrow">
                                            <div>
                                                <h6>许可协议</h6>
                                                <p><a class="icon" rel="noopener" target="_blank"
                                                        title="Creative Commons" href="https://creativecommons.org/"><i
                                                            class="fab fa-creative-commons"></i></a><a class="icon"
                                                        rel="noopener" target="_blank" title="Attribution"
                                                        href="https://creativecommons.org/licenses/by/4.0/"><i
                                                            class="fab fa-creative-commons-by"></i></a><a class="icon"
                                                        rel="noopener" target="_blank" title="Noncommercial"
                                                        href="https://creativecommons.org/licenses/by-nc/4.0/"><i
                                                            class="fab fa-creative-commons-nc"></i></a></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="recommend-area">
                                <div class="recommend-post"><span
                                        class="is-size-6 has-text-grey has-mr-7"># 推荐文章</span><br><span>  1.<a
                                            class="is-size-6" href="/2021/02/25/Draft/2021/%E5%BF%AB%E6%9F%A5/"
                                            target="_blank">快查</a><br></span><span>  2.<a class="is-size-6"
                                            href="/2021/11/10/Draft/2021/JVM%20%E4%B8%8E%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"
                                            target="_blank">JVM 与上层技术</a><br></span><span>  3.<a class="is-size-6"
                                            href="/2021/02/18/Draft/2021/%E4%BA%94%E5%88%86%E9%92%9F%E6%90%AD%E5%BB%BA%E5%9C%A8%E7%BA%BF%E5%8D%9A%E5%AE%A2/"
                                            target="_blank">五分钟搭建在线博客</a><br></span><span>  4.<a class="is-size-6"
                                            href="/2021/03/01/Draft/2021/%E5%89%8D%E7%AB%AF/" target="_blank">魑魅先生 |
                                            前端</a><br></span><span>  5.<a class="is-size-6"
                                            href="/2021/03/01/Draft/2021/JAVA%E5%BA%94%E7%94%A8/" target="_blank">魑魅先生 |
                                            业务技术</a><br></span><span>  6.<a class="is-size-6"
                                            href="/2021/03/01/Draft/2021/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"
                                            target="_blank">魑魅先生 | 设计模式</a><br></span></div>
                            </div>
                            <link rel="stylesheet"
                                href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                            <div class="social-share"></div>
                            <script
                                src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                        </article>
                    </div>
                    <div class="card">
                        <div class="card-content">
                            <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
                            <div class="buttons is-centered"><a class="button donate" data-type="alipay"><span
                                        class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span
                                        class="qrcode"><img
                                            src="http://rcy276gfy.hd-bkt.clouddn.com/1c4f12804cc5a92919acd743d93a869.jpg"
                                            alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span
                                        class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span
                                        class="qrcode"><img
                                            src="http://rcy276gfy.hd-bkt.clouddn.com/260e4f4bc9e4053108cd9d02bae7386.png"
                                            alt="微信"></span></a></div>
                        </div>
                    </div>
                    <nav class="post-navigation mt-4 level is-mobile">
                        <div class="level-start"><a class="article-nav-prev level level-item link-muted"
                                href="/2021/01/20/Draft/2021/SpringBoot/"><i
                                    class="level-item fas fa-chevron-left"></i><span
                                    class="level-item">SpringBoot</span></a></div>
                        <div class="level-end"><a class="article-nav-next level level-item link-muted"
                                href="/2021/01/19/Draft/2021/Hexo%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B/"><span
                                    class="level-item">博客模板</span><i class="level-item fas fa-chevron-right"></i></a>
                        </div>
                    </nav>
                    <!--!-->
                    <div class="card">
                        <div class="card-content">
                            <div class="title is-5">评论</div>
                            <div id="comment-container"></div>
                            <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css">
                            <script> $.getScript('/js/gitalk.min.js', function () {
                                    var gitalk = new Gitalk({
                                        language: 'zh-CN',
                                        id: '9db3d7e84e1b224bd9da5bc5a819eaf3',
                                        repo: 'MrDemonlxl.github.io',
                                        owner: 'MrDemonlxl',
                                        clientID: '20ef8321698ab8c0c37b',
                                        clientSecret: '4faa4daae14b55afd2ed357fba92d1e9c7c3f729',
                                        admin: ["MrDemonlxl"],
                                        createIssueManually: true,
                                        distractionFreeMode: false,
                                        perPage: 10,
                                        pagerDirection: 'last',
                                        proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',

                                        enableHotKey: true,
                                        isLocked: false
                                    })
                                    gitalk.render('comment-container')
                                });</script>
                        </div>
                    </div>
                </div>
                <div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky">
                    <div class="card widget" id="toc" data-type="toc">
                        <div class="card-content">
                            <div class="menu">
                                <h3 class="menu-label">目录</h3>
                                <ul class="menu-list">
                                    <li><a class="is-flex is-mobile"
                                            href="#%E6%96%B0%E5%AD%A6%E5%9B%9B%E9%97%AE"><span>新学四问</span></a></li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E8%BF%9B%E5%BA%A6%EF%BC%9A-%E3%80%9085--5.25%E3%80%91"><span>进度： 【85
                                                -5.25】</span></a></li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%3D%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E7%AF%87%3D"><span>=分布式基础篇=</span></a>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span>一、项目介绍</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#1.1-%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF"><span>1.1
                                                        项目背景</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#1.2-%E7%94%B5%E5%95%86%E6%A8%A1%E5%BC%8F"><span>1.2
                                                        电商模式</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#1.2.1-b2b-%E6%A8%A1%E5%BC%8F"><span>1.2.1 B2B
                                                                模式</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#1.2.2-b2c-%E6%A8%A1%E5%BC%8F"><span>1.2.2 B2C
                                                                模式</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#1.2.3-c2b-%E6%A8%A1%E5%BC%8F"><span>1.2.3 C2B
                                                                模式</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#1.2.4-c2c-%E6%A8%A1%E5%BC%8F"><span>1.2.4 C2C
                                                                模式</span></a></li>
                                                    <li><a class="is-flex is-mobile" href="#1.2.5-o2o"><span>1.2.5
                                                                O2O</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#1.3-%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E"><span>1.3
                                                        谷粒商城</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#1.4-%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E5%9B%BE"><span>1.4
                                                        项目架构图</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E9%A1%B9%E7%9B%AE%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%9B%BE"><span>项目微服务架构图</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%92%E5%88%86%E5%9B%BE"><span>微服务划分图</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#1.5-%E9%A1%B9%E7%9B%AE%E6%8A%80%E6%9C%AF%E5%92%8C%E7%89%B9%E8%89%B2"><span>1.5
                                                        项目技术和特色</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#1.6-%E9%A1%B9%E7%9B%AE%E5%89%8D%E7%BD%AE%E8%A6%81%E6%B1%82"><span>1.6
                                                        项目前置要求</span></a></li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E4%BA%8C%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span>二、分布式基础概念</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#2.1-%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span>2.1 微服务</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#2.2-%E9%9B%86%E7%BE%A4-%26-%E5%88%86%E5%B8%83%E5%BC%8F-%26-%E8%8A%82%E7%82%B9"><span>2.2
                                                        集群 &amp; 分布式 &amp; 节点</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#2.3-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span>2.3
                                                        远程调用</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#2.4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span>2.4
                                                        负载均衡</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#2.5-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%2F%E5%8F%91%E7%8E%B0-%26-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span>2.5
                                                        服务注册/发现 &amp; 注册中心</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#2.6-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span>2.6
                                                        配置中心</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#2.7-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD-%26-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span>2.7
                                                        服务熔断 &amp; 服务降级</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span>服务熔断</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span>服务降级</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile" href="#2.8-api%E7%BD%91%E5%85%B3"><span>2.8
                                                        Api网关</span></a></li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E4%B8%89%E3%80%81%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span>三、搭建环境</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#3.1-%E5%AE%89%E8%A3%85-linux-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span>3.1
                                                        安装 Linux 虚拟机</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E4%B8%8B%E8%BD%BD%26-%E5%AE%89%E8%A3%85-vagrant"><span>下载&amp;
                                                                安装 Vagrant</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#3.2-%E5%AE%89%E8%A3%85-docker"><span>3.2 安装 docker</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.2.1-%E5%8D%B8%E8%BD%BD%E7%B3%BB%E7%BB%9F%E4%B9%8B%E5%89%8D%E5%AE%89%E8%A3%85%E7%9A%84docker"><span>3.2.1
                                                                卸载系统之前安装的docker</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#3.3-docker-%E5%AE%89%E8%A3%85-mysql"><span>3.3 docker 安装
                                                        mysql</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.3.1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span>3.3.1
                                                                下载镜像文件</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.3.3-%E9%80%9A%E8%BF%87%E5%AE%B9%E5%99%A8%E7%9A%84mysql-%E5%91%BD%E4%BB%A4%E5%B7%A5%E5%85%B7%E8%BF%9E%E6%8E%A5"><span>3.3.3
                                                                通过容器的mysql 命令工具连接</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#3.4-docker-%E5%AE%89%E8%A3%85-redis"><span>3.4 docker 安装
                                                        redis</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.4.1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span>3.4.1
                                                                下载镜像文件</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.4.2-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B%E5%B9%B6%E5%90%AF%E5%8A%A8"><span>3.4.2
                                                                创建实例并启动</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.4.3-%E4%BD%BF%E7%94%A8-redis-%E9%95%9C%E5%83%8F%E6%89%A7%E8%A1%8C-redis-cli-%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5"><span>3.4.3
                                                                使用 redis 镜像执行 redis-cli 命令连接</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#3.5-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%BB%9F%E4%B8%80"><span>3.5
                                                        开发环境统一</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E9%85%8D%E7%BD%AE-jdk-1.8-%E7%BC%96%E8%AF%91%E9%A1%B9%E7%9B%AE"><span>配置
                                                                jdk 1.8 编译项目</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.5.2-idea-%26-vscode"><span>3.5.2 idea &amp;
                                                                vscode</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E6%AD%A5%E9%AA%A42%3A-%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AD%97%E6%AE%B5%E4%B8%8A%E5%8A%A0%E4%B8%8A%40tablelogic%E6%B3%A8%E8%A7%A3"><span>步骤2:
                                                                实体类字段上加上@TableLogic注解</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E9%85%8D%E7%BD%AE-git-%E8%BF%9B%E5%85%A5-git-bash"><span>配置
                                                                git 进入 git bash</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E9%85%8D%E7%BD%AE-ssh-%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"><span>配置
                                                                ssh 免密码登录</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#4.%E4%BD%BF%E7%94%A8%E4%BA%BA%E4%BA%BA%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8%E7%94%9F%E6%88%90%E5%9F%BA%E7%A1%80%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span>4.使用人人代码生成器生成基础业务代码</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#3.6-%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83"><span>3.6
                                                        前后端联调</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.6.1-%E5%90%AF%E5%8A%A8%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span>3.6.1
                                                                启动前端项目</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.6.2-%E5%90%AF%E5%8A%A8%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE"><span>3.6.2
                                                                启动后端项目</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.6.3.2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span>3.6.3.2
                                                                为什么会有跨域问题</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.6.4-%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3"><span>3.6.4
                                                                跨域解决</span></a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E5%9B%9B%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%84%E4%BB%B6"><span>四、分布式组件</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#springcloud-alibaba"><span>SpringCloud Alibaba</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#%E6%8A%80%E6%9C%AF%E6%90%AD%E9%85%8D%E6%96%B9%E6%A1%88"><span>技术搭配方案</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#springcloud-alibaba-1"><span>SpringCloud
                                                                Alibaba</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#springcloud"><span>SpringCloud</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84"><span>项目架构</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E7%BB%84%E4%BB%B6%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span>组件技术方案</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#nacos%E3%80%90%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E3%80%91"><span>Nacos【注册中心】</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#1.%E5%85%AC%E5%85%B1%E4%BE%9D%E8%B5%96%E5%BC%95%E8%BF%9B"><span>1.公共依赖引进</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#2.%E4%B8%8B%E8%BD%BDnacos-server"><span>2.下载Nacos
                                                                Server</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#releases-%C2%B7-alibaba%2Fnacos-(github.com)%E5%B9%B6%E7%82%B9%E5%87%BB%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%8B%E7%9A%84startup.bat%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%2C%E5%90%AF%E5%8A%A8%E4%B8%8D%E4%BA%86%E5%8F%AF%E8%83%BD%E6%9C%AA%E9%85%8Djava_home%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span>Releases
                                                                · alibaba/nacos
                                                                (github.com)并点击文件夹下的startup.bat启动服务,启动不了可能未配JAVA_HOME环境变量</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#2%E3%80%81%E5%9C%A8%E5%BA%94%E7%94%A8%E7%9A%84-%2Fresource-%2Fapplication.properties-%E4%B8%AD%E9%85%8D%E7%BD%AE-nacos-server%E5%9C%B0%E5%9D%80"><span>2、在应用的
                                                                /resource /application.properties 中配置 Nacos
                                                                Server地址</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#4.%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3%E5%BC%80%E5%90%AF%E6%9C%8D%E5%8A%A1%E4%B8%8E%E6%B3%A8%E8%A7%A3%E5%8A%9F%E8%83%BD"><span>4.启动类添加注解开启服务与注解功能</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#5.%E9%85%8D%E7%BD%AE%E6%A8%A1%E5%9D%97%E5%90%8D"><span>5.配置模块名</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#6.%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%9D%97%E8%AE%BF%E9%97%AE"><span>6.启动模块访问</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#nacos%E3%80%90%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E3%80%91"><span>Nacos【配置中心】</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#5.3.5%E3%80%81%E8%BF%9B%E9%98%B6"><span>5.3.5、进阶</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile" href="#sentinel"><span>Sentinel</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#2%E3%80%81sentinel-%E7%AE%80%E4%BB%8B"><span>2、Sentinel
                                                                简介</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#2%E3%80%81hystrix-%E4%B8%8E-sentinel-%E6%AF%94%E8%BE%83"><span>2、Hystrix
                                                                与 Sentinel 比较</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3%E3%80%81%E6%95%B4%E5%90%88-feign-%E5%92%8C-sentinel-%E6%B5%8B%E8%AF%95%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span>3、整合
                                                                Feign 和 Sentinel 测试熔断降级</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#4%E3%80%81%E6%95%B4%E5%90%88-sentinel-%E6%B5%8B%E8%AF%95%E9%99%90%E6%B5%81"><span>4、整合
                                                                Sentinel 测试限流</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#5%E3%80%81sentinel%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81"><span>5、Sentinel网关限流</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile" href="#seata"><span>Seata</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#1%E3%80%81%E7%AE%80%E4%BB%8B-1"><span>1、简介</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#2%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span>2、核心概念</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile" href="#oss"><span>OSS</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#5.6.1%E3%80%81%E7%AE%80%E4%BB%8B"><span>5.6.1、简介</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#5.6.2%E3%80%81%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span>5.6.2、使用步骤</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#5.6.3%E3%80%81-%E6%8A%BD%E5%8F%96%E6%88%90%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%EF%BC%9Foss"><span>5.6.3、
                                                                抽取成一个单独的第三方服务？OSS</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#5.6.4%E3%80%81web%E7%AB%AF%E4%B8%8A%E4%BC%A0%E4%BB%8B%E7%BB%8D"><span>5.6.4、Web端上传介绍</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#openfeign"><span>OpenFeign</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E7%AE%80%E4%BB%8B"><span>简介</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#1.%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span>1.引入依赖</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#2.%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span>2.创建服务接口</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3.%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8A%9F%E8%83%BD"><span>3.开启远程调用功能</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile" href="#gateway"><span>Gateway</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E7%AE%80%E4%BB%8B-1"><span>简介</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#sleuth%2Bzipkin-%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span>Sleuth+Zipkin
                                                        服务链路追踪</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8"><span>为什么用</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E4%BA%94%E3%80%81%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span>五、前端开发基础知识</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#7.1-vscode-%E4%BD%BF%E7%94%A8"><span>7.1 VSCode 使用</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile" href="#7.2-es6"><span>7.2 ES6</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile" href="#7.3-node.js"><span>7.3
                                                        Node.js</span></a></li>
                                            <li><a class="is-flex is-mobile" href="#7.4-vue"><span>7.4 Vue</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#7.4.5-%E6%95%B4%E5%90%88-element-ui"><span>7.4.5 整合
                                                                Element UI</span></a></li>
                                                    <li><a class="is-flex is-mobile" href="#7.5-babel"><span>7.5
                                                                Babel</span></a></li>
                                                    <li><a class="is-flex is-mobile" href="#7.6-webpack"><span>7.6
                                                                Webpack</span></a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E5%85%AD%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB"><span>六、商品服务&amp;三级分类</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#8.1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span>8.1
                                                        基础概念</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.1.1%E3%80%81%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB"><span>8.1.1、三级分类</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.1.2%E3%80%81spu-%E5%92%8C-sku"><span>8.1.2、SPU 和
                                                                SKU</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.1.3%E3%80%81%E5%9F%BA%E6%9C%AC%E5%B1%9E%E6%80%A7-%E3%80%90%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E3%80%91%E4%B8%8E-%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7"><span>8.1.3、基本属性
                                                                【规格参数】与 销售属性</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.1.4%E3%80%81%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E4%BD%8D%E7%BD%AE"><span>8.1.4、接口文档位置</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#do-%E4%B8%8E-po-%E7%9A%84%E5%8C%BA%E5%88%AB"><span>DO
                                                                与 PO 的区别</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#8.2-%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99"><span>8.2
                                                        三级分类接口编写</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.2.1-%E6%A0%91%E5%BD%A2%E5%B1%95%E7%A4%BA%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE"><span>8.2.1
                                                                树形展示三级分类数据</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.2.2-%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4%26%E5%88%A0%E9%99%A4%E6%95%88%E6%9E%9C%E7%BB%86%E5%8C%96"><span>8.2.2
                                                                逻辑删除&amp;删除效果细化</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.2.3-%E6%96%B0%E5%A2%9E%E6%95%88%E6%9E%9C%26%E5%9F%BA%E6%9C%AC%E4%BF%AE%E6%94%B9"><span>8.2.3
                                                                新增效果&amp;基本修改</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8.2.4-%E6%8B%96%E6%8B%BD%E5%8A%9F%E8%83%BD%26%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%26%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span>8.2.4
                                                                拖拽功能&amp;数据收集&amp;批量删除</span></a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E4%B8%83%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86"><span>七、商品服务&amp;品牌管理</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#9.1%E3%80%81%E6%95%88%E6%9E%9C%E6%98%BE%E7%A4%BA%E4%BC%98%E5%8C%96%E4%B8%8E%E5%BF%AB%E9%80%9F%E6%98%BE%E7%A4%BA%E5%BC%80%E5%85%B3"><span>9.1、效果显示优化与快速显示开关</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#9.2%E3%80%81%E8%A1%A8%E5%8D%95%E6%95%88%E9%AA%8C%26%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%88%E9%AA%8C%E8%A7%84%E5%88%99"><span>9.2、表单效验&amp;自定义效验规则</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#9.3%E3%80%81jsr303-%E6%95%B0%E6%8D%AE%E6%95%88%E9%AA%8C-%26-%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span>9.3、JSR303
                                                        数据效验 &amp; 统一异常处理</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#9.3.1%E3%80%81%E7%BB%99bean%E6%B7%BB%E5%8A%A0%E6%95%88%E9%AA%8C%E6%B3%A8%E8%A7%A3-javax.validation.constraints%E5%8C%85%E4%B8%8B-%E5%B9%B6%E5%AE%9A%E4%B9%89%E8%87%AA%E5%B7%B1%E7%9A%84%E7%9A%84message%E6%8F%90%E7%A4%BA"><span>9.3.1、给Bean添加效验注解
                                                                javax.validation.constraints包下
                                                                并定义自己的的message提示</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#9.3.2%E3%80%81%E5%BC%80%E5%90%AF%E6%95%88%E9%AA%8C%E5%8A%9F%E8%83%BD-%40valid"><span>9.3.2、开启效验功能
                                                                @Valid</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#9.3.3%E3%80%81%E7%BB%99%E6%95%88%E9%AA%8C%E7%9A%84bean%E5%90%8E%E7%B4%A7%E8%B7%9F%E4%B8%80%E4%B8%AAbindingresult-%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%8F%96%E5%88%B0%E6%95%88%E9%AA%8C%E7%9A%84%E7%BB%93%E6%9E%9C"><span>9.3.3、给效验的bean后紧跟一个BindingResult
                                                                就可以获取到效验的结果</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#9.3.4%E3%80%81%E5%88%86%E7%BB%84%E6%95%88%E9%AA%8C-(%E5%A4%9A%E5%9C%BA%E6%99%AF%E5%A4%8D%E6%9D%82%E6%95%88%E9%AA%8C)"><span>9.3.4、分组效验
                                                                (多场景复杂效验)</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#9.3.5%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%88%E9%AA%8C"><span>9.3.5、自定义效验</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#9.3.6%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span>9.3.6、异常处理</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E5%85%AB%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84"><span>八、商品服务&amp;属性分组</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#10.1-%E3%80%81%E5%89%8D%E7%AB%AF%E7%BB%84%E4%BB%B6%E6%8A%BD%E5%8F%96-%26-%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E4%BA%A4%E4%BA%92"><span>10.1
                                                        、前端组件抽取 &amp; 父子组件交互</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#10.1.1-%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84---%E6%95%88%E6%9E%9C"><span>10.1.1
                                                                属性分组 - 效果</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#10.1.2-layout-%E5%B8%83%E5%B1%80"><span>10.1.2 Layout
                                                                布局</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#10.1.3-%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92"><span>10.1.3
                                                                父子组件如何进行交互</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#10.2-%E3%80%81%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7%E5%88%86%E7%B1%BB%E5%88%86%E7%BB%84"><span>10.2
                                                        、获取属性分类分组</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#10.3-%E3%80%81%E5%88%86%E7%B1%BB%E6%96%B0%E5%A2%9E-%26-%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A8"><span>10.3
                                                        、分类新增 &amp; 级联选择器</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#10.4-%E3%80%81%E5%88%86%E7%B1%BB%E4%BF%AE%E6%94%B9-%26-%E5%9B%9E%E6%98%BE%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A8"><span>10.4
                                                        、分类修改 &amp; 回显级联选择器</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#10.5%E3%80%81%E5%93%81%E7%89%8C%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94%E4%B8%8E%E7%BA%A7%E8%81%94%E6%9B%B4%E6%96%B0"><span>10.5、品牌分类关联与级联更新</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#10.5.1%E3%80%81%E5%AE%9E%E7%8E%B0%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86%E6%90%9C%E7%B4%A2"><span>10.5.1、实现品牌管理搜索</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E4%B9%9D%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%B9%B3%E5%8F%B0%E5%B1%9E%E6%80%A7"><span>九、商品服务&amp;平台属性</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#object%E5%88%92%E5%88%86"><span>Object划分</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#8%E3%80%81dao%EF%BC%88data-access-object%EF%BC%89-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1"><span>8、DAO（data
                                                                access object） 数据访问对象</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#11.1-%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E6%96%B0%E5%A2%9E%E4%B8%8Evo"><span>11.1
                                                        规格参数新增与VO</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#11.1.1-%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0"><span>11.1.1
                                                                获取分类规格参数</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#11.2-%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8%26%E8%A7%84%E6%A0%BC%E4%BF%AE%E6%94%B9"><span>11.2
                                                        规格参数列表&amp;规格修改</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#11.3.3%E3%80%81%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7"><span>11.3.3、销售属性</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#11.3-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94%E5%B1%9E%E6%80%A7%26%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94%26%E6%9F%A5%E8%AF%A2%E5%88%86%E7%BB%84%E6%9C%AA%E5%85%B3%E8%81%94%E5%B1%9E%E6%80%A7"><span>11.3
                                                        查询分类关联属性&amp;删除关联&amp;查询分组未关联属性</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#11.4.4%E3%80%81%E6%96%B0%E5%A2%9E%E5%88%86%E7%BB%84%E4%B8%8E%E5%B1%9E%E6%80%A7%E5%85%B3%E8%81%94"><span>11.4.4、新增分组与属性关联</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E5%8D%81%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E6%96%B0%E5%A2%9E%E5%95%86%E5%93%81"><span>十、商品服务&amp;新增商品</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#12.1-%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94%E7%9A%84%E5%93%81%E7%89%8C"><span>12.1
                                                        获取分类关联的品牌</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#12.2-%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E4%B8%8B%E6%89%80%E6%9C%89%E5%88%86%E7%BB%84%E4%BB%A5%E5%8F%8A%E5%B1%9E%E6%80%A7"><span>12.2
                                                        获取分类下所有分组以及属性</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#12.3-%E5%95%86%E5%93%81-vo-%E6%8A%BD%E5%8F%96%26%E5%95%86%E5%93%81%E6%96%B0%E5%A2%9E%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span>12.3
                                                        商品 VO 抽取&amp;商品新增业务流程</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#12.3.4-%E5%B0%81%E8%A3%85-vo-%E4%B8%AD%EF%BC%8C%E6%9B%B4%E6%94%B9%E5%AF%B9%E5%BA%94%E5%BE%97%E5%B1%9E%E6%80%A7"><span>12.3.4
                                                                封装 Vo 中，更改对应得属性</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#12.3.5-%E5%88%86%E6%9E%90%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span>12.3.5
                                                                分析业务流程</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#12.3.6-%E4%B8%BB%E8%A6%81%E7%BC%96%E7%A0%81%EF%BC%81"><span>12.3.6
                                                                主要编码！</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#12.3.7-%E6%80%BB%E7%BB%93"><span>12.3.7 总结</span></a>
                                                    </li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#12.3.8-%E5%95%86%E5%93%81%E4%BF%9D%E5%AD%98%E5%90%8E-debug-%E8%B0%83%E8%AF%95"><span>12.3.8
                                                                商品保存后 Debug 调试</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#3%E3%80%81%E7%A8%8B%E5%BA%8F%E4%B8%AD%E5%85%B6%E4%BB%96%E7%9A%84%E5%BC%82%E5%B8%B8"><span>3、程序中其他的异常</span></a>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E5%8D%81%E4%B8%80%E3%80%81-%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%26%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86"><span>十一、
                                                商品服务&amp;商品管理</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile" href="#spu-sku"><span>SPU SKU</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#11.1-%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86-spu-%E6%A3%80%E7%B4%A2"><span>11.1
                                                        商品管理 SPU 检索</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#11.2-%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86-sku-%E6%A3%80%E7%B4%A2"><span>11.2
                                                        商品管理 SkU 检索</span></a></li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E5%8D%81%E4%BA%8C%E3%80%81%E4%BB%93%E5%82%A8%E6%9C%8D%E5%8A%A1%26%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86"><span>十二、仓储服务&amp;仓库管理</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#14.1-%E6%95%B4%E5%90%88ware%E6%9C%8D%E5%8A%A1%26%E8%8E%B7%E5%8F%96%E4%BB%93%E5%BA%93%E5%88%97%E8%A1%A8"><span>14.1
                                                        整合ware服务&amp;获取仓库列表</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.1.1%E6%95%B4%E5%90%88-ware-%E6%9C%8D%E5%8A%A1"><span>14.1.1整合
                                                                ware 服务</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.1.2-%E8%8E%B7%E5%8F%96%E4%BB%93%E5%BA%93%E5%88%97%E8%A1%A8"><span>14.1.2
                                                                获取仓库列表</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#14.2-%E6%9F%A5%E8%AF%A2%E5%BA%93%E5%AD%98%26%E5%88%9B%E5%BB%BA%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"><span>14.2
                                                        查询库存&amp;创建采购需求</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.2.1-%E6%9F%A5%E8%AF%A2%E5%BA%93%E5%AD%98"><span>14.2.1
                                                                查询库存</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.2.2-%E5%88%9B%E5%BB%BA%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"><span>14.2.2
                                                                创建采购需求</span></a></li>
                                                </ul>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#14.3-%E5%90%88%E5%B9%B6%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82%26%E9%A2%86%E5%8F%96%E9%87%87%E8%B4%AD%E5%8D%95%26%E5%AE%8C%E6%88%90%E9%87%87%E8%B4%AD%26spu%E8%A7%84%E6%A0%BC%E7%BB%B4%E6%8A%A4"><span>14.3
                                                        合并采购需求&amp;领取采购单&amp;完成采购&amp;Spu规格维护</span></a>
                                                <ul class="menu-list">
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.3.1-%E5%90%88%E5%B9%B6%E9%87%87%E8%B4%AD%E9%9C%80%E6%B1%82"><span>14.3.1
                                                                合并采购需求</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.3.2-%E9%A2%86%E5%8F%96%E9%87%87%E8%B4%AD%E5%8D%95"><span>14.3.2
                                                                领取采购单</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.3.3-%E5%AE%8C%E6%88%90%E9%87%87%E8%B4%AD"><span>14.3.3
                                                                完成采购</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.3.4-spu%E8%A7%84%E6%A0%BC%E7%BB%B4%E6%8A%A4"><span>14.3.4
                                                                Spu规格维护</span></a></li>
                                                    <li><a class="is-flex is-mobile"
                                                            href="#14.3.5-spu%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C"><span>14.3.5
                                                                Spu更新操作</span></a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E7%AF%87%E6%80%BB%E7%BB%93"><span>分布式基础篇总结</span></a>
                                        <ul class="menu-list">
                                            <li><a class="is-flex is-mobile"
                                                    href="#1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span>1、分布式基础概念</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#2%E3%80%81%E5%9F%BA%E7%A1%80%E5%BC%80%E5%8F%91"><span>2、基础开发</span></a>
                                            </li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#3%E3%80%81%E7%8E%AF%E5%A2%83"><span>3、环境</span></a></li>
                                            <li><a class="is-flex is-mobile"
                                                    href="#4%E3%80%81%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83"><span>4、开发规范</span></a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#%3D%E5%88%86%E5%B8%83%E5%BC%8F%E9%AB%98%E7%BA%A7%E7%AF%87%3D"><span>=分布式高级篇=</span></a>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#1%E3%80%81elasticsearch---%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span>1、Elasticsearch
                                                - 全文检索</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E7%AE%80%E4%BB%8B-2"><span>简介</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#1.1.4-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6"><span>1.1.4
                                                            倒排索引机制</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#3%E3%80%81%E5%AE%89%E8%A3%85nginx"><span>3、安装nginx</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#1.3.7-%E6%A0%B7%E6%9C%AC%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span>1.3.7
                                                            样本测试数据</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#2%E3%80%81%E6%B5%8B%E8%AF%95"><span>2、测试</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#1.5.3-%E4%BD%BF%E7%94%A8"><span>1.5.3 使用</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#2%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span>2、商城业务
                                                &amp; 商品上架</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#2.1-%E5%95%86%E5%93%81mapping"><span>2.1
                                                            商品Mapping</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#2.2.2-%E5%B0%86%E6%95%B0%E6%8D%AE%E5%8F%91%E9%80%81%E7%BB%99-es%E4%BF%9D%E5%AD%98-%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%8F%91%E9%80%81%E7%BB%99-search%E6%9C%8D%E5%8A%A1"><span>2.2.2
                                                            将数据发送给 es保存 ，直接发送给 search服务</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#3%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-%E9%A6%96%E9%A1%B5%E6%95%B4%E5%90%88"><span>3、商城业务
                                                &amp; 首页整合</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#3.1.2-springboot-%E6%95%B4%E5%90%88-thymeleaf"><span>3.1.2
                                                            SpringBoot 整合 thymeleaf</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#3.2-%E6%95%B4%E5%90%88dev-tools-%E6%B8%B2%E6%9F%93%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE"><span>3.2
                                                            整合dev-tools 渲染分类数据</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#4%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-nginx-%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE"><span>4、商城业务
                                                &amp; Nginx 域名访问</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#4.1-nginx-%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E7%8E%AF%E5%A2%83%E4%B8%80%EF%BC%88%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%EF%BC%89"><span>4.1
                                                            Nginx 搭建域名环境一（反向代理配置）</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#4.2-nginx-%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E7%8E%AF%E5%A2%83%E4%BA%8C-%EF%BC%88%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%88%B0%E7%BD%91%E5%85%B3%EF%BC%89"><span>4.2
                                                            Nginx 搭建域名环境二 （负载均衡到网关）</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#5%E3%80%81%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B-%26-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span>5、性能压测
                                                &amp; 压力测试</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8C%87%E6%A0%87"><span>2、数据库指标</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#5.2.3-jmeter-address-already-in-use-%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3"><span>5.2.3
                                                            JMeter Address Already in use 错误解决</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#6%E3%80%81%E7%BC%93%E5%AD%98%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span>6、缓存与分布式锁</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#4%E3%80%81%E4%BC%98%E5%8C%96%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96"><span>4、优化三级分类数据获取</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%8B%E5%A6%82%E4%BD%95%E5%8A%A0%E9%94%81"><span>分布式下如何加锁</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#6%E3%80%81redission---%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%A3%E5%86%B3"><span>6、Redission
                                                            - 缓存一致性解决</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span>缓存数据一致性解决方案</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#6%E3%80%81%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0"><span>6、缓存更新</span></a>
                                                </li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#7%E3%80%81%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1-%26-%E5%95%86%E5%93%81%E6%A3%80%E7%B4%A2"><span>7、商城业务
                                                &amp; 商品检索</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#7.1.2-%E6%A3%80%E7%B4%A2%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90%E6%8A%BD%E5%8F%96"><span>7.1.2
                                                            检索返回结果模型分析抽取</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#7.2.1-%E6%9F%A5%E8%AF%A2%E9%83%A8%E5%88%86-%26-%E8%81%9A%E5%90%88%E9%83%A8%E5%88%86"><span>7.2.1
                                                            查询部分 &amp; 聚合部分</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#7.3-%E7%BB%93%E6%9E%9C%E6%8F%90%E5%8F%96%E5%B0%81%E8%A3%85"><span>7.3
                                                            结果提取封装</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#7.4.7-%E9%9D%A2%E5%8C%85%E5%B1%91%E5%AF%BC%E8%88%AA%EF%BC%88%E9%81%87%E5%88%B0%E9%97%AE%E9%A2%98%EF%BC%81%EF%BC%89"><span>7.4.7
                                                            面包屑导航（遇到问题！）</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#8%E3%80%81%E5%BC%82%E6%AD%A5-%26-%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span>8、异步
                                                &amp; 线程池</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#8.1.4-%E5%BC%80%E5%8F%91%E4%B8%AD%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span>8.1.4
                                                            开发中为什么使用线程池</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#8.2.7-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88"><span>8.2.7
                                                            多任务组合</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#9%E3%80%81%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85"><span>9、商品详情</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#9.1.1-%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96"><span>9.1.1
                                                            返回数据模型抽取</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#9.2-%E6%9F%A5%E8%AF%A2%E8%AF%A6%E6%83%85"><span>9.2
                                                            查询详情</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#9.3-sku-%E7%BB%84%E5%90%88%E5%88%87%E6%8D%A2"><span>9.3
                                                            sku 组合切换</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#10%E3%80%81%E5%95%86%E5%93%81%E4%B8%9A%E5%8A%A1-%26-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1"><span>10、商品业务
                                                &amp; 认证服务</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#10.1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span>10.1
                                                            环境搭建</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#10.2-%E5%89%8D%E7%AB%AF%E9%AA%8C%E8%AF%81%E7%A0%81%E5%80%92%E8%AE%A1%E6%97%B6"><span>10.2
                                                            前端验证码倒计时</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#4%E3%80%81%E4%BD%BF%E7%94%A8-java-%E6%B5%8B%E8%AF%95%E7%9F%AD%E4%BF%A1%E6%98%AF%E5%90%A6%E8%83%BD%E8%BF%9B%E8%A1%8C%E5%8F%91%E9%80%81"><span>4、使用
                                                            Java 测试短信是否能进行发送</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#10.4-%E9%AA%8C%E8%AF%81%E7%A0%81%E9%98%B2%E5%88%B7%E6%A0%A1%E9%AA%8C"><span>10.4
                                                            验证码防刷校验</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#5%E3%80%81%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6-%26-%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C"><span>5、异常机制
                                                            &amp; 用户注册</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#2%E3%80%81%E5%9C%A8-member-%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%BC%96%E5%86%99%E6%8E%A5%E5%8F%A3"><span>2、在
                                                            Member 服务中编写接口</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#5%E3%80%81session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3-%E7%BB%9F%E4%B8%80%E5%AD%98%E5%82%A8"><span>5、Session共享问题解决-统一存储</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#4%E3%80%81springsession-%E5%8E%9F%E7%90%86"><span>4、SpringSession
                                                            原理</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#11%E3%80%81%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E5%92%8C%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95"><span>11、单点登录和社交登录</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#11.3.4-%E6%8B%BF%E5%88%B0accesstoken-%E8%AF%B7%E6%B1%82%E5%AF%B9%E5%BA%94%E6%8E%A5%E5%8F%A3%E6%8B%BF%E5%88%B0%E4%BF%A1%E6%81%AF"><span>11.3.4
                                                            拿到AccessToken 请求对应接口拿到信息</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#6%E3%80%81%E4%BD%BF%E7%94%A8-jwt"><span>6、使用
                                                            jwt</span></a></li>
                                                <li><a class="is-flex is-mobile" href="#11.3-jwt"><span>11.3
                                                            JWT</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#12%E3%80%81%E8%B4%AD%E7%89%A9%E8%BD%A6"><span>12、购物车</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#1%E3%80%81%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0%EF%BC%9A"><span>1、需求描述：</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#12.2.3-threadlocal-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span>12.2.3
                                                            ThreadLocal 身份验证</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#12.3-%E6%B7%BB%E5%8A%A0%E8%B4%AD%E7%89%A9%E8%BD%A6"><span>12.3
                                                            添加购物车</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#12.4.2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span>12.4.2
                                                            代码编写</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#12.5.2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span>12.5.2
                                                            代码实现</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#13%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97---mq"><span>13、消息队列 -
                                                MQ</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E6%B5%81%E9%87%8F%E6%B6%88%E5%B3%B0"><span>流量消峰</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#13.2-%E6%A6%82%E8%BF%B0"><span>13.2 概述</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#13.3-rabbitmq%E6%A6%82%E5%BF%B5"><span>13.3
                                                            RabbitMQ概念</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#13.4-docker-%E5%AE%89%E8%A3%85rabbitmq"><span>13.4 Docker
                                                            安装RabbitMQ</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#13.5-rabbitmq-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span>13.5
                                                            RabbitMQ 运行机制</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#2%E3%80%81rabbittemplate%EF%BC%9A%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E5%A4%84%E7%90%86%E7%BB%84%E4%BB%B6"><span>2、RabbitTemplate：消息发送处理组件</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E5%8F%AF%E9%9D%A0%E6%8A%B5%E8%BE%BE---ack-%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6"><span>可靠抵达
                                                            - Ack 消息确认机制</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E5%BB%B6%E6%97%B6%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0---1"><span>延时队列实现
                                                            - 1</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#3%E3%80%81%E6%B6%88%E6%81%AF%E7%A7%AF%E5%8E%8B"><span>3、消息积压</span></a>
                                                </li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#14%E3%80%81%E8%AE%A2%E5%8D%95"><span>14、订单</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#6%E3%80%81%E5%94%AE%E5%90%8E%E4%B8%AD"><span>6、售后中</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#14.2-%E8%AE%A2%E5%8D%95%E6%B5%81%E7%A8%8B"><span>14.2
                                                            订单流程</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#14.3-%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86"><span>14.3
                                                            幂等性处理</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E8%AE%A2%E5%8D%95%EF%BC%9Aorderlistener"><span>订单：OrderListener</span></a>
                                                </li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#15%E3%80%81%E5%B9%82%E7%AD%89%E6%80%A7"><span>15、幂等性</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#15.1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%82%E7%AD%89%E6%80%A7"><span>15.1
                                                            什么是幂等性</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#15.2-%E9%82%A3%E4%BA%9B%E6%83%85%E5%86%B5%E9%9C%80%E8%A6%81%E9%98%B2%E6%AD%A2"><span>15.2
                                                            那些情况需要防止</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#15.3-%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E9%9C%80%E8%A6%81%E5%B9%82%E7%AD%89"><span>15.3
                                                            什么情况下需要幂等</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#5%E3%80%81%E5%85%A8%E5%B1%80%E8%AF%B7%E6%B1%82%E5%94%AF%E4%B8%80id"><span>5、全局请求唯一id</span></a>
                                                </li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#16%E3%80%81%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span>16、本地事务</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#16.1-%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%80%A7%E8%B4%A8"><span>16.1
                                                            事务的基本性质</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#16.2-%E4%BA%8B%E7%89%A9%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span>16.2
                                                            事物的隔离级别</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#16.3-%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span>16.3
                                                            事务传播行为</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#2%E3%80%81%E4%BA%8B%E7%89%A9%E7%9A%84%E5%9D%91"><span>2、事物的坑</span></a>
                                                </li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#17%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span>17、分布式事务</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#17.1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span>17.1
                                                            为什么要有分布式事务</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#4%E3%80%81%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E3%80%81%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7%E3%80%81%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span>4、强一致性、弱一致性、最终一致性</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#4%E3%80%81%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1---%E5%8F%AF%E9%9D%A0%E4%BF%A1%E6%81%AF-%2B-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5%E5%9E%8B%EF%BC%89"><span>4、柔性事务
                                                            - 可靠信息 + 最终一致性方案（异步通知型）</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#18%E3%80%81%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98"><span>18、支付宝支付</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#1%E3%80%81%E8%BF%9B%E5%85%A5%E8%9A%82%E8%9A%81%E9%87%91%E6%9C%8D%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0"><span>1、进入蚂蚁金服开放平台</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#3%E3%80%81%E4%BD%BF%E7%94%A8%E6%B2%99%E7%AE%B1%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span>3、使用沙箱进行测试</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#4%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E5%85%AC%E9%92%A5%E3%80%81%E7%A7%81%E9%92%A5%E3%80%81%E5%8A%A0%E5%AF%86%E3%80%81%E7%AD%BE%E5%90%8D%E5%92%8C%E9%AA%8C%E7%AD%BE%3F"><span>4、什么是公钥、私钥、加密、签名和验签?</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#1%E3%80%81%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E5%90%8E%E5%BC%82%E6%AD%A5%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3%E5%A4%84%E7%90%86"><span>1、支付成功后异步回调接口处理</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#3%E3%80%81%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B8%B8%E7%94%A8%E7%9A%84%E8%BD%AF%E4%BB%B6"><span>3、内网穿透常用的软件</span></a>
                                                </li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#19%E3%80%81%E7%A7%92%E6%9D%80"><span>19、秒杀</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#19.1-%E7%A7%92%E6%9D%80%E4%B8%9A%E5%8A%A1"><span>19.1
                                                            秒杀业务</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#%E7%A7%92%E6%9D%80%E6%96%B9%E5%BC%8F2"><span>秒杀方式2</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#19.3-%E9%99%90%E6%B5%81"><span>19.3 限流</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#19.4-%E7%A7%92%E6%9D%80%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1"><span>19.4
                                                            秒杀核心业务</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#20%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span>20、定时任务</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#20.1-cron%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span>20.1
                                                            cron表达式</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#20.2-cron-%E7%A4%BA%E4%BE%8B"><span>20.2 cron
                                                            示例</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#20.3-springboot%E6%95%B4%E5%90%88%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span>20.3
                                                            SpringBoot整合定时任务</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#20.4-%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span>20.4
                                                            分布式定时任务</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#20.5%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E9%97%AE%E9%A2%98"><span>20.5定时任务的问题</span></a>
                                                </li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#20.6-%E6%89%A9%E5%B1%95---%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E6%95%B4"><span>20.6
                                                            扩展 - 分布式调整</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                    <li><a class="is-flex is-mobile"
                                            href="#21%E3%80%81%E7%A7%92%E6%9D%80%EF%BC%88%E9%AB%98%E5%B9%B6%E5%8F%91%EF%BC%89%E7%B3%BB%E7%BB%9F%E5%85%B3%E6%B3%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span>21、秒杀（高并发）系统关注的问题</span></a>
                                        <ul class="menu-list">
                                            <ul class="menu-list">
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.1-%E6%9C%8D%E5%8A%A1%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3"><span>21.1
                                                            服务单一职责</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.2-%E7%A7%92%E6%9D%80%E9%93%BE%E6%8E%A5%E5%8A%A0%E5%AF%86"><span>21.2
                                                            秒杀链接加密</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.3-%E5%BA%93%E5%AD%98%E9%A2%84%E7%83%AD-%2B-%E5%BF%AB%E9%80%9F%E6%89%A3%E5%87%8F"><span>21.3
                                                            库存预热 + 快速扣减</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.4-%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span>21.4
                                                            动静分离</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.5-%E6%81%B6%E6%84%8F%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA"><span>21.5
                                                            恶意请求拦截</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.6-%E6%B5%81%E9%87%8F%E9%94%99%E5%B3%B0"><span>21.6
                                                            流量错峰</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.7-%E9%99%90%E6%B5%81-%26-%E7%86%94%E6%96%AD-%26-%E9%99%8D%E7%BA%A7"><span>21.7
                                                            限流 &amp; 熔断 &amp; 降级</span></a></li>
                                                <li><a class="is-flex is-mobile"
                                                        href="#21.8-%E9%98%9F%E5%88%97%E6%B6%88%E5%B3%B0"><span>21.8
                                                            队列消峰</span></a></li>
                                            </ul>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <style>
                            .menu-list>li>a.is-active+.menu-list {
                                display: block;
                            }

                            .menu-list>li>a+.menu-list {
                                display: none;
                            }
                        </style>
                        <script src="/js/toc.js" defer></script>
                    </div>
                    <div class="card widget" data-type="profile">
                        <div class="card-content">
                            <nav class="level">
                                <div class="level-item has-text-centered flex-shrink-1">
                                    <div>
                                        <figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded"
                                                src="http://rcy276gfy.hd-bkt.clouddn.com/微信图片_20210131173244.jpg"
                                                alt="魑魅先生"></figure>
                                        <p class="title is-size-4 is-block" style="line-height:inherit;">魑魅先生</p>
                                        <p class="is-size-6 is-block">快乐永远在解决问题的间隙里(*￣︶￣)</p>
                                        <p class="is-size-6 is-flex justify-content-center"><i
                                                class="fas fa-map-marker-alt mr-1"></i><span>浙江-杭州</span></p>
                                    </div>
                                </div>
                            </nav>
                            <nav class="level is-mobile">
                                <div class="level-item has-text-centered is-marginless">
                                    <div>
                                        <p class="heading">文章</p><a href="/archives">
                                            <p class="title">57</p>
                                        </a>
                                    </div>
                                </div>
                                <div class="level-item has-text-centered is-marginless">
                                    <div>
                                        <p class="heading">分类</p><a href="/categories">
                                            <p class="title">86</p>
                                        </a>
                                    </div>
                                </div>
                                <div class="level-item has-text-centered is-marginless">
                                    <div>
                                        <p class="heading">标签</p><a href="/tags">
                                            <p class="title">43</p>
                                        </a>
                                    </div>
                                </div>
                            </nav>
                            <div class="level"><a class="level-item button is-primary is-rounded"
                                    href="https://github.com/MrDemonlxl" target="_blank" rel="noopener">关注我</a></div>
                            <div class="level is-mobile"><a class="level-item button is-transparent is-marginless"
                                    target="_blank" rel="noopener" title="Github"
                                    href="https://github.com/MrDemonlxl"><i class="fab fa-github"></i></a><a
                                    class="level-item button is-transparent is-marginless" target="_blank"
                                    rel="noopener" title="Weibo" href="https://weibo.com/MrDemonlxl"><i
                                        class="fab fa-weibo"></i></a><a
                                    class="level-item button is-transparent is-marginless" target="_blank"
                                    rel="noopener" title="Email" href="/714416426@qq.com"><i
                                        class="fa fa-envelope"></i></a><a
                                    class="level-item button is-transparent is-marginless" target="_blank"
                                    rel="noopener" title="Next" href="https://mrdemonlxl.github.io"><i
                                        class="fab fa-dribbble"></i></a><a
                                    class="level-item button is-transparent is-marginless" target="_blank"
                                    rel="noopener" title="RSS"
                                    href="https://mp.weixin.qq.com/mp/profile_ext?action=home&amp;__biz=MzI5NDc0MDg1Mg==#wechat_redirect"><i
                                        class="fas fa-rss"></i></a></div>
                            <div>
                                <hr>
                                <p id="hitokoto">:D 一言句子获取中...</p>
                                <script type="text/javascript" defer>function getYiyan() {
                                        $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                            if (data) {
                                                $('#hitokoto').html("");
                                                $('#hitokoto').append("<strong style='color: #3273dc;'>" + data.hitokoto + "</strong>" +
                                                    "<p>" + "来源《" + data.from + "》</p><p>提供者-" + data.creator + "</p>");
                                            }
                                        });
                                    }
                                    $(function () { getYiyan(); $('#hitokoto').click(function () { getYiyan(); }) });</script>
                            </div>
                        </div>
                    </div>
                    <div class="card widget" data-type="links">
                        <div class="card-content">
                            <div class="menu">
                                <h3 class="menu-label">链接</h3>
                                <ul class="menu-list">
                                    <li><a class="level is-mobile" href="https://www.jianshu.com/u/4af2d33dbe6f"
                                            target="_blank" rel="noopener"><span class="level-left"><span
                                                    class="level-item">简书</span></span><span class="level-right"><span
                                                    class="level-item tag">www.jianshu.com</span></span></a></li>
                                    <li><a class="level is-mobile" href="https://blog.csdn.net/qq_37862970"
                                            target="_blank" rel="noopener"><span class="level-left"><span
                                                    class="level-item">CSDN</span></span><span class="level-right"><span
                                                    class="level-item tag">blog.csdn.net</span></span></a></li>
                                    <li><a class="level is-mobile" href="https://github.com/MrDemonlxl" target="_blank"
                                            rel="noopener"><span class="level-left"><span
                                                    class="level-item">GitHub</span></span><span
                                                class="level-right"><span
                                                    class="level-item tag">github.com</span></span></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card widget">
                        <div class="card-content">
                            <h3 class="menu-label">最新评论</h3><span class="body_hot_comment">加载中，最新评论有1分钟缓存...</span>
                        </div>
                    </div>
                    <div class="card widget">
                        <div class="card-content">
                            <h3 class="menu-label">最新文章</h3>
                            <article class="media">
                                <div class="media-content">
                                    <p class="date"><time dateTime="2022-05-22T10:59:37.980Z">2022-05-22</time></p>
                                    <p class="title"><a href="/2022/05/22/Draft/2021/Draft/"> </a></p>
                                </div>
                            </article>
                            <article class="media">
                                <figure class="media-left"><a class="image"
                                        href="/2021/11/10/Draft/2021/JVM%20%E4%B8%8E%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/"><img
                                            src="http://rcy276gfy.hd-bkt.clouddn.com/39go6v.jpg" alt="JVM 与上层技术"></a>
                                </figure>
                                <div class="media-content">
                                    <p class="date"><time dateTime="2021-11-10T14:10:43.000Z">2021-11-10</time></p>
                                    <p class="title"><a
                                            href="/2021/11/10/Draft/2021/JVM%20%E4%B8%8E%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/">JVM
                                            与上层技术</a></p>
                                    <p class="categories"><a
                                            href="/categories/%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0/">底层学习</a> / <a
                                            href="/categories/%E5%BA%95%E5%B1%82%E5%AD%A6%E4%B9%A0/JVM-%E4%B8%8E%E4%B8%8A%E5%B1%82%E6%8A%80%E6%9C%AF/">JVM
                                            与上层技术</a></p>
                                </div>
                            </article>
                            <article class="media">
                                <figure class="media-left"><a class="image"
                                        href="/2021/10/20/Draft/2021/MyBatis-Plus/"><img
                                            src="http://rcy276gfy.hd-bkt.clouddn.com/webp.png" alt="MyBatis-Plus"></a>
                                </figure>
                                <div class="media-content">
                                    <p class="date"><time dateTime="2021-10-20T14:10:43.000Z">2021-10-20</time></p>
                                    <p class="title"><a href="/2021/10/20/Draft/2021/MyBatis-Plus/">MyBatis-Plus</a></p>
                                    <p class="categories"><a href="/categories/Frame/">Frame</a> / <a
                                            href="/categories/Frame/MyBatis-Plus/">MyBatis-Plus</a></p>
                                </div>
                            </article>
                            <article class="media">
                                <figure class="media-left"><a class="image"
                                        href="/2021/07/20/Draft/2021/%E9%97%AA%E5%85%89/"><img
                                            src="http://rcy276gfy.hd-bkt.clouddn.com/webp.png" alt="思维闪光"></a></figure>
                                <div class="media-content">
                                    <p class="date"><time dateTime="2021-07-20T14:10:43.000Z">2021-07-20</time></p>
                                    <p class="title"><a href="/2021/07/20/Draft/2021/%E9%97%AA%E5%85%89/">思维闪光</a></p>
                                    <p class="categories"><a
                                            href="/categories/%E4%B8%B4%E6%97%B6%E8%AE%B0%E5%BD%95/">临时记录</a> / <a
                                            href="/categories/%E4%B8%B4%E6%97%B6%E8%AE%B0%E5%BD%95/%E6%80%9D%E7%BB%B4%E9%97%AA%E5%85%89/">思维闪光</a>
                                    </p>
                                </div>
                            </article>
                            <article class="media">
                                <figure class="media-left"><a class="image"
                                        href="/2021/05/31/Draft/2021/Python3%E5%AD%A6%E4%B9%A0/"><img
                                            src="http://rcy276gfy.hd-bkt.clouddn.com/webp1.png" alt="Python 学习"></a>
                                </figure>
                                <div class="media-content">
                                    <p class="date"><time dateTime="2021-05-31T14:10:43.000Z">2021-05-31</time></p>
                                    <p class="title"><a href="/2021/05/31/Draft/2021/Python3%E5%AD%A6%E4%B9%A0/">Python
                                            学习</a></p>
                                    <p class="categories"><a
                                            href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a> / <a
                                            href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Python%E5%AD%A6%E4%B9%A0/">Python学习</a>
                                    </p>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div class="card widget">
                        <div class="card-content">
                            <div class="menu">
                                <h3 class="menu-label">分类</h3>
                                <ul class="menu-list">
                                    <li><a class="level is-mobile is-marginless"
                                            href="/categories/BUG%E8%AE%B0%E5%BD%95/"><span class="level-start"><span
                                                    class="level-item">BUG记录</span></span><span class="level-end"><span
                                                    class="level-item tag">2</span></span></a>
                                        <ul class="mr-0">
                                            <li><a class="level is-mobile is-marginless"
                                                    href="/categories/BUG%E8%AE%B0%E5%BD%95/BUG/"><span
                                                        class="level-start"><span
                                                            class="level-item">BUG</span></span><span
                                                        class="level-end"><span
                                                            class="level-item tag">2</span></span></a></li>
                                        </ul>
                                    </li>
                                    <li><a class="level is-mobile is-marginless" href="/categories/English/"><span
                                                class="level-start"><span class="level-item">English</span></span><span
                                                class="level-end"><span class="level-item tag">1</span></span></a>
                                        <ul class="mr-0">
                                            <li><a class="level is-mobile is-marginless"
                                                    href="/categories/English/%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8B%B1%E8%AF%AD/"><span
                                                        class="level-start"><span
                                                            class="level-item">程序员英语</span></span><span
                                                        class="level-end"><span
                                                            class="level-item tag">1</span></span></a></li>
                                        </ul>
                                    </li>
                                    <li><a class="level is-mobile is-marginless" href="/categories/Frame/"><span
                                                class="level-start"><span class="level-item">Frame</span></span><span
                                                class="level-end"><span class="level-item tag">6</span></span></a>
                                        <ul class="mr-0">
                                            <li><a class="level is-mobile is-marginless"
                                                    href="/categories/Frame/MyBatis/"><span class="level-start"><span
                                                            class="level-item">MyBatis</span></span><span
                                                        class="level-end"><span
                                                            class="level-item tag">1</span></span></a></li>
                                            <li><a class="level is-mobile is-marginless"
                                                    href="/categories/Frame/MyBatis-Plus/"><span
                                                        class="level-start"><span
                                                            class="level-item">MyBatis-Plus</span></span><span
                                                        class="level-end"><span
                                                            class="level-item tag">1</span></span></a></li>
                                            <li><a class="level is-mobile is-marginless"
                                                    href="/categories/Frame/Spring/"><span class="level-start"><span
                                                            class="level-item">Spring</span></span><span
                                                        class="level-end"><span
                                                            class="level-item tag">1</span></span></a></li>
                                            <li><a class="level is-mobile is-marginless"
                                                    href="/categories/Frame/SpringBoot/"><span class="level-start"><span
                                                            class="level-item">SpringBoot</span></span><span
                                                        class="level-end"><span
                                                            class="level-item tag">1</span></span></a></li>
                                            <li><a class="level is-mobile is-marginless"
                                                    href="/categories/Frame/SpringCloud/"><span
                                                        class="level-start"><span
                                                            class="level-item">SpringCloud</span></span><span
                                                        class="level-end"><span
                                                            class="level-item tag">1</span></span></a></li>
                                        </ul>
                                    </li><a class="level is-mobile is-marginless" href="/categories/"><span
                                            class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card widget">
                        <div class="card-content">
                            <div class="menu">
                                <h3 class="menu-label">归档</h3>
                                <ul class="menu-list">
                                    <li><a class="level is-mobile is-marginless" href="/archives/2022/05/"><span
                                                class="level-start"><span class="level-item">五月 2022</span></span><span
                                                class="level-end"><span class="level-item tag">1</span></span></a></li>
                                    <li><a class="level is-mobile is-marginless" href="/archives/2021/11/"><span
                                                class="level-start"><span class="level-item">十一月 2021</span></span><span
                                                class="level-end"><span class="level-item tag">1</span></span></a></li>
                                    <li><a class="level is-mobile is-marginless" href="/archives/2021/10/"><span
                                                class="level-start"><span class="level-item">十月 2021</span></span><span
                                                class="level-end"><span class="level-item tag">1</span></span></a></li>
                                    <li><a class="level is-mobile is-marginless" href="/archives/2021/07/"><span
                                                class="level-start"><span class="level-item">七月 2021</span></span><span
                                                class="level-end"><span class="level-item tag">1</span></span></a></li>
                                    <li><a class="level is-mobile is-marginless" href="/archives/2021/05/"><span
                                                class="level-start"><span class="level-item">五月 2021</span></span><span
                                                class="level-end"><span class="level-item tag">3</span></span></a></li>
                                    <a class="level is-mobile is-marginless" href="/archives/"><span
                                            class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card widget">
                        <div class="card-content">
                            <div class="menu">
                                <h3 class="menu-label">标签</h3>
                                <div class="field is-grouped is-grouped-multiline">
                                    <div class="control"><a class="tags has-addons"
                                            href="/tags/%E5%B7%A5%E5%85%B7%E6%95%99%E7%A8%8B/"><span
                                                class="tag">工具教程</span><span class="tag is-grey-lightest">6</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons" href="/tags/Frame/"><span
                                                class="tag">Frame</span><span class="tag is-grey-lightest">5</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons"
                                            href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span
                                                class="tag">程序人生</span><span class="tag is-grey-lightest">3</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons" href="/tags/BUG/"><span
                                                class="tag">BUG</span><span class="tag is-grey-lightest">2</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons"
                                            href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tag">前端</span><span
                                                class="tag is-grey-lightest">2</span></a></div>
                                    <div class="control"><a class="tags has-addons" href="/tags/CRUD/"><span
                                                class="tag">CRUD</span><span class="tag is-grey-lightest">1</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons" href="/tags/Docker/"><span
                                                class="tag">Docker</span><span class="tag is-grey-lightest">1</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons" href="/tags/Dubbo/"><span
                                                class="tag">Dubbo</span><span class="tag is-grey-lightest">1</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons" href="/tags/English/"><span
                                                class="tag">English</span><span
                                                class="tag is-grey-lightest">1</span></a></div>
                                    <div class="control"><a class="tags has-addons" href="/tags/Life/"><span
                                                class="tag">Life</span><span class="tag is-grey-lightest">1</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span
                                                class="tag">MongoDB</span><span
                                                class="tag is-grey-lightest">1</span></a></div>
                                    <div class="control"><a class="tags has-addons" href="/tags/NO-GAME-NO-LIFE/"><span
                                                class="tag">NO GAME NO LIFE</span><span
                                                class="tag is-grey-lightest">1</span></a></div>
                                    <div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span
                                                class="tag">Nginx</span><span class="tag is-grey-lightest">1</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons"
                                            href="/tags/Python%E5%AD%A6%E4%B9%A0/"><span
                                                class="tag">Python学习</span><span
                                                class="tag is-grey-lightest">1</span></a></div>
                                    <div class="control"><a class="tags has-addons" href="/tags/RabbitMQ/"><span
                                                class="tag">RabbitMQ</span><span
                                                class="tag is-grey-lightest">1</span></a></div>
                                    <div class="control"><a class="tags has-addons" href="/tags/Redis/"><span
                                                class="tag">Redis</span><span class="tag is-grey-lightest">1</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons"
                                            href="/tags/Software-Engineer/"><span class="tag">Software
                                                Engineer</span><span class="tag is-grey-lightest">1</span></a></div>
                                    <div class="control"><a class="tags has-addons" href="/tags/SpringCloud/"><span
                                                class="tag">SpringCloud</span><span
                                                class="tag is-grey-lightest">1</span></a></div>
                                    <div class="control"><a class="tags has-addons"
                                            href="/tags/%E4%B8%B4%E6%97%B6%E8%AE%B0%E5%BD%95/"><span
                                                class="tag">临时记录</span><span class="tag is-grey-lightest">1</span></a>
                                    </div>
                                    <div class="control"><a class="tags has-addons"
                                            href="/tags/%E4%B9%A6%E5%BD%B1%E9%9F%B3/"><span class="tag">书影音</span><span
                                                class="tag is-grey-lightest">1</span></a></div>
                                </div>
                                <div class="field is-grouped is-grouped-multiline"><a class="tags has-addons"
                                        href="/tags/"><span class="tag">查看全部&gt;&gt;</span></a></div>
                            </div>
                        </div>
                    </div>
                    <div class="card widget" data-type="subscribe-email">
                        <div class="card-content">
                            <div class="menu">
                                <h3 class="menu-label">订阅更新</h3>
                                <form action="https://feedburner.google.com/fb/a/mailverify" method="post"
                                    target="popupwindow"
                                    onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=mrdemonlxlFeedsId&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true">
                                    <input type="hidden" value="mrdemonlxlFeedsId" name="uri"><input type="hidden"
                                        name="loc" value="en_US">
                                    <div class="field has-addons">
                                        <div class="control has-icons-left is-expanded"><input class="input"
                                                name="email" type="email" placeholder="Email"><span
                                                class="icon is-small is-left"><i class="fas fa-envelope"></i></span>
                                        </div>
                                        <div class="control"><input class="button" type="submit" value="订阅"></div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!--!-->
                    <div class="column-right-shadow is-hidden-widescreen"></div>
                </div>
            </div>
        </div>
    </section>
    <footer class="footer">
        <div class="container">
            <div class="level">
                <div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img
                            src="http://rcy276gfy.hd-bkt.clouddn.com/彩色logo.png" alt="魑魅先生" height="28"></a>
                    <p class="size-small"><span>&copy; 2022 魑魅先生</span>  Powered by <a href="https://hexo.io/"
                            target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus"
                            target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing"
                            target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/"
                                target="_blank">川ICP备88888888号-8</a><br></span><span>©
                            版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a
                                href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span
                                id="statistic-times">loading...</span>
                            <script>function createTime(time) {
                                    var n = new Date(time);
                                    now.setTime(now.getTime() + 250),
                                        days = (now - n) / 1e3 / 60 / 60 / 24,
                                        dnum = Math.floor(days),
                                        hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                                        hnum = Math.floor(hours),
                                        1 == String(hnum).length && (hnum = "0" + hnum),
                                        minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                                        mnum = Math.floor(minutes),
                                        1 == String(mnum).length && (mnum = "0" + mnum),
                                        seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                                        snum = Math.round(seconds),
                                        1 == String(snum).length && (snum = "0" + snum),
                                        document.getElementById("statistic-times").innerHTML = "❤️本站自 <strong>" + time.split(" ")[0].replace(/\//g, ".") + "</strong> 已运行 <strong>" + dnum + "</strong> 天 <strong>" + hnum + "</strong> 小时 <strong>" + mnum + "</strong> 分 <strong>" + snum + "</strong> 秒！❤️";
                                } var now = new Date(); setInterval("createTime('2021/02/18 00:00:00')", 250, "");</script><br>
                        </span>
                    <div class="size-small"><span>❤️感谢 <strong><span id="busuanzi_value_site_uv">99+</span></strong>
                            小伙伴的 <strong><span id="busuanzi_value_site_pv">99+</span></strong> 次光临！❤️</span></div>
                    </p>
                </div>
                <div class="level-end">
                    <div class="field has-addons">
                        <p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener"
                                title="Creative Commons" href="https://creativecommons.org/"><i
                                    class="fab fa-creative-commons"></i></a></p>
                        <p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener"
                                title="Attribution 4.0 International"
                                href="https://creativecommons.org/licenses/by/4.0/"><i
                                    class="fab fa-creative-commons-by"></i></a></p>
                        <p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener"
                                title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i
                                    class="fab fa-github"></i></a></p>
                    </div>
                    <div class="sideMusic">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
                        <script src="/js/APlayer.min.js"></script>
                        <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
                        <meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="3071252637"
                            theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting"
                            lrctype="0" list-max-height="400px" fixed="true"></meting-js>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
    <script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script>
    <script>moment.locale("zh-CN");</script>
    <script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script>
    <script src="/js/column.js"></script>
    <script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i
            class="fas fa-chevron-up"></i></a>
    <script src="/js/back_to_top.js" defer></script>
    <!--!-->
    <!--!-->
    <!--!-->
    <script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script>
    <script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js"
        defer></script>
    <script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script>
    <!--!-->
    <!--!-->
    <!--!-->
    <script src="/js/main.js" defer></script>
    <script>$.getScript('/js/comment-issue-data.js', function () { loadIssueData('20ef8321698ab8c0c37b', '4faa4daae14b55afd2ed357fba92d1e9c7c3f729', 'MrDemonlxl', 'MrDemonlxl.github.io', false); })</script>
    <div class="searchbox">
        <div class="searchbox-container">
            <div class="searchbox-header">
                <div class="searchbox-input-container"><input class="searchbox-input" type="text"
                        placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a>
            </div>
            <div class="searchbox-body"></div>
        </div>
    </div>
    <script src="/js/insight.js" defer></script>
    <script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({ "contentUrl": "/content.json" }, { "hint": "想要查找什么...", "untitled": "(无标题)", "posts": "文章", "pages": "页面", "categories": "分类", "tags": "标签" });
        });</script>
    <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>
    <script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust: false
        })

        function loadBusuanzi() {
            $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () { });
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });

        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({ opacity: 1 });
            if (true) {
                $.getScript('/js/comment-issue-data.js', function () { loadIssueData('20ef8321698ab8c0c37b', '4faa4daae14b55afd2ed357fba92d1e9c7c3f729', 'MrDemonlxl', 'MrDemonlxl.github.io', false); });
            }
            if (false) {
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if (typeof loadBanner == 'function') {
                loadBanner();
            }
        });</script>
</body>

</html>